<form>
  <label>Tenants</label>
  <fieldset submitButton="false">
    <input type="time" token="time_token" searchWhenChanged="true">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="mso_token" searchWhenChanged="true">
      <label>Multi-Site Orchestrator</label>
      <selectFirstChoice>true</selectFirstChoice>
      <fieldForLabel>mso_host</fieldForLabel>
      <fieldForValue>mso_host</fieldForValue>
      <search>
        <query>eventtype="cisco_mso" mso_api_endpoint=tenantDetails OR mso_api_endpoint=schemaTenants OR mso_api_endpoint=siteHealth | fields mso_host | dedup mso_host | table mso_host</query>
        <earliest>$time_token.earliest$</earliest>
        <latest>$time_token.latest$</latest>
      </search>
    </input>
  </fieldset>
  <row rejects="$mso_token$">
      <panel>
      <html>
       <p><i>Data is not available in selected time range or MSO data collection is not configured. Try expanding the time range or configure the MSO: <a href="/app/TA_cisco-ACI/aci_setup" target="_blank">Setup Page</a></i></p>
     </html>
    </panel>
  </row>
  <row depends="$mso_token$">
    <panel depends="$never_show_this_panel$">
      <table>
        <search>
          <done>
            <condition match="$job.resultCount$ &gt; 0">
              <set token="mso_site_url">$result.url$</set>
              <set token="mso_site_type">$result.platform$</set>
            </condition>
          </done>
          <query>eventtype="cisco_mso" mso_api_endpoint=siteHealth mso_host=$mso_token$ name=$mso_site_token$ | dedup mso_site_id | rex field=urls "https://(?&lt;url&gt;.*)$" | mvexpand url  | dedup apicSiteId | table name, platform, url</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$mso_token$">
    <panel>
      <chart>
        <title>Top 10 Tenants Association By Site</title>
        <search>
          <query>eventtype="cisco_mso"  mso_api_endpoint=tenantDetails mso_host=$mso_token$
| dedup name
|fillnull value="None" siteAssociations_siteId | rename name as "tenant_name",siteAssociations_siteId as "id"
|mvexpand id
| join type=outer id
    [| search eventtype="cisco_mso" mso_api_endpoint=siteHealth mso_host=$mso_token$| dedup id| fields id,name]| fillnull value="None" name
| stats dc(tenant_name) as Count by name 
| sort Count DESC |head 10 | rename name as "Site Name"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <chart>
        <title>Top 10 Tenants Association By User</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=tenantDetails mso_host=$mso_token$|fillnull value="None" userAssociations_userId 
| rename userAssociations_userId as "user_id"
| mvexpand user_id
| join type=outer user_id
    [| search eventtype="cisco_mso" mso_api_endpoint=userDetails mso_host=$mso_token$
    | rename id as "user_id" 
    | dedup user_id| fields user_id,username]| fillnull value="None" username
| stats dc(name) as Count by username
| sort Count DESC |head 10 | rename username as "User Name"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <chart>
        <title>Top 10 Tenants Association By Schema</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=schemaTenants mso_host=$mso_token$ |
fillnull value="None" mso_schema_id
| mvexpand mso_schema_id
| join type=outer mso_schema_id
    [| search eventtype="cisco_mso" mso_api_endpoint=schemaDetails mso_host=$mso_token$|rename id as "mso_schema_id" 
    | dedup mso_schema_id| fields mso_schema_id,displayName]| fillnull value="None" displayName
| stats dc(name) as Count by displayName
| sort Count DESC |head 10 | rename displayName as "Schema Name"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row depends="$mso_token$">
    <panel>
      <chart>
        <title>Top 10 Schema Association By Tenant</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=schemaTenants mso_host=$mso_token$ 
| dedup mso_schema_id, displayName 
| stats dc(mso_schema_id) as Count by displayName 
| sort -Count
| head 10 | rename displayName as "Tenant Name"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <chart>
        <title>Tenant Association with Schema</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=tenantDetails mso_host=$mso_token$ 
| dedup id 
| join id type=outer 
    [ search eventtype="cisco_mso" mso_api_endpoint=schemaTenants mso_host=$mso_token$
    | fields id, mso_schema_id] 
| fillnull value="NA" mso_schema_id 
| eval associated=case(mso_schema_id == "NA", "Not Associated with Any Schema") 
| fillnull value="Associated with Schema" associated 
| stats count as Count by associated | rename associated as Associated</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row depends="$mso_token$">
    <panel>
      <input type="dropdown" token="mso_site_token" searchWhenChanged="true">
        <label>Site</label>
        <selectFirstChoice>true</selectFirstChoice>
        <fieldForLabel>name</fieldForLabel>
        <fieldForValue>name</fieldForValue>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=siteHealth mso_host=$mso_token$ | fields mso_site_id, name | dedup mso_site_id | table mso_site_id, name</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
      </input>
      <table>
        <title>Tenant Details</title>
        <search>
          <query>eventtype="cisco_mso"  mso_api_endpoint=tenantDetails mso_host=$mso_token$
| dedup name
|fillnull value="None" username|fillnull value="None" siteAssociations_siteId | rename name as "tenant_name",siteAssociations_siteId as "id"
|mvexpand id
| join type=outer id
   [| search eventtype="cisco_mso" mso_api_endpoint=siteHealth mso_host=$mso_token$| dedup id| fields id,name]| fillnull value="None" name  | join type=outer userAssociations_userId [| search eventtype="cisco_mso" mso_api_endpoint=userDetails mso_host=$mso_token$ | dedup id | rename id as userAssociations_userId| table userAssociations_userId, username]
| search name=$mso_site_token$
| table tenant_name, username,name, description | rename tenant_name as "Tenant Name", username as Username, description as Description, name as "Site Name" | fillnull value="-"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <drilldown>
          <link target="_blank">/app/cisco-app-ACI/tenant_dashboard?form.mso_host=$mso_token$&amp;form.apic_host=$mso_site_url$&amp;tenant_name=$row.Tenant Name$&amp;form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$mso_token$">
    <panel>
      <title>Audit Logs</title>
      <table>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=msoAuditRecords type=tenant mso_host=$mso_token$| table timestamp, user_username,user_domainName, type, event
| rename timestamp as "Timestamp", user_username as "Username",user_domainName as "Domain Name", type as "Type", event as "Event"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
</form>