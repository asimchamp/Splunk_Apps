<form script="tenant_dashboard.js" stylesheet="table_decorations.css">
  <label>Tenant Details</label>
  <description></description>
  <search id="baseSearch">
    <query>| `apic-tenant-overview` |dedup dn</query>
    <earliest>$earliest$</earliest>
    <latest>$latest$</latest>
  </search>
  <search>
    <query>| inputlookup mso_site_details | dedup apic_host | table apic_host | eval apic_host="apic_host!=".apic_host | mvcombine apic_host | eval apic_host=mvjoin(apic_host, " AND ")</query>
    <earliest>-24h@h</earliest>
    <latest>now</latest>
    <done>
      <condition>
        <set token="not_search_apic_host">$result.apic_host$</set>
      </condition>
    </done>
  </search>
  <search>
    <query>| inputlookup mso_site_details | dedup mso_host | table mso_host</query>
    <earliest>-24h@h</earliest>
    <latest>now</latest>
    <done>
      <condition match="'job.resultCount'==0">
        <unset token="hide_filter"></unset>
        <set token="non_mso_filter">non_mso_filter</set>
        <set token="apic_host_query">eventtype="cisco_apic_*" component=credentials | fields apic_host | dedup apic_host | SORT apic_host</set>
      </condition>
      <condition>
        <set token="hide_filter">hide_filter</set>
      </condition>
    </done>
  </search>
  <search>
    <query>| inputlookup mso_site_details | search mso_host=$mso_host$ | dedup apic_host | table apic_host | eval apic_host="apic_host=".apic_host | mvcombine apic_host | eval apic_host=mvjoin(apic_host, " OR ")</query>
    <earliest>-24h@h</earliest>
    <latest>now</latest>
    <done>
      <condition match="'job.resultCount'&gt;0">
        <set token="search_apic_host">$result.apic_host$</set>
      </condition>
    </done>
  </search>
  <fieldset autoRun="true" submitButton="false">
    <input type="time" searchWhenChanged="true" token="time_token">
      <label>Time Picker</label>
      <default>
        <earliest>-60m@m</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="mso_host" searchWhenChanged="true" depends="$hide_filter$">
      <label>Multi-Site Orchestrator</label>
      <fieldForLabel>mso_host</fieldForLabel>
      <fieldForValue>mso_host</fieldForValue>
      <search>
        <query>| inputlookup mso_site_details | dedup mso_host | table mso_host</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
      <choice value="non_mso_sites">Non MSO Sites</choice>
      <change>
        <condition value="non_mso_sites">
          <set token="host_filter">$not_search_apic_host$</set>
          <set token="apic_host_query">eventtype="cisco_apic_*" component=credentials $not_search_apic_host$ | fields apic_host | dedup apic_host | SORT apic_host</set>
        </condition>
        <condition>
          <set token="host_filter">$search_apic_host$</set>
          <set token="apic_host_query">| inputlookup mso_site_details | search mso_host=$mso_host$ | dedup apic_host | table apic_host</set>
        </condition>
      </change>
      <default>non_mso_sites</default>
    </input>
    <input type="dropdown" token="apic_host" searchWhenChanged="true">
      <label>APIC Sites/Cluster</label>
      <selectFirstChoice>true</selectFirstChoice>
      <search>
        <query>$apic_host_query$</query>
        <earliest>$time_token.earliest$</earliest>
        <latest>$time_token.latest$</latest>
        <done>
          <condition match="job.resultCount==0">
            <unset token="formed_apic_host"></unset>
          </condition>
        </done>
      </search>
      <fieldForLabel>apic_host</fieldForLabel>
      <fieldForValue>apic_host</fieldForValue>
      <choice value="all">All</choice>
      <change>
        <condition match="$value$==&quot;all&quot; AND $non_mso_filter$==&quot;non_mso_filter&quot; AND $mso_host$==&quot;non_mso_sites&quot;">
          <set token="formed_apic_host">apic_host=*</set>
        </condition>
        <condition match="$value$==&quot;all&quot; AND $mso_host$==&quot;non_mso_sites&quot;">
          <set token="formed_apic_host">$not_search_apic_host$</set>
        </condition>
        <condition value="all">
          <set token="formed_apic_host">$search_apic_host$</set>
        </condition>
        <condition>
          <set token="formed_apic_host">apic_host=$apic_host$</set>
        </condition>
      </change>
    </input>
    <input type="text" token="healthRange" searchWhenChanged="true">
      <label>Enter Max required Health Score: 1-100</label>
      <default>100</default>
    </input>
  </fieldset>
  <row>
    <panel>
      <html id="role">
        <h3>APIC User Role Privileges</h3>
       <div>APIC user role required: Read-All. For Application Statistics (L2 Ingress), 'admin' role privilege is required for the configured APIC user account.</div>
     </html>
    </panel>
  </row>
  <row>
    <panel>
      <html id="overview">
      <h1>Dashboard Overview</h1>
     <p>This dashboard provides Health and Fault details for Tenants and their components over the time period specified using the time picker. <br/>Following drilldown capabilities are provided:<br/>
          <ul>
            <li> Drilldown on Tenant fault chart - Provide details on Tenant specific faults.</li>
            <li>Drilldown on Tenant Health chart - Provides Health detail of  Applications and End Point Groups.</li>
          </ul>
        </p>
     </html>
    </panel>
  </row>
  <row depends="$tenant_name$">
    <panel>
      <single id="master">
        <title>Tenant Health - $tenant_name$</title>
        <search base="baseSearch">
          <query>| search component="fvTenant" $formed_apic_host$ TenantName=$tenant_name$| stats values(health) AS "Health"| appendpipe [stats count | where count==0]</query>
        </search>
        <option name="drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <set token="tenantName">$tenant_name$</set>
          <unset token="faultTenant"></unset>
        </drilldown>
      </single>
    </panel>
    <panel>
      <single>
        <title>Tenant Faults - $tenant_name$</title>
        <search base="baseSearch">
          <query>| search $formed_apic_host$ TenantName=$tenant_name$| dedup dn| stats latest(health) AS "Health" count(eval(match(code,".*"))) AS Faults |fields - Health,NULL</query>
        </search>
        <option name="drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <set token="faultTenant">$tenant_name$</set>
          <unset token="tenantName"></unset>
        </drilldown>
      </single>
    </panel>
  </row>
  <row rejects="$tenant_name$">
    <panel>
      <chart>
        <title>Top 10 Afftected Tenant's Health</title>
        <search base="baseSearch">
          <query>| search component="fvTenant" $formed_apic_host$ |stats latest(health) AS "Health" by TenantName |  where $healthRange$ &gt;= Health | eval "Health &lt; 60" = case(Health &lt; 60, Health) | eval "Health &lt; 80" = case(Health &gt;= 60 AND Health &lt;80, Health) | eval "Health &lt; 100" = case(Health &gt;=80 AND Health &lt;=100, Health) | SORT Health | head 10 | table TenantName,"Health &lt; 60","Health &lt; 80","Health &lt; 100" | rename TenantName AS Tenant</query>
          
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.axisTitleX.text">Tenant</option>
        <option name="charting.legend.labels">["Health &lt; 60","Health &lt; 80","Health &lt; 100"]</option>
        <option name="charting.seriesColors">[0xFF3333,0xFFA500,0x088A08]</option>
        <drilldown>
          <set token="tenantName">$click.value$</set>
          <unset token="faultTenant"></unset>
        </drilldown>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
      </chart>
    </panel>
    <panel>
      <chart>
        <title>Top 10 Affected Tenant's Faults</title>
        <search base="baseSearch">
          <query>| search $formed_apic_host$ | dedup dn| stats latest(health) AS "Health" count(eval(match(code,".*"))) AS Faults by TenantName | rename TenantName AS name | where Faults &gt; 0 | SORT Health | head 10 | fields - Health,NULL</query>
        </search>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <drilldown>
          <set token="faultTenant">$click.value$</set>
          <unset token="tenantName"></unset>
        </drilldown>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <table id="detail1" depends="$tenantName$" rejects="$faultTenant$">
        <title>Application Health for Tenant: $tenantName$</title>
        <search base="baseSearch">
          <query>| search component="fvAp" TenantName=$tenantName$ health="*" $formed_apic_host$| dedup dn| stats latest(health) AS "Health" by ApplicationName | table ApplicationName,"Health" | rename ApplicationName AS Application</query>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <table id="detail2" depends="$tenantName$" rejects="$faultTenant$">
        <title>End Point Group Health for Tenant: $tenantName$</title>
        <search base="baseSearch">
          <query>| search component="fvEPg" TenantName=$tenantName$ health=* $formed_apic_host$ | dedup dn| stats latest(health) AS "Health" count(eval(match(code,".*"))) AS Faults latest(ApplicationName) AS Application  by dn,EndPointGroupName | table EndPointGroupName,Application,Health,Faults | dedup EndPointGroupName, Application | fields - dn | rename EndPointGroupName AS EPG |SORT Health</query>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table id="detail3" depends="$tenantName$" rejects="$faultTenant$">
        <title>Application Statistics for Tenant: $tenantName$</title>
        <search>
          <query>| tstats  values(Stats.dropCum) AS dropCum values(Stats.floodCum) AS floodCum values(Stats.multicastCum) AS multicastCum values(Stats.unicastCum) AS unicastCum values(Stats.dn) AS dn from datamodel=Statistics where Stats.component=l2IngrBytesAg15min groupby Stats.App_Stats.Tenant,Stats.App_Stats.Application,_time | rename Stats.App_Stats.Tenant AS Tenant, Stats.App_Stats.Application AS Application | search Tenant= $tenantName$ | where dn LIKE "%/CDl2IngrBytesAg15min" | stats latest(dropCum) AS "Ingress Total Drop Bytes" sparkline(avg(dropCum)) AS "Drop Bytes Trend" latest(floodCum) AS "Ingress Total Flood Bytes" latest(unicastCum) AS "Ingress Total Unicast Bytes" latest(multicastCum) AS "Ingress Total Multicast Bytes" by Tenant,Application</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="count">5</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
        <format field="Drop Bytes Trend" type="sparkline">
          <option name="spotRadius">3</option>
          <option name="width">75</option>
          <option name="fillColor">#CCDDFF</option>
          <option name="lineColor">#5379af</option>
          <option name="maxSpotColor">#A2FFA2</option>
          <option name="lineWidth">1</option>
          <option name="height">25</option>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table id="detail4" depends="$tenantName$" rejects="$faultTenant$">
        <title>Client End Point Details for Tenant: $tenantName$</title>
        <search>
          <query>|`end_point_detail`| search Tenant=$tenantName$ | table Tenant,Application,EPG,EPG-Health,VirtualMachine,state,Network-Adapter,ESX-Host,vCenter,Interface | rename VirtualMachine AS "Virtual Machine" ESX-Host AS "ESX host" Network-Adapter AS "Network Adapter" EPG-Health AS "EPG Health" state AS "State"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table id="highlight" depends="$faultTenant$" rejects="$tenantName$">
        <title>$faultTenant$ Tenant Fault Details</title>
        <search>
          <query>| tstats values(apic.code) AS "Fault-code"  latest(apic.ack) AS Ack values(apic.descr) AS Descr latest(apic.cause) AS Cause  latest(apic.created) AS Created latest(apic.changeSet) AS ChangeSet latest(apic.rule) AS Rule latest(apic.severity) AS severity  values(apic.name) AS Name values(apic.Tenant.TenantName) AS Tenant values(apic.Tenant.ApplicationName) AS Application from datamodel=Health WHERE apic.component="fvTenant" groupby apic.dn,apic.Tenant.group_field |lookup APICFaultDetails code AS "Fault-code" OUTPUT description  AS Explanation "Recommended Action" AS "Recommended Action" | search Tenant=$faultTenant$ Fault-code=*| rename apic.dn AS dn | table Name,dn,Fault-code,Ack,severity,Created,Explanation,"Recommended Action",Cause,Rule,Descr,ChangeSet</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>All Tenant Details</title>
        <search>
          <query>eventtype=cisco_apic_health component=fvTenant dn="*/health" $formed_apic_host$ NOT "code" | dedup dn | search twScore  | table name, twScore | rename name AS Tenant | rename twScore AS "Heath Score" | JOIN type=outer max=0 Tenant  [search eventtype=cisco_apic_health component=fvAEPg dn="*/health" $formed_apic_host$ NOT "code" | dedup dn | rex field=dn "uni\/tn-(?&lt;Tenant&gt;[^\/]+)" | stats count(name) by Tenant | rename count(name) AS "EPGs"  | table EPGs, Tenant ] | JOIN type=outer max=0 Tenant  [search eventtype=cisco_apic_health component=fvBD dn="*/health" $formed_apic_host$ NOT "code" | dedup dn | rex field=dn "uni\/tn-(?&lt;Tenant&gt;[^\/]+)" | stats count(name) by Tenant | rename count(name) AS "Bridge Domains"  | table "Bridge Domains", Tenant ] | JOIN type=outer max=0 Tenant  [search eventtype=cisco_apic_health component=fvCtx dn="*/health" $formed_apic_host$ NOT "code" | dedup dn | rex field=dn "uni\/tn-(?&lt;Tenant&gt;[^\/]+)" | stats count(name) by Tenant | rename count(name) AS "VRFs"  | table "VRFs", Tenant ] | table Tenant, "Bridge Domains", "VRFs", "EPGs", "Heath Score"  | fillnull value=0 | rename Tenant As Name | SORT Name</query>
           <earliest>$time_token.earliest$</earliest>
           <latest>$time_token.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
</form>