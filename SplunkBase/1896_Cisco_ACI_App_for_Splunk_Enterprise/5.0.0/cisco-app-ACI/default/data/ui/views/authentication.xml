<form script="set_apic_token.js" stylesheet="table_decorations.css">
  <label>Authentication</label>
  <description></description>
  <search id="baseSearch">
    <query>|` authentication_details`</query>
    <earliest>$time_token.earliest$</earliest>
    <latest>$time_token.latest$</latest>
  </search>
  <search>
    <query>| inputlookup mso_site_details | dedup apic_host | table apic_host | eval apic_host="apic_host!=".apic_host | mvcombine apic_host | eval apic_host=mvjoin(apic_host, " AND ")</query>
    <earliest>-24h@h</earliest>
    <latest>now</latest>
    <done>
      <condition>
        <set token="not_search_apic_host">$result.apic_host$</set>
      </condition>
    </done>
  </search>
  <search>
    <query>| inputlookup mso_site_details | dedup mso_host | table mso_host</query>
    <earliest>-24h@h</earliest>
    <latest>now</latest>
    <done>
      <condition match="'job.resultCount'==0">
        <unset token="hide_filter"></unset>
        <set token="non_mso_filter">non_mso_filter</set>
        <set token="apic_host_query">eventtype="cisco_apic_*" component=credentials | fields apic_host | dedup apic_host | SORT apic_host</set>
      </condition>
      <condition>
        <set token="hide_filter">hide_filter</set>
      </condition>
    </done>
  </search>
  <search>
    <query>| inputlookup mso_site_details | search mso_host=$mso_host$ | dedup apic_host | table apic_host | eval apic_host="apic_host=".apic_host | mvcombine apic_host | eval apic_host=mvjoin(apic_host, " OR ")</query>
    <earliest>-24h@h</earliest>
    <latest>now</latest>
    <done>
      <condition match="'job.resultCount'&gt;0">
        <set token="search_apic_host">$result.apic_host$</set>
      </condition>
    </done>
  </search>
  <fieldset autoRun="true" submitButton="false">
    <input type="time" token="time_token" searchWhenChanged="true">
      <label>Time Picker</label>
      <default>
        <earliest>-4h@m</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="mso_host" searchWhenChanged="true" depends="$hide_filter$">
      <label>Multi-Site Orchestrator</label>
      <fieldForLabel>mso_host</fieldForLabel>
      <fieldForValue>mso_host</fieldForValue>
      <search>
        <query>| inputlookup mso_site_details | dedup mso_host | table mso_host</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
      <choice value="non_mso_sites">Non MSO Sites</choice>
      <change>
        <condition value="non_mso_sites">
          <set token="host_filter">$not_search_apic_host$</set>
          <set token="apic_host_query">eventtype="cisco_apic_*" component=credentials $not_search_apic_host$ | fields apic_host | dedup apic_host | SORT apic_host</set>
        </condition>
        <condition>
          <set token="host_filter">$search_apic_host$</set>
          <set token="apic_host_query">| inputlookup mso_site_details | search mso_host=$mso_host$ | dedup apic_host | table apic_host</set>
        </condition>
      </change>
      <default>non_mso_sites</default>
    </input>
    <input type="dropdown" token="apic_host" searchWhenChanged="true">
      <label>APIC Sites/Cluster</label>
      <selectFirstChoice>true</selectFirstChoice>
      <search>
        <query>$apic_host_query$</query>
        <earliest>$time_token.earliest$</earliest>
        <latest>$time_token.latest$</latest>
        <done>
          <condition match="job.resultCount==0">
            <unset token="formed_apic_host"></unset>
          </condition>
        </done>
      </search>
      <fieldForLabel>apic_host</fieldForLabel>
      <fieldForValue>apic_host</fieldForValue>
      <choice value="all">All</choice>
      <change>
        <condition match="$value$==&quot;all&quot; AND $non_mso_filter$==&quot;non_mso_filter&quot;">
          <set token="formed_apic_host">apic_host=*</set>
          <unset token="form.multiTokenQuery"></unset>
        </condition>
        <condition match="$value$==&quot;all&quot; AND $mso_host$==&quot;non_mso_sites&quot;">
          <set token="formed_apic_host">$not_search_apic_host$</set>
          <unset token="form.multiTokenQuery"></unset>
        </condition>
        <condition value="all">
          <set token="formed_apic_host">$search_apic_host$</set>
          <unset token="form.multiTokenQuery"></unset>
        </condition>
        <condition>
          <set token="formed_apic_host">apic_host=$apic_host$</set>
          <unset token="form.multiTokenQuery"></unset>
        </condition>
      </change>
    </input>
    <input type="multiselect" token="multiTokenQuery" searchWhenChanged="true">
      <default>*</default>
      <label>User</label>
      <delimiter> OR user=</delimiter>
      <choice value="*">All</choice>
      <search>
        <query>| tstats latest(classInfo.name) AS user from datamodel=Systems where (classInfo.component=aaaUser OR classInfo.component=aaaRemoteUser ) groupby classInfo.dn, classInfo.apic_host | rename classInfo.apic_host AS apic_host | search $formed_apic_host$ | dedup user | table user</query>
      <earliest>$time_token.earliest$</earliest>
      <latest>$time_token.latest$</latest>
      </search>
      <fieldForLabel>user</fieldForLabel>
      <fieldForValue>user</fieldForValue>
    </input>
  </fieldset>
  <row>
    <panel>
      <html id="role">
        <h3>APIC User Role Privileges</h3>
       <div>APIC user role required: Admin. User related login/sessions can still be viewed with non-admin role privilege.</div>
     </html>
    </panel>
  </row>
  <row>
    <panel>
      <single>
        <title>Users</title>
        <search>
          <query>| tstats latest(classInfo.unixUserId) from datamodel=Systems where (classInfo.component=aaaUser OR classInfo.component=aaaRemoteUser) groupby classInfo.dn, classInfo.apic_host | rename classInfo.apic_host AS apic_host | search $formed_apic_host$ | dedup classInfo.dn,apic_host | stats count(classInfo.dn)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="numberPrecision">0</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="unitPosition">after</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
        <drilldown target="User Details">
          <condition match="$apic_host$==&quot;all&quot;">
            <link>
              <![CDATA[
                 user_details?display_apic_host=All&formed_apic_host=$formed_apic_host$&time_token.earliest=$time_token.earliest$&time_token.latest=$time_token.latest$
      			  ]]> 
            </link>
          </condition>
          <condition>
            <link>
              <![CDATA[
                user_details?display_apic_host=$apic_host$&formed_apic_host=$formed_apic_host$&time_token.earliest=$time_token.earliest$&time_token.latest=$time_token.latest$
  			    ]]>
            </link>
          </condition>
        </drilldown>
      </single>
    </panel>
    <panel>
      <single>
        <title>Local Users</title>
        <search>
          <query>| tstats latest(classInfo.unixUserId) from datamodel=Systems where classInfo.component=aaaUser groupby classInfo.dn,classInfo.apic_host | rename classInfo.apic_host AS apic_host | search $formed_apic_host$ | dedup classInfo.dn,apic_host | stats count(classInfo.dn)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="numberPrecision">0</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="unitPosition">after</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
        <drilldown target="Local User Details">
          <condition match="$apic_host$==&quot;all&quot;">
            <link>
              <![CDATA[
                 local_user_details?display_apic_host=All&formed_apic_host=$formed_apic_host$&time_token.earliest=$time_token.earliest$&time_token.latest=$time_token.latest$
      			  ]]> 
            </link>
          </condition>
          <condition>
            <link>
              <![CDATA[
                local_user_details?display_apic_host=$apic_host$&formed_apic_host=$formed_apic_host$&time_token.earliest=$time_token.earliest$&time_token.latest=$time_token.latest$
  			    ]]>
            </link>
            </condition>
        </drilldown>
      </single>
    </panel>
    <panel>
      <single>
        <title>Remote Users</title>
        <search>
          <query>| tstats latest(classInfo.unixUserId) from datamodel=Systems where  classInfo.component=aaaRemoteUser groupby classInfo.dn, classInfo.apic_host | rename classInfo.apic_host AS apic_host | search $formed_apic_host$ | dedup classInfo.dn,apic_host | stats count(classInfo.dn)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="numberPrecision">0</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="unitPosition">after</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
        <drilldown target="Remote User Details">
          <condition match="$apic_host$==&quot;all&quot;">
            <link>
              <![CDATA[
                 remote_user_details?display_apic_host=All&formed_apic_host=$formed_apic_host$&time_token.earliest=$time_token.earliest$&time_token.latest=$time_token.latest$
      			  ]]> 
            </link>
          </condition>
          <condition>
            <link>
              <![CDATA[
                remote_user_details?display_apic_host=$apic_host$&formed_apic_host=$formed_apic_host$&time_token.earliest=$time_token.earliest$&time_token.latest=$time_token.latest$
  			    ]]>
            </link>
            </condition>
        </drilldown>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <chart id="master1">
        <title>Authentication By Admin</title>
        <search base="baseSearch">
          <query>| dedup dn,apic_host | search user=admin AND trig="login,session" AND $formed_apic_host$ | rename trig AS Trigger | stats count by description</query>
        </search>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <drilldown>
          <set token="authadmin">$click.value$</set>
          <unset token="authFailUser"></unset>
          <unset token="authSuccessfulUser"></unset>
        </drilldown>
      </chart>
    </panel>
    <panel>
      <chart id="master2">
        <title>Authentication Failed by User</title>
        <search base="baseSearch">
          <query>| search trig="login,session" AND $formed_apic_host$ | where description LIKE "%Failure" | search user=$multiTokenQuery$  |fields - dn,trig | timechart count by user | fields - NULL</query>
        </search>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <drilldown>
          <set token="authFailUser">$click.name2$</set>
          <unset token="authadmin"></unset>
          <unset token="authSuccessfulUser"></unset>
        </drilldown>
      </chart>
    </panel>
    <panel>
      <chart id="master3">
        <title>Authentication Success by User</title>
        <search base="baseSearch">
          <query>| search trig="login,session" AND $formed_apic_host$ |where description LIKE "%Success"  |  search user=$multiTokenQuery$ | timechart count by user | fields - NULL</query>
        </search>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <drilldown>
          <set token="authSuccessfulUser">$click.name2$</set>
          <unset token="authadmin"></unset>
          <unset token="authFailUser"></unset>
        </drilldown>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <table id="details1" depends="$authadmin$">
        <title>Authentication by Admin: "$authadmin$"</title>
        <search>
          <query>| tstats values(session.user) AS "user"  values(session.descr) AS "description" values(session.id) AS "Session-ID" values(session.trig) AS "trig" FROM datamodel=Auth groupby _time,session.dn,session.apic_host | rename session.dn AS dn, session.apic_host AS apic_host | reverse | dedup dn,apic_host | search user=admin AND trig="login,session" AND $formed_apic_host$  description="$authadmin$" | rename trig AS Trigger| fields - user, dn</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table id="details2" depends="$authFailUser$">
        <title>Failure by User: "$authFailUser$"</title>
        <search>
          <query>| tstats values(session.trig) AS "trig" values(session.descr) AS "description" latest(session.id) AS Session-ID  values(session.user) AS "user" FROM datamodel=Auth groupby session.dn,_time,session.apic_host | reverse | dedup "Session-ID"  | rename session.apic_host as apic_host | search $formed_apic_host$ trig="login,session" | rename session.dn AS dn, trig AS "Trigger" | where description LIKE "%Failure" | search user= "$authFailUser$"  | table _time,dn,user,description,Session-ID,Trigger</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table id="details3" depends="$authSuccessfulUser$">
        <title>Successful Login by User:"$authSuccessfulUser$"</title>
        <search>
          <query>| tstats values(session.trig) AS "trig" values(session.descr) AS "description" latest(session.id) AS Session-ID  values(session.user) AS "user" FROM datamodel=Auth groupby session.dn,_time,session.apic_host | reverse | dedup "Session-ID" | rename session.apic_host as apic_host | search $formed_apic_host$ trig="login,session" | rename session.dn AS dn, trig AS "Trigger" | where description LIKE "%Success" | search user="$authSuccessfulUser$"  | table _time,dn,user,description,Session-ID,Trigger</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>User Audit Logs</title>
        <search>
          <query>|tstats latest(classInfo.created) AS "TimeStamp" values(classInfo.ind) AS Action values(classInfo.descr) AS Description  latest(classInfo.id) AS "ID"  latest(classInfo.severity) AS Severity from datamodel=Counters where classInfo.component=aaaModLR groupby classInfo.dn,classInfo.user,classInfo.affected,classInfo.apic_host | rename classInfo.user AS user, classInfo.affected AS "Affected Objects", classInfo.apic_host AS apic_host | search $formed_apic_host$ | search user=$multiTokenQuery$ | fields - classInfo.dn | SORT TimeStamp | reverse | rename user AS user | fields - apic_host</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
</form>
