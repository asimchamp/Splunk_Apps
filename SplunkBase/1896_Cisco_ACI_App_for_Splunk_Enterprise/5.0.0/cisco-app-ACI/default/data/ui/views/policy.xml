<form>
  <label>Policy</label>
  <fieldset submitButton="false">
    <input type="time" token="time_token">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="mso_token" searchWhenChanged="true">
      <label>Multi-Site Orchestrator</label>
      <selectFirstChoice>true</selectFirstChoice>
      <fieldForLabel>mso_host</fieldForLabel>
      <fieldForValue>mso_host</fieldForValue>
      <search>
        <query>eventtype="cisco_mso" mso_api_endpoint=policyDetails | fields mso_host | dedup mso_host | table mso_host</query>
        <earliest>$time_token.earliest$</earliest>
        <latest>$time_token.latest$</latest>
      </search>
      <change>
        <unset token="show_panel"></unset>
      </change>
    </input>
  </fieldset>
  <row rejects="$mso_token$">
      <panel>
      <html>
       <p><i>Data is not available in selected time range or MSO data collection is not configured. Try expanding the time range or configure the MSO: <a href="/app/TA_cisco-ACI/aci_setup" target="_blank">Setup Page</a></i></p>
     </html>
    </panel>
  </row>
  <row depends="$mso_token$">
    <panel>
      <table>
        <title>Policy</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=policyDetails mso_host=$mso_token$
| dedup id| table name, tenantId, desc, policyType | join max=0 tenantId type=outer [| search eventtype="cisco_mso"  mso_api_endpoint=tenantDetails mso_host=$mso_token$
| rename id as tenantId | dedup name | rename name as "Tenant Name"]
| rename name as Name,desc as Description, policyType as "Policy Type" | table Name, "Tenant Name", Description, "Policy Type"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
    <panel>
      <chart>
        <title>Policy SubType Breakdown</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=policyDetails mso_host=$mso_token$| stats dc(id) as Count by policySubtype | rename policySubtype as "Policy SubType"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <condition match="$row.Policy SubType$==&quot;option&quot;">
            <set token="query">eventtype="cisco_mso" mso_api_endpoint=policyDetails policySubtype=option mso_host=$mso_token$
| dedup id| table name, dhcpOption_name, dhcpOption_id, dhcpOption_data, tenantId | join max=0 tenantId type=outer [| search eventtype="cisco_mso"  mso_api_endpoint=tenantDetails mso_host=$mso_token$
| rename id as tenantId | dedup name | rename name as "Tenant Name"] |rename name as Name,dhcpOption_name as "Name of DHCP Option", dhcpOption_id as "ID of DHCP Option", dhcpOption_data as "Data of DHCP Option" | table Name, "Name of DHCP Option", "ID of DHCP Option", "Data of DHCP Option", "Tenant Name" | fillnull value="-"</set>
            <set token="show_panel">true</set>
            <set token="subtype">$row.Policy SubType$</set>
          </condition>
          <condition match="$row.Policy SubType$==&quot;relay&quot;">
            <set token="query">eventtype="cisco_mso" mso_api_endpoint=policyDetails policySubtype=relay mso_host=$mso_token$ |dedup id
|  table name, provider_addr, provider_epgRef, provider_externalEpgRef,provider_l3Ref, provider_tenantId, tenantId  | join max=0 tenantId type=outer [| search eventtype="cisco_mso"  mso_api_endpoint=tenantDetails mso_host=$mso_token$
| rename id as tenantId | dedup name | rename name as "Tenant Name"] |rename name as Name , provider_addr as "Address of Provider",provider_epgRef as "EPG Ref of Provider",provider_externalEpgRef as "External EPG Ref of Provider",provider_l3Ref as "L3 Ref of Provider",provider_tenantId as "Tenant ID of Provider" | table Name, "Address of Provider", "EPG Ref of Provider", "External EPG Ref of Provider", "L3 Ref of Provider", "Tenant ID of Provider", "Tenant Name" | fillnull value="-"</set>
            <set token="show_panel">true</set>
            <set token="subtype">$row.Policy SubType$</set>
          </condition>
        </drilldown>
      </chart>
    </panel>
  </row>
  <row depends="$show_panel$">
    <panel depends="$dont_show_css$">
      <html>
          <style>
                #table_subtype .table th, .table td {
                     text-align: left;
                 }
          </style>
      </html>
    </panel>
    <panel>
      <table id="table_subtype">
        <title>Policy SubType: $subtype$</title>
        <search>
          <query>$query$</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$mso_token$">
    <panel>
      <table>
        <title>Audit Logs</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=msoAuditRecords type=policy mso_host=$mso_token$ | table timestamp, user_username,user_domainName, type, event
| rename timestamp as Timestamp,user_username as User, user_domainName as "Domain Name",type as "Type", event as "Event"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
</form>