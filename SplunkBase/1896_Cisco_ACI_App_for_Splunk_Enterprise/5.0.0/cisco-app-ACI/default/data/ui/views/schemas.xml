<form>
  <label>Schemas</label>
  <fieldset submitButton="false">
    <input type="time" token="time_token" searchWhenChanged="true">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="mso_hostname_token" searchWhenChanged="true">
      <label>Multi-Site Orchestrator</label>
      <selectFirstChoice>true</selectFirstChoice>
      <fieldForLabel>mso_host</fieldForLabel>
      <fieldForValue>mso_host</fieldForValue>
      <search>
        <query>eventtype="cisco_mso" mso_api_endpoint=schemaDetails | dedup mso_host | table mso_host</query>
        <earliest>$time_token.earliest$</earliest>
        <latest>$time_token.latest$</latest>
      </search>
      <change>
        <unset token="schema_id_token"></unset>
        <unset token="form.schema_id_token"></unset>
      </change>
    </input>
    <input type="dropdown" token="schema_id_token" searchWhenChanged="true">
      <label>Schema</label>
      <choice value="*">All</choice>
      <default>*</default>
      <initialValue>*</initialValue>
      <fieldForLabel>displayName</fieldForLabel>
      <fieldForValue>id</fieldForValue>
      <search>
        <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaDetails | dedup id | table id, displayName</query>
        <earliest>$time_token.earliest$</earliest>
        <latest>$time_token.latest$</latest>
      </search>
    </input>
  </fieldset>
  <row rejects="$mso_hostname_token$">
      <panel>
      <html>
       <p><i>Data is not available in selected time range or MSO data collection is not configured. Try expanding the time range or configure the MSO: <a href="/app/TA_cisco-ACI/aci_setup" target="_blank">Setup Page</a></i></p>
     </html>
    </panel>
  </row>
  <row depends="$mso_hostname_token$">
    <panel>
      <single>
        <title>No. of Schemas Associated With MSO: $mso_hostname_token$</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaDetails | stats dc(id)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <set token="schema_name">$click.value$</set>
          <set token="show_panel_schema">true</set>
        </drilldown>
      </single>
    </panel>
    <panel>
      <chart>
        <title>Top 10 Schemas By No. Of Sites</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaDetails |stats dc(sites_siteId) as count by displayName | sort 0 count DESC |head 10 | rename displayName as "Schema Name", count as Count</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row depends="$show_panel_schema$">
    <panel>
      <table>
        <title>Schema Details</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaDetails id=$schema_id_token$ | table displayName, templates_name, templates_tenantId | eval templates_tenants=mvzip(templates_name,templates_tenantId) | mvexpand templates_tenants  | eval temp_split=split(templates_tenants,",") | eval template_name=mvindex(temp_split,0), tenant_id=mvindex(temp_split,1) | table displayName, template_name, tenant_id | join max=0 tenant_id [| search eventtype="cisco_mso"  mso_api_endpoint=tenantDetails mso_host=$mso_hostname_token$
| dedup name | rename id as tenant_id | table tenant_id, name]  | table displayName, template_name, name  | stats values(template_name) as template_name, values(name) as name by displayName | rename displayName as "Schema Name", template_name as "Template Name", name as "Tenant Name"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$mso_hostname_token$">
    <panel>
      <single>
        <title>External Endpoint Group</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaDetails id=$schema_id_token$ | stats dc(templates_externalEpgs_name)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <set token="show_panel_external">true</set>
          <unset token="show_panel_vrf"></unset>
          <unset token="show_panel_bds"></unset>
          <unset token="show_panel_contracts"></unset>
          <unset token="show_panel_anps"></unset>
        </drilldown>
      </single>
    </panel>
    <panel>
      <single>
        <title>VRF</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaDetails id=$schema_id_token$ |stats dc(templates_vrfs_name)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>30s</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <unset token="show_panel_external"></unset>
          <set token="show_panel_vrf">true</set>
          <unset token="show_panel_bds"></unset>
          <unset token="show_panel_contracts"></unset>
          <unset token="show_panel_anps"></unset>
        </drilldown>
      </single>
    </panel>
    <panel>
      <single>
        <title>Bridge Domain</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaDetails id=$schema_id_token$ |stats dc(templates_bds_name)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <drilldown>
          <unset token="show_panel_external"></unset>
          <unset token="show_panel_vrf"></unset>
          <set token="show_panel_bds">true</set>
          <unset token="show_panel_contracts"></unset>
          <unset token="show_panel_anps"></unset>
        </drilldown>
      </single>
    </panel>
  </row>
  <row depends="$mso_hostname_token$">
    <panel>
      <single>
        <title>Contracts</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaDetails id=$schema_id_token$ |stats dc(templates_contracts_name)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <unset token="show_panel_external"></unset>
          <unset token="show_panel_vrf">true</unset>
          <unset token="show_panel_bds"></unset>
          <set token="show_panel_contracts">true</set>
          <unset token="show_panel_anps"></unset>
        </drilldown>
      </single>
    </panel>
    <panel>
      <single>
        <title>Filters</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaDetails id=$schema_id_token$ |stats dc(templates_filters_name)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>30s</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">/app/cisco-app-ACI/search?earliest=$form.time_token.earliest$&amp;latest=$form.time_token.latest$&amp;q=eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaDetails id=$schema_id_token$ | dedup templates_filters_name</link>
        </drilldown>
      </single>
    </panel>
    <panel>
      <single>
        <title>Application Profiles</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaDetails id=$schema_id_token$ |stats dc(templates_anps_name)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <unset token="show_panel_external"></unset>
          <unset token="show_panel_vrf">true</unset>
          <unset token="show_panel_bds"></unset>
          <unset token="show_panel_contracts"></unset>
          <set token="show_panel_anps">true</set>
        </drilldown>
      </single>
    </panel>
  </row>
  <row depends="$show_panel_external$">
    <panel>
      <table>
        <title>External Endpoint Group Fault Details</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaHealthFaults mso_schema_id=$schema_id_token$ | dedup externalEpgs_faults_code | eval faults=mvzip(mvzip(externalEpgs_faults_code, externalEpgs_faults_type),externalEpgs_faults_message) | mvexpand faults | rex field=faults "(?&lt;Fault_Code&gt;\w+),(?&lt;Fault_Type&gt;\w+),(?&lt;Fault_Message&gt;[^\{]+)" | dedup Fault_Code | table Fault_Code, Fault_Type, Fault_Message | rename Fault_Code as "Fault Code", Fault_Type as "Fault Type",Fault_Message as "Fault Message"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
      <table>
        <title>External Endpoint Group Health Details</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaHealthFaults mso_schema_id=$schema_id_token$  | dedup externalEpgs_externalEpgRef | eval health=mvzip(externalEpgs_externalEpgRef, externalEpgs_health_score) | mvexpand health | rex field=health "(?&lt;External_EPG_Reference&gt;[^\{]+),(?&lt;Health_Score&gt;\w+)" | dedup External_EPG_Reference | table External_EPG_Reference, Health_Score | rename External_EPG_Reference as "External EPG Reference", Health_Score as "Health Score"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$show_panel_vrf$">
    <panel>
      <table>
        <title>VRF Fault Details</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaHealthFaults mso_schema_id=$schema_id_token$ | dedup vrfs_faults_code | eval faults=mvzip(mvzip(vrfs_faults_code, vrfs_faults_type),vrfs_faults_message) | mvexpand faults | rex field=faults "(?&lt;Fault_Code&gt;\w+),(?&lt;Fault_Type&gt;\w+),(?&lt;Fault_Message&gt;[^\{]+)" | dedup Fault_Code | table Fault_Code, Fault_Type, Fault_Message | rename Fault_Code as "Fault Code", Fault_Type as "Fault Type",Fault_Message as "Fault Message"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
      <table>
        <title>VRF Health Details</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaHealthFaults mso_schema_id=$schema_id_token$ | dedup vrfs_vrfRef | eval health=mvzip(vrfs_vrfRef, vrfs_health_score) | mvexpand health | rex field=health "(?&lt;VRF_Reference&gt;[^\{]+),(?&lt;Health_Score&gt;\w+)" | dedup VRF_Reference | table VRF_Reference, Health_Score| rename VRF_Reference as "VRF Reference", Health_Score as "Health Score"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$show_panel_bds$">
    <panel>
      <table>
        <title>Bridge Domain Fault Details</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaHealthFaults mso_schema_id=$schema_id_token$ | dedup bds_faults_code | eval faults=mvzip(mvzip(bds_faults_code, bds_faults_type),bds_faults_message) | mvexpand faults | rex field=faults "(?&lt;Fault_Code&gt;\w+),(?&lt;Fault_Type&gt;\w+),(?&lt;Fault_Message&gt;[^\{]+)" | dedup Fault_Code | table Fault_Code, Fault_Type, Fault_Message | rename Fault_Code as "Fault Code", Fault_Type as "Fault Type",Fault_Message as "Fault Message"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
      <table>
        <title>Bridge Domain Health Details</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaHealthFaults mso_schema_id=$schema_id_token$ | dedup bds_bdRef | eval health=mvzip(bds_bdRef, bds_health_score) | mvexpand health | rex field=health "(?&lt;Bridge_Domain_Reference&gt;[^\{]+),(?&lt;Health_Score&gt;\w+)" | dedup Bridge_Domain_Reference | table Bridge_Domain_Reference, Health_Score | rename Bridge_Domain_Reference as "Bridge Domain Reference", Health_Score as "Health Score"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$show_panel_anps$">
    <panel>
      <table>
        <title>Application Profile Fault Details</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaHealthFaults mso_schema_id=$schema_id_token$ | dedup anps_faults_code | eval faults=mvzip(mvzip(anps_faults_code, anps_faults_type),anps_faults_message) | mvexpand faults | rex field=faults "(?&lt;Fault_Code&gt;\w+),(?&lt;Fault_Type&gt;\w+),(?&lt;Fault_Message&gt;[^\{]+)" | dedup Fault_Code | table Fault_Code, Fault_Type, Fault_Message | rename Fault_Code as "Fault Code", Fault_Type as "Fault Type",Fault_Message as "Fault Message"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
      <table>
        <title>Application Profile Health Details</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaHealthFaults mso_schema_id=$schema_id_token$ | dedup anps_anpRef | eval health=mvzip(anps_anpRef, anps_health_score) | mvexpand health | rex field=health "(?&lt;Application_Profile_Reference&gt;[^\{]+),(?&lt;Health_Score&gt;\w+)"  | dedup Application_Profile_Reference | table Application_Profile_Reference, Health_Score | rename Application_Profile_Reference as "Application Profile Reference", Health_Score as "Health Score"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$show_panel_contracts$">
    <panel>
      <table>
        <title>Contracts Fault Details</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=schemaHealthFaults mso_schema_id=$schema_id_token$ | dedup contracts_faults_code | eval faults=mvzip(mvzip(contracts_faults_code, contracts_faults_type),contracts_faults_message) | mvexpand faults | rex field=faults "(?&lt;Fault_Code&gt;\w+),(?&lt;Fault_Type&gt;\w+),(?&lt;Fault_Message&gt;[^\{]+)" | dedup Fault_Code | table Fault_Code, Fault_Type, Fault_Message | rename Fault_Code as "Fault Code", Fault_Type as "Fault Type",Fault_Message as "Fault Message"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$mso_hostname_token$">
    <panel>
      <table>
        <title>Audit Logs</title>
        <search>
          <query>eventtype="cisco_mso" mso_host=$mso_hostname_token$ mso_api_endpoint=msoAuditRecords type=schema | eval "Username"=user_username, "Domain Name"=user_domainName , "Type"=type, "Event"=event, "Timestamp"=timestamp | table Timestamp, Username,"Domain Name", Type, Event</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
</form>