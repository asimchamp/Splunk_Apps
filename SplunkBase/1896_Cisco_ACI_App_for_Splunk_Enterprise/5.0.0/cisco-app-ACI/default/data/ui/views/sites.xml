<form script="mso_sites_dashboard.js">
  <label>Sites</label>
  <fieldset submitButton="false">
    <input type="time" token="time_token" searchWhenChanged="true">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="mso_host_token" searchWhenChanged="true">
      <label>Multi-Site Orchestrator</label>
      <selectFirstChoice>true</selectFirstChoice>
      <fieldForLabel>mso_host</fieldForLabel>
      <fieldForValue>mso_host</fieldForValue>
      <search>
        <query>eventtype="cisco_mso" mso_api_endpoint=siteHealth | fields mso_host | dedup mso_host | table mso_host</query>
        <earliest>$time_token.earliest$</earliest>
        <latest>$time_token.latest$</latest>
      </search>
      <change>
        <unset token="mso_site_token"></unset>
        <unset token="form.mso_site_token"></unset>
      </change>
    </input>
    <input type="dropdown" token="mso_site_token" searchWhenChanged="true">
      <label>Site</label>
      <choice value="*">All</choice>
      <default>*</default>
      <initialValue>*</initialValue>
      <fieldForLabel>name</fieldForLabel>
      <fieldForValue>mso_site_id</fieldForValue>
      <search>
        <query>eventtype="cisco_mso" mso_api_endpoint=siteHealth mso_host=$mso_host_token$ | fields mso_site_id, name | dedup mso_site_id | table mso_site_id, name</query>
        <earliest>$time_token.earliest$</earliest>
        <latest>$time_token.latest$</latest>
      </search>
    </input>
  </fieldset>
  <row rejects="$mso_host_token$">
      <panel>
      <html>
       <p><i>Data is not available in selected time range or MSO data collection is not configured. Try expanding the time range or configure the MSO: <a href="/app/TA_cisco-ACI/aci_setup" target="_blank">Setup Page</a></i></p>
     </html>
    </panel>
  </row>
  <row depends="$mso_host_token$">
    <panel depends="$never_show_this_panel$">
      <table>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=siteHealth mso_host=$mso_host_token$ mso_site_id=$mso_site_token$ | dedup mso_site_id | rex field=urls "https://(?&lt;url&gt;.*)$" | mvexpand url  | dedup apicSiteId | table name, platform, url</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <done>
            <condition match="$job.resultCount$ &gt; 0">
              <set token="mso_site_url">$result.url$</set>
              <set token="mso_site_type">$result.platform$</set>
            </condition>
          </done>
        </search>
      </table>
    </panel>
  </row>
  <row depends="$mso_host_token$">
    <panel>
      <title>Site Information</title>
      <table>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=siteHealth mso_host=$mso_host_token$ mso_site_id=$mso_site_token$ | dedup apicSiteId | eval x=mvzip(mvzip(clusterStatus_controllerName,clusterStatus_health, "|"),clusterStatus_adminState, "|") | mvexpand x | rex field=x "^(?&lt;controller_name&gt;[^|]*)\|(?&lt;controller_health&gt;[^|]*)\|(?&lt;controller_adminstate&gt;[^|]*)" | rex field=urls "https://(?&lt;url&gt;.*)$" | mvexpand url | dedup url | table name, platform, apicSiteId, url, controller_health, controller_adminstate | rename name as "Site Name", platform as Platform, apicSiteId as "APIC Site ID", url as "Controller Host", controller_health as "Controller Health", controller_adminstate as "Controller Admin State"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <condition match="$row.Platform$ == &quot;on-premise&quot;">
            <set token="prem">This is on-prem</set>
            <link target="_blank">/app/cisco-app-ACI/home_page?form.mso_host=$mso_host_token$&amp;form.apic_host=$row.Controller Host$&amp;form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
          </condition>
          <condition match="$row.Platform$ == &quot;cloud&quot;">
            <set token="cloud">This is cloud</set>
            <link target="_blank">/app/cisco-app-ACI/cloud_apic_overview?form.apic_host=$row.Controller Host$&amp;form.timeToken.earliest=$time_token.earliest$&amp;form.timeToken.latest=$time_token.latest$</link>
          </condition>
        </drilldown>
      </table>
    </panel>
    <panel>
      <chart id="health">
        <title>Site Health</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=siteHealth mso_host=$mso_host_token$ mso_site_id=$mso_site_token$| fillnull value="Not Available" health_score | rex field=urls "https://(?&lt;url&gt;.*)$" | mvexpand url | fields name, platform, url, _time, health_score  | chart latest(health_score) AS Health by _time,name</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.drilldown">all</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <set token="site_health"></set>
        </drilldown>
      </chart>
    </panel>
  </row>
  <row depends="$mso_host_token$">
    <panel>
      <single>
        <title>Critical Faults</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=siteHealth mso_host=$mso_host_token$ mso_site_id=$mso_site_token$ | dedup mso_site_id | fillnull value="None" faults_type, faults_count | eval x=mvzip(faults_type, faults_count) | mvexpand x | rex field=x "(?&lt;fault_type&gt;\w+)\,(?&lt;fault_type_count&gt;\d+)$" | search fault_type="critical" | stats sum(fault_type_count)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0xdc4e41"]</option>
        <option name="rangeValues">[10000000000000000]</option>
        <option name="refresh.display">progressbar</option>
        <option name="useColors">1</option>
        <drilldown>
          <condition match="$mso_site_token$=&quot;*&quot;">
            <link target="_blank">/app/cisco-app-ACI/help_desk?form.mso_host=$mso_host_token$&amp;form.apic_host=all&amp;form.multiTokenQuery=critical&amp;form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
          </condition>
          <condition match="$mso_site_token$!=&quot;*&quot;">
            <link target="_blank">/app/cisco-app-ACI/help_desk?form.mso_host=$mso_host_token$&amp;form.apic_host=$mso_site_url$&amp;form.multiTokenQuery=critical&amp;form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
          </condition>
        </drilldown>
      </single>
    </panel>
    <panel>
      <single>
        <title>Major Faults</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=siteHealth mso_host=$mso_host_token$ mso_site_id=$mso_site_token$ | dedup mso_site_id | fillnull value="None" faults_type, faults_count | eval x=mvzip(faults_type, faults_count) | mvexpand x | rex field=x "(?&lt;fault_type&gt;\w+)\,(?&lt;fault_type_count&gt;\d+)$" | search fault_type="major" | stats sum(fault_type_count)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="refresh.display">progressbar</option>
        <option name="rangeColors">["0xf1813f"]</option>
        <option name="rangeValues">[10000000000000000]</option>
        <option name="useColors">1</option>
        <drilldown>
          <condition match="$mso_site_token$=&quot;*&quot;">
            <link target="_blank">/app/cisco-app-ACI/help_desk?form.mso_host=$mso_host_token$&amp;form.apic_host=all&amp;form.multiTokenQuery=major&amp;form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
          </condition>
          <condition match="$mso_site_token$!=&quot;*&quot;">
            <link target="_blank">/app/cisco-app-ACI/help_desk?form.mso_host=$mso_host_token$&amp;form.apic_host=$mso_site_url$&amp;form.multiTokenQuery=major&amp;form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
          </condition>
        </drilldown>
      </single>
    </panel>
    <panel>
      <single>
        <title>Warning Faults</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=siteHealth mso_host=$mso_host_token$ mso_site_id=$mso_site_token$ | dedup mso_site_id | fillnull value="None" faults_type, faults_count | eval x=mvzip(faults_type, faults_count) | mvexpand x | rex field=x "(?&lt;fault_type&gt;\w+)\,(?&lt;fault_type_count&gt;\d+)$" | search fault_type="warning" | stats sum(fault_type_count)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="refresh.display">progressbar</option>
        <option name="rangeColors">["0xf8be34"]</option>
        <option name="rangeValues">[10000000000000000]</option>
        <option name="useColors">1</option>
        <drilldown>
          <condition match="$mso_site_token$=&quot;*&quot;">
            <link target="_blank">/app/cisco-app-ACI/help_desk?form.mso_host=$mso_host_token$&amp;form.apic_host=all&amp;form.multiTokenQuery=warning&amp;form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
          </condition>
          <condition match="$mso_site_token$!=&quot;*&quot;">
            <link target="_blank">/app/cisco-app-ACI/help_desk?form.mso_host=$mso_host_token$&amp;form.apic_host=$mso_site_url$&amp;form.multiTokenQuery=warning&amp;form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
          </condition>
        </drilldown>
      </single>
    </panel>
    <panel>
      <single>
        <title>Minor Faults</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=siteHealth mso_host=$mso_host_token$ mso_site_id=$mso_site_token$ | dedup mso_site_id | fillnull value="None" faults_type, faults_count | eval x=mvzip(faults_type, faults_count) | mvexpand x | rex field=x "(?&lt;fault_type&gt;\w+)\,(?&lt;fault_type_count&gt;\d+)$" | search fault_type="minor" | stats sum(fault_type_count)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x0877a6"]</option>
        <option name="rangeValues">[10000000000000000]</option>
        <option name="refresh.display">progressbar</option>
        <option name="useColors">1</option>
        <drilldown>
          <condition match="$mso_site_token$=&quot;*&quot;">
            <link target="_blank">/app/cisco-app-ACI/help_desk?form.mso_host=$mso_host_token$&amp;form.apic_host=all&amp;form.multiTokenQuery=minor&amp;form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
          </condition>
          <condition match="$mso_site_token$!=&quot;*&quot;">
            <link target="_blank">/app/cisco-app-ACI/help_desk?form.mso_host=$mso_host_token$&amp;form.apic_host=$mso_site_url$&amp;form.multiTokenQuery=minor&amp;form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
          </condition>
        </drilldown>
      </single>
    </panel>
  </row>
  <row depends="$mso_host_token$">
    <panel>
      <table>
        <title>Audit Logs</title>
        <search>
          <query>eventtype="cisco_mso" mso_api_endpoint=msoAuditRecords mso_host=$mso_host_token$ key=$mso_site_token$ | table timestamp, user_username,user_domainName, type, event | rename timestamp as "Time Stamp", user_username as Username, user_domainName as "Domain Name", type as Type, event as Event</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
</form>