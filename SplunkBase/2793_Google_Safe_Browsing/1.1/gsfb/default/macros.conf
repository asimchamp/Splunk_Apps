[GoogleSafeBrowsing(1)]
args = url
definition = stats count by $url$ | lookup canonicalize_lookup url as $url$ | stats count by url_canonicalized | lookup suffix_expression_lookup url as url_canonicalized | spath input=url_prefixes | rename {}.gsfb_prefix AS g_prefix | rename {}.gsfb_hash AS g_hash | rename {}.gsfb_expression AS g_expr | lookup kv_prefixes_lookup prefix as g_prefix | search chunk_key=* | fields url_canonicalized chunk_key | lookup kv_chunks_lookup _key as chunk_key | eval tmp = mvfilter(match(chunk_type, "^add$")) | eval c = mvcount(tmp) | eval n_add = if(isnull(c), 0, c) | eval tmp = mvfilter(match(chunk_type, "^sub$")) | eval c = mvcount(tmp) | eval n_sub = if(isnull(c), 0, c) | eval chunk_type_sum = n_add - n_sub | search chunk_type_sum>0 | table url_canonicalized chunk_type list_name chunk_number chunk_key

[GoogleSafeBrowsingFullHashCheck(1)]
args = url
definition = stats count by $url$ | lookup canonicalize_lookup url as $url$ | stats count by url_canonicalized | lookup suffix_expression_lookup url as url_canonicalized | spath input=url_prefixes | rename {}.gsfb_prefix AS g_prefix | rename {}.gsfb_hash AS g_hash | rename {}.gsfb_expression AS g_expr | lookup kv_prefixes_lookup prefix as g_prefix | search chunk_key=* | fields url_canonicalized chunk_key g_hash prefix_length | lookup kv_chunks_lookup _key as chunk_key | eval tmp = mvfilter(match(chunk_type, "^add$")) | eval c = mvcount(tmp) | eval n_add = if(isnull(c), 0, c) | eval tmp = mvfilter(match(chunk_type, "^sub$")) | eval c = mvcount(tmp) | eval n_sub = if(isnull(c), 0, c) | eval chunk_type_sum = n_add - n_sub | search chunk_type_sum>0 | mvexpand g_hash | lookup full_length_hashes_lookup hash as g_hash prefix_length as prefix_length | search confirmed_lists=*  | table url_canonicalized g_hash chunk_number chunk_type list_name confirmed_lists

[canonicalize(1)]
args = url
definition = lookup canonicalize_lookup url as $url$ 

[suffix_expression(1)]
args = url
definition = lookup suffix_expression_lookup url as  $url$

[kv_prefixes(1)]
args = prefix
definition = lookup kv_prefixes_lookup prefix as $prefix$ 

[kv_chunks(1)]
args = ckey
definition =  lookup kv_chunks_lookup _key as $ckey$

[full_length_hashes(2)]
args = hash, plen
definition = lookup full_length_hashes_lookup hash as $hash$ prefix_length as $plen$

[safe_browsing_lookup_api]
args = url
definition = lookup safe_browsing_lookup_api_lookup url as $url$

