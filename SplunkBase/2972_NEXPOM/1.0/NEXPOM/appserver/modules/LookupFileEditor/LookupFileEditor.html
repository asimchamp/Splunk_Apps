
<%page args="module"/>
<%# Copyright (C) 2009-2012 Splunk Inc. All Rights Reserved.

import os
import splunk
import sys
import re

sys.path.append( os.path.join("..", "..", "..", "bin") )

from LookupFileEditor import getCapabilities4User, getLookupFile

# Get cherry key
session_key = cherrypy.session.get('sessionKey')

# Get cherry username
user = cherrypy.session['user']['name']

args = cherrypy.serving.request.params

messages = []

# Below are the variables we will try to populate
namespace        = args.get("namespace", None)
lookup_file      = args.get("lookup_file", None)
lookup_name      = args.get("lookup_name", None)
owner            = args.get("owner", None)
path_description = args.get("path", None)

if path_description is not None:
	split_path = path_description.split('/')
	
	if len(split_path) == 2:
		namespace, lookup_file = split_path

# If we got a lookup name but not a file, then get the lookup file from the transform name
if lookup_name and not lookup_file:
	lookup_file = getLookupFile(lookup_name, namespace, session_key, owner=owner)	

# Get capabilities
capabilities = getCapabilities4User(user, session_key)

# Test capabilities
insufficient_permissions = False

if lookup_file is None:
    is_new = True
else:
    is_new = False

# Get the module params
title_new  = module['params'].get('titleNew' , "New Lookup Table File")
title_edit = module['params'].get('titleEdit', "Edit Lookup Table File")
list_view  = module['params'].get('listView' , "lookup_list")

if title_new is None or title_new == '':
	title_new = "Data input"

if title_edit is None or title_edit == '':
	title_edit = "Edit Lookup File"

try:

	# Get the URL to redirect to
	redirect = None
	
	# Get the form action URL
	form_action = make_url(["module", "system", "Splunk.Module.LookupFileEditor", "render"]);
	
	# Get the app name
	app = APP['id']

except splunk.AuthorizationFailed:
	insufficient_permissions = True
	
%>

<%namespace name="lib" file="//lib.html" import="*"/>
<%namespace name="helpers" file="//view/_helpers.html" import="*"/>

% if insufficient_permissions:
  <div class="no_permissions_dialog" id="no_permissions">
  	<div class="padlock"></div>
    <div class="dialog_message">You do not have the necessary capability required to edit lookup files. Please contact your Splunk administrator.</div>
  </div>
% else:
% if splunk.getReleaseVersion().startswith("5."):
<script src="${make_url(['/static/app/NEXPOM/js/lib/jquery.min.js'])}"></script>
<script src="${make_url(['/static/app/NEXPOM/js/lib/jquery.handsontable.full.js'])}"></script>
<script src="${make_url(['/static/app/NEXPOM/js/lib/csv.js'])}"></script>
% endif
<script src="${make_url(['/static/app/NEXPOM/js/resource_loader.js'])}"></script>
<script>

% if splunk.getReleaseVersion().startswith("5."):
//On Splunk 5.0.x, we need to load a newer version of jQuery for the HandsOnTable plugin.
new_jquery = $;
old_jquery = $.noConflict(true);
% else:
// We need to delay the loading of the handsontable a little bit so that the Splunk's built-in Javascript has a chance to load (http://lukemurphey.net/issues/705)
setTimeout(
		function(){
			addJavascript('${make_url(['/static/app/NEXPOM/js/lib/jquery.handsontable.full.js'])}');
			addJavascript('${make_url(['/static/app/NEXPOM/js/lib/csv.js'])}');
		},
		100
);
% endif

% if lookup_file:
lookup_file = "${lookup_file}";
% else:
lookup_file = null;
% endif
	
% if namespace:
namespace = "${namespace}";
% else:
namespace = null;
% endif

% if owner and owner != "nobody":
user = "${owner}";
% else:
user = null;
% endif

% if list_view:
list_view = "${list_view}";
% else:
list_view = null;
% endif

</script>

<div id="importFileControls">
	Import from data file: <input type="file" id="importLookup"></input>
</div>

% if is_new:
<h1>${title_new}</h1>
% else:
<h1>${title_edit}</h1>
% endif


%if lookup_name:
<h2>${lookup_name}</h2>
%elif lookup_file:
<h2>${lookup_file}</h2>
%endif


% if is_new:
<div id="item-lookup-file" class="widget fieldsetWrapper multiColumnFieldset">
	<div>
        <label for="lookup_file" class="">The file name you want to save</label>
        <div>
            <div id="lookup_file_error" class="widgeterror"></div>
            <input type="text" name="lookup_file" id="lookup_file_input" >            
        </div>
        <p class="exampleText"><em>"This filename is saved as sourcetype"</em></p>
	</div>
	<div style ="display:none">
        <label for="namespace" class="">App</label>
        <div>
            <div id="lookup_namespace_error" class="widgeterror"></div>
            
			<select name="namespace" id="lookup_file_namespace">
			</select>
            
        </div>
        <p class="exampleText"><em>Specifies the app where the lookup file will reside</em></p>
	</div>
</div>
% endif

<div id="item-data-table" class="widget">
        <div>
            <div class="widgeterror"></div>            
        </div>
</div>
<div class="table-loading-message" id="loading">Loading lookup file...</div>

<style>
@import url("${make_url(['/static/css/admin.css'])}"); 
</style>

<table class="splTable splTable-list warning_dialog" id="warning_dialog">
	<tbody>
		<tr>
            <td class="empty_results" id="warning_dialog_text">The requested lookup file does not exist.</td>
        </tr>
    </tbody>
</table>

<div id="tableEditor">
	<div id="dataTable" style="width: 100%"></div>
	
	${csrf_hidden_input()}
	<div id="mainControls" class="actionButtons">
		<input type="hidden" id="returnto" name="returnto" value=""></input>
		<a id="save" class="splButton-primary">
			<span>Save</span>
		</a>
	</div>
</div>
% endif