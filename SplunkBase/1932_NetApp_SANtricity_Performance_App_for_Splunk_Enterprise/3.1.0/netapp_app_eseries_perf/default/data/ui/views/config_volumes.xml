<form version="1.1" stylesheet="row_coloring.css,application.css" script="preferred_controller_row_coloring.js,drive_optimal_row_coloring.js">
  <label>Configuration - Volume</label>
  <search id="baseSearch">
    <query>
      `get_nesa_index` sourcetype=eseries:graph host="$arrayId$" | head 1 | `expand_json_array(volume)` | search name="$volume$" [| inputlookup nesa_volume_groups | search arrayId="$arrayId$" volumeGroup="$volumeGroup$" | fields volumeGroupRef ]
    </query>
    <earliest>-2h@h</earliest>
    <latest>now</latest>
  </search>
  <fieldset submitButton="false" autoRun="false">
    <input type="dropdown" token="arrayId" searchWhenChanged="true">
      <label>Array</label>
      <search>
        <query>
          | inputlookup nesa_volume_groups | stats count by arrayId, arrayName
        </query>
      </search>
      <fieldForLabel>arrayName</fieldForLabel>
      <fieldForValue>arrayId</fieldForValue>
    </input>
    <input type="dropdown" token="controllerLabel" searchWhenChanged="true">
      <label>Controller</label>
      <choice value="*">ALL</choice>
      <default>*</default>
      <search>
        <query>
          | inputlookup nesa_controllers | search arrayId="$arrayId$" | dedup controllerLabel
        </query>
      </search>
      <fieldForLabel>controllerLabel</fieldForLabel>
      <fieldForValue>controllerLabel</fieldForValue>
    </input>
    <input type="dropdown" token="volumeGroup" searchWhenChanged="true">
      <label>Volume Groups/Pools</label>
      <search>
        <query>
          | inputlookup nesa_volume_groups | search
[| inputlookup nesa_volumes | search
[| inputlookup nesa_controllers | search arrayId="$arrayId$" controllerLabel="$controllerLabel$" | fields arrayId, controllerRef] | fields arrayId, volumeGroupRef ]
| fields volumeGroup
        </query>
      </search>
      <fieldForLabel>volumeGroup</fieldForLabel>
      <fieldForValue>volumeGroup</fieldForValue>
    </input>
    <input type="dropdown" token="volume" searchWhenChanged="true">
      <label>Volume</label>
      <search>
        <query>
          | inputlookup nesa_volumes | search [| inputlookup nesa_controllers | search arrayId="$arrayId$" controllerLabel="$controllerLabel$" | fields arrayId, controllerRef] | search [| inputlookup nesa_volume_groups | search arrayId="$arrayId$" volumeGroup="$volumeGroup$" | fields volumeGroupRef ]
        </query>
      </search>
      <fieldForLabel>volumeName</fieldForLabel>
      <fieldForValue>volumeName</fieldForValue>
    </input>
  </fieldset>
  <row>
    <panel>
      <single>
        <search>
          <query>
          | stats count | eval class="None" | eval label="Configuration - Volume Groups/Pools"
        </query>
        </search>
        <option name="field">label</option>
        <option name="refresh.time.visible">false</option>
        <drilldown>
          <link>
            <![CDATA[/app/netapp_app_eseries_perf/config_vgroups?form.arrayId=$form.arrayId$&form.controllerLabel=$form.controllerLabel$&form.volumeGroup=$form.volumeGroup$]]>
          </link>
        </drilldown>
      </single>
      <single>
        <search>
          <query>
          | stats count | eval class="None" | eval label="Performance - Volume Group/Pool by Drive"
        </query>
        </search>
        <option name="field">label</option>
        <option name="refresh.time.visible">false</option>
        <drilldown>
          <link>
            <![CDATA[/app/netapp_app_eseries_perf/perf_drives?form.arrayId=$form.arrayId$&form.controllerLabel=$form.controllerLabel$&form.volumeGroup=$form.volumeGroup$]]>
          </link>
        </drilldown>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <single>
        <title>Status</title>
        <search base="baseSearch">
          <query>
        </query>
        </search>
        <option name="field">status</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Action</title>
        <search base="baseSearch">
          <query>
        </query>
        </search>
        <option name="field">action</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>RAID Level</title>
        <search base="baseSearch">
          <query>
          eval raidLevel=upper(raidLevel)
        </query>
        </search>
        <option name="field">raidLevel</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <single>
        <title>On Preferred Controller</title>
        <search base="baseSearch">
          <query>
          | eval Preferred=if(tostring(currentManager)==tostring(preferredManager), "TRUE", "FALSE") | eval class=if(Preferred="TRUE", "non-existent-CSS-class", "elevated")
        </query>
        </search>
        <option name="field">Preferred</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Block Size</title>
        <search base="baseSearch">
          <query>
        </query>
        </search>
        <option name="field">blkSize</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Total Capacity</title>
        <search base="baseSearch">
          <query>
          `_bytes_to_GiB(totalSizeInBytes)`
        </query>
        </search>
        <option name="field">totalSizeInBytes</option>
        <option name="underLabel">GiB</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <table id="volumes_table">
        <title>Volumes in this Group on Controller "$controllerLabel$"</title>
        <search>
          <query>
          `get_nesa_index` sourcetype=eseries:graph host="$arrayId$" | head 1 | `expand_json_array(volume)` | lookup nesa_controllers arrayId AS host, controllerRef AS currentManager OUTPUT controllerLabel | lookup nesa_volume_groups volumeGroupRef, arrayId AS host OUTPUT volumeGroup | search volumeGroup="$volumeGroup$" controllerLabel="$controllerLabel$" | `_bytes_to_GiB(capacity)` | eval Preferred=if(tostring(currentManager)==tostring(preferredManager), "TRUE", "FALSE") | lookup nesa_controllers arrayId AS host, controllerRef AS currentManager OUTPUT controllerLabel | rename controllerLabel AS currentManager | lookup nesa_controllers arrayId AS host, controllerRef AS preferredManager OUTPUT controllerLabel | rename controllerLabel AS preferredManager | `nesa_short_volume_table_field_list` | `nesa_short_volume_table_field_renames`
        </query>
          <earliest>-2h@h</earliest>
          <latest>now</latest>
        </search>
      </table>
    </panel>
  </row>
    <!--
    <chart>
      <title>Capacity</title>
      <option name="charting.chart">pie</option>
      <option name="charting.fieldColors">{"freeSpace": 0x00994d, "usedSpace": 0x990000}</option>
      <searchPostProcess>table usedSpace, freeSpace | transpose</searchPostProcess>
    </chart>
  </row>
-->
  <row>
    <panel>
      <table id="drives_table">
        <title>Drives in the Parent Volume Groups/Pools</title>
        <search>
          <query>
          <![CDATA[`get_nesa_index` sourcetype=eseries:graph host="$arrayId$" | head 1 | `expand_json_array(drive)` | lookup nesa_volume_groups volumeGroupRef AS currentVolumeGroupRef, arrayId AS host OUTPUT volumeGroup | search volumeGroup="$volumeGroup$" | lookup nesa_drives arrayId AS host, diskId AS id OUTPUT driveLabel | foreach usableCapacity, rawCapacity [ `_bytes_to_GiB(<<FIELD>>)` ] | eval driveMediaType=upper(driveMediaType) | eval averageEraseCountPercent=if(driveMediaType="SSD", 'ssdWearLife.averageEraseCountPercent', null()) | eval spareBlocksRemainingPercent=if(driveMediaType="SSD", 'ssdWearLife.spareBlocksRemainingPercent', null()) | foreach currentSpeed, maxSpeed [ eval <<FIELD>>=replace(<<FIELD>>, "speed", "") ] | `nesa_full_drive_table_field_list` | `nesa_full_drive_table_field_renames` | eval Interface=upper(Interface)]]>
        </query>
          <earliest>-2h@h</earliest>
          <latest>now</latest>
        </search>
      </table>
    </panel>
  </row>
</form>