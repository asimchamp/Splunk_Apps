[servervirt_index]
definition = index=servervirt
iseval = 0

[getDiskStats(3)]
args = shared, size, util
definition = eval diskUtil=if($shared$=="True", `formatBytes($size$)`." (".round((($util$/$size$)*100), 2)."% on disk)", `formatBytes($size$)`)
iseval = 0

[formatBytes(1)]
args = bytes
definition = if($bytes$>1099511627776, tostring(round($bytes$/1099511627776,2))+" TB", if($bytes$>1073741824, tostring(round($bytes$/1073741824,2))+" GB", if($bytes$>1048576, tostring(round($bytes$/1048576,2))+" MB", if($bytes$>1024, tostring(round($bytes$/1024))+" KB", tostring($bytes$)+" Bytes"))))
iseval = 0

[toGB(1)]
args = bytes
definition = round($bytes$/1073741824,2)
iseval = 0

[toMB(1)]
args = bytes
definition = round($bytes$/1048576,2)
iseval = 0

[formatBps(1)]
args = bps
definition = if($bytes$>1099511627776, tostring(round($bytes$/1099511627776,2))+" TB", if($bytes$>1073741824, tostring(round($bytes$/1073741824,2))+" GB", if($bytes$>1048576, tostring(round($bytes$/1048576,2))+" MB", if($bytes$>1024, tostring(round($bytes$/1024))+" KB", tostring($bytes$)+" Bytes")))) 
iseval = 0

[getPercentMemUsed(2)]
args = memTotal, memFree
definition = eval memPercentUsed=round((($memTotal$ - $memFree$ * 1024)/$memTotal$)*100, 0)."%"

[getVMDiskStats(1)]
args = vmname
definition = `hypervisor_index` `vm` name_label="$vmname$" | dedup vm_uuid | fields vm_uuid | join vm_uuid [search `hypervisor_index` sourcetype=Hypervisor:XenServer:VBD type="Disk" | dedup vm_uuid | fields vm_uuid, vdi_uuid ] | join vdi_uuid [ search `hypervisor_index` sourcetype=Hypervisor:XenServer:VDI | dedup vdi_uuid | fields virtual_size, vdi_uuid, physical_utilisation, sr_uuid ] | join sr_uuid [search `hypervisor_index` sourcetype=Hypervisor:XenServer:SR | dedup sr_uuid | fields sr_uuid, shared] | `getDiskStats(shared, virtual_size, physical_utilisation)` | table virtual_size, physical_utilisation, shared, diskUtil
iseval = 0

[getDiskPercentFree(2)]
args = size, used
definition = (($size$-$used$)/$size$)*100
iseval = 0

[updateObjectIDs]
definition = index=servervirt (sourcetype=hypervisor:xenserver:host OR sourcetype=hypervisor:xenserver:vm OR sourcetype=hypervisor:xenserver:pool OR sourcetype=hypervisor:xenserver:sr) | fields *_uuid name_label sourcetype | eval obj_uuid=case(sourcetype=="hypervisor:xenserver:host", host_uuid, sourcetype=="hypervisor:xenserver:vm", vm_uuid, sourcetype=="hypervisor:xenserver:sr", sr_uuid, sourcetype=="hypervisor:xenserver:pool", pool_uuid) | dedup obj_uuid | inputlookup xs_object_id_lookup.csv append=t | dedup obj_uuid | table obj_uuid, name_label, sourcetype | outputlookup xs_object_id_lookup.csv
iseval = 0

[updateHostSourcetypes]
definition = eventtype=servervirt:host | fields hyp_hostname sourcetype | dedup hyp_hostname | inputlookup host_sourcetypes.csv append=t | dedup hyp_hostname | table hyp_hostname, sourcetype | outputlookup host_sourcetypes.csv
iseval = 0

##################################################
#     Alerts
##################################################

[alerts-CPU_host_critical]
definition = 90
iseval = 0

[alerts-CPU_host_warn]
definition = 80
iseval = 0

[alerts-CPU_vm_critical]
definition = 90
iseval = 0

[alerts-CPU_vm_warn]
definition = 80
iseval = 0

[alerts-high_vCPU_to_pCPU]
definition = 4
iseval = 0

[alerts-RAM_host_warn]
# Available Bytes
definition = 2147000000
iseval = 0

[alerts-RAM_host_critical]
# Available Bytes
definition = 1074000000
iseval = 0

[alerts-RAM_vm_warn]
# Available Bytes
definition = 104900000
iseval = 0

[alerts-RAM_vm_critical]
# Available Bytes
definition = 52430000
iseval = 0