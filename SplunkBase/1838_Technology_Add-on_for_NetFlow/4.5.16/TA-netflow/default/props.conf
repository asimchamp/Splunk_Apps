#
# Copyright (C) 2015 NetFlow Logic
# All rights reserved.
#
# These coded instructions and statements contain unpublished trade
# secrets and proprietary information. They are protected by federal
# copyright law and by trade secret law, and may not be disclosed to
# third parties or used, copied, reverse engineered, decompiled, or
# duplicated in any form, in whole or in part, without the prior
# written consent of NetFlow Logic.
#

[flowintegrator]
SHOULD_LINEMERGE = false
TRANSFORMS-srcip6 = SRCIP6Extraction
TRANSFORMS-destip6 = DESTIP6Extraction
TRANSFORMS-expip6 = EXPIP6Extraction
EVAL-flow_smpl_id = if(isnull(flow_smpl_id), "no sampling", flow_smpl_id)
LOOKUP-nfcid =  nfc_lookup nfc_id OUTPUT module_id,nfc_module_name,nfc_module_set
#EXTRACT-nfo_hostname = ((\w{3}\s+\d{1,2}\s\d{2}:\d{2}:\d{2})|(1?\s?\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.{1}\d{2}:\d{2}))\s+(?P<nfo_hostname>[^ ]+)\s+(?P<nfv9_source_id>[^ ]+)?\s?(nfc_id|NFO)
EVAL-nfo_hostname = if(isnull(nfo_hostname),"not-enabled",nfo_hostname)
EVAL-src_inst_name = if(isnull(src_inst_name),src_vm_name,src_inst_name)
EVAL-dest_inst_name = if(isnull(dest_inst_name),dest_vm_name,dest_inst_name)
TRANSFORMS-nfo_hostname = nfo_hostname
TRANSFORMS-protocol_ts = protocol_ts
TRANSFORMS-nfc_id = nfc_id
TRANSFORMS-direction = direction
TRANSFORMS-threat_list_name = threat_list_name
TRANSFORMS-app_name = app_name
TRANSFORMS-username = username
TRANSFORMS-idp = idp
TRANSFORMS-action = action
TRANSFORMS-flow_type = flow_type
TRANSFORMS-reputation = reputation

#CIM fields:
EXTRACT-protocol_id = protocol\"?(=|:\s)\"?(?<protocol_id>\d*)
EVAL-src = if(isnull(vpc_name)    ,if( isnull(src_vm_name)        ,if(((lower(src_host)=="unknown") OR (lower(src_host)=="pending_resolution") OR (lower(src_host)=="name_not_found") OR (lower(src_host)=="dns_error") OR (lower(src_host)=="internal_error") OR (isnull(src_host)))            ,exp_ip + " - " + src_ip            ,exp_ip + " - " + src_ip + " (" + src_host + ")" )        ,if(((lower(src_host)=="unknown") OR (lower(src_host)=="pending_resolution") OR (lower(src_host)=="name_not_found") OR (lower(src_host)=="dns_error") OR (lower(src_host)=="internal_error") OR (isnull(src_host)))            ,exp_ip + " - " + src_ip            ,exp_ip + " - " + src_ip + " (" +src_host + "/" + src_vm_name + ")"))       ,if( isnull(src_vm_name)                 ,if(((lower(src_host)=="unknown") OR (lower(src_host)=="pending_resolution") OR (lower(src_host)=="name_not_found") OR (lower(src_host)=="dns_error") OR (lower(src_host)=="internal_error") OR (isnull(src_host)))            ,exp_ip + " (" + vpc_name + ")- " + src_ip             ,exp_ip + " (" + vpc_name + ") - " + src_ip +  " (" + src_host + ")"  )        ,if(((lower(src_host)=="unknown") OR (lower(src_host)=="pending_resolution") OR (lower(src_host)=="name_not_found") OR (lower(src_host)=="dns_error") OR (lower(src_host)=="internal_error") OR (isnull(src_host)))            ,exp_ip + " (" + vpc_name + ") - " + src_ip             ,exp_ip + " (" + vpc_name + ") - " + src_ip +  " (" + src_host + "/" + src_vm_name + ")"  )))
EVAL-dest = if(isnull(vpc_name)    ,if( isnull(dest_vm_name)        ,if(((lower(dest_host)=="unknown") OR (lower(dest_host)=="pending_resolution") OR (lower(dest_host)=="name_not_found") OR (lower(dest_host)=="dns_error") OR (lower(dest_host)=="internal_error") OR (isnull(dest_host)))            ,exp_ip + " - " + dest_ip            ,exp_ip + " - " + dest_ip + " (" + dest_host + ")" )        ,if(((lower(dest_host)=="unknown") OR (lower(dest_host)=="pending_resolution") OR (lower(dest_host)=="name_not_found") OR (lower(dest_host)=="dns_error") OR (lower(dest_host)=="internal_error") OR (isnull(dest_host)))            ,exp_ip + " - " + dest_ip            ,exp_ip + " - "+ dest_ip + " (" + dest_host + "/" + dest_vm_name + ")"))       ,if( isnull(dest_vm_name)                 ,if(((lower(dest_host)=="unknown") OR (lower(dest_host)=="pending_resolution") OR (lower(dest_host)=="name_not_found") OR (lower(dest_host)=="dns_error") OR (lower(dest_host)=="internal_error") OR (isnull(dest_host)))            ,exp_ip + " (" + vpc_name + ") - " + dest_ip             ,exp_ip + " (" + vpc_name + ") - " + dest_ip +  " (" + dest_host + ")"  )        ,if(((lower(dest_host)=="unknown") OR (lower(dest_host)=="pending_resolution") OR (lower(dest_host)=="name_not_found") OR (lower(dest_host)=="dns_error") OR (lower(dest_host)=="internal_error") OR (isnull(dest_host)))            ,exp_ip + " (" + vpc_name + ") - " + dest_ip             ,exp_ip + " (" + vpc_name + ") - " + dest_ip +  " (" + dest_host + "/" + dest_vm_name+ ")"  )))
EVAL-bytes = if(isnull(bytes),bytes_in,bytes)
EVAL-action = if(isnull(action),case(nfc_id=="20067", "allowed", (nfc_id=="20267" AND vpcflow_action=="REJECTED"), "blocked", (nfc_id=="20267" AND vpcflow_action!="REJECTED"), "allowed", (nfc_id=="20467" AND  decision=="D"), "blocked",(nfc_id=="20467" AND  decision!="D"),"allowed",nfc_id=="20367","allowed",nfc_id=="20020", "blocked", nfc_id=="20032", "blocked", nfc_id="20120", "blocked", nfc_id="20050", "allowed", nfc_id="20051", "allowed", nfc_id="20052", "allowed", nfc_id="20053", "allowed"),action)
EVAL-vendor_action = if(isnull(action),case(nfc_id=="20067", "allowed", nfc_id=="20020", "blocked", nfc_id=="20032", "blocked", nfc_id="20120", "blocked", nfc_id="20050", "suspicious", nfc_id="20051", "suspicious", nfc_id="20052", "suspicious", nfc_id="20053", "suspicious", 1=1, "unknown"),action)
EVAL-direction = case(direction=="ingress", "inbound", direction=="egress", "outbound", 1=1, direction)
FIELDALIAS-dvc_ip = exp_ip AS dvc_ip
FIELDALIAS-dvc = exp_ip AS dvc
FIELDALIAS-src_interface = input_snmp AS src_interface
FIELDALIAS-dest_interface = output_snmp AS dest_interface
EVAL-packets = if(isnull(packets),packets_in,packets)
FIELDALIAS-response_time = avg_time AS response_time
LOOKUP-protocol = ta_netflow_protocol_lookup protocol_id OUTPUT protocol transport protocol_reference protocol_hex

[netflow_metrics]
INDEXED_EXTRACTIONS = json
LINE_BREAKER = ([\r\n]+)
NO_BINARY_CHECK = true
category = Log to Metrics
TRANSFORMS-extract_all_fields = extract_all_fields
METRIC-SCHEMA-TRANSFORMS = metric-schema:netflow_metrics
disabled = false
pulldown_type = true
KV_MODE = none
