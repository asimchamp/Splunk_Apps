require.config({paths:{text:"../app/website_monitoring/js/lib/text",setup_view:"../app/website_monitoring/js/views/SetupView"}});define(["underscore","jquery","models/SplunkDBase","setup_view","text!../app/website_monitoring/js/templates/AppSetupView.html","css!../app/website_monitoring/css/AppSetupView.css"],function(a,f,h,e,d){var b="/en-US/splunkd/__raw/servicesNS/nobody/website_monitoring/app_config/website_monitoring/";var c=b+"default";var g=h.extend({url:b,initialize:function(){h.prototype.initialize.apply(this,arguments)}});return e.extend({className:"AppSetupView",events:{"click #save-config":"saveConfig"},defaults:{secure_storage_realm:"website_monitoring_app_proxy",secure_storage_username:"IN_CONF_FILE"},formProperties:{proxyServer:".proxy-address input",proxyUser:".proxy-user input",proxyIgnore:".proxy-ignore input",proxyServerPort:".proxy-port input",threadLimit:".thread-limit input",proxyPassword:".proxy-password input",proxyPasswordConfirmation:".proxy-password-confirm input",proxyType:".proxy-type select",responseLength:".response-length input"},initialize:function(){this.options=a.extend({},this.defaults,this.options);e.prototype.initialize.apply(this,[this.options]);this.setupValidators();this.website_monitoring_configuration=null;this.secure_storage_stanza=this.makeStorageEndpointStanza(this.options.secure_storage_username,this.options.secure_storage_realm);this.is_on_cloud=null;this.server_info=null},updateModel:function(){if(this.is_on_cloud){this.website_monitoring_configuration.entry.content.set({name:"default",proxy_server:"proxy_server",proxy_port:"",proxy_type:"http",proxy_ignore:"",proxy_user:"user",proxy_password:"",thread_limit:this.getThreadLimit(),max_response_body_length:this.getResponseLength()},{silent:true})}else{this.website_monitoring_configuration.entry.content.set({name:"default",proxy_server:this.getProxyServer(),proxy_port:this.getProxyServerPort(),proxy_type:this.getProxyType(),proxy_ignore:this.getProxyIgnore(),proxy_user:this.getProxyUser(),proxy_password:"",thread_limit:this.getThreadLimit(),max_response_body_length:this.getResponseLength()},{silent:true})}},savePassword:function(){var i=this.getProxyPassword();if(i.length===0){return this.deleteEncryptedCredential(this.secure_storage_stanza,true)}else{return this.saveEncryptedCredential(this.options.secure_storage_username,i,this.options.secure_storage_realm)}},saveConfig:function(){if(!this.userHasAdminAllObjects()){alert("You don't have permission to edit this app")}else{if(this.validate()){this.updateModel();this.showFormInProgress(true);f.when(this.website_monitoring_configuration.save({},{url:c}),this.savePassword()).then(function(){this.showInfoMessage("Configuration successfully saved");this.showFormInProgress(false);this.redirectIfNecessary("status_overview")}.bind(this)).fail(function(i){this.showFormInProgress(false);if(i.responseJSON&&i.responseJSON.messages&&i.responseJSON.messages.length>0&&i.responseJSON.messages[0].text){this.showWarningMessage("Configuration could not be saved: "+i.responseJSON.messages[0].text)}else{this.showWarningMessage("Configuration could not be saved")}}.bind(this));this.setConfigured()}}return false},setControlsEnabled:function(i){if(i===undefined){i=true}f("input,select",this.el).prop("disabled",!i)},showFormInProgress:function(i){f(".btn-primary").prop("disabled",i);this.setControlsEnabled(!i);if(i){f(".btn-primary").text("Saving Configuration...")}else{f(".btn-primary").text("Save Configuration")}},fetchAppConfiguration:function(){this.website_monitoring_configuration=new g();this.setControlsEnabled(false);var i=jQuery.Deferred();this.website_monitoring_configuration.fetch({url:c,id:"default",success:function(l,j,k){console.info("Successfully retrieved the default website_monitoring configuration");this.setProxyServer(l.entry.content.attributes.proxy_server);this.setProxyServerPort(l.entry.content.attributes.proxy_port);this.setProxyType(l.entry.content.attributes.proxy_type);this.setProxyIgnore(l.entry.content.attributes.proxy_ignore);this.setThreadLimit(l.entry.content.attributes.thread_limit);this.setResponseLength(l.entry.content.attributes.max_response_body_length);this.setProxyUser(l.entry.content.attributes.proxy_user);this.setProxyPassword(l.entry.content.attributes.proxy_password);this.setProxyPasswordConfirmation(l.entry.content.attributes.proxy_password);i.resolve(j)}.bind(this),error:function(j,l,k){if(l.status===404){console.info("Default website_monitoring configuration doesn't exist yet");this.setProxyServer("");this.setProxyServerPort("");this.setProxyType("http");this.setProxyIgnore("");this.setThreadLimit("200");this.setResponseLength("1000");this.setProxyUser("");this.setProxyPassword("");this.setProxyPasswordConfirmation("");this.website_monitoring_configuration=new g({user:"nobody",app:"website_monitoring"});i.resolve(j)}else{console.warn("Unsuccessfully retrieved the default website_monitoring configuration");i.reject()}}.bind(this)});return i},render:function(){f.when(this.isOnCloud()).then(function(i){if(this.userHasAdminAllObjects()){this.$el.html(a.template(d,{has_permission:this.userHasAdminAllObjects(),is_on_cloud:i}));if(this.website_monitoring_configuration===null){this.setControlsEnabled(false);f.when(this.fetchAppConfiguration(),this.getEncryptedCredential(this.secure_storage_stanza,true)).then(function(j,k){if(k){this.setProxyPassword(k.entry.content.attributes.clear_password);this.setProxyPasswordConfirmation(k.entry.content.attributes.clear_password)}this.setControlsEnabled(true)}.bind(this))}}else{this.$el.html("Sorry, you don't have permission to perform setup")}}.bind(this))},isValidPort:function(j){var i=parseInt(j,10);if(j===""){return true}else{if(isNaN(i)){return false}else{if(i<1||i>65535){return false}else{return true}}}},isValidThreadLimit:function(j){var i=parseInt(j,10);if(isNaN(i)){return false}else{if(i<1){return false}else{return true}}},isValidResponseLength:function(i){var j=parseInt(i,10);if(isNaN(j)){return false}else{if(j<-1||j>1048576){return false}else{return true}}},matchesPassword:function(i){var j=this.getProxyPassword();if(j!==i){return false}else{return true}},isValidServer:function(j){var k=/^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+$/gm;var i=/\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/g;if(j===""){return true}else{if(k.exec(j)||i.exec(j)){return true}else{return false}}},setupValidators:function(){this.addValidator(".proxy-address",this.getProxyServer.bind(this),this.isValidServer,"Must be a valid domain name or IP address");this.addValidator(".proxy-port",this.getProxyServerPort.bind(this),this.isValidPort,"Must be a valid port number");this.addValidator(".thread-limit",this.getThreadLimit.bind(this),this.isValidThreadLimit,"Must be an integer greater than 0");this.addValidator(".response-length",this.getResponseLength.bind(this),this.isValidResponseLength,"Must be an integer greather than -1 and less than 104876");this.addValidator(".proxy-password-confirm",this.getProxyPasswordConfirmation.bind(this),this.matchesPassword.bind(this),"Must match the password")}})});