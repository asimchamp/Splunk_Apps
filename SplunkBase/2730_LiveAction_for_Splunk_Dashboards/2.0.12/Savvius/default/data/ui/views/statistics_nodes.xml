<form script="savvius.js" stylesheet="statistics_nodes.css">
  <label>Nodes</label>
  <fieldset autorun="true" submitButton="false">
    <!-- Global timer. Not token is necessary -->
    <input type="time" searchWhenChanged="true">
      <label>Date &amp; Time</label>
      <default>
        <earliest>-1h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" searchWhenChanged="true" token="source">
      <label>Source</label>
      <default>*</default>
      <choice value="*">All</choice>
      <search>
        <query>sourcetype=sv_summaries | stats count by host</query>
        <earliest>$earliest$</earliest>
        <latest>$latest$</latest>
      </search>
      <fieldForValue>host</fieldForValue>
      <fieldForLabel>host</fieldForLabel>
    </input>
    <input type="dropdown" searchWhenChanged="true" token="node_type">
      <label>Node Type</label>
      <default>^\S*$</default>
      <choice value="^\S*$">All</choice>
      <choice value="^(?:[a-fA-F0-9]{2}:){5}[a-fA-F0-9]{2}$">Physical</choice>
      <choice value="(^IP\-(?:[0-9]{1,3}\.){3}[0-9]{1,3}$)|(^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$)">IP</choice>
      <choice value="(^IPv6\-(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]).){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]).){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$)|(^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]).){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]).){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$)">IPv6</choice>
      <choice value="(^IPX\-(?:[a-fA-F0-9]{1,8}\.){1}[a-fA-F0-9]{1,12}$)|(^(?:[a-fA-F0-9]{1,8}\.){1}[a-fA-F0-9]{1,12}$)">IPX</choice>
    </input>
    <input type="text" searchWhenChanged="true" token="address">
      <label>Address</label>
      <default>*</default>
    </input>
  </fieldset>
  <row>
    <panel>
      <single>
        <search>
          <query>sourcetype=sv_nodes host="$source$" Address="$address$"
            | regex Address="$node_type$"
            | stats dc(Address) as nodecount
            | fieldformat nodecount=tostring(nodecount, "commas")</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="underLabel">Nodes</option>
        <option name="field">count</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <chart>
        <title>Node Volume</title>
        <search>
          <query>sourcetype=sv_nodes host="$source$" Address="$address$"
            | regex Address="$node_type$"
            | timechart dc(Address) as "Node Count"</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.axisY2.enabled">undefined</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">collapsed</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisTitleY.text">Node Count</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">zero</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
        <option name="height">200px</option>
      </chart>
    </panel>
    <panel>
      <chart>
        <title>Top Nodes (Total Bytes)</title>
        <search>
          <query>sourcetype=sv_nodes host="$source$" Address="$address$"
            | regex Address="$node_type$"
            | eval tbytes='Bytes Received' + 'Bytes Sent'
            | chart sum(tbytes) as "Total Bytes" by Address
            | rename Address as Node
            | sort -"Total Bytes" | head 10</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.legend.placement">right</option>
        <option name="height">200px</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <chart>
        <title>Top Node Utilization</title>
        <search>
          <query>sourcetype=sv_nodes host="$source$" Address="$address$"
            | regex Address="$node_type$"
            | eval tbytes='Bytes Received' + 'Bytes Sent'
            | timechart sum(tbytes) as "Total Bytes" by Address limit=10 useother=f</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">collapsed</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisTitleY.text">Total Bytes</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="height">200px</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>Node List</title>
        <search>
          <query>sourcetype=sv_nodes host="$source$" Address="$address$"
            | regex Address="$node_type$"
            | eval tbytes='Bytes Received' + 'Bytes Sent'
            | eval tpackets='Packets Received' + 'Packets Sent'
            | eval rbytes=round(tbytes)
            | eval rpackets=round(tpackets)
            | eventstats sum(tbytes) as totalBytes
            | eventstats sum(tpackets) as totalPackets
            | eventstats sum(tbytes) as nodeBytes by Address
            | eventstats sum(tpackets) as nodePackets by Address
            | eval percentBytes=round((nodeBytes/totalBytes)*100, 2)
            | eval percentBytes=percentBytes + "%"
            | eval percentPackets=round((nodePackets/totalPackets)*100, 2)
            | eval percentPackets=percentPackets + "%"
            | eval Megabits=(tbytes/125000)
            | stats sparkline(avg(Megabits)) as "Average Network Utilization (Mb)" sum("Bytes Sent") as "Bytes Sent" sum("Bytes Received") as "Bytes Received" values(percentBytes) as "Bytes %" sum("Packets Sent") as "Packets Sent" sum("Packets Received") as "Packets Received" values(percentPackets) as "Packets %" min("Min Size Sent") as "Min Size Sent" max("Max Size Sent") as "Max Size Sent" min("Min Size Received") as "Min Size Received" max("Max Size Received") as "Max Size Received" by Address
            | fieldformat "Bytes Sent"=tostring('Bytes Sent', "commas")
            | fieldformat "Bytes Received"=tostring('Bytes Received', "commas")
            | fieldformat "Packets Sent"=tostring('Packets Sent', "commas")
            | fieldformat "Packets Received"=tostring('Packets Received', "commas")
            | fieldformat "Min Size Sent"=tostring('Min Size Sent', "commas")
            | fieldformat "Max Size Sent"=tostring('Max Size Sent', "commas")
            | fieldformat "Min Size Received"=tostring('Min Size Received', "commas")
            | fieldformat "Max Size Received"=tostring('Max Size Received', "commas")
            | sort - "Bytes %"</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="count">10</option>
        <drilldown>
          <condition field="Average Network Utilization (Mb)">
            <link>
              <![CDATA[
                  overview_network?earliest=$earliest$&latest=$latest$&form.source=$source$
                      ]]>
            </link>
          </condition>
          <condition field="Bytes Send">
            <link>
              <![CDATA[
                  overview_network?earliest=$earliest$&latest=$latest$&form.source=$source$
                      ]]>
            </link>
          </condition>
          <condition field="Bytes Received">
            <link>
              <![CDATA[
                  overview_network?earliest=$earliest$&latest=$latest$&form.source=$source$
                      ]]>
            </link>
          </condition>
          <condition field="Bytes %">
            <link>
              <![CDATA[
                  overview_network?earliest=$earliest$&latest=$latest$&form.source=$source$
                      ]]>
            </link>
          </condition>
          <condition field="Packets Sent">
            <link>
              <![CDATA[
                  overview_network?earliest=$earliest$&latest=$latest$&form.source=$source$
                      ]]>
            </link>
          </condition>
          <condition field="Packets Received">
            <link>
              <![CDATA[
                  overview_network?earliest=$earliest$&latest=$latest$&form.source=$source$
                      ]]>
            </link>
          </condition>
          <condition field="Packets %">
            <link>
              <![CDATA[
                  overview_network?earliest=$earliest$&latest=$latest$&form.source=$source$
                      ]]>
            </link>
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>
</form>