<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Simple XML Escaped and Modified</title>
    <link rel="shortcut icon" href="{{STATIC_URL}}img/favicon.ico">
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{STATIC_URL}}css/pages/dashboard-simple-bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_STATIC_URL}}app/demo_bubbles/dashboard.css" />
</head>
<body class="simplexml preload">
<div class="header">
    <div id="placeholder-splunk-bar">
        <a href="{{SPLUNKWEB_URL}}app/launcher/home" class="brand" title="splunk &gt; listen to your data">splunk<strong>&gt;</strong></a>
    </div>
    <div id="placeholder-app-bar"></div>
</div>
<div class="dashboard-body container-fluid main-section-body" data-role="main">
    <div class="dashboard-header clearfix">
        <h2>Airports by Destination (Custom HTML)</h2>
    </div>
    <div class="dashboard-row dashboard-row1">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel">
                
                <div class="panel-element-row">
                    <div class="dashboard-element table" id="element1" style="width: 100%">
                        <div class="panel-head">
                            <h3>Airports by Destination</h3>
                        </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
     <!-- Mod #1, Added row to the dashboard HTML -->
    <div class="dashboard-row dashboard-row2">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel">
                <div class="dashboard-element" id="element2">
                    <div class="panel-head">
                        <h3 style="color: tomato;">escapehatch</h3>
                    </div>
                    <div class="panel-body"><p id="chart"></p></div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Mod #1 -->
</div>
<div class="footer"></div>
<script src="{% url 'page_config' %}?autoload=1"></script>
<script src="{{STATIC_URL}}i18n.js"></script>
<script src="{{STATIC_URL}}js/build/splunkjs.min/config.js"></script>
<!-- Mod #2, D3 Bubble Chart from http://bl.ocks.org/mbostock/4063269 -->
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
function dovis(root) {
    var diameter = 960,
        format = d3.format(",d"),
        color = d3.scale.category20c();

    var bubble = d3.layout.pack()
        .sort(null)
        .size([diameter, diameter])
        .padding(1.5);

    d3.select("#chart>svg").remove();
    var svg = d3.select("#chart").append("svg")
        .attr("width", diameter)
        .attr("height", diameter)
        .attr("class", "bubble");

    var node = svg.selectAll(".node")
        .data(bubble.nodes(classes(root))
        .filter(function(d) { return !d.children; }))
      .enter().append("g")
        .attr("class", "node")
        .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

    node.append("title")
        .text(function(d) { return d.className + ": " + format(d.value); });

    node.append("circle")
        .attr("r", function(d) { return d.r; })
        .style("fill", function(d) { return color(d.packageName); });

    node.append("text")
        .attr("dy", ".3em")
        .style("text-anchor", "middle")
        .text(function(d) { return d.className.substring(0, d.r / 3); });

    // Returns a flattened hierarchy containing all leaf nodes under the root.
    function classes(root) {
      var classes = [];

      function recurse(name, node) {
        if (node.children) node.children.forEach(function(child) { recurse(node.name, child); });
        else classes.push({packageName: name, className: node.name, value: node.size});
      }

      recurse(null, root);
      return {children: classes};
    }

    d3.select(self.frameElement).style("height", diameter + "px");
}
</script>
<!-- End Mod #2 -->

<script type="text/javascript">
require.config({
    baseUrl: "{{STATIC_URL}}"
});
require([
    "splunkjs/mvc", 
    "splunkjs/mvc/utils",
    "underscore",
    "jquery",
    "splunkjs/mvc/simplexml/i18n!",
    "splunkjs/mvc/simplexml",
    "splunk.config"], 
    function(mvc, utils, _, $) {
        // AUTO-COMPILED JAVASCRIPT

        //
        // Import required dependencies
        //

        var DashboardController = require("splunkjs/mvc/simplexml/controller");
        var HeaderView = require("splunkjs/mvc/headerview");
        var FooterView = require("splunkjs/mvc/footerview");
        var Dashboard = require("splunkjs/mvc/simplexml/dashboard");
        var ChartElement = require("splunkjs/mvc/simplexml/element/chart");
        var EventElement = require("splunkjs/mvc/simplexml/element/event");
        var HtmlElement = require("splunkjs/mvc/simplexml/element/html");
        var ListElement = require("splunkjs/mvc/simplexml/element/list");
        var MapElement = require("splunkjs/mvc/simplexml/element/map");
        var SingleElement = require("splunkjs/mvc/simplexml/element/single");
        var TableElement = require("splunkjs/mvc/simplexml/element/table");
        var SearchManager = require("splunkjs/mvc/searchmanager");
        var SavedSearchManager = require("splunkjs/mvc/savedsearchmanager");
        var PostProcessSearchContext = require("splunkjs/mvc/postprocess");
        var UrlTokenModel = require("splunkjs/mvc/simplexml/urltokenmodel");
        
        //
        // Create form token namespaces
        //
        
        var defaultTokenModel = mvc.Components.getInstance('default', {create: true});
        var submittedTokenModel = mvc.Components.getInstance('submitted', {create: true});
        
        var urlTokenModel = new UrlTokenModel();
        mvc.Components.registerInstance('url', urlTokenModel);
        
        var submitTokens = function() {
            // Submit form, even if no values have changed since the last submit.
            submittedTokenModel.clear();
            submittedTokenModel.set(defaultTokenModel.toJSON());
        };
        
        //
        // Create header and footer Splunk UI
        //

        new HeaderView({
            name: 'header',
            section: 'dashboards',
            el: $('.header')
        }, {tokens: true}).render();

        new FooterView({
            name: 'footer',
            el: $('.footer')
        }, {tokens: true}).render();

        new Dashboard({
            name: 'dashboard',
            el: $('.dashboard-body')
        }, {tokens: true}).render();

        //
        // Create components
        //
        
        new TableElement({
            "name": "element1",
            "dataOverlayMode": "none",
            "displayRowNumbers": true,
            "drilldown": "row",
            "wrap": "true",
            "managerid": "search1",
            "el": $('#element1')
        }, {tokens: true}).render();

        splunkjs.mvc.Components.get('element1').on("drilldown", function(e){
            e.defaultDrilldown();
        });


        //
        // Create searches
        //


        var search1 = new SearchManager({
            "name": "search1",
            "latest_time": "1359705600",
            "search": "search index=faa\n| stats count by DestState DestAirport\n| sort - count",
            "earliest_time": "1357027200",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "status_buckets": 0,
            "preview": true,
            "timeFormat": "%s.%Q",
            "wait": 0
        }, {tokens: true, tokenNamespace: "submitted"});


        DashboardController.ready();

        // END OF AUTO-COMPILED JAVASCRIPT


        // Mod #3, Add code to process the search, create a Flare-like JSON object and send it to D3

        var datasource = splunkjs.mvc.Components.get("search1").data('preview', {
            output_mode: 'json_rows',
            count: 0 // get all results
        });

        var onDataChanged = function(results) {
            if (!datasource.hasData()) {
                return;
            }
            // Format Splunk data for Sankey
            var collection = results.collection().toJSON();
            var bubblechart = { 'name': 'Destinations', 'children': [ ] };
            for (var i=0; i < collection.length; i++) {
                // Search for phoneType in existing children
                var destStateIdx = -1;
                $.each(bubblechart.children, function(idx, el) {
                    if (el.name == collection[i]['DestState']) {
                        destStateIdx = idx;
                    }
                });
                if (destStateIdx == -1) {
                    bubblechart.children.push({ 'name': collection[i]['DestState'], children: [ ] });
                    destStateIdx = bubblechart.children.length - 1;
                }

                bubblechart.children[destStateIdx].children.push({ 'name': collection[i]['DestAirport'], 'size': collection[i]['count'] });

            }
            dovis(bubblechart);
        };
        datasource.on('data', onDataChanged);

    }
);
</script>
</body>
</html>
