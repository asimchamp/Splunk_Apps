<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Simple XML Escaped and Modified | Splunk</title>
    <link rel="shortcut icon" href="{{SPLUNKWEB_URL_PREFIX}}/static/img/favicon_enterprise.ico" />
    <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/pages/dashboard-simple-bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/demo_bubbles/dashboard.css" />
    <!--[if IE 7]><link rel="stylesheet" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/sprites-ie7.css" /><![endif]-->
</head>
<body class="simplexml preload">
<div class="header">
    <div id="placeholder-splunk-bar">
        <a href="{{SPLUNKWEB_URL_PREFIX}}/app/launcher/home" class="brand" title="splunk &gt; listen to your data">splunk<strong>&gt;</strong></a>
    </div>
    <div id="placeholder-app-bar"></div>
</div>
<div class="dashboard-body container-fluid main-section-body" data-role="main">
    <div class="dashboard-header clearfix">
        <h2>Simple XML Escaped and Modified</h2>
        <p class="description"></p>
    </div>
    <div class="dashboard-row dashboard-row1">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">
                    <div class="dashboard-element table" id="element1" style="width: 100%">
                        <div class="panel-head">
                            <h3>Airports by Destination</h3>
                        </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- [START] Mod #1 of 3, Added row to the dashboard HTML -->

    <div class="dashboard-row dashboard-row2">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">
                    <div class="dashboard-element table" id="element2" style="width: 100%">
                        <div class="panel-head">
                            <h3>Airports by Destination (Custom D3 Bubble Chart)</h3>
                        </div>
                        <div class="panel-body"><p id="chart"></p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>    

     <!-- [END] Mod #1 of 3 -->

</div>
<div class="footer"></div>
<script src="{{SPLUNKWEB_URL_PREFIX}}/config?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/i18n.js"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/build/simplexml.min/config.js"></script>

<!-- [START] Mod #2 of 3, D3 Bubble Chart from http://bl.ocks.org/mbostock/4063269 -->
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
function dovis(root) {
    var diameter = 960,
        format = d3.format(",d"),
        color = d3.scale.category20c();

    var bubble = d3.layout.pack()
        .sort(null)
        .size([diameter, diameter])
        .padding(1.5);

    d3.select("#chart>svg").remove();
    var svg = d3.select("#chart").append("svg")
        .attr("width", diameter)
        .attr("height", diameter)
        .attr("class", "bubble");

    var node = svg.selectAll(".node")
        .data(bubble.nodes(classes(root))
        .filter(function(d) { return !d.children; }))
      .enter().append("g")
        .attr("class", "node")
        .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

    node.append("title")
        .text(function(d) { return d.className + ": " + format(d.value); });

    node.append("circle")
        .attr("r", function(d) { return d.r; })
        .style("fill", function(d) { return color(d.packageName); });

    node.append("text")
        .attr("dy", ".3em")
        .style("text-anchor", "middle")
        .text(function(d) { return d.className.substring(0, d.r / 3); });

    // Returns a flattened hierarchy containing all leaf nodes under the root.
    function classes(root) {
      var classes = [];

      function recurse(name, node) {
        if (node.children) node.children.forEach(function(child) { recurse(node.name, child); });
        else classes.push({packageName: name, className: node.name, value: node.size});
      }

      recurse(null, root);
      return {children: classes};
    }

    d3.select(self.frameElement).style("height", diameter + "px");
}
</script>
<!-- [END] Mod #2 of 3 -->

<script type="text/javascript">
require.config({
    baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
    waitSeconds: 0 // Disable require.js load timeout
});
require([
    "splunkjs/mvc",
    "splunkjs/mvc/utils",
    "splunkjs/mvc/tokenutils",
    "underscore",
    "jquery",
    "splunkjs/mvc/simplexml",
    "splunkjs/mvc/headerview",
    "splunkjs/mvc/footerview",
    "splunkjs/mvc/simplexml/dashboard",
    "splunkjs/mvc/simplexml/element/chart",
    "splunkjs/mvc/simplexml/element/event",
    "splunkjs/mvc/simplexml/element/html",
    "splunkjs/mvc/simplexml/element/list",
    "splunkjs/mvc/simplexml/element/map",
    "splunkjs/mvc/simplexml/element/single",
    "splunkjs/mvc/simplexml/element/table",
    "splunkjs/mvc/simpleform/input/dropdown",
    "splunkjs/mvc/simpleform/input/radiogroup",
    "splunkjs/mvc/simpleform/input/text",
    "splunkjs/mvc/simpleform/input/timerange",
    "splunkjs/mvc/simpleform/input/submit",
    "splunkjs/mvc/searchmanager",
    "splunkjs/mvc/savedsearchmanager",
    "splunkjs/mvc/postprocessmanager",
    "splunkjs/mvc/simplexml/urltokenmodel",
    ],
    function(
        mvc,
        utils,
        TokenUtils,
        _,
        $,
        DashboardController,
        HeaderView,
        FooterView,
        Dashboard,
        ChartElement,
        EventElement,
        HtmlElement,
        ListElement,
        MapElement,
        SingleElement,
        TableElement,
        DropdownInput,
        RadioGroupInput,
        TextInput,
        TimeRangeInput,
        SubmitButton,
        SearchManager,
        SavedSearchManager,
        PostProcessManager,
        UrlTokenModel) {


        // AUTO-COMPILED JAVASCRIPT


        var pageLoading = true;

        //
        // Create form token namespaces
        //

        var urlTokenModel = new UrlTokenModel();
        mvc.Components.registerInstance('url', urlTokenModel);
        var defaultTokenModel = mvc.Components.getInstance('default', {create: true});
        var submittedTokenModel = mvc.Components.getInstance('submitted', {create: true});

        urlTokenModel.on('url:navigate', function() {
            defaultTokenModel.set(urlTokenModel.toJSON());
            if (!_.isEmpty(urlTokenModel.toJSON()) && !_.all(urlTokenModel.toJSON(), _.isUndefined)){
                submitTokens();
            } else {
                submittedTokenModel.clear();
            }
        });

        // Initialize non-input tokens
        defaultTokenModel.set(urlTokenModel.toJSON());

        var defaultUpdate = {};

        var submitTokens = function() {
            submitTokensSoon(pageLoading);  // captures from enclosing scope before debounce
        };

        var submitTokensSoon = _.debounce(function(updateHistory) {
            submittedTokenModel.set(defaultTokenModel.toJSON());
            urlTokenModel.saveOnlyWithPrefix('form\.', defaultTokenModel.toJSON(), {
                replaceState: updateHistory
            });
        });


        //
        // Create searches
        //

        var search1 = new SearchManager({
            "id": "search1",
            "earliest_time": "1357027200",
            "search": "search index=faa | stats count by DestState DestAirport | sort - count",
            "cancelOnUnload": true,
            "status_buckets": 0,
            "latest_time": "1359705600",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": true
        }, {tokens: true, tokenNamespace: "submitted"});


        //
        // Create header and footer Splunk UI
        //

        new HeaderView({
            id: 'header',
            section: 'dashboards',
            el: $('.header'),
            acceleratedAppNav: true
        }, {tokens: true}).render();

        new FooterView({
            id: 'footer',
            el: $('.footer')
        }, {tokens: true}).render();

        //
        // Create dashboard editing UI
        //

        new Dashboard({
            id: 'dashboard',
            el: $('.dashboard-body')
        }, {tokens: true}).render();

        //
        // Create components
        //

        var element1 = new TableElement({
            "id": "element1",
            "dataOverlayMode": "none",
            "displayRowNumbers": true,
            "drilldown": "row",
            "wrap": "true",
            "managerid": "search1",
            "el": $('#element1')
        }, {tokens: true}).render();
        

        //
        // Submit any form data
        //

        submitTokens();


        //
        // Signal the dashboard is done loading.
        //

        DashboardController.ready();
        pageLoading = false;

        // END OF AUTO-COMPILED JAVASCRIPT

       // [START] Mod #3 of 3, Add code to process the search, create a Flare-like JSON object and send it to D3

        var datasource = splunkjs.mvc.Components.get("search1").data('preview', {
            output_mode: 'json_rows',
            count: 0 // get all results
        });

        var onDataChanged = function(results) {
            if (!datasource.hasData()) {
                return;
            }
            // Format Splunk data for Sankey
            var collection = results.collection().toJSON();
            var bubblechart = { 'name': 'Destinations', 'children': [ ] };
            for (var i=0; i < collection.length; i++) {
                // Search for phoneType in existing children
                var destStateIdx = -1;
                $.each(bubblechart.children, function(idx, el) {
                    if (el.name == collection[i]['DestState']) {
                        destStateIdx = idx;
                    }
                });
                if (destStateIdx == -1) {
                    bubblechart.children.push({ 'name': collection[i]['DestState'], children: [ ] });
                    destStateIdx = bubblechart.children.length - 1;
                }

                bubblechart.children[destStateIdx].children.push({ 'name': collection[i]['DestAirport'], 'size': collection[i]['count'] });

            }
            dovis(bubblechart);
        };
        datasource.on('data', onDataChanged);

       // [END] Mod #3 of 3
        
    }
);
</script>
</body>
</html>

