<form script="external_link.js" stylesheet="custom.css" version="1.1">
  <label>VirusTotal Lookup</label>
  <search id="vtSearch"><query>| script vtlookup __EXECUTE__ "$search_hash_url$" | spath input=vt</query></search>
      <description>Enter the hash or URL below.  Ex:  57f222d8fbe0e290b4bf8eaa994ac641</description>
  <!-- Add time range picker -->
  <fieldset autoRun="True" submitButton="true">
    <!-- Add Wildcard Filter -->
    <input type="text" token="search_hash_url" searchWhenChanged="true">
      <label>Hash or URL/IP</label>
      <default>$url:UrlHash$</default>
      <suffix/>
    </input>
  </fieldset>
<row>
    <panel>
      <single>
        <title>VT Hits</title>

        <search base="vtSearch" id="vthits"><query>rex field=vt  "\'malicious\':\s+(?&lt;vt_hits&gt;\d+)," |eval vt_positives =if(isnull(vt_hits), 0, vt_hits) | table vt_positives</query></search>

        <option name="drilldown">none</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>VT Misses</title>
        
        <search base="vtSearch" id="vtmiss"><query>rex field=vt "\'undetected\':\s+(?&lt;vt_misses&gt;\d+)" | eval vt_negatives = if(isnull(vt_misses), "All", vt_misses) | table vt_negatives</query></search>
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Total Engines</title>
        
        <search base="vtSearch"><query>rex field=vt "\'undetected\':\s+(?&lt;vt_negatives&gt;\d+)" | rex field=vt "\'malicious\':\s+(?&lt;vt_hits&gt;\d+),"|eval vt_positives =if(isnull(vt_hits), 0, vt_hits) | eval vt_total=(vt_positives+vt_negatives) | eval vt_total = if(isnull(vt_total), "All", vt_total) | table vt_total</query></search> 
               
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
      </single>
    </panel>
    <panel>
      <chart>
        <title>VT Percentage</title>
        <search base="vtSearch">
        	<query>
        	 rex field=vt "\'undetected\':\s+(?&lt;vt_negatives&gt;\d+)" | rex field=vt "\'malicious\':\s+(?&lt;vt_hits&gt;\d+),"|eval vt_positives =if(isnull(vt_hits), 0, vt_hits) | eval vt_total=(vt_positives+vt_negatives)| eval HitPercentage=(vt_positives/vt_total)*100 | eval HitPercentage=round(HitPercentage,0) | eval HitPercentage=HitPercentage | eval MissPercentage=100-HitPercentage |  eval MissPercentage = if(isnull(MissPercentage), 100,MissPercentage ) | eval HitPercentage = if(isnull(HitPercentage), 0,HitPercentage ) | table HitPercentage, MissPercentage | transpose
        </query>
        </search>
        <option name="height">80</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.chart.showLabels">true</option>
        <option name="charting.chart.showpercent">true</option>
        <option name="charting.fieldColors">{HitPercentage:0xFA0000,MissPercentage:0xB7B7B7}</option>
        <option name="list.drilldown">full</option>
        <option name="list.wrap">1</option>
        <option name="maxLines">5</option>
        <option name="raw.drilldown">full</option>
        <option name="rowNumbers">false</option>
        <option name="table.drilldown">all</option>
        <option name="table.wrap">1</option>
        <option name="type">list</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">none</option>
      </chart>
    </panel>
  </row>
      <row>
      <table id="detail">
        <title>Messages</title>
        <search base="vtSearch"><query> rex field=vt "\'last_analysis_date\':\s+(?&lt;scan_date&gt;\d+)" | eval scan_date=strftime(scan_date,"%Y-%m-%d %H:%M:%S")|rex field=vt "\'links\':\s+\{'self\':\s+\'(?&lt;permalink&gt;.*)\'" |eval permalink= replace(permalink, "api\/v3\/files", "gui/file")| table scan_date, permalink | rename scan_date AS "Scan Date", permalink AS "Event Link"</query></search>
        <option name="drilldown">cell</option>
        <option name="dataOverlayMode">none</option>
        <drilldown target="_blank">
          <condition field="Verbose Message"></condition>
          <condition field="Scan Date"></condition>
          <condition field="Event Link">$row.permalink$</condition>
        </drilldown>
        <option name="wrap">undefined</option>
        <option name="maxLines">1</option>
        <option name="rowNumbers">undefined</option>
      </table>
  </row>
  <row>
    <panel>
      <table>
        <title>VT Hit Details</title>
        <search base="vtSearch"><query>rex field=vt "\'last_analysis_results\':.*?{(?&lt;vt2&gt;.*})" | rex max_match=70 field=vt2 "(?&lt;json_field&gt;\'.*?\'.*?{\'category\'\:.*?})," | mvexpand json_field | spath input=json_field | rex max_match=70 field=json_field "\{'category\':\s+\'(?&lt;Detected&gt;.+?)\'" | rex max_match=70 field=json_field "\'(?&lt;Scanner&gt;.*?)\'.*?{" |sort +Scanner  | rex max_match=70 field=json_field "\'engine_version\':\s+\'(?&lt;Version&gt;.*?)\'," | rex max_match=70 field=json_field "\'engine_update\':.*?\'(?&lt;Update&gt;.*?)\'}" | rex max_match=70 field=json_field "\'result\':\s\'(?&lt;Result&gt;.*?)\'" | table Scanner Detected Version Update Result | rename Result AS "Signature"</query></search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="count">70</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>VT Raw Response</title>
        <search base="vtSearch"><query>table vt | rename vt AS "Response"</query></search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="count">70</option>
      </table>
    </panel>
  </row>
</form>
