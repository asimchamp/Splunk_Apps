<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Configure KPI | Splunk</title>
    <link rel="shortcut icon" href="{{SPLUNKWEB_URL_PREFIX}}/static/img/favicon.ico" />
        <link rel="stylesheet" type="text/css" href="/en-US/static/@237341.1/css/build/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="/en-US/static/@237341.1/css/build/pages/dashboard-simple-bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/search/dashboard.css" />
    <!--[if IE 7]><link rel="stylesheet" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/sprites-ie7.css" /><![endif]-->
  <style>
    td.icon {
        text-align: center;
    }

    td.icon i {
        font-size: 15px;
        text-shadow: 1px 1px #aaa;
    }

    td.icon .icon-delete {
        color: red;    	
    }
     
</style>
</head>
<body class="simplexml preload locale-en">
<!-- 
BEGIN LAYOUT
This section contains the layout for the dashboard. Splunk uses proprietary
styles in <div> tags, similar to Bootstrap's grid system. 
-->
<a class="navSkip" href="#navSkip" tabindex="1">Screen reader users, click here to skip the navigation bar</a>
<div class="header splunk-header">
        <div id="placeholder-splunk-bar">
            <a href="{{SPLUNKWEB_URL_PREFIX}}/app/launcher/home" class="brand" title="splunk &gt; listen to your data">splunk<strong>&gt;</strong></a>
        </div>
            <div id="placeholder-app-bar"></div>
</div>
<a id="navSkip"></a>
  
<div class="dashboard-body container-fluid main-section-body" data-role="main">
    <div class="dashboard-header clearfix">
        <h2>Configure KPI</h2>

    <form id="form_new_kpi">
        <div class="fieldset">
           
          	<div class="input">
          		<label>KPI Event type</label>
            	<div class="input input-dropdown" id="new_kpi_eventtype"></div>
          	</div>
          <div class="input">
          <label>KPI Type</label>
          <div class="input input-dropdown" id="new_kpi_type"></div>
          </div>
          <div class="input">
             <label>KPI Field</label>
          	 <div class="input input-dropdown" id="new_kpi_field"></div>
            </div>
          <div class="input">
            <label>Comparison</label>
          	<div class="input input-dropdown" id="new_kpi_compare"></div>
            </div>
          <div class="input">
            	<label>KPI Value</label>
            	<div class="input input-text" id="new_kpi_value"></div>
          </div>
            <br>
              <div class="input">
            <label>KPI Ok Value</label>
          	<div class="input input-text" id="new_kpi_ok"></div>
            </div>
          <div class="input">
            	<label>KPI Violated Value</label>
            	<div class="input input-text" id="new_kpi_violated"></div>
          </div>
              <div class="input">
            	<label>KPI Description</label>
            	<div class="input input-text" id="new_kpi_description"></div>
          </div>
              <br>
            <div class="form-submit" id="search_btn">
                <button class="btn btn-primary submit">Create New KPI</button>
            </div>
        </div>
    </form>

    <div id="row1" class="dashboard-row dashboard-row1">
        <div id="panel1" class="dashboard-cell" style="width: 100%;">                
            <div class="panel-element-row">
                <div id="element1" class="dashboard-element table" style="width: 100%">
                    <div class="panel-head">
                        <h3>KV Store collection</h3>
                    </div>
                    <div class="panel-body"></div>
                </div>
            </div>
        </div>
    </div>

</div>
<div class="footer"></div>

<!-- 
END LAYOUT
-->

<script src="{{SPLUNKWEB_URL_PREFIX}}/config?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/i18n.js"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/i18ncatalog?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/build/simplexml.min/config.js"></script>
<script type="text/javascript">
require.config({
    baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
    waitSeconds: 0
});

//
// LIBRARY REQUIREMENTS
//
// In the require function, we include the necessary libraries and modules for
// the HTML dashboard. Then, we pass variable names for these libraries and
// modules as function parameters, in order.
// 
// When you add libraries or modules, remember to retain this mapping order
// between the library or module and its function parameter. You can do this by
// adding to the end of these lists, as shown in the commented examples below.

require([
    "splunkjs/mvc",
    "splunkjs/mvc/utils",
    "splunkjs/mvc/tokenutils",
    "underscore",
    "jquery",
    "splunkjs/mvc/simplexml",
    "splunkjs/mvc/headerview",
    "splunkjs/mvc/footerview",
    "splunkjs/mvc/simplexml/dashboardview",
    "splunkjs/mvc/simplexml/dashboard/panelref",
    "splunkjs/mvc/simplexml/element/chart",
    "splunkjs/mvc/simplexml/element/event",
    "splunkjs/mvc/simplexml/element/html",
    "splunkjs/mvc/simplexml/element/list",
    "splunkjs/mvc/simplexml/element/map",
    "splunkjs/mvc/simplexml/element/single",
    "splunkjs/mvc/tableview",
    "splunkjs/mvc/simpleform/formutils",
    "splunkjs/mvc/simplexml/eventhandler",
    "splunkjs/mvc/simpleform/input/dropdown",
    "splunkjs/mvc/simpleform/input/radiogroup",
    "splunkjs/mvc/simpleform/input/multiselect",
    "splunkjs/mvc/simpleform/input/checkboxgroup",
    "splunkjs/mvc/simpleform/input/text",
    "splunkjs/mvc/simpleform/input/timerange",
    "splunkjs/mvc/simpleform/input/submit",
    "splunkjs/mvc/searchmanager",
    "splunkjs/mvc/savedsearchmanager",
    "splunkjs/mvc/postprocessmanager",
    "splunkjs/mvc/simplexml/urltokenmodel",
  	"splunkjs/mvc/dropdownview"
    // Add comma-separated libraries and modules manually here, for example:
    // ..."splunkjs/mvc/simplexml/urltokenmodel",
    // "splunkjs/mvc/checkboxview"
    ],
    function(
        mvc,
        utils,
        TokenUtils,
        _,
        $,
        DashboardController,
        HeaderView,
        FooterView,
        Dashboard,
        PanelRef,
        ChartElement,
        EventElement,
        HtmlElement,
        ListElement,
        MapElement,
        SingleElement,
        TableElement,
        FormUtils,
        EventHandler,
        DropdownInput,
        RadioGroupInput,
        MultiSelectInput,
        CheckboxGroupInput,
        TextInput,
        TimeRangeInput,
        SubmitButton,
        SearchManager,
        SavedSearchManager,
        PostProcessManager,
        UrlTokenModel,
  		DropdownView

        // Add comma-separated parameter names here, for example: 
        // ...UrlTokenModel, 
        // CheckboxView
        ) {



        var pageLoading = true;


        // 
        // TOKENS
        //
        
        // Create token namespaces
        var urlTokenModel = new UrlTokenModel();
        mvc.Components.registerInstance('url', urlTokenModel);
        var defaultTokenModel = mvc.Components.getInstance('default', {create: true});
        var submittedTokenModel = mvc.Components.getInstance('submitted', {create: true});

        urlTokenModel.on('url:navigate', function() {
            defaultTokenModel.set(urlTokenModel.toJSON());
            if (!_.isEmpty(urlTokenModel.toJSON()) && !_.all(urlTokenModel.toJSON(), _.isUndefined)) {
                submitTokens();
            } else {
                submittedTokenModel.clear();
            }
        });

        // Initialize tokens
        defaultTokenModel.set(urlTokenModel.toJSON());

        function submitTokens() {
            // Copy the contents of the defaultTokenModel to the submittedTokenModel and urlTokenModel
            FormUtils.submitForm({ replaceState: pageLoading });
        }

        function setToken(name, value) {
            defaultTokenModel.set(name, value);
            submittedTokenModel.set(name, value);
        }

        function unsetToken(name) {
            defaultTokenModel.unset(name);
            submittedTokenModel.unset(name);
        }

        
        
        //
        // SEARCH MANAGERS
        //

        var search1 = new SearchManager({
            "id": "search1",
            "cancelOnUnload": true,
            "latest_time": "$latest$",
            "search": " | inputlookup kpi | eval  delete = _key | fields delete kpi_description eventtype kpi_type kpi_field kpi_compare kpi_value kpi_ok kpi_violated",
            "earliest_time": "0",
            "status_buckets": 0,
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": true,
            "runWhenTimeIsUndefined": false
        }, {tokens: true});

  
  		new SearchManager({
  			id: "current_eventtypes",
   			app: utils.getCurrentApp(),
            auto_cancel: 90,
            preview: false,
  			search: "|`kpi_getEventtypes`"
  		}, {tokens: true, tokenNamespace: "submitted"});
  
  		
  		var new_kpi_field_list = new SearchManager({
  			id: "new_kpi_field_list",
   			app: utils.getCurrentApp(),
            auto_cancel: 90,
            preview: false
  		});
  
        //
        // SPLUNK HEADER AND FOOTER
        //

        new HeaderView({
            id: 'header',
            section: 'dashboards',
            el: $('.header'),
            acceleratedAppNav: true,
            useSessionStorageCache: true,
            splunkbar: true,
            appbar: true,
            litebar: false,
        }, {tokens: true}).render();

        new FooterView({
            id: 'footer',
            el: $('.footer')
        }, {tokens: true}).render();


        //
        // DASHBOARD EDITOR
        //

        new Dashboard({
            id: 'dashboard',
            el: $('.dashboard-body'),
            showTitle: true,
            editable: true
        }, {tokens: true}).render();


        //
        // VIEWS: VISUALIZATION ELEMENTS
        //

        var element1 = new TableElement({
            "id": "element1",
            "rowNumbers": "undefined",
            "wrap": "undefined",
            "managerid": "search1",
            "el": $('#element1')
        }, {tokens: true, tokenNamespace: "submitted"});
        

  
  var CustomIconCellRenderer = TableElement.BaseCellRenderer.extend({ 
            canRender: function(cellData) {
                // This method returns 'true' for the 'range' field
                return cellData.field === 'delete';
            },
            
            // This render function only works when canRender returns 'true'
            render: function($td, cellData) {
                console.log("cellData: ", cellData);

                var icon = 'delete';
  $td.addClass('icon').html(_.template('<img class="icon-delete" title="Delete <%-keyid%>?" id="<%-keyid%>" src="{{SPLUNKWEB_URL_PREFIX}}/static/app/TA_KPI/icons/16-em-cross.png">', {
                    icon: icon,
                    keyid: cellData.value
                }));
            }
        });
        
        // Create an instance of the custom cell renderer
        var myCellRenderer = new CustomIconCellRenderer();

        // Add the custom cell renderer to the table
        element1.addCellRenderer(myCellRenderer); 
 
 
  		element1.render();
  
  		

        //
        // VIEWS: FORM INPUTS
        //
  
  		
  		var new_kpi_eventtype_dd  = new DropdownView({
  			id: "new_kpi_eventtype",
  			managerid: "current_eventtypes",
  			labelField: "title",
            valueField: "title",
  			value: "$form.new_kpi_eventtype$",
            el: $("#new_kpi_eventtype")
        },  {tokens: true, tokenNamespace: "submitted"}).render();
  
  
  
  		var new_kpi_field_dd  = new DropdownView({
  			id: "new_kpi_field",
  			managerid: "new_kpi_field_list",
  			labelField: "column",
            valueField: "column",
  			value: "$form.new_kpi_field$",
            el: $("#new_kpi_field")
        },  {tokens: true, tokenNamespace: "submitted"}).render();
  
  		new_kpi_eventtype_dd.on("change", function(newValue) {
            mysearch = "`kpi_getFieldsByEventtype(\"" + newValue + "\")`";
  			new_kpi_field_list.settings.set("search", mysearch);
  			new_kpi_field_list.startSearch();
  			console.log(mysearch);
        });
  
  		var new_kpi_value_ti = new TextInput({
            "id": "new_kpi_value",
            "value": "$form.new_kpi_value$",
            "el": $('#new_kpi_value')
        }, {tokens: true}).render();

        new_kpi_value_ti.on("change", function(newValue) {
            FormUtils.handleValueChange(new_kpi_value_ti);
        });
  
  		var new_kpi_violated_ti = new TextInput({
            "id": "new_kpi_violated",
            "value": "$form.new_kpi_violated$",
            "el": $('#new_kpi_violated')
        }, {tokens: true}).render();

        new_kpi_violated_ti.on("change", function(newValue) {
            FormUtils.handleValueChange(new_kpi_violated_ti);
        });
  
  		var new_kpi_ok_ti = new TextInput({
            "id": "new_kpi_ok",
            "value": "$form.new_kpi_ok$",
            "el": $('#new_kpi_ok')
        }, {tokens: true}).render();

        new_kpi_ok_ti.on("change", function(newValue) {
            FormUtils.handleValueChange(new_kpi_ok_ti);
        });
  
  		var new_kpi_description_ti = new TextInput({
            "id": "new_kpi_description",
            "value": "$form.new_kpi_description$",
            "el": $('#new_kpi_description')
        }, {tokens: true}).render();

        new_kpi_description_ti.on("change", function(newValue) {
            FormUtils.handleValueChange(new_kpi_description_ti);
        });
  
  		var new_kpi_type_dd  = new DropdownView({
  			id: "new_kpi_type",
  			choices: [
            			{label: "Static", value: "static"}
            		],
  			value: "$form.new_kpi_type$",
            el: $("#new_kpi_type")
        },  {tokens: true, tokenNamespace: "submitted"}).render();
  
  		var new_kpi_compare_dd  = new DropdownView({
  			id: "new_kpi_compare",
  			choices: [
            			{label: "Is Greater Than", value: "gt"},
  						{label: "Is Lesser Than", value: "lt"},
  						{label: "Equal To", value: "eq"}
            		],
  			value: "$form.new_kpi_compare$",
            el: $("#new_kpi_compare")
        },  {tokens: true, tokenNamespace: "submitted"}).render();

        

    

        // 
        // SERVICE OBJECT
        //

        // Create a service object using the Splunk SDK for JavaScript
        // to send REST requests
        var service = mvc.createService({ owner: "nobody" });

		element1.on("click", function(e){
  			e.preventDefault();
  			console.log(e);
  			if ("delete" == e.field) {  				
  				myID = e.event.value;
  				if (confirm("Really delete KPI " + myID + "?")) {
  					console.log("deleting " + myID);
  					service.del("/servicesNS/nobody/TA_KPI/storage/collections/data/col_kpi/" + myID)
                	.done(function() { 
                    	// Run the search again to update the table
                    	search1.startSearch(); 
  					});
				} else {
    				return false;
				}	  				
  			}
  			
  		});

        // 
        // SUBMIT FORM DATA
        //

        var submit = new SubmitButton({
            id: "submit",
            el: $("#search_btn")
        }, {tokens: true}).render();

        submit.on("submit", function() {
            submitTokens();

            // When the Submit button is clicked, get all the form fields by accessing token values
            var tokens = mvc.Components.getInstance("default");
            var form_eventtype = tokens.get("new_kpi_eventtype"),
  				form_kpi_description = tokens.get("new_kpi_description"),
  				form_kpi_value = tokens.get("new_kpi_value"),
  				form_kpi_ok = tokens.get("new_kpi_ok"),
  				form_kpi_violated = tokens.get("new_kpi_violated");
            
            
            // Create a dictionary to store the field names and values
                var record = { 
                "eventtype": new_kpi_eventtype_dd.val(), 
                "kpi_description": form_kpi_description,
  				"kpi_type": new_kpi_type_dd.val(),
  				"kpi_compare": new_kpi_compare_dd.val(),
  				"kpi_field": new_kpi_field_dd.val(),
  				"kpi_value": form_kpi_value,
  				"kpi_ok": form_kpi_ok,
  				"kpi_violated": form_kpi_violated
            }; 

  			console.log(record);
            // Use the request method to send a REST POST request
            // to the storage/collections/data/{collection}/ endpoint
  			service.request(
  "/servicesNS/nobody/TA_KPI/storage/collections/data/col_kpi/",
                "POST",
                null,
                null,
                JSON.stringify(record),
                {"Content-Type": "application/json"},
                null)
                    .done(function() { 
                         // Run the search again to update the table
                        search1.startSearch();

                        // Clear the form fields 
                        $("#form_new_kpi input[type=text]").val(""); 
  			});
        });


        // Initialize time tokens to default
        if (!defaultTokenModel.has('earliest') && !defaultTokenModel.has('latest')) {
            defaultTokenModel.set({ earliest: '0', latest: '' });
        }

        if (!_.isEmpty(urlTokenModel.toJSON())){
            submitTokens();
        }



        //
        // DASHBOARD READY
        //

        DashboardController.ready();
        pageLoading = false;

    }
);
</script>
</body>
</html>
