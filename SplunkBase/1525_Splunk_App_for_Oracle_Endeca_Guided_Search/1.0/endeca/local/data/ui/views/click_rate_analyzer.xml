<?xml version='1.0' encoding='utf-8'?>
<form>
  <label>Click Rate Analyzer</label>
  <fieldset autoRun="true">
    <input type="text" token="searchTerm">
    <label>Search Terms</label>
    <default>*</default>
    <seed>*</seed>
  </input>
  <input type="text" token="dimensionValue">
    <label>Dimension Value</label>
    <default>*</default>
    <seed>*</seed>
  </input>
  <input type="time">
      <default>Last 30 days</default>
      </input>
  </fieldset>    
  <row>
    <chart>
      <searchTemplate>index=endeca sourcetype="logserver_output" | eval SEARCH_TERMS=if(isnull(SEARCH_TERMS), "", SEARCH_TERMS) | eval DIMENSION_VALUE=if(isnull(DIMENSION_VALUE), "", DIMENSION_VALUE) | reverse | streamstats current=f last(TYPE) as previousPageType, last(SEARCH_TERMS) as previousSearchTerms, last(DIMENSION_VALUE) as previousDimensionValues by SESSION_ID  | eval previousDimensionValues=if(isnull(previousDimensionValues), "", previousDimensionValues) | eval DIMENSION_VALUE=if(iSnull(DIMENSION_VALUE), "", DIMENSION_VALUE) | eval previousSearchTerms=if(isnull(previousSearchTerms), "", previousSearchTerms) | eval SEARCH_TERMS=if(iSnull(SEARCH_TERMS), "", SEARCH_TERMS)| search ((TYPE=R previousSearchTerms="$searchTerm$" previousDimensionValues="$dimensionValue$") OR (SEARCH_TERMS="$searchTerm$" DIMENSION_VALUE="$dimensionValue$")) | eval clickthroughCounter=if(TYPE=="R", 1, 0)  | eval requestCounter=if(NOT TYPE=="R", 1, 0)  | timechart eval(sum(clickthroughCounter)/sum(requestCounter)) as "Clickthrough Rate"</searchTemplate>
      <title>Overall Clickthrough Rate Over Time</title>
      <option name="charting.chart">area</option>
      <option name="charting.chart.nullValueMode">zero</option>
    </chart>
  </row>
  <row>
    <table>
      <searchTemplate>`searchTermRequestCount($searchTerm$, $dimensionValue$)` | join type=left SEARCH_TERMS [search index=endeca sourcetype="logserver_output" | eval SEARCH_TERMS=if(isnull(SEARCH_TERMS), "", SEARCH_TERMS) | eval DIMENSION_VALUE=if(isnull(DIMENSION_VALUE), "", DIMENSION_VALUE) | reverse | streamstats current=f last(TYPE) as previousPageType, last(DIMENSION_VALUE) as previousDimensionValues, last(SEARCH_TERMS) as previousSearchTerms by SESSION_ID | eval SEARCH_TERMS=previousSearchTerms | eval DIMENSION_VALUE=previousDimensionValues | search TYPE=R SEARCH_TERMS="$searchTerm$" DIMENSION_VALUE="$dimensionValue$" | where isnotnull(previousSearchTerms) | eval SEARCH_TERMS = previousSearchTerms | stats count as totalClickthroughs by SEARCH_TERMS] |  stats sum(totalClickthroughs) as totalClickthroughs, values(searchTermRequestCount) as totalSearchRequests, values(avgRecordsReturned) as "Average Records Returned" by SEARCH_TERMS | eval totalClickthroughs = if(isnull(totalClickthroughs), 0, totalClickthroughs) | eval clickthroughRate = round(totalClickthroughs / totalSearchRequests * 100,2) | sort -totalClickthroughs,-totalSearchRequests | rename SEARCH_TERMS as "Search Term", totalClickthroughs as "Clickthroughs", totalSearchRequests as "Search Requests", clickthroughRate as ClickthroughRate | fieldformat ClickthroughRate = tostring(ClickthroughRate) + "%"</searchTemplate>
      <title>Click Rate by Search Term</title>
	  <drilldown>
       <link>
       	<![CDATA[
  			/app/endeca/click_rate_analyzer?form.searchTerm=$row.Search Term$&form.dimensionValue=$form.dimensionValue$&earliest=$earliest$&latest=$latest$
       	]]>
       </link>
     </drilldown>         
    </table>
    <table>
      <searchTemplate>`dimensionValueRequestCount($dimensionValue$, $searchTerm$)` | join type=left DIMENSION_VALUE [search index=endeca sourcetype="logserver_output" | eval DIMENSION_VALUE=if(isnull(DIMENSION_VALUE), "", DIMENSION_VALUE) | eval SEARCH_TERMS=if(isnull(SEARCH_TERMS), "", SEARCH_TERMS) | reverse | streamstats current=f last(TYPE) as previousPageType, last(DIMENSION_VALUE) as previousDimensionValues, last(SEARCH_TERMS) as previousSearchTerms by SESSION_ID | eval SEARCH_TERMS=previousSearchTerms | eval DIMENSION_VALUE=previousDimensionValues | search TYPE=R SEARCH_TERMS="$searchTerm$" DIMENSION_VALUE="$dimensionValue$" | where isnotnull(previousDimensionValues) | eval DIMENSION_VALUE = previousDimensionValues | stats count as totalClickthroughs by DIMENSION_VALUE] |  stats sum(totalClickthroughs) as totalClickthroughs, values(dimensionValueRequestCount) as totalDimensionValueRequests, values(avgRecordsReturned) as "Average Records Returned" by DIMENSION_VALUE | eval totalClickthroughs = if(isnull(totalClickthroughs), 0, totalClickthroughs) | eval clickthroughRate = round(totalClickthroughs / totalDimensionValueRequests * 100,2) | sort -totalClickthroughs,-totalDimensionValueRequests | rename DIMENSION_VALUE as "Dimension Value", totalClickthroughs as "Clickthroughs", totalDimensionValueRequests as "Dim Val Requests", clickthroughRate as ClickthroughRate | fieldformat ClickthroughRate = tostring(ClickthroughRate) + "%"</searchTemplate>
      <title>Click Rate by Dimension Value</title>
	  <drilldown>
       <link>
       	<![CDATA[
  			/app/endeca/click_rate_analyzer?form.dimensionValue=$row.Dimension Value$&form.searchTerm=$form.searchTerm$&earliest=$earliest$&latest=$latest$
       	]]>
       </link>
     </drilldown>         
    </table>
  </row>
</form>