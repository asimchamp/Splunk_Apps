<dashboard>
  <label>Search Token Setter</label>
  <row>
  	<panel>
  		<html>
  			<h2>Search Token Setter</h2>

        <p>Set tokens directly from the search manager to control various behavior on the page, enrich displays with search information, and more.  Each search that is dispatched by Splunk makes available a wide set of metadata around the search, the job, and even the results.  This feature enables developers to access and set tokens from that metadata to be used throughout the page.</p>

        <h4>Common use cases:</h4>
        <ul>
          <li>Inlcude result count in the viz element title</li>
          <li>If search returns "0 results", then run a different search, or hide the panel altogether</li>
          <li>Include time range of the search directly below the viz element using html</li>
          <li>Build a fully-custom html element, and insert search results as token variables</li>
        </ul>

        <h4>Search event handlers that you can bind to:</h4>
        <ul>
          <li><i>progress</i> - job metadata available starting at the first progress event through to finalized state</li>
          <li><i>preview</i> - similar to progress, but includes first search result in addition</li>
          <li><i>done</i> - job metadata available upon completion of the search</li>
          <li><i>finalized</i> - similar to done, but uncludes first search result in addition</li>
          <li><i>cancelled</i> - event indicating that the search has been cancelled</li>
          <li><i>error</i> - event indicating that the search includes an error</li>
          <li><i>fail</i> - event indicated that the search has failed</li>
        </ul>

        <h4>Common search tokens:</h4>
        <ul>
          <li>Job Metadata</li>
          <ul>
            <li><code>$$job.earliestTime$$</code> - Initial time a search job starts</li>
            <li><code>$$job.latestTime$$</code> - Latest time recorded for the search job</li>
            <li><code>$$job.resultCount$$</code> - Number of results returned by the search job</li>
            <li><code>$$job.runDuration$$</code> - Time, in seconds, that the search took to complete</li>
            <li><code>$$job.messages$$</code> - List of error and debug messages generated by the search job</li>
          </ul>
          <li>Search Results (first result only)</li>
          <ul>
            <li><code>$$result.[fieldName]$$</code> - Results are referenced directly by their field name</li>
          </ul>
        </ul>

  		</html>
  	</panel>
  </row>
  <row>
    <panel>
      <title>Adding Result Count to Viz Title</title>
      <chart>
        <title>Top sourcetypes ($sourcetype_count$ total sourcetypes)</title>
        <search>
          <query>index=_internal |  top sourcetype</query>
          <earliest>-60m</earliest>
          <latest>now</latest>
          <progress>
            <set token="sourcetype_count">$job.resultCount$</set>
          </progress>
          <cancelled>
            <unset token="sourcetype_count" />
          </cancelled>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
      </chart>
      <html>
      	<h2>Using search token setter to add result count to element titles</h2>

      	<p></p>

      	<pre><![CDATA[
        <search>
          <query>index=_internal |  top sourcetype</query>
          <earliest>-60m</earliest>
          <latest>now</latest>
          <progress>
            <set token="sourcetype_count">$job.resultCount$</set>
          </progress>
          <cancelled>
            <unset token="sourcetype_count" />
          </cancelled>
        </search>
      		]]>
      	</pre>

      </html>
    </panel>
  </row>


  <row>
    <panel>
      <title>Search Logic Based on Result Count</title>

      <input type="radio" token="index_switcher">
         <label>Choose Index</label>
         <choice value="index=_internal">index=_internal</choice>
         <choice value="index=_null">index=_null</choice>
         <initialValue>index=_null</initialValue>
      </input>

        <search id="search_logic">
          <query>$index_switcher$ |  top sourcetype</query>
          <earliest>-60m@m</earliest>
          <latest>now</latest>
          <progress>
            <condition match="'job.resultCount' == 0">
              <set token="show_html">foob</set>
            </condition>
            <condition>
              <unset token="show_html"/>
            </condition>
          </progress>
        </search>

      <chart rejects="$show_html$">
        <title>Top sourcetypes for index=_internal</title>
        <search base="search_logic" />
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
      </chart>

      <html depends="$show_html$">
         <p style="color:blue;margin-left:30px;font-size:14px">Search returned no results, so we've hidden the chart!</p>
      </html>

      <html>
        <h3>Custom Logic Using Eval Expressions in Search</h3>

        <p>Leverage the new eval-based expression logic for both conditional matching as well as token setting.  Use this to define complex conditional matching, as well as token filtering/formatting.</p>

        <br/>

        <h4>Allow the use of eval expressions in &lt;condition&gt; elements in event handlers. </h4>
        <pre style="margin-left:30px"><![CDATA[
<condition match="[eval expression]>">
    ... actions ... 
</condition>]]></pre>

        <h4>Support &lt;eval&gt; element to compute tokens based on the result of eval expressions</h4>
        <pre style="margin-left:30px"><![CDATA[
<eval token="new_token">[eval expression]</eval>]]></pre>

        <br/>

        <h3>Reference code for above example:</h3>

        <pre><![CDATA[
        <search id="search_logic">
          <query>$index_switcher$ |  top sourcetype</query>
          <earliest>-60m@m</earliest>
          <latest>now</latest>
          <progress>
            <condition match="'job.resultCount' == 0">
              <set token="show_html">true</set>
            </condition>
            <condition>
              <unset token="show_html"/>
            </condition>
          </progress>
        </search>
          ]]>
        </pre>

      </html>
    </panel>
  </row>


</dashboard>