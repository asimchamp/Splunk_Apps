<%page args="module" />

<h1>Report Sending Schedules</h1>

<button type="button" class="splButton-primary" data-toggle="modal" data-target="#edit">New</button>

<div id="lookup_list">
    <table id="schedule_content_table" class="splTable">
	<thead>
            <tr>
                <th>Title</th><th>Attachment</th><th>URL</th><th>Address</th><th>Cron</th><th>Action</th>
            </tr>
	</thead>
        <tbody>
        </tbody>
    </table>
</div>

<style>
  td {
    max-width: 40em;
    overflow-wrap: break-word;
  }
</style>

<script src="${make_url(['/static/app/report_sender/js/lib/jquery.dataTables.min.js'])}"></script>
<script src="${make_url(['/static/app/report_sender/js/resource_loader.js'])}"></script>
<script language="javascript">

$("#new_schedule").click(function(){ document.location="new_schedule"; });

addStylesheet('/static/app/lookup_editor/css/lib/jquery.dataTables.css');
addStylesheet('/static/app/lookup_editor/css/SplunkDataTables.css');

function populateSchedules(data) {
    var app = Splunk.util.getCurrentApp();
    $('#schedule_content_table').dataTable().fnClearTable();

    var tbody = $('#schedule_content_table > tbody');
    
    data.forEach(function (d) {
        var tr = $('<tr/>');
        tbody.append(tr);
        tr.append('<td>'+d.title+'</td>');
        tr.append('<td>'+d.attachment+'</td>');
        tr.append('<td>'+d.url+'</td>');
        tr.append('<td>'+d.email+'</td>');
        tr.append('<td>'+d.cron+'</td>');
        tr.append('<td>'+'<a class="btn" href="#">Remove</a>'+'</td>');
        tr.append('</tr>');
        tr.find('a.btn').click(function () {
            $.ajax({
                url: Splunk.util.make_url('/splunkd/servicesNS/nobody/' + app + '/storage/collections/data/reportschedule/' + d._key),
                type: 'DELETE'
            })
            .done(function () {
                d.op = 'remove';
                $.post(Splunk.util.make_url('/custom/report_sender/schedule_editor/manage_schedule'), d);
                tr.remove();
            });
        });
    });

    $('#schedule_content_table').dataTable({
        "bPaginate": true,
        "bLengthChange": true,
        "bFilter": true,
        "bSort": false,
        "bInfo": false,
        "bAutoWidth": false,
        "sPaginationType": "full_numbers",
        bDestroy: true
    });
}

function getSchedules() {
    var app = Splunk.util.getCurrentApp();
    var uri = Splunk.util.make_url('/splunkd/servicesNS/nobody/' + app + '/storage/collections/data/reportschedule');

    $.getJSON(uri)
        .done(populateSchedules)
        .fail(function () {
            alert('Unable to get kv store data');
        });
}

$(document).ready(function () {
    getSchedules();
    var app = Splunk.util.getCurrentApp();

    var kvstore_url = Splunk.util.make_url('/splunkd/servicesNS/nobody/' + app + '/storage/collections/data/reportschedule');
    var cron_url = Splunk.util.make_full_url('/custom/report_sender/schedule_editor/manage_schedule');

    $('#save').on('click.dismiss.modal', function (e) {
        var schedule = {};
        $('#edit input').each(function () {
            schedule[this.name] = this.value;
        });

        schedule.op = 'add';
        schedule.key = new Date().getTime();
        $.post(cron_url, schedule)
            .done(function (d) {
                console.log(schedule);
                $.ajax({
                    url: kvstore_url,
                    type: 'POST',
                    data: JSON.stringify(schedule),
                    contentType: 'application/json',
                    dataType: 'json'
                }).done(function () {
                    $('div#edit input').clearInputs();
                    getSchedules();
                });
            });
    });

});
</script>

<div class="splunk-components">
    <div id="edit" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Add/Edit Schedule</h3>
        </div>
        <div class="modal-body">
            <label>Title:</label>
            <input type="text" name="title" />
            <label>Attachment:</label>
            <input type="text" name="attachment" />
            <label>URL:</label>
            <input type="text" name="url" />
            <label>Email:</label>
            <input type="email" name="email" />
            <label>Crontab:</label>
            <input type="text" name="cron" />
        </div>
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
            <button class="btn btn-primary" data-dismiss="modal" id="save" aria-hidden="true">Save</button>
        </div>
    </div>
</div>

