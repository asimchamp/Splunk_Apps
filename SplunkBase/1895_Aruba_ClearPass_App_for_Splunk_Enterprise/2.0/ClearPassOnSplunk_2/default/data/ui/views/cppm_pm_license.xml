<form>
  <label>Policy Manager License Indicator</label>
  <description>Indication of PM License Usage</description>

  <fieldset autoRun="True" submitButton="true">
    <input type="checkbox" token="servers">
      <label>ClearPass Servers</label>
      <delimiter> OR </delimiter>
      <valuePrefix>cphost=</valuePrefix>
      <prefix>(</prefix>
      <suffix>)</suffix>
      <populatingSearch fieldForValue="cphost" fieldForLabel="cphost">
        <![CDATA[eventtype=cppm earliest=-30d@d latest=@d | stats count by cphost]]>
      </populatingSearch>
    </input>

  </fieldset>
  
      <searchTemplate>
  eventtype=cppm-pass-authentication $servers$ earliest=-36d@d latest=-30d@d | eval daycnt=1 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt  |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-35d@d latest=-29d@d | eval daycnt=2 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-34d@d latest=-28d@d | eval daycnt=3 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-33d@d latest=-27d@d | eval daycnt=4 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-32d@d latest=-26d@d | eval daycnt=5 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-31d@d latest=-25d@d | eval daycnt=6 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-30d@d latest=-24d@d | eval daycnt=7 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-29d@d latest=-23d@d | eval daycnt=8 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-28d@d latest=-22d@d | eval daycnt=9 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-27d@d latest=-21d@d | eval daycnt=10 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-26d@d latest=-20d@d | eval daycnt=11 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-25d@d latest=-19d@d | eval daycnt=12 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-24d@d latest=-18d@d | eval daycnt=13 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-23d@d latest=-17d@d | eval daycnt=14 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-22d@d latest=-16d@d | eval daycnt=15 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-21d@d latest=-15d@d | eval daycnt=16 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-20d@d latest=-14d@d | eval daycnt=17 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-19d@d latest=-13d@d | eval daycnt=18 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-18d@d latest=-12d@d | eval daycnt=19 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-17d@d latest=-11d@d | eval daycnt=20 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-16d@d latest=-10d@d | eval daycnt=21 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-15d@d latest=-9d@d | eval daycnt=22 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-14d@d latest=-8d@d | eval daycnt=23 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-13d@d latest=-7d@d | eval daycnt=24 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-12d@d latest=-6d@d | eval daycnt=25 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-11d@d latest=-5d@d | eval daycnt=26 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-10d@d latest=-4d@d | eval daycnt=27 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-9d@d latest=-3d@d | eval daycnt=28 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-8d@d latest=-2d@d | eval daycnt=29 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] |
 append [ search eventtype=cppm-pass-authentication $servers$ earliest=-7d@d latest=-1d@d | eval daycnt=30 | fields mac_address, daycnt | stats dc(mac_address) as mac_count by daycnt ] | sort by daycnt | 
 streamstats avg(mac_count) as avg_mac_count
      </searchTemplate>

  <row>
    <single>
      <searchString>
        eventtype=cppm-pass-authentication $servers$ earliest=@d latest=@d | dedup mac_address | stats count 
      </searchString>
      <option name="underLabel">Today's Unique MAC Count</option>
    </single>
    <single>
      <searchString>
        eventtype=cppm-pass-authentication $servers$ earliest=-7d@d latest=@d | dedup mac_address | stats count as 7DayTotal
      </searchString>
      <option name="underLabel">7-Day Unique MAC Count</option>
    </single>
    <single>
      <searchPostProcess>
 	search daycnt=30 |fields  avg_mac_count | eval avg_mac_count=round(avg_mac_count) 
      </searchPostProcess>
      <option name="underLabel">7-Day Unique MAC Count (30 DAY AVG)</option>
    </single>
  </row>
  <row>
    <chart>
      <title>Past Week Unique MACs - chart</title>
      <searchString>
	eventtype=cppm-pass-authentication  $servers$ earliest=-7d@d latest=@d  |  bin _time span=1d | stats values(mac_address) as macs dc(mac_address) as c1count by _time| streamstats dc(macs) as c2count|fields _time, c2count| rename c2count as "Cumulative New Macs" | rename c2count as "Cumulative New Macs"
      </searchString>
      <option name="charting.chart">column</option>
    </chart>
    <table>
      <title>Past Week Unique MACs - table</title>
      <searchString>
	eventtype=cppm-pass-authentication  $servers$ earliest=-7d@d latest=@d  |  bin _time span=1d | stats values(mac_address) as macs dc(mac_address) as c1count by _time| streamstats dc(macs) as c2count|fields _time, c2count| rename c2count as "Cumulative New Macs" 
      </searchString>
    </table>
  </row>

  <row>
    <chart>
      <title>30 DAY AVG Unique MAC Count - Chart</title>
      <searchPostProcess>
 	table daycnt, avg_mac_count, mac_count | eval avg_mac_count=round(avg_mac_count) | rename avg_mac_count as "Running Avg Since Day 1"| rename daycnt as DAY | rename mac_count as "Day's Trailing 7 Day Mac Count"
      </searchPostProcess>
      <option name="charting.chart">line</option>
    </chart>

    <table>
      <title>30 DAY AVG Unique MAC Count - Table</title>
      <searchPostProcess>
 	table daycnt, avg_mac_count, mac_count | eval avg_mac_count=round(avg_mac_count) | rename avg_mac_count as "Running Avg Since Day 1"| rename daycnt as DAY | rename mac_count as "Day's Trailing 7 Day Mac Count"
      </searchPostProcess>
    </table>
  </row>

</form>

