<form>
  <label>Search Head Utilization by User</label>
  <fieldset submitButton="true">
    <input searchWhenChanged="true" token="timepicked" type="time">
      <label>Time</label>
      <default>
        <earliestTime>-60m@m</earliestTime>
        <latestTime>now</latestTime>
      </default>
    </input>
    <input searchWhenChanged="true" token="host" type="dropdown">
      <label>Splunk Server</label>
      <default>*</default>
      <choice value="*">All</choice>
      <earliestTime>$timepicked.earliest$</earliestTime>
      <latestTime>$timepicked.latest$</latestTime>
      <populatingSearch fieldForLabel="host" fieldForValue="host">index=_audit action=search (id=* OR search_id=*) | fields host | dedup host | table host | sort host</populatingSearch>
    </input>
  </fieldset>
  <row>
    <panel>
      <table>
        <title>Total Run Time and Search Count by User (Ad-Hoc Only) (Drill-down to see searches)</title>
        <search>
          <query>index=_audit action=search (id=* OR search_id=*) host=$host$ | eval search_id = if(isnull(search_id), id, search_id) | replace '*' with * in search_id |  rex "search='(?&lt;search&gt;.*?)', autojoin" | search search_id!=scheduler_* | convert num(total_run_time) | eval user = if(user="n/a", null(), user) | stats min(_time) as _time first(user) as user max(total_run_time) as total_run_time, max(result_count) as result_count, first(search) as search by search_id | search search=search* search!=*_internal* search!=*_audit* | eval total_run_time_min=round(total_run_time/60,2) | stats sum(total_run_time_min) as "Total Run Time Minutes", sum(result_count) as result_count, count(search_id) as "Total Searches" by user | search user!="splunk-system-user" | rename user as User, _time as "Time", result_count as "Total Result Count" | sort -"Total Run Time Minutes"</query>
          <earliest>$timepicked.earliest$</earliest>
          <latest>$timepicked.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">row</option>
        <option name="count">10</option>
        <drilldown>
          <set token="user_clicked">$click.value$</set>
        </drilldown>
      </table>
    </panel>
    <panel>
      <table depends="$user_clicked$">
        <title>Splunk Account Information for $user_clicked$</title>
        <search>
          <query>| rest /services/authentication/users/ | search title=$user_clicked$ | fields title realname email roles type splunk_server | table title realname email roles type splunk_server | dedup title realname email roles type splunk_server | fields - count | rename title as User, realname as "Real Name", email as "Email Address", roles as "Splunk Roles", type as "Account Type", splunk_server as "Splunk Server"</query>
          <earliest>$timepicked.earliest$</earliest>
          <latest>$timepicked.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="drilldown">none</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table depends="$user_clicked$">
        <title>Searches Executed by $user_clicked$ (Ad-Hoc Only)</title>
        <search>
          <query>index=_audit action=search (id=* OR search_id=*) host=* | eval search_id = if(isnull(search_id), id, search_id) | replace '*' with * in search_id |  rex "search='(?&lt;search&gt;.*?)', autojoin" | search search_id!=scheduler_* | convert num(total_run_time) | eval user = if(user="n/a", null(), user) | search user="$user_clicked$" | stats min(_time) as _time first(user) as user max(total_run_time) as total_run_time, max(result_count) as result_count, first(search) as search by search_id | search search=search* search!=*_internal* search!=*_audit* | eval total_run_time_min=round(total_run_time/60,2) | stats sum(total_run_time_min) as trtm, max(result_count) as result_count by user search | table user trtm result_count search | rename user as "User", result_count as "Result Count", trtm as "Total Run Time Minutes", search as "Search" | sort -"Total Run Time Minutes"</query>
          <earliest>$timepicked.earliest$</earliest>
          <latest>$timepicked.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="drilldown">cell</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>Top 100 Most Expensive Searches by Search and User</title>
        <search>
          <query>index=_audit (host="*" OR splunk_server=local) action=search (id=* OR search_id=*) | eval search_id=if(isnull(search_id), id, search_id) | replace '*' with * in search_id | search search_id!=rt_* search_id!=searchparsetmp* | rex "search='(?&lt;search&gt;.*?)', autojoin" | rex "savedsearch_name=\"(?&lt;savedsearch_name&gt;.*?)\"\]\[" |  eval search=case(isnotnull(search),search,isnull(search) AND savedsearch_name!="","Scheduled search name : ".savedsearch_name,isnull(search) AND savedsearch_name=="","SID : ".search_id) | convert num(total_run_time) |  eval user = if(user="n/a", "nobody", user) | stats min(_time) as _time last(user) as user max(total_run_time) as total_run_time last(search) as search by search_id  | search search_id=* search!=typeahead* search!="|history*" search!=*_internal* search!=*_audit* | search search_id!=subsearch_* | sort - total_run_time | rename total_run_time as "Search Run Time" | fields - search_id | head 100 | eval _time=strftime(_time, "%Y-%m-%dT%H:%M:%S%z") | rename user as User, search as Search, _time as Time</query>
          <earliest>$timepicked.earliest$</earliest>
          <latest>$timepicked.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
</form>