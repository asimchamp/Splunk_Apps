{% extends "sentry:template/sentry_base_with_full_controls_no_unhide.html" %}

{% load splunkmvc %}

{% block title %}{{app_name}} | Lookup{% endblock title %}
{% block css %}
    <!-- Style sheets are loaded here -->
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}{{app_name}}/custom.css" />
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}splunkjs/css/dashboard.css" />
    <style>
        
    </style>
{% endblock css %}

{% block sentry_header %}
<div class="dashboard-body container-fluid main-section-body" data-role="main">
        <div class="span12 dashboard-header clearfix">
            <h2>Lookup</h2>
        </div>
{% endblock sentry_header %}

{% block content %}
    <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 33.33%;">
            <div class="dashboard-panel">
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="tableEmployeeDemographics" style="width: 100%">
                        <div class="panel-head">
                            <h3>Employee Demographics</h3>
                        </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="dashboard-cell" style="width: 33.33%;">
            <div class="dashboard-panel">
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="tableCustomerDemographics" style="width: 100%">
                        <div class="panel-head">
                            <h3>Customer Demographics</h3>
                        </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="dashboard-cell" style="width: 33.33%;">
            <div class="dashboard-panel">
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="tableCEDemographics" style="width: 100%">
                        <div class="panel-head">
                            <h3>Customer's Employee Demographics</h3>
                        </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 33.33%;">
            <div class="dashboard-panel">
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="tableReports" style="width: 100%">
                        <div class="panel-head">
                            <h3>Matching Reports</h3>
                        </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="dashboard-cell" style="width: 33.33%;">
            <div class="dashboard-panel">
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="chartEmpEnc" style="width: 100%">
                        <div class="panel-head">
                            <h3>Number of Customers Viewed by Employee</h3>
                        </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="dashboard-cell" style="width: 33.33%;">
            <div class="dashboard-panel">
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="chartCustEnc" style="width: 100%">
                        <div class="panel-head">
                            <h3>Employees Accessing Customer</h3>
                        </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel">
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="tableAccessLogs" style="width: 100%">
                        <div class="panel-head">
                            <h3>Access Logs</h3>
                        </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content%}

{% block managers %}
        
    {% searchmanager
        id="searchAccessLogs"
        search='index="sentry" user_id="$selUserID$" cust_id="$selCustID$" app="$selApp$" | `emp_demo` | `cust_demo` | lookup metrics metric_id OUTPUTNEW metric_description | fields access_time,app,access_type,metric_name,metric_description,user_id,cust_id,emp_name,emp_job_title,emp_hr_dept,cust_name,workstation_id'|token_safe
        earliest_time="$earlyTime$"|token_safe
        latest_time="$lateTime$"|token_safe
        autostart=false
    %}
    {% searchmanager
        id="searchMiscLogs"
        search='index="sentry" cube="epic_btg" user_id="$selUserID$" cust_id="$selCustID$" app="$selApp$" | fields btg_time, user_id, cust_id, emp_last_name, emp_first_name, emp_job_title, emp_hr_dept, cust_last_name, cust_first_name,  btg_reason, btg_explanation'|token_safe
        earliest_time="$earlyTime$"|token_safe
        latest_time="$lateTime$"|token_safe
        autostart=false
    %}
    {% searchmanager
        id="searchCustomerDemographics"
        search='index=sentry cust_id="$selCustID$" | head 1 | eval demouser=if("$selCustID$"="*", "NULL", "$selCustID$") | where lower(cust_id) = lower(demouser) |  eval "Customer Name" = cust_last_name + ", " + cust_first_name | eval "Address Line 1" = cust_addr_line1 | eval "Address Line 2" = cust_addr_line2 | eval "City, State Zip" = cust_city + ", " + cust_state + " " + cust_zip | eval "SSN" = "***-**-" + cust_ssn_last4 | rename cust_id AS "Customer ID", cust_home_phone AS "Home Phone", cust_work_phone AS "Work Phone", cust_birth_date AS "Birth Date", cust_pcp AS "PCP User ID" | table "Customer ID", "Customer Name", "SSN", "Birth Date", "Address Line 1", "Address Line 2", "City, State Zip", "Home Phone", "Work Phone", "PCP User ID" | transpose | rename column AS Attribute, "row 1" AS Value'|token_safe
        autostart=false
    %}
    {% searchmanager
        id="searchEmployeeDemographics"
        search='index=sentry user_id="$selUserID$" | head 1 | eval demouser=if("$selUserID$"="*", "NULL", "$selUserID$") | where lower(user_id) = lower(demouser) | eval "Employee Name" = emp_last_name + ", " + emp_first_name | eval SSN = "***-**-" + emp_ssn_last4 | eval "City, State Zip" = emp_city + ", " + emp_state + " " + emp_zip | eval "Manager\'s Name" = mgr_last_name + ", " + mgr_first_name | eval "Facility, Org, Type" = emp_facility + ", " + emp_org + ", " + emp_type | rename user_id AS "User ID", emp_job_title AS "Job Title", emp_dept AS "Department", emp_hr_dept AS "HR Department", emp_birthdate AS "Birth Date", emp_phone AS "Phone", emp_addr_line1 AS "Address Line 1", emp_addr_line2 AS "Address Line 2", emp_mailstop AS "Mail Stop" | table "User ID", "Employee Name", SSN, "Birth Date", "Address Line 1", "Address Line 2", "City, State Zip", "Job Title", Department, "HR Department", "Facility, Org, Type", Phone, "Mail Stop", "Manager\'s Name" | transpose | rename column AS Attribute, "row 1" AS Value'|token_safe
        autostart=false
    %}
    {% searchmanager
        id="searchCEDemographics"
        search='| inputlookup cust_is_emp | eval democust=if("$selCustID$"="*", "NULL", "$selCustID$") | where lower(cust_id) = lower(democust) | eval "Manager\'s Name" = cust_mgr_last_name + ", " + cust_mgr_first_name | rename cust_job_title AS "Job Title", cust_dept AS "Department", cust_hr_dept AS "HR Department", cust_facility AS "Facility", cust_mailstop AS "Mail Stop", cust_org AS "Organization", cust_type AS "Employee Type", cust_user_id AS "User ID" | fields "User ID" "Job Title" Department "HR Department" "Facility" "Mail Stop" Organization "Employee Type" "Manager\'s Name" | transpose | rename column AS Attribute, "row 1" AS Value'|token_safe
        autostart=false
    %}
    {% searchmanager
        id="searchReports"
        search='index=sentry_summary report=* user_id="$selUserID$" cust_id="$selCustID$" app="$selApp$" | stats count AS match_count by app, user_id cust_id report'|token_safe
        earliest_time="$earlyTime$"|token_safe
        latest_time="$lateTime$"|token_safe
        autostart=false
    %}
    {% searchmanager
        id="searchEmpEnc"
        search='index=sentry user_id="$selUserEmpCustEnc$" cust_id="*" app="$selApp$" | timechart dc(cust_id) by user_id'|token_safe
        earliest_time="$earlyTime$"|token_safe
        latest_time="$lateTime$"|token_safe
        autostart=false
    %}
    {% searchmanager
        id="searchCustEnc"
        search='index=sentry user_id="*" cust_id="$selCustEmpCustEnc$" app="$selApp$" emp_first_name!="-" | timechart count by user_id'|token_safe
        earliest_time="$earlyTime$"|token_safe
        latest_time="$lateTime$"|token_safe
        autostart=false
    %}
{% endblock managers %}

{% block js %}
<script>
	require(["splunkjs/mvc"], function() {
	    require.config({
	        baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
	        waitSeconds: 0 // Disable require.js load timeout 
	    });
	
		require(["splunkjs/ready!", 
	             "splunkjs/mvc/simplexml/element/table",
	             "splunkjs/mvc/simplexml/element/chart"], function(mvc, TableElement, ChartElement) {
	    	
	        // Initialization 
	
	        if (!paramsExist){
	        	// Set the default time range 
	        	timerange.val({"earliest_time": "-7d@h", "latest_time": "now"});
	        }
	        
	        // Set default for the App dropdown 
	        dropdownTriageApp.settings.set("default", "*");
	        
	        // Set default for the App dropdown 
	        dropdownApp.settings.set("default", "*");
	
	
	        searches.push(mvc.Components.getInstance("searchAccessLogs"));
	        searches.push(mvc.Components.getInstance("searchMiscLogs"));
	        searches.push(mvc.Components.getInstance("searchCustomerDemographics"));
	        searches.push(mvc.Components.getInstance("searchCEDemographics"));
	        searches.push(mvc.Components.getInstance("searchEmployeeDemographics"));
	        searches.push(mvc.Components.getInstance("searchReports"));
	        searches.push(mvc.Components.getInstance("searchEmpEnc"));
	        searches.push(mvc.Components.getInstance("searchCustEnc"));
	
	
	        // Views
	
	        var tableEmployeeDemographics = new TableElement({
	            "id": "tableEmployeeDemographics",
	            "managerid": "searchEmployeeDemographics",
	            "fields": "Attribute,Value",
	            "pageSize": "20",
	            "drilldown": "none",
	            "link.visible": false,
	            "el": $('#tableEmployeeDemographics')
	        }, {tokens: true}).render();
	
	        var tableCEDemographics = new TableElement({
	            "id": "tableCEDemographics",
	            "managerid": "searchCEDemographics",
	            "fields": "Attribute,Value",
	            "pageSize": "20",
	            "drilldown": "none",
	            "link.visible": false,
	            "el": $('#tableCEDemographics')
	        }, {tokens: true}).render();
	
	        var tableCustomerDemographics = new TableElement({
	            "id": "tableCustomerDemographics",
	            "managerid": "searchCustomerDemographics",
	            "fields": "Attribute,Value",
	            "pageSize": "20",
	            "drilldown": "none",
	            "link.visible": false,
	            "el": $('#tableCustomerDemographics')
	        }, {tokens: true}).render();
	
	        var tableReports = new TableElement({
	            "id": "tableReports",
	            "managerid": "searchReports",
	            "fields": "match_count app user_id cust_id report",
	            "pageSize": "20",
	            "drilldown": "none",
	            "link.inspectSearch.visible": false,
	            "link.openSearch.visible": false,
	            "el": $('#tableReports')
	        }, {tokens: true}).render();
		
	        var chartEmpEnc = new ChartElement({
	            "id": "chartEmpEnc",
	            "managerid": "searchEmpEnc",
	            "charting.chart": "column",
	            "charting.legend.placement": "bottom",
	            "charting.axisTitleY.text": "Customer Count",
	            "charting.axisTitleX.visibility": "collapsed",
	            "link.visible": false,
	            "drilldown": "none",
	            "el": $('#chartEmpEnc')
	        }, {tokens: true}).render();
	
	        var chartCustEnc = new ChartElement({
	            "id": "chartCustEnc",
	            "managerid": "searchCustEnc",
	            "charting.chart": "column",
	            "charting.legend.placement": "bottom",
	            "charting.axisTitleY.text": "Access Count",
	            "charting.axisTitleX.visibility": "collapsed",
	            "link.visible": false,
	            "drilldown": "none",
	            "el": $('#chartCustEnc')
	        }, {tokens: true}).render();
	
	        var tableAccessLogs = new TableElement({
	            "id": "tableAccessLogs",
	            "managerid": "searchAccessLogs",
	            "fields": "access_time,app,access_type,metric_name,metric_description,user_id,cust_id,emp_name,emp_job_title,emp_hr_dept,cust_name,workstation_id",
	            "pageSize": "20",
	            "drilldown": "none",
	            "link.inspectSearch.visible": false,
	            "link.openSearch.visible": false,
	            "displayRowNumbers": true,
	            "el": $('#tableAccessLogs')
	        }, {tokens: true}).render();
	

	    });
    });
</script>
{% endblock js %}
