{% extends "sentry:template/sentry_base_with_full_controls.html" %}

{% load splunkmvc %}

{% block title %}{{app_name}} | Relation - Personal{% endblock title %}
{% block css %}
    <!-- Style sheets are loaded here -->
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}{{app_name}}/custom.css" />
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}splunkjs/css/dashboard.css" />
    <style>

    </style>
{% endblock css %}

{% block sentry_header %}
<div class="dashboard-body container-fluid main-section-body" data-role="main">
        <div class="span12 dashboard-header clearfix">
            <h2>Relation: Personal</h2>
        </div>
{% endblock sentry_header %}

{% block content %}
    <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel">
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="tableEVS" style="width: 100%">
                        <div class="panel-head">
                           <!-- <h3>Employee Viewing Self</h3> -->
                       </div>
                       <div class="heading_wrapper">
	                    <span class="heading_3">Employee Viewing Self</span>
	                    <div id="help_icon" class="eyeIcon">i
			        <div id="help_info_outer" class="custom-dropdown-menu hidden">
			            <div id="help_info_inner" class="custom-dropdown-msg">
			                     evs is a weighted aggregate score looking for matches in:<br>
                                             - First Name, Last Name, Address Line 1, Address Line 2 and SSN Last 4.
				    </div>
			        </div>
			    </div>
	                </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel">
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="tableLNM" style="width: 100%">
                        <div class="panel-head">
                            <!--<h3>Employee Viewing Last Name</h3>-->
	                   	</div>
                            <div class="heading_wrapper">
	                            <span class="heading_3">Employee Viewing Last Name</span>
	                            <div id="help_icon" class="eyeIcon">i
			                        <div id="help_info_outer" class="custom-dropdown-menu hidden">
				                        <div id="help_info_inner" class="custom-dropdown-msg">
				                            lnm is a weighted aggregate score looking for matches in:<br>
			                                - Last Name.<br>
			                                - Common last names are reduced according the how common the name is.<br>
			                                - Weight is increased if Customer ID is within 20,000+/- from the employee's Customer ID.
				                        </div>
			                        </div>
			                    </div>
	                    	</div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content%}

{% block managers %}

    {% searchmanager
        id="searchEVS"
        search='index="sentry_summary" report="emp_view_self" user_id="$selUserID$" cust_id="$selCustID$" app="$selApp$" NOT [| inputlookup triage $includeTriaged$ | fields user_id, cust_id, app ] | sort -_time | table evs,access_time,app,access_type,metric_name,user_id,cust_id,emp_job_title,emp_hr_dept,emp_cust_name,emp_cust_ssn_last4,emp_cust_addr'|token_safe
        earliest_time="$earlyTime$"|token_safe
        latest_time="$lateTime$"|token_safe
        autostart=False
    %}
    {% searchmanager
        id="searchLNM"
        search='index="sentry_summary" report="emp_view_lastname" user_id="$selUserID$" cust_id="$selCustID$" app="$selApp$" NOT [| inputlookup triage $includeTriaged$ | fields user_id, cust_id, app ] | sort -lnm -access_count | table _time,initial_access,lnm,app,access_count,user_id,cust_id,emp_job_title,emp_hr_dept,emp_cust_name,emp_cust_addr'|token_safe
        earliest_time="$earlyTime$"|token_safe
        latest_time="$lateTime$"|token_safe
        autostart=False
    %}

{% endblock managers %}

{% block js %}
<script>
    require(["splunkjs/mvc"], function() {
	    require.config({
	        baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
	        waitSeconds: 0 // Disable require.js load timeout 
	    });

		require(["splunkjs/ready!", 
	             "splunkjs/mvc/simplexml/element/table"], function(mvc, TableElement) {
	                 
	        // Initialization 
	
	        // Set the default time range 
	        timerange.val({"earliest_time": "-7d@h", "latest_time": "now"});
	        
	        // Set default for the App dropdown 
	        dropdownTriageApp.settings.set("default", "*")
	        
	        // Set default for the App dropdown 
	        dropdownApp.settings.set("default", "*")
	
	        
	        searches.push(mvc.Components.getInstance("searchEVS"));
	        searches.push(mvc.Components.getInstance("searchLNM"));
	
	 
	        // Views 
	
	        var tableEVS = new TableElement({
	            "id": "tableEVS",
	            "managerid": "searchEVS",
	            "fields": "evs,access_time,app,access_type,metric_name,user_id,cust_id,emp_job_title,emp_hr_dept,emp_cust_name,emp_cust_ssn_last4,emp_cust_addr",
	            "pageSize": "15",
	            drilldownRedirect: false,
	            "link.inspectSearch.visible": false,
	            "link.openSearch.visible": false,
	            "el": $('#tableEVS')
	        }, {tokens: true}).render();
	
	        var tableLNM = new TableElement({
	            "id": "tableLNM",
	            "managerid": "searchLNM",
	            "fields": "initial_access,lnm,app,access_count,user_id,cust_id,emp_job_title,emp_hr_dept,emp_cust_name,emp_cust_addr",
	            "pageSize": "15",
	            drilldownRedirect: false,
	            "link.inspectSearch.visible": false,
	            "link.openSearch.visible": false,
	            "el": $('#tableLNM')
	        }, {tokens: true}).render();
	
	
	        // Event Handlers 
	
	        // Table EVS click
	        tableEVS.on("click", function(e) {
	        	var earlyTime = tokens.get("earlyTime");
	            var lateTime = tokens.get("lateTime");
	            var selApp = tokens.get("selApp");
	            redirector({'selUserID': e.data['row.user_id'], 'selCustID': e.data['row.cust_id'], 'selApp': e.data['row.app'], 'earlyTime': earlyTime, 'lateTime': lateTime}, 'lookup');
	        });
	
	        // Table LNM click
	        tableLNM.on("click", function(e) {
	        	var earlyTime = tokens.get("earlyTime");
	            var lateTime = tokens.get("lateTime");
	            var selApp = tokens.get("selApp");
	            redirector({'selUserID': e.data['row.user_id'], 'selCustID': e.data['row.cust_id'], 'selApp': e.data['row.app'], 'earlyTime': earlyTime, 'lateTime': lateTime}, 'lookup');
	        });
	
	    });
    });
</script>
{% endblock js %}

