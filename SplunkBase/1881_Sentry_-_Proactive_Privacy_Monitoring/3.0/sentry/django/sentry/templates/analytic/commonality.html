{% extends "sentry:template/sentry_base_with_full_controls.html" %}

{% load splunkmvc %}

{% block title %}{{app_name}} | Analytic - Commonality{% endblock title %}
{% block css %}
    <!-- Style sheets are loaded here -->
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}{{app_name}}/custom.css" />
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}splunkjs/css/dashboard.css" />
    <style>
		

    </style>
{% endblock css %}


{% block sentry_header %}
<div class="dashboard-body container-fluid main-section-body" data-role="main">
        <div class="span12 dashboard-header clearfix">
            <h2>Analytic: Commonality</h2>
        </div>
{% endblock sentry_header %}


{% block content %}
    <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel">
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="tableEVE" style="width: 100%">
                        <div class="panel-head">
                            <!--<h3>Employee Viewing Employee</h3>-->
	                   	</div>
                            <div class="heading_wrapper">
	                            <span class="heading_3">Employee Viewing Employee</span>
	                            <div id="help_icon" class="eyeIcon">i
			                        <div id="help_info_outer" class="custom-dropdown-menu hidden">
				                        <div id="help_info_inner" class="custom-dropdown-msg">
				                            This report looks at access between an Employee and another Employee when the viewing employee is the only 
			                                one to access the customer/employee record that day.<br>
			                                - These results do not include interactions where IP_NOTES are present.<br>
			                                - A metric ratio is used which is the access_count divided by the uniq metric count and it is multiplied
			                                by the access_count.<br>
			                                - The eve score is bumped up when there is employee to customer/employee demographic commonality and compares
			                                the following attributes: Facility, Manager Name, Mailstop, Department, HR Department, Job Title.<br>
			                                - Only scores that are above 50 are displayed.
							                        </div>
			                        </div>
			                    </div>
	                    	</div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 30%;">
            <div class="dashboard-panel">
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="tableWC" style="width: 100%">
                        <div class="panel-head">
                            <!--<h3>Employee Viewing Last Name</h3>-->
                        </div>
                            <div class="heading_wrapper">
	                            <span class="heading_3">Employee Walking Customer IDs</span>
	                            <div id="help_icon" class="eyeIcon">i
			                        <div id="help_info_outer" class="custom-dropdown-menu hidden">
				                        <div id="help_info_inner" class="custom-dropdown-msg">
				                            Customer ID walking is when two records are viewed and the Customer ID's are +-20 from each other.<br>
		                                The left side displays the user_id and the number of "Cust ID Walks" by that employee.<br>
		                                To view additional details on Customer ID walking click the left side and the detail view will update.<br>
		                                The cust_delta column shows the difference between itself and the previous record by Customer ID sort.  It will not show any value if the cust_delta is greater than 20.
				                        </div>
			                        </div>
			                    </div>
	                    	</div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="dashboard-cell" style="width: 70%;">
            <div class="dashboard-panel">
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="tableWCD" style="width: 100%">
                        <div class="panel-head">
                            <h3>Employee Walking Customer IDs Detail</h3>
                        </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content%}

{% block managers %}
	
    {% searchmanager
        id="searchEVE"
        search='index="sentry_summary" report="emp_view_emp" user_id="$selUserID$" cust_id="$selCustID$" app="$selApp$" NOT [| inputlookup triage $includeTriaged$ | fields user_id, cust_id, app ] | sort -eve | table _time eve access_count uniq_metrics access_start app user_id cust_id emp_name cust_name emp_cust_job_title emp_cust_dept emp_cust_hr_dept emp_cust_facility emp_cust_mailstop emp_cust_mgr'|token_safe
        earliest_time="$earlyTime$"|token_safe
        latest_time="$lateTime$"|token_safe
        autostart=False
    %}
	{% searchmanager
        id="searchWC"
        search='index="sentry_summary" report="cust_walk_count" user_id="$selUserID$" app="$selApp$" NOT [| inputlookup triage $includeTriaged$ | fields user_id app] | table date app user_id walk_count | sort -date -walk_count'|token_safe
        earliest_time="$earlyTime$"|token_safe
        latest_time="$lateTime$"|token_safe
        autostart=False
    %}
    {% searchmanager
        id="searchWCD"
        search='index="sentry" user_id="$selWUserID$" app="$selWApp$" | where  match(access_time, "$selWDate$") | transaction user_id cust_id app | `emp_demo` | `cust_demo` | eval access_start = if(isnull(mvindex(access_time, 1)), access_time, mvindex(access_time,1)) | fields access_start app user_id cust_id emp_name emp_job_title cust_name | sort -date cust_id | delta cust_id AS cust_delta | eval cust_delta=if(cust_delta > 20 OR isnull(cust_delta), "", cust_delta)'|token_safe
        earliest_time="$earlyTime$"|token_safe
        latest_time="$lateTime$"|token_safe
        autostart=True
    %}


{% endblock managers %}

{% block js %}
<script>
    require(["splunkjs/mvc"], function() {
	    require.config({
	        baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
	        waitSeconds: 0 // Disable require.js load timeout 
	    });

		require(["splunkjs/ready!", 
	             "splunkjs/mvc/simplexml/element/table"], function(mvc, TableElement) {
	        
	        // Initialization 
	
	        // Set the default time range 
	        timerange.val({"earliest_time": "-7d@h", "latest_time": "now"});
	        
	        // Set default for the App dropdown 
	        dropdownTriageApp.settings.set("default", "*");
	        
	        // Set default for the App dropdown 
	        dropdownApp.settings.set("default", "*");
	
	        
	        searches.push(mvc.Components.getInstance("searchEVE"));
	        searches.push(mvc.Components.getInstance("searchWC"));
	        searches.push(mvc.Components.getInstance("searchWCD"));
	
	 
	        // Views 
	
	        var tableEVE = new TableElement({
	            "id": "tableEVE",
	            "managerid": "searchEVE",
	            "fields": "eve,access_count,uniq_metrics,access_start,app,user_id,cust_id,emp_name,cust_name,emp_cust_job_title,emp_cust_dept,emp_cust_hr_dept,emp_cust_facility,emp_cust_mailstop,emp_cust_mgr",
	            "pageSize": "20",
	            "drilldownRedirect": false,
	            "link.inspectSearch.visible": false,
	            "link.openSearch.visible": false,
	            "el": $('#tableEVE')
	        }, {tokens: true}).render();
	
	        var tableWC = new TableElement({
	            "id": "tableWC",
	            "managerid": "searchWC",
	            "fields": "date,app,user_id,walk_count",
	            "pageSize": "15",
	            "drilldownRedirect": false,
	            "link.inspectSearch.visible": false,
	            "link.openSearch.visible": false,
	            "el": $('#tableWC')
	        }, {tokens: true}).render();
	
	        var tableWCD = new TableElement({
	            "id": "tableWCD",
	            "managerid": "searchWCD",
	            "fields": "access_start user_id emp_name emp_job_title cust_name cust_id cust_delta",
	            "pageSize": "15",
	            "drilldownRedirect": false,
	            "link.inspectSearch.visible": false,
	            "link.openSearch.visible": false,
	            "el": $('#tableWCD')
	        }, {tokens: true}).render();
	        
	        
	        // Event Handlers 
	
	        // Table EVE click 
	        tableEVE.on("click", function(e) {
	        	var earlyTime = tokens.get("earlyTime");
	            var lateTime = tokens.get("lateTime");
	            var selApp = tokens.get("selApp");
	            redirector({'selUserID': e.data['row.user_id'], 'selCustID': e.data['row.cust_id'], 'selApp': e.data['row.app'], 'earlyTime': earlyTime, 'lateTime': lateTime}, 'lookup');
	        });
	
	     	// Table WC click
	        tableWC.on("click", function(e) {
	            tokens.set({"selWDate": e.data['row.date']});
	            tokens.set({"selWUserID": e.data['row.user_id']});
	            tokens.set({"selWApp": e.data['row.app']});
	            search_wcd.startSearch();
	        });
	
	        // Table LNM click
	        tableWCD.on("click", function(e) {
	        	var earlyTime = tokens.get("earlyTime");
	            var lateTime = tokens.get("lateTime");
	            var selApp = tokens.get("selApp");
	            redirector({'selUserID': e.data['row.user_id'], 'selCustID': e.data['row.cust_id'], 'selApp': e.data['row.app'], 'earlyTime': earlyTime, 'lateTime': lateTime}, 'lookup');
	        });
	        
		});
    });
</script>
{% endblock js %}

