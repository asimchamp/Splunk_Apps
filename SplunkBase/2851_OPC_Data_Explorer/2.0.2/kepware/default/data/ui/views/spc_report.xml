<form>
  <label>SPC Report</label>
  <fieldset submitButton="false" autoRun="true">
    <input type="dropdown" token="part">
      <label>PartSelector</label>
      <search>
        <query>sourcetype=opc Tag = "*Widget1*Assy*Out_Torq*" | stats Values(Tag) as Tag | mvexpand Tag</query>
      </search>
      <fieldForLabel>Tag</fieldForLabel>
      <fieldForValue>Tag</fieldForValue>
      <default>Widget1.Assy.Out_Torq1_val1</default>
    </input>
    <input type="time" token="timeRange">
      <label>Timerange</label>
      <default>
        <earliest>@d</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="link" token="viewSelector" searchWhenChanged="true">
      <label>View Selector</label>
      <choice value="dashboard">Dashboard</choice>
      <choice value="spc">SPC Manual</choice>
      <default>Dashboard</default>
      	<change>
          <condition value ="dashboard">
            <set token="showDashboard">true</set>
            <set token="showManual">false</set>
          </condition>
          <condition value ="spc">
            <set token="showDashboard">false</set>
            <set token="showManual">true</set>
          </condition>
      	</change>
    </input>
  </fieldset>
  <row>
    <panel depends = "$showDashboard$">
      <title>Distribution of Pass and Fail</title>
      <input type="text" token="dut">
        <label>Design Upper Tolerance</label>
        <default>590</default>
      </input>
      <input type="text" token="dlt">
        <label>Design Lower Tolerance</label>
        <default>450</default>
      </input>
      <chart>
        <search>
          <query>Tag = "$part$" Value &gt; 0 | Eval QC=if(Value &gt; $dlt$ AND Value &lt; $dut$, "PASS", "FAIL") | stats count(QC) by QC</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
    <panel depends = "$showDashboard$">
      <chart>
        <title>Historical Pass/Fail</title>
        <search>
          <query>Tag = "$part$" Value &gt; 0 | Eval QC=if(Value &gt; $dlt$ AND Value &lt; $dut$, "PASS", "FAIL") | timechart count(QC) by QC</query>
          <earliest>@d</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">collapsed</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked100</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
    <panel depends = "$showDashboard$">
      <html>
        <img src="../../static/app/kepware/images/SPLFormula.png"/>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>x-Bar and Range Chart Values</title>
        <search>
          <query>Tag = "$part$" Value &gt; 0 | stats count(Value) as n, avg(Value) as xBar, max(Value) as xMax, min(Value) as xMin | eval k=2 | eval A2=1.880 | eval d2=1.128 | eval D4=3.268 | eval range=xMax-xMin | eval rBar = Range/k | eval UCLx=xBar + A2*R | eval LCLx = xBar - A2*rBar | eval UCLr = D4*rBar</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
  <row>
    <panel depends = "$showDashboard$">
      <title>X-Chart</title>
      <chart>
        <search>
          <query>Tag = "$part$*" Value &gt; 0 | eval uppertol=$dut$ | eval lowertol=$dlt$ | eval nominal=(uppertol+lowertol)/2 | delta Value as Range | eval MR=abs(Range) | eventstats avg(Value) as Average, avg(MR) as AverageR | eval UCLx=Average+(2.66*AverageR) | eval LCLx=Average-(2.66*AverageR) | eval StDevR=AverageR/1.128 | rename Value as Actual | table _time, UCLx, LCLx, Average, Actual</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">collapsed</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel depends = "$showDashboard$">
      <title>Statistical Table</title>
      <table>
        <search>
          <query>Tag = "$part$*" Value &gt; 0 | eval uppertol=$dut$ | eval lowertol=$dlt$ | eval nominal=(uppertol+lowertol)/2 | delta Value as Range | eval MR=abs(Range) | eventstats avg(Value) as Average, avg(MR) as AverageR | eval UCLx=Average+(2.66*AverageR) | eval LCLx=Average-(2.66*AverageR) | eval StDevR=AverageR/1.128 | rename Value as Actual | table _time, UCLx, LCLx, Average, Actual</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="count">15</option>
      </table>
    </panel>
  </row>
  <row>
    <panel depends = "$showManual$">
      <title>SPC Formula</title>
      <html depends="$showEng$">
        <iframe width="100%" height="400px" src="../../static/app/kepware/documents/SPC_Formula.pdf"/>
      </html>
    </panel>
  </row>
</form>