<?xml version="1.0" encoding="UTF-8"?>
<view onUnloadCancelJob="True" template="dashboard.html">
	<label>Administrator Audit</label>
	<module name="AccountBar" layoutPanel="appHeader" />
	<module name="AppBar" layoutPanel="appHeader" />
	<module name="SideviewUtils" layoutPanel="appHeader" />

	<module name="Message" layoutPanel="messaging">
		<param name="filter">*</param>
		<param name="clearOnJobDispatch">False</param>
		<param name="maxSize">1</param>
	</module>

	<module name="TitleBar" layoutPanel="viewHeader"/>

	<module name="URLLoader" layoutPanel="panel_row1_col1">
		<module name="TimeRangePicker" layoutPanel="panel_row1_col1_grp1" autoRun="True">
			<param name="default">Last 24 hours</param>
			<param name="searchWhenChanged">True</param>
			
			<module name="Search">
				<param name="search"><![CDATA[eventtype=msad-admin-audit NOT src_nt_domain="NT AUTHORITY"|stats count by src_user,src_nt_domain]]></param>
				<module name="Pulldown" layoutPanel="panel_row1_col1_grp2">
					<param name="name">src_nt_domain</param>
					<param name="label">Account Domain:</param>
					<param name="postProcess">$postProcess$|dedup $name$|sort $name$</param>
					<param name="staticFieldsToDisplay"></param>
					<param name="searchFieldsToDisplay">
						<list>
							<param name="label">src_nt_domain</param>
							<param name="value">src_nt_domain</param>
						</list>
					</param>
					<module name="Pulldown" layoutPanel="panel_row1_col1_grp3">
						<param name="name">src_user</param>
						<param name="label">Administrator:</param>
						<param name="postProcess">$postProcess$|search src_nt_domain="$src_nt_domain$"|dedup $name$|sort $name$</param>
						<param name="staticFieldsToDisplay"></param>
						<param name="searchFieldsToDisplay">
							<list>
								<param name="label">src_user</param>
								<param name="value">src_user</param>
							</list>
						</param>
						<!-- Main Contents -->

						<!-- R2C1 - Log ins by this admin (time, Site, Workstation) -->
						<module name="Search" layoutPanel="panel_row2_col1">
							<param name="search">
								<![CDATA[eventtype=msad-successful-user-logons dest_nt_domain="$src_nt_domain$" user="$src_user$"|rename src as src_ip|`ip-to-host`|`fix-localhost`|lookup SiteInfo host|dedup consecutive=t Site,src_host,src_ip|table _time,Site,src_host,src_ip|rename src_host as Workstation,src_ip as "IP Address"]]>
							</param>
							<module name="GenericHeader">
								<param name="label">Administrator Logons</param>
							</module>
							<module name="Pager">
								<module name="SimpleResultsTable"></module>
							</module>
						</module>
						
						<!-- R2C2 - Account Unlocks (time, user - link to user audit) -->
						<module name="Search" layoutPanel="panel_row2_col2">
							<param name="search"><![CDATA[eventtype=msad-account-lockout msad_action="Unlocked" src_nt_domain="$src_nt_domain$" src_user="$src_user$"|where isnotnull(user)|table _time,msad_action,user,dest_nt_domain|rename msad_action as "Action",user as "Username",dest_nt_domain as "Domain"]]></param>
							<module name="GenericHeader">
								<param name="label">Account Unlock Actions</param>
							</module>
							<module name="Pager">
								<module name="SimpleResultsTable">
									<param name="drilldown">row</param>
									<param name="drilldownPrefix">click</param>
									<module name="Redirector">
										<param name="url">audit_user</param>
										<param name="arg.nt_user">$click.cell2.value$</param>
										<param name="arg.nt_domain">$click.cell3.value$</param>
										<param name="arg.earliest">$search.timeRange.earliest$</param>
										<param name="arg.latest">$search.timeRange.latest$</param>
									</module>
								</module>
							</module>
						</module>
						
						<!-- R3C1 - User MAD (time, user - link to chg mgmt page) -->
						<module name="Search" layoutPanel="panel_row3_col1">
							<param name="search"><![CDATA[eventtype=msad-user-changes src_nt_domain="$src_nt_domain$" src_user="$src_user$"|where isnotnull(user)|`msad-changed-attributes`|table _time,msad_action,user,dest_nt_domain,MSADChanges|rename msad_action as "Action",user as "Username",dest_nt_domain as "Domain",MSADChanges as "Changes"]]></param>
							<module name="GenericHeader">
								<param name="label">User Administrative Changes</param>
							</module>
							<module name="Pager">
								<module name="SimpleResultsTable">
									<param name="drilldown">row</param>
									<param name="drilldownPrefix">click</param>
									<module name="Redirector">
										<param name="url">audit_user</param>
										<param name="arg.nt_user">$click.cell2.value$</param>
										<param name="arg.nt_domain">$click.cell3.value$</param>
										<param name="arg.earliest">$search.timeRange.earliest$</param>
										<param name="arg.latest">$search.timeRange.latest$</param>
									</module>
								</module>
							</module>
						</module>					
						
						<!-- R3C2 - Group MAD (time, user, link to chg mgmt page) -->
						<module name="Search" layoutPanel="panel_row3_col2">
							<param name="search"><![CDATA[eventtype=msad-groupmembership-changes src_nt_domain="$src_nt_domain$" src_user="$src_user$"|table _time,msad_action,dest_nt_domain,user_group,member_id|rename msad_action as "Action",dest_nt_domain as "Domain", user_group as "Group",member_id as "Member"]]></param>
							<module name="GenericHeader">
								<param name="label">Group Membership Changes</param>
							</module>
							<module name="Pager">
								<module name="SimpleResultsTable">
									<param name="drilldown">row</param>
									<param name="drilldownPrefix">click</param>
									<module name="Redirector">
										<param name="url">audit_group</param>
										<param name="arg.groupName">$click.cell3.value$</param>
										<param name="arg.nt_domain">$click.cell2.value$</param>
										<param name="arg.earliest">$search.timeRange.earliest$</param>
										<param name="arg.latest">$search.timeRange.latest$</param>
									</module>
								</module>
							</module>
						</module>
						
						<!-- R4C1 - GPO Changes (time, GPO, link to chg mgmt page) -->
						<module name="Search" layoutPanel="panel_row4_col1">
							<param name="search"><![CDATA[eventtype=msad-ad-access src_nt_domain="$src_nt_domain$" src_user="$src_user$" Object_Type="groupPolicyContainer"|eval srch=replace(Object_Name,"},*CN=.*","}")|transaction maxspan=5m session_id,host,srch|`session-to-host`|table _time,login_host,srch,src_nt_domain|ldapfilter domain="$src_nt_domain$" search="($$srch$$)" attrs=displayName|table _time,login_host,displayName|rename login_host as "Workstation",displayName as "Group Policy"]]></param>
							<module name="GenericHeader">
								<param name="label">Group Policy Changes</param>
							</module>
							<module name="Pager">
								<module name="SimpleResultsTable"></module>
							</module>
						</module>
						
						<!-- R4C2 - Computer MAD (time, computer, link to chg mgmt page) -->
						<module name="Search" layoutPanel="panel_row4_col2">
							<param name="search"><![CDATA[eventtype=msad-computer-changes src_nt_domain="$src_nt_domain$" src_user="$src_user$"|eval dest_host=dest_nt_domain."\\".user|`msad-changed-attributes`|table _time,action,dest_host,MSADChanges|rename action as Action,dest_host as "Workstation", MSADChanges as "Changes"]]></param>
							<module name="GenericHeader">
								<param name="label">Computer Account Changes</param>
							</module>
							<module name="Pager">
								<module name="SimpleResultsTable"></module>
							</module>
						</module>

						
						<!-- End of main contents -->
					</module> <!-- Pulldown for Administrator -->
				</module> <!-- Pulldown for domain -->
			</module> <!-- Search for domain -->
		</module> <!-- TimeRangePicker -->
	</module> <!-- URLLoader -->
</view>
