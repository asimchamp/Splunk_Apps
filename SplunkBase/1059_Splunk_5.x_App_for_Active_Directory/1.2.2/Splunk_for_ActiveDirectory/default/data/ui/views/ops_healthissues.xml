<?xml version="1.0" encoding="UTF-8"?>
<view onUnloadCancelJob="True" template="dashboard.html">
	<label>Health Issues</label>
	<module name="AccountBar" layoutPanel="appHeader" />
	<module name="AppBar" layoutPanel="appHeader" />
	<module name="SideviewUtils" layoutPanel="appHeader" />

	<module name="Message" layoutPanel="messaging">
		<param name="filter">*</param>
		<param name="clearOnJobDispatch">False</param>
		<param name="maxSize">1</param>
	</module>

	<module name="TitleBar" layoutPanel="viewHeader"/>
	<module name="HTML" layoutPanel="panel_row1_col1">
		<param name="html"><![CDATA[
		<h2>Active Directory Health Issues</h2>
		<p>This dashboard shows any health issues within the selected time period.  Use the drill-down to drill
			into the domain controller issues found.</p>
		]]></param>
	</module>

	<!-- The Time Range Picker feeds the picker for the Column Selector -->
	<module name="TimeRangePicker" layoutPanel="panel_row1_col1" autoRun="True">
		<param name="default">Last 60 minutes</param>
		<param name="searchWhenChanged">True</param>
		
		<!-- Search for the MSAD Topology so we can render it in the Column Selector -->
		<module name="Search">
			<param name="search"><![CDATA[|`domain-selector`]]></param>
	
			<module name="JobProgressIndicator" layoutPanel="panel_row2_col1"></module>

			<module name="ColumnSelector" layoutPanel="panel_row2_col1">
				<param name="drilldownPrefix">domainselection</param>
				<param name="defaultState">true</param>
				<param name="autoSelector">both</param>
				<param name="loadFromCookie">true</param>
				<param name="cookieName">domainselection</param>
				<param name="columns">
					<param name="ForestName">
						<param name="title">Forest</param>
						<param name="weight">0</param>
					</param>
					<param name="Site">
						<param name="title">Site</param>
						<param name="weight">1</param>
					</param>
					<param name="DomainDNSName">
						<param name="title">Domain</param>
						<param name="weight">2</param>
					</param>
					<param name="host">
						<param name="title">Server</param>
						<param name="weight">3</param>
					</param>
				</param>
				
				<!-- Beginning of main page -->
				
				<!-- 
					The main search looks for non-OK values for ProcsOK==False || DNSRegister==False || SYSVOLShare==False 
					
					Note that any of these going False is the "start" of the outage, and they all must be true for the
					end of the outage.
					
					XXX-TODO: May need to use strftime() and duration() on the _time/duration after renaming to make it look
					ok for presentation
				-->
				<module name="Search" layoutPanel="panel_row3_col1">
					<param name="search"><![CDATA[eventtype=msad-dc-health $domainselection.host$|eval everything_ok=if(ProcsOK=="False" OR DNSRegister=="False" OR SYSVOLShare=="False","False","True")|transaction host,everything_ok|search everything_ok="False"|eval duration=tostring(duration,"duration")|eval stime=strftime(_time,"%c")|table stime,duration,host,ProcsOK,DNSRegister,SYSVOLShare|rename stime as "Start Time", duration as "Outage Duration", host as "Host", ProcsOK as "Services", DNSRegister as "DNS Registration", SYSVOLShare as "SYSVOL Shared"]]>
					</param>
					<module name="JobProgressIndicator"></module>
					<module name="GenericHeader"><param name="label">Health Issues</param></module>
					<module name="Pager">
						<param name="count">20</param>
						<module name="SimpleResultsTable">
							<param name="count">20</param>
							<param name="drilldown">row</param>
							<module name="Redirector">
								<param name="url">ops_dc_status</param>
								<param name="arg.autoRun">True</param>
								<param name="arg.host">$click.cell2.value$</param>
								<param name="arg.earliest">$search.timeRange.earliest$</param>
								<param name="arg.latest">$search.timeRange.latest$</param>
							</module>
						</module>
					</module>
				</module>
				
				<module name="GenericHeader" layoutPanel="panel_row3_col1">
					<param name="label">Anomalous Events</param>
					<module name="Search">
						<param name="search"><![CDATA[eventtype=msad-anomalous-events $domainselection.host$|lookup EventCodes EventCode,LogName OUTPUTNEW desc|eval desc=if(isnull(desc),"Unknown EventCode",desc)|stats count by host,Type,EventCode,LogName,desc]]></param>
						<module name="Pager">
							<param name="entityName">results</param>
							<module name="SimpleResultsTable">
								<param name="drilldown">row</param>
								<module name="Redirector">
									<param name="url">flashtimeline</param>
									<param name="arg.autoRun">True</param>
									<param name="arg.q"><![CDATA[eventtype=msad-anomalous-events host="$click.cell0.value$" Type="$click.cell1.value$" EventCode="$click.cell2.value$" LogName="$click.cell3.value$"]]></param>
									<param name="arg.earliest">$search.timeRange.earliest$</param>
									<param name="arg.latest">$search.timeRange.latest$</param>
								</module>
							</module>
						</module>	
					</module> <!-- Search -->
				</module> <!-- GenericHeader -->
				
				<!-- End of main page -->
			</module> <!-- ColumnSelector -->
		</module> <!-- Search driver for Column selector -->
	</module> <!-- TimeRangePicker -->
</view>
