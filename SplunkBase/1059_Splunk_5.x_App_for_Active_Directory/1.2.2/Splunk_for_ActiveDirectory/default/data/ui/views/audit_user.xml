<?xml version="1.0" encoding="UTF-8"?>
<view onUnloadCancelJob="True" template="dashboard.html">
	<label>User Audit</label>
	<module name="AccountBar" layoutPanel="appHeader" />
	<module name="AppBar" layoutPanel="appHeader" />
	<module name="SideviewUtils" layoutPanel="appHeader" />

	<module name="Message" layoutPanel="messaging">
		<param name="filter">*</param>
		<param name="clearOnJobDispatch">False</param>
		<param name="maxSize">1</param>
	</module>

	<module name="TitleBar" layoutPanel="viewHeader"/>

	<module name="URLLoader" layoutPanel="panel_row1_col1">
		<module name="TimeRangePicker" layoutPanel="panel_row1_col1_grp1" autoRun="True">
			<param name="default">Last 60 minutes</param>
			<param name="searchWhenChanged">True</param>
			
			<module name="Search">
				<param name="search"><![CDATA[|`domain-dropdown`]]></param>
				<module name="Pulldown" layoutPanel="panel_row1_col1_grp2">
					<param name="name">nt_domain</param>
					<param name="label">Account Domain:</param>
					<param name="staticFieldsToDisplay"></param>
					<param name="searchFieldsToDisplay">
						<list>
							<param name="label">nt_domain</param>
							<param name="value">nt_domain</param>
						</list>
					</param>
					<module name="TextField" layoutPanel="panel_row1_col1_grp3">
						<param name="name">nt_user</param>
						<param name="label">Account User:</param>
						
						<!-- R2C1 - LDAP Record -->
						<module name="Search" layoutPanel="panel_row2_col1">
							<param name="search"><![CDATA[|ldapsearch domain=$nt_domain$ search="(sAMAccountName=$nt_user$)"|fields *]]></param>
							<module name="GenericHeader"><param name="label">Active Directory Record</param></module>
							<module name="JobProgressIndicator"></module>
							<module name="LDAPRecord"></module>
						</module>
						
						<!--  R2C2 Group Membership -->
						<module name="Search" layoutPanel="panel_row2_col2">
							<param name="search"><![CDATA[|ldapsearch domain=$nt_domain$ search="(objectclass=group)" attrs="cn,description,primaryGroupToken"|eval joiner=mvappend(dn,primaryGroupToken)|rename dn as groupDN,cn as groupName,primaryGroupToken as primaryGroupID|table groupDN,groupName,primaryGroupID,joiner|mvexpand joiner|join type=inner joiner [ldapsearch domain=$nt_domain$ search="(sAMAccountName=$nt_user$)" attrs="memberOf,primaryGroupID"|eval joiner=mvappend(memberOf,primaryGroupID)|table joiner|mvexpand joiner]|dedup groupDN|table groupDN,groupName,primaryGroupID|sort primaryGroupID]]></param>
							<module name="GenericHeader"><param name="label">Group Membership</param></module>
							<module name="JobProgressIndicator"></module>
							<module name="Pager">
								<param name="count">5</param>
								<module name="SimpleResultsTable">
									<param name="count">5</param>
									<param name="drilldown">row</param>
									<module name="Redirector">
										<param name="url">audit_group</param>
										<param name="arg.groupName">$click.cell1.value$</param>
										<param name="arg.nt_domain">$src_nt_domain$</param>
										<param name="arg.earliest">$search.timeRange.earliest$</param>
										<param name="arg.latest">$search.timeRange.latest$</param>
									</module> <!-- Redirector -->
								</module> <!-- SimpleResultsTable -->
							</module> <!-- Pager -->
						</module>
						
						<!-- R2C2 Account Lockout Activity -->
						<module name="Search" layoutPanel="panel_row2_col2">
							<param name="search"><![CDATA[eventtype=msad-account-lockout user="$nt_user$" dest_nt_domain="$nt_domain$"|dedup consecutive=T EventCode|eval adminuser=src_nt_domain."\\".src_user|eval actor=if(EventCode==4767 OR EventCode==671,adminuser,src_host)|table _time,signature,actor|rename signature as "Action",src_host as "Workstation",actor as "Actor"]]></param>
							<module name="GenericHeader"><param name="label">Account Lockout Activity</param></module>
							<module name="JobProgressIndicator"></module>
							<module name="Pager">
								<module name="SimpleResultsTable"></module>
							</module>
						</module>
						
						<!-- R2C2 Failed Logon Activity -->
						<module name="Search" layoutPanel="panel_row2_col2">
							<param name="search"><![CDATA[`lockouts-for-user($nt_domain$,$nt_user$)`|rename mintime as "Earliest",maxtime as "Latest",src as Workstation,src_ip as "IP Address", signature as "Reason"]]></param>
							<module name="GenericHeader"><param name="label">Failed Logon Activity</param></module>
							<module name="JobProgressIndicator"></module>
							<module name="Pager">
								<module name="SimpleResultsTable"></module>
							</module>
						</module>
					</module> <!-- TextField#Account User -->
				</module> <!-- Pulldown#Account Domain -->
			</module> <!-- Search driving Pulldown -->
		</module> <!-- TimeRangePicker -->
	</module> <!-- URLLoader -->
</view>
