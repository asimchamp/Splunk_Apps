<!-- Copyright (C) 2010-2019 Sideview LLC.  All Rights Reserved. -->
<view autoCancelInterval="90" isVisible="false" onunloadCancelJobs="true" template="dashboard.html" stylesheet="custom.css" isSticky="False">
  <label>Browse</label>
  <module name="AccountBar" layoutPanel="appHeader" />
  <module name="AppBar" layoutPanel="appHeader" />
  <module name="SideviewUtils" layoutPanel="appHeader">
    <param name="customJavascript">sideview_utils/save_create_patches.js</param>
    <param name="customStylesheet">observeit/browse.css observeit/dashboard_tabs.css</param>
  </module>
  
  <module name="Message" layoutPanel="messaging">
    <param name="filter">*</param>
    <param name="maxSize">2</param>
    <param name="clearOnJobDispatch">False</param>
  </module>

  <module name="URLLoader" layoutPanel="viewHeader" autoRun="True">
    <param name="keepURLUpdated">True</param>

    <module name="TimeRangePicker" layoutPanel="mainSearchControls">
      <param name="label">Time range</param>
      <param name="default">last 7 days</param>

      <module name="Search">
        <param name="search">
`oit_cmlog` `fillnull_commands` 
| stats values(SessionId) as SessionId by OS ServerName UserName LoginName ClientName ApplicationName Command
        </param>

        <module name="CheckboxPulldown">
          <param name="name">OS</param>
          <param name="label">OS</param>
          <param name="valueField">$name$</param>
          <param name="labelField">label</param>
          <param name="template">$name$="$value$"</param>
          <param name="selectAllOptimization">omit</param>
          <param name="postProcess">stats dc(SessionId) as sessionCount by $name$ | sort $name$ | eval label=$name$+" (" + sessionCount + ")"</param>
          
          <module name="CheckboxPulldown">
            <param name="name">ServerName</param>
            <param name="label">Server</param>
            <param name="valueField">$name$</param>
            <param name="labelField">label</param>
            <param name="template">$name$="$value$"</param>
            <param name="selectAllOptimization">omit</param>
            <param name="postProcess">search $OS$ | stats dc(SessionId) as sessionCount by $name$ | sort $name$ | eval label=$name$+" (" + sessionCount + ")"</param>
            
            <module name="CheckboxPulldown">
              <param name="name">UserName</param>
              <param name="label">User</param>
              <param name="valueField">$name$</param>
              <param name="labelField">label</param>
              <param name="template">$name$="$value$"</param>
              <param name="selectAllOptimization">omit</param>
              <param name="postProcess">search $OS$ $ServerName$ | stats dc(SessionId) as sessionCount by $name$ | sort $name$ | eval label=$name$+" (" + sessionCount + ")"</param>

              <module name="CheckboxPulldown">
                <param name="name">LoginName</param>
                <param name="label">Login</param>
                <param name="valueField">$name$</param>
                <param name="labelField">label</param>
                <param name="template">$name$="$value$"</param>
                <param name="selectAllOptimization">omit</param>
                <param name="postProcess">search $OS$ $ServerName$ $UserName$ | stats dc(SessionId) as sessionCount by $name$ | sort $name$ | eval label=$name$+" (" + sessionCount + ")"</param>

                
                <module name="CheckboxPulldown">
                  <param name="name">Command</param>
                  <param name="label">Commands</param>
                  <param name="valueField">$name$</param>
                  <param name="labelField">label</param>
                  <param name="template">$name$="$value$"</param>
                  <param name="nullTemplate">isnull($name$)</param>
                  <param name="postProcess">search $OS$ $ServerName$ $UserName$ $LoginName$ $name$!="N/A" | stats dc(SessionId) as sessionCount by $name$ | sort $name$ | eval label=$name$+" (" + sessionCount + ")" </param>
                  <param name="selectAllOptimization">*</param>
                  <param name="staticOptions">
                    <list>
                      <param name="value"></param>
                      <param name="label">(none)</param>
                      <param name="selected">True</param>
                    </list>
                  </param>

                  <module name="CheckboxPulldown">
                    <param name="name">ApplicationName</param>
                    <param name="label">Applications</param>
                    <param name="cssClass">applicationPulldown</param>
                    <param name="valueField">$name$</param>
                    <param name="labelField">label</param>
                    <param name="template">$name$="$value$"</param>
                    <param name="nullTemplate">isnull($name$)</param>
                    <param name="postProcess">search $OS$ $ServerName$ $UserName$ $LoginName$ $name$!="N/A" | stats dc(SessionId) as sessionCount by $name$ | sort $name$ | eval label=$name$+" (" + sessionCount + ")"</param>
                    <param name="selectAllOptimization">*</param>
                    <param name="staticOptions">
                      <list>
                        <param name="value"></param>
                        <param name="label">(none)</param>
                        <param name="selected">True</param>
                      </list>
                    </param>


                    <module name="ValueSetter">
                      <param name="name">optionalOR</param>
                      <param name="requiredKeys">Command,ApplicationName</param>
                      <param name="value">OR</param>

                      <module name="ValueSetter">
                        <param name="name">ApplicationsAndCommands</param>
                        <param name="requiredKeysMode">OR</param>
                        <param name="requiredKeys">Command,ApplicationName</param>
                        <param name="value">| search $ApplicationName$ $optionalOR$ $Command$</param>

                        <module name="TextField">
                          <param name="name">searchterms</param>
                          <param name="template"> | search $value$</param>
                          <param name="label">Misc. terms</param>

                          <module name="Button">
                            <param name="allowSoftSubmit">True</param>

                            <module name="ValueSetter">
                              <param name="arg.tabs">ServerName UserName ClientName DomainName LoginName ApplicationName Command Alert</param>

                              <module name="ValueSetter">
                                <param name="name">tabsArray</param>
                                <param name="delim">+</param>
                                <param name="value">$tabs$</param>

                                <module name="ArrayValueSetter">
                                  <param name="name">dcAndValuesClausesForStats</param>
                                  <param name="array">$tabsArray$</param>
                                  <param name="template">dc($value$) as dc_$value$ values($value$) as values_$value$</param>
                                  <param name="separator">+</param>
                                  <param name="outerTemplate">$value$</param>

                                  <module name="ArrayValueSetter">
                                    <param name="name">valuesClausesForStats</param>
                                    <param name="array">$tabsArray$</param>
                                    <param name="template">values($value$) as $value$</param>
                                    <param name="separator">+</param>
                                    <param name="outerTemplate">$value$</param>


                                    <module name="ArrayValueSetter">
                                      <param name="name">fullStatsClauseList</param>
                                      <param name="array">$tabsArray$</param>
                                      <param name="template">values_$value$ dc_$value$</param>
                                      <param name="separator">+</param>
                                      <param name="outerTemplate">$value$</param>

                                      <module name="Search">
                                        <param name="search"><![CDATA[
(`oit_cmlog` $OS$ $ServerName$ $UserName$ $LoginName$) OR (`oit_alerts`)
`merge_applications_and_commands`
| fields SessionId $tabs$ 
| fields - _time
| stats values(*) as * by SessionId
`fillnull_all` 
$searchterms$
$ApplicationsAndCommands$
| stats dc(*) as *
| fields SessionId $tabs$  
| transpose
| rename "row 1" as count column as field
| `get_labels`
                                        ]]></param>

                                        <module name="Tabs" layoutPanel="panel_row1_col1">
                                          <param name="name">field</param>
                                          <param name="valueField">$name$</param>
                                          <param name="labelField">label</param>
                                          <param name="customBehavior">tabFields</param>

                                          <module name="HTML" layoutPanel="viewHeader">
                                            <param name="html"><![CDATA[
                                            <h1>Browse $field.label$</h1>
                                            ]]></param>
                                          </module>

                                          <module name="ValueSetter" layoutPanel="panel_row1_col1_grp1">
                                            <param name="name">customReport</param>
                                            <param name="if.$field$=SessionId[priority=1]">
                                            eval duration=ended-_time 
                                            | eval duration=replace(tostring(duration,"duration"),"\.0+$$","")
                                            | eval actions="" 
                                            | sort 0 - _time
                                            | fields _time duration SessionId $tabs$ Slides Alert ViewerURL actions
                                            </param>
                                            <param name="if.$field$=[priority=2]">stats dc(*) as *</param>
                                            <param name="default">fields - ended 
                                            | stats sparkline as activity
                                            $dcAndValuesClausesForStats$ dc(SessionId) as Sessions
                                            sum(Slides) as Slides by $field$
                                            | fillnull $tabs$ value=" "
                                            </param>

                                            <module name="Search">
                                              <param name="search"><![CDATA[

 `custom_index` (sourcetype=oit_cmlog $OS$ $ServerName$ $UserName$ $LoginName$ ) OR (`oit_alerts`) 
`merge_applications_and_commands`
| stats min(_time) as _time max(_time) as ended $valuesClausesForStats$ dc(ViewerURL) as Slides last(ViewerURL) as ViewerURL by SessionId
$searchterms$
 `fillnull_all` 
$ApplicationsAndCommands$
| $customReport$

                                              ]]></param>
                                              <module name="SearchControls" layoutPanel="panel_row1_col1">
                                                <param name="sections">info export saveMenu createMenu</param>
                                                <param name="saveMenu">saveSearch</param>
                                              </module>

                                              <module name="Link">
                                                <param name="label">&#187; graph $field.lowercaseLabel$ over time</param>
                                                <param name="cssClass">clearRight</param>

                                                <module name="Redirector">
                                                  <param name="url">general_report</param>
                                                  <param name="generalSearchTermField">searchterms</param>
                                                  <param name="arg.zField">$reportSplitBy$</param>
                                                  <param name="arg.OS">$OS.rawValue$</param>
                                                  <param name="arg.ServerName">$ServerName.rawValue$</param>
                                                  <param name="arg.UserName">$UserName.rawValue$</param>
                                                  <param name="arg.LoginName">$LoginName.rawValue$</param>
                                                  <param name="arg.searchterms">$searchterms.rawValue$</param>
                                                  <param name="arg.ApplicationName">$ApplicationName.rawValue$</param>
                                                  <param name="arg.Command">$Command.rawValue$</param>
                                                  <param name="arg.earliest">$search.timeRange.earliest$</param>
                                                  <param name="arg.latest">$search.timeRange.latest$</param>
                                                  <param name="target">_blank</param>
                                                </module>
                                              </module>

                                              <module name="Link">
                                                <param name="label">&#187; see raw search syntax</param>
                                                <module name="Redirector">
                                                  <param name="url">search</param>
                                                  <param name="arg.q">search $search$</param>
                                                  <param name="arg.earliest">$search.timeRange.earliest$</param>
                                                  <param name="arg.latest">$search.timeRange.latest$</param>
                                                  <param name="target">_blank</param>
                                                </module>
                                              </module>



                                              <!-- Because the the first field in the session display is time, 
                                              the Table thinks it's a time drilldown, so it swaps the _time value 
                                              in for $search.timeRange.earliest$ when it processes the drilldown. 
                                              -->
                                              <module name="ValueSetter">
                                                <param name="arg.bc_earliest">$search.timeRange.earliest$</param>
                                                <param name="arg.bc_latest">$search.timeRange.latest$</param>


                                                <module name="Pager">

                                                  <module name="ValueSetter">
                                                    <param name="name">tableType</param>
                                                    <param name="if.$field$=SessionId">session</param>
                                                    <param name="default">everythingElse</param>

                                                    <module name="Switcher">
                                                      <param name="selectedGroup">$tableType$</param>

                                                      <module name="Table" group="session">
                                                        <param name="hiddenFields">ViewerURL SessionId</param>

                                                        <module name="HTML" group="row.fields.actions">
                                                          <param name="html"><![CDATA[
                                                            <a href="$row.fields.ViewerURL$" target="_blank"><img width="16" height="16" src="../../static/app/observeit/images/icon_video.gif"/></a>
                                                          ]]></param>
                                                        </module>

                                                        <module name="Redirector">
                                                          <param name="url">session_detail</param>
                                                          <param name="arg.UserName">$UserName.rawValue$</param>
                                                          <param name="arg.SessionId">$row.fields.SessionId$</param>
                                                          <param name="arg.ApplicationName">$ApplicationName.rawValue$</param>
                                                          <param name="arg.Command">$Command.rawValue$</param>
                                                          <param name="arg.bc_earliest">$bc_earliest$</param>
                                                          <param name="arg.bc_latest">$bc_latest$</param>
                                                          <param name="arg.bc_OS">$OS.rawValue$</param>
                                                          <param name="arg.bc_ServerName">$ServerName.rawValue$</param>
                                                          <param name="arg.bc_UserName">$UserName.rawValue$</param>
                                                          <param name="arg.bc_Applications">$Applications.rawValue$</param>
                                                          <param name="arg.bc_Commands">$Commands.rawValue$</param>
                                                          <param name="arg.bc_searchterms">$searchterms.rawValue$</param>

                                                        </module>
                                                      </module>
              
                                                      <module name="Table" group="everythingElse">
                                                        <param name="hiddenFields">ViewerURL SessionId $fullStatsClauseList$</param>

                                                        <module name="ValueSetter" group="row.fields.ServerName">
                                                          <param name="name">display</param>
                                                          <param name="if.$field$=ServerName[priority=5]">$row.fields.ServerName$</param>
                                                          <param name="if.$row.fields.dc_ServerName$=0[priority=4]"></param>
                                                          <param name="if.$row.fields.dc_ServerName$=1[priority=3]">$row.fields.values_ServerName$</param>
                                                          
                                                          <param name="default"><![CDATA[
                                                          <span class="distinctValueCount">($row.fields.dc_ServerName$ distinct values)</span>
                                                          ]]></param>
                                                          <module name="HTML"> 
                                                            <param name="html"><![CDATA[
                                                              $display$
                                                            ]]></param>
                                                          </module>
                                                        </module>

                                                        <module name="ValueSetter" group="row.fields.UserName">
                                                          <param name="name">display</param>
                                                          <param name="if.$field$=UserName[priority=5]">$row.fields.UserName$</param>
                                                          <param name="if.$row.fields.dc_UserName$=0[priority=4]"></param>
                                                          <param name="if.$row.fields.dc_UserName$=1[priority=3]">$row.fields.values_UserName$</param>
                                                          
                                                          <param name="default"><![CDATA[
                                                          <span class="distinctValueCount">($row.fields.dc_UserName$ distinct values)</span>
                                                          ]]></param>
                                                          <module name="HTML"> 
                                                            <param name="html"><![CDATA[
                                                              $display$
                                                            ]]></param>
                                                          </module>
                                                        </module>

                                                        <module name="ValueSetter" group="row.fields.ClientName">
                                                          <param name="name">display</param>
                                                          <param name="if.$field$=ClientName[priority=5]">$row.fields.ClientName$</param>
                                                          <param name="if.$row.fields.dc_ClientName$=0[priority=4]"></param>
                                                          <param name="if.$row.fields.dc_ClientName$=1[priority=3]">$row.fields.values_ClientName$</param>
                                                          
                                                          <param name="default"><![CDATA[
                                                          <span class="distinctValueCount">($row.fields.dc_ClientName$ distinct values)</span>
                                                          ]]></param>
                                                          <module name="HTML"> 
                                                            <param name="html"><![CDATA[
                                                              $display$
                                                            ]]></param>
                                                          </module>
                                                        </module>

                                                        <module name="ValueSetter" group="row.fields.DomainName">
                                                          <param name="name">display</param>
                                                          <param name="if.$field$=DomainName[priority=5]">$row.fields.DomainName$</param>
                                                          <param name="if.$row.fields.dc_DomainName$=0[priority=4]"></param>
                                                          <param name="if.$row.fields.dc_DomainName$=1[priority=3]">$row.fields.values_DomainName$</param>
                                                          
                                                          <param name="default"><![CDATA[
                                                          <span class="distinctValueCount">($row.fields.dc_DomainName$ distinct values)</span>
                                                          ]]></param>
                                                          <module name="HTML"> 
                                                            <param name="html"><![CDATA[
                                                              $display$
                                                            ]]></param>
                                                          </module>
                                                        </module>

                                                        <module name="ValueSetter" group="row.fields.LoginName">
                                                          <param name="name">display</param>
                                                          <param name="if.$field$=LoginName[priority=5]">$row.fields.LoginName$</param>
                                                          <param name="if.$row.fields.dc_LoginName$=0[priority=4]"></param>
                                                          <param name="if.$row.fields.dc_LoginName$=1[priority=3]">$row.fields.values_LoginName$</param>
                                                          
                                                          <param name="default"><![CDATA[
                                                          <span class="distinctValueCount">($row.fields.dc_LoginName$ distinct values)</span>
                                                          ]]></param>
                                                          <module name="HTML"> 
                                                            <param name="html"><![CDATA[
                                                              $display$
                                                            ]]></param>
                                                          </module>
                                                        </module>

                                                        <module name="ValueSetter" group="row.fields.ApplicationName">
                                                          <param name="name">display</param>
                                                          <param name="if.$field$=ApplicationName[priority=5]">$row.fields.ApplicationName$</param>
                                                          <param name="if.$row.fields.dc_ApplicationName$=0[priority=4]"></param>
                                                          <param name="if.$row.fields.dc_ApplicationName$=1[priority=3]">$row.fields.values_ApplicationName$</param>
                                                          
                                                          <param name="default"><![CDATA[
                                                          <span class="distinctValueCount">($row.fields.dc_ApplicationName$ distinct values)</span>
                                                          ]]></param>
                                                          <module name="HTML"> 
                                                            <param name="html"><![CDATA[
                                                              $display$
                                                            ]]></param>
                                                          </module>
                                                        </module>


                                                        <module name="ValueSetter" group="row.fields.Alert">
                                                          <param name="name">display</param>
                                                          <param name="if.$field$=Alert[priority=5]">$row.fields.Alert$</param>
                                                          <param name="if.$row.fields.dc_Alert$=0[priority=4]"></param>
                                                          <param name="if.$row.fields.dc_Alert$=1[priority=3]">$row.fields.values_Alert$</param>
                                                          
                                                          <param name="default"><![CDATA[
                                                          <span class="distinctValueCount">($row.fields.dc_Alert$ distinct rules triggered)</span>
                                                          ]]></param>
                                                          <module name="HTML"> 
                                                            <param name="html"><![CDATA[
                                                              $display$
                                                            ]]></param>
                                                          </module>
                                                        </module>

                                                        <module name="ValueSetter" group="row.fields.Command">
                                                          <param name="name">display</param>
                                                          <param name="if.$field$=Command[priority=5]">$row.fields.Command$</param>
                                                          <param name="if.$row.fields.dc_Command$=0[priority=4]"></param>
                                                          <param name="if.$row.fields.dc_Command$=1[priority=3]">$row.fields.values_Command$</param>
                                                          
                                                          <param name="default"><![CDATA[
                                                          <span class="distinctValueCount">($row.fields.dc_Command$ distinct values)</span>
                                                          ]]></param>
                                                          <module name="HTML"> 
                                                            <param name="html"><![CDATA[
                                                              $display$
                                                            ]]></param>
                                                          </module>
                                                        </module>

                                                        <module name="ValueSetter" group="row.fields.sourcetype">
                                                          <param name="name">display</param>
                                                          <param name="if.$field$=sourcetype[priority=5]">$row.fields.sourcetype$</param>
                                                          
                                                          <param name="default"><![CDATA[
                                                          $row.fields.values_sourcetype$
                                                          ]]></param>
                                                          <module name="HTML"> 
                                                            <param name="html"><![CDATA[
                                                              $display$
                                                            ]]></param>
                                                          </module>
                                                        </module>

                                                        <module name="CustomBehavior">
                                                          <param name="customBehavior">bouncer</param>
                                                        </module>

                                                      </module>
                                                    </module>
                                                  </module>
                                                  <module name="Pager" />
                                                </module>
                                              </module>
                                            </module>
                                          </module>
                                        </module>
                                      </module>
                                    </module>
                                  </module>
                                </module>
                              </module>
                            </module>
                          </module>
                        </module>
                      </module>
                    </module>
                  </module>
                </module>
              </module>
            </module>
          </module>
        </module>
      </module>
    </module>
  </module>
</view>



<!--

TODO 

Select none condition in Applications / Commands results in unexpected behavior.
Homepage bar chart Drilldown with selected values as filters, to new Browse page
refactor CSS

show values if dc<3,  dc otherwise
if dc=1,  roll up and pull out the whole tab into some static looking HTML. evolve to auto detail view.


LAUNCH
remove timeshifter_and_anonymizer
New Screenshots

given <filter list>
  
  if only one <noun> textfield filter is set, with no wildcard,  then we are a detail view for <noun>
      TAB - show activity by <noun>
  
  if no <noun> textfields are set,  we are BROWSING . 
      TAB - user selects either activity by session,  or activity by <noun>

  for each OTHER <noun>,  if there's only one of them,  pull them out of the table entirely and up out of the tabs entirely, and up into an HTML summary above the tab line.
  If sessionId is set,   throw "Applications/Commands over time" below that and just above the tab line.


ROLL UP BY SESSION,  APPLY TOP LEVEL FILTERS ?AS OR?.
ROLL UP BY <CHOICE>,  APPLY FILTERS ?AS OR?
      FOR EACH <CHOICE>, SUMMARIZE EVERYTHING ELSE.
           DRILLDOWN GIVES CHOICE BETWEEN 
               1) ADDING FILTER OF JUST <NOUN>=<SSELCETION>
               OR 
               2) ALSO ADDING RELEVANT COLUMN CLOCKED FILTER ?TO TOP LEVEL?.
-->

