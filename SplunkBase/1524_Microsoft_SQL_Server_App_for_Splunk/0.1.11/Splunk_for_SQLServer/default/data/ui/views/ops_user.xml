<form>
	<label>SQL User Information</label>

	<fieldset autoRun="true" submitButton="true">
		<input type="dropdown" token="ServerInstance">
			<label>Server Instance</label>
			<populatingSearch fieldForValue="SIVal" fieldForLabel="ServerInstance" earliest="-10m" latest="now">
| inputlookup SQLInstanceInformation 
| eval SIVal=replace(ServerInstance,"\\\\","\\\\")
| stats count by ServerInstance,SIVal
			</populatingSearch>
		</input>
		<!-- JIRA MSSQL-53 - Cascading Fieldsets needed -->
		<input type="dropdown" token="User">
			<label>User</label>
			<populatingSearch fieldForValue="QuotedName" fieldForLabel="Name" earliest="-10m" latest="now">
| inputlookup SQLUserInformation 
| search ServerInstance="$ServerInstance$"
| eval QuotedName=replace(Name,"\\\\","\\\\")
| stats count by QuotedName,Name
		</populatingSearch>
		</input>
	</fieldset>

	<row>
		<table>
			<title>User Access Information</title>
			<searchTemplate>
| inputlookup SQLUserInformation
| search ServerInstance="$ServerInstance$" Name="$User$"
| head 1
| lookup SQLLastLogin user as Name,ServerInstance OUTPUT LastLogin
| eval LastLogin = strftime(LastLogin, "%F %T")
| table CreateDate,DateLastModified,LastLogin,IsDisabled,IsLocked,IsPasswordExpired,WindowsLoginAccessType
| transpose 10
			</searchTemplate>
			<earliestTime>-5m</earliestTime>
			<latestTime>now</latestTime>
			<option name="showPager">false</option>
		</table>
		<table>
			<title>Other User Information</title>
			<searchTemplate>
| inputlookup SQLUserInformation
| search ServerInstance="$ServerInstance$" Name="$User$"
| head 1
| table IsSystemObject,Language,LoginType,MustChangePassword,PasswordExpirationEnabled,PasswordPolicyEnforced
| transpose 10
			</searchTemplate>
			<earliestTime>-5m</earliestTime>
			<latestTime>now</latestTime>
			<option name="showPager">false</option>
		</table>
		<table>
			<title>Databases</title>
			<searchTemplate>
| inputlookup SQLUserInformation
| search ServerInstance="$ServerInstance$" Name="$User$"
| table DatabaseName,ServerInstance,HasDBAccess
			</searchTemplate>
			<earliestTime>-5m</earliestTime>
			<latestTime>now</latestTime>
			<option name="showPager">true</option>
			<drilldown>
				<link><![CDATA[/app/Splunk_for_SQLServer/ops_database?ServerInstance=$ServerInstance$&DatabaseName=$DatabaseName$]]></link>
			</drilldown>
		</table>
	</row>
	<row>
		<table>
			<title>IP Address History (Last 24 hours)</title>
			<searchTemplate>
eventtype=mssql-audit server_instance_name="$ServerInstance$" session_server_principal_name="$User$" class_type="LX" 
| where isnotnull(src_ip) 
| stats count,latest(_time) as _time, by src_ip
| eval lastLogin = strftime(_time, "%F %T")
| table src_ip,count,lastLogin
| rename src_ip as "IP Address", count as "# Logins", lastLogin as "Last Access"
			</searchTemplate>
			<earliestTime>-24h</earliestTime>
			<latestTime>now</latestTime>
			<option name="showPager">true</option>
		</table>
		<table>
			<title>Failed Logons (Last 24 hours)</title>
			<searchTemplate>`mssql-failed-logins("$ServerInstance$","$User$")`</searchTemplate>
			<earliestTime>-24h</earliestTime>
			<latestTime>now</latestTime>
			<option name="showPager">true</option>
		</table>
		<chart>
			<title>CPU Seconds (Last 24 hours)</title>
			<searchTemplate><![CDATA[
eventtype=mssql-audit server_instance_name="$ServerInstance$" session_server_principal_name="$User$" class_type="LX" action_id="LGO" 
| rex field=_raw "(?ms)<total_cpu>(?<total_cpu>\d+)" 
| timechart sum(total_cpu)
			]]></searchTemplate>
			<earliestTime>-24h</earliestTime>
			<latestTime>now</latestTime>
			<option name="charting.chart">line</option>
			<option name="charting.chart.nullValueMode">zero</option>
		</chart>
	</row>
</form>
