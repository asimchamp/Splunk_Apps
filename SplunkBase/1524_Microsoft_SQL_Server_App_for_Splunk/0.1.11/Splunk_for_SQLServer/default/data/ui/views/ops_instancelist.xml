<form>

	<label>SQL Instances</label>

	<fieldset autoRun="true" submitButton="true">
		<input type="dropdown" token="Status">
			<label>Service Status</label>
			<prefix>Status="</prefix>
			<suffix>"</suffix>
			<default>*</default>
			<choice value="*">All Instances</choice>
			<populatingSearch fieldForValue="Status" fieldForLabel="Status" earliest="-10m" latest="now">eventtype=mssql-services | stats count by Status</populatingSearch>
		</input>
	</fieldset>

	<row>
		<table>
			<title>SQL Instances</title>
			<searchTemplate>
| inputlookup SQLInstanceInformation
| join host,DisplayName [ search eventtype=mssql-services | stats latest(_time) as _time,latest(Status) as Status by host,DisplayName ]
| search $Status$
| lookup SQLDatabaseInformation ServerInstance OUTPUT DatabaseGuid
| eval nDB=mvcount(DatabaseGuid)
| eval ProductRelease = Product + " " + Release + " " + ProductLevel
| stats values(host) as Hosts,values(Status) as Status,values(ServiceAccount) as ServiceAccount,values(Version) as Version, values(ProductRelease) as "Product Release", values(Edition) as Edition, max(nDB) as "# Databases" by ServerInstance
| eval modSI = replace(ServerInstance,"\\\\","\\\\")
			</searchTemplate>
			<fields>ServerInstance,Hosts,Status,ServiceAccount,Version,"Product Release",Edition,"# Databases"</fields>
			<earliestTime>-10m</earliestTime>
			<latestTime>now</latestTime>
			<option name="showPager">true</option>
			<drilldown>
				<link><![CDATA[/app/Splunk_for_SQLServer/ops_instance?form.ServerInstance=$row.modSI$]]></link>
			</drilldown>
		</table>
	</row>
</form>
