<form isVisible="false">
    <label>SQL Host Information</label>
    <fieldset autoRun="true" submitButton="true">
            <input type="dropdown" token="SQLHost">
                    <label>SQL Host</label>
                    <prefix>host="</prefix>
                    <suffix>"</suffix>
                    <populatingSearch fieldForValue="host" fieldForLabel="host" earliest="-10m" latest="now">| inputlookup SQLHostInformation</populatingSearch>
            </input>
    </fieldset>
    
    <row>
        <table>
            <title>Host Details</title>
            <searchString>
|inputlookup SQLHostInformation
| search $SQLHost$ 
| lookup OSVersion OSBaseVersion OUTPUT OSVersionName 
| table ComputerName,ComputerDomain,OSVersionName,OSBuildNumber,OSSerialNumber 
| rename OSVersionName as "Operating System", OSBuildNumber as "Build", OSSerialNumber as "Serial Number" 
| transpose 10
            </searchString>
            <option name="displayRowNumbers">false</option>
            <option name="showPager">false</option>
            <option name="count">10</option>
        </table>
        <table>
            <title>Installed Instances</title>
            <searchString>
|inputlookup SQLInstanceInformation 
| search $SQLHost$ 
| join host,DisplayName [ search eventtype=mssql-services | stats latest(Status) as Status by host,DisplayName ] 
| eval P = Product + " " + Release + " " + ProductLevel + " " + Edition 
| table ServerInstance,P,Status
| rename P as "SQL Product"
            </searchString>   
            <option name="displayRowNumbers">false</option>
            <option name="showPager">false</option>
            <option name="count">10</option>
            <drilldown>
                <link>/app/Splunk_for_SQLServer/ops_instance?form.ServerInstance=$row.ServerInstance$</link>
            </drilldown>
        </table>
        <table>
            <title>Disk Utilization</title>
            <searchString>
eventtype=perfmon $SQLHost$ object=LogicalDisk instance!="_Total" 
| eval Value=round(Value,2)
| xyseries instance,counter,Value
| sort -"Disk Name"
            </searchString>
            <earliestTime>-5m</earliestTime>
            <latestTime>now</latestTime>
            <option name="displayRowNumbers">false</option>
            <option name="count">10</option>
            <option name="showPager">true</option>
        </table>
    </row>
    
    <row>
        <chart>
            <title>% Processor</title>
            <searchString>
eventtype=perfmon $SQLHost$ object=Processor counter="% Processor Time" instance="_Total"
| eval Value=round(Value,2)
| stats latest(Value) as Value
            </searchString>
            <earliestTime>rt-2m</earliestTime>
            <latestTime>rt</latestTime>
            <option name="charting.chart">radialGauge</option>
            <option name="charting.chart.rangeValues">[0,70,90,100]</option>
            <option name="height">250px</option>
        </chart>
        <chart>
            <title>Network Utilization</title>
            <searchString>
eventtype=perfmon $SQLHost$ object="Network Interface" instance!="isatap.*"
| eval Value=round(Value,2)
| xyseries instance,counter,Value
| rename "Bytes Total/sec" as bytes,"Current Bandwidth" as bandwidth
| addcoltotals
| where isnull(instance)
| eval perc=(bytes/bandwidth)*100
| table perc
            </searchString>
            <earliestTime>rt-2m</earliestTime>
            <latestTime>rt</latestTime>
            <option name="charting.chart">radialGauge</option>
            <option name="charting.chart.rangeValues">[0,70,90,100]</option>
            <option name="height">250px</option>
        </chart>
        <chart>
            <title>Memory Utilization</title>
            <searchString>
eventtype=mssql-hostmemory $SQLHost$
| head 1
| eval perc=(AvailableMemory / TotalPhysicalMemory) * 100
| table perc
            </searchString>
            <earliestTime>rt-2m</earliestTime>
            <latestTime>rt</latestTime>
            <option name="charting.chart">fillerGauge</option>
            <option name="charting.chart.rangeValues">[0,70,90,100]</option>
            <option name="height">250px</option>
        </chart>
    </row>
    
    <row>
	<table>
	    <title>SQL Process CPU Utilization</title>
	    <searchString>
eventtype=perfmon $SQLHost$ sourcetype="PerfmonMk:Process-sql" instance="sql*"
| stats sparkline(avg(%_Processor_Time)) as "CPU Utilization", max(%_Processor_Time) as "Peak" by instance
| eval Peak=round(Peak,2)
	    </searchString>
            <earliestTime>-24h</earliestTime>
            <latestTime>now</latestTime>
	</table>
	<table>
	    <title>SQL Process Memory Utilization</title>
	    <searchString>
eventtype=perfmon $SQLHost$ sourcetype="PerfmonMk:Process-sql" instance="sql*"
| stats sparkline(avg(Private_Bytes)) as "Memory Utilization", max(Private_Bytes) as "Peak" by instance
| eval Peak=case(Peak>1000000,tostring(round(Peak/1000000,2))+"MB",Peak>1000,tostring(round(Peak/1000,2))+"kB",isnotnull(Peak),Peak)
	    </searchString>
            <earliestTime>-24h</earliestTime>
            <latestTime>now</latestTime>
	</table>
    </row>
    <row>
        <table>
            <title>System Events</title>
            <searchString>
eventtype=winevent-notablesystemevent $SQLHost$
| table _time,host,LogName,SourceName,RecordNumber,EventCode,Type,Message
            </searchString>
            <earliestTime>-24h</earliestTime>
            <latestTime>now</latestTime>
            <option name="showPager">true</option>
            <drilldown>
                <link><![CDATA[/app/Splunk_for_SQLServer/flashtimeline?q=search eventtype=winevent-notablesystemevent host=$row.host$&LogName=$row.LogName$&SourceName=$row.SourceName$&RecordNumber=$row.RecordNumber$]]></link>
            </drilldown>
        </table>
    </row>
    
</form>
