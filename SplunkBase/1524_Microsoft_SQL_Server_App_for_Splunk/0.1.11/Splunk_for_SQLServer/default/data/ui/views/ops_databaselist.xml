<form>

	<label>SQL Databases</label>

	<fieldset autoRun="true" submitButton="true">
		<input type="dropdown" token="Status">
			<label>Database Status</label>
			<prefix>Status="</prefix>
			<suffix>"</suffix>
			<default>*</default>
			<choice value="*">All Databases</choice>
			<populatingSearch fieldForValue="Status" fieldForLabel="Status" earliest="-10m" latest="now">eventtype=mssql-databasehealth | stats count by Status</populatingSearch>
		</input>
	</fieldset>

	<row>
		<table>
			<title>SQL Databases</title>
			<searchTemplate>
| inputlookup SQLDatabaseInformation
| join host,DatabaseGuid [ search eventtype=mssql-databasehealth | stats latest(_time) as _time,latest(Status) as Status,latest(Size) as Size,latest(LogSize) as LogSize,latest(ActiveConnections) as ActiveConnections,latest(DataSpaceUsage) as DataSpaceUsage,latest(IndexSpaceUsage) as IndexSpaceUsage,latest(SpaceAvailable) as SpaceAvailable by host,DatabaseGuid ]
| search $Status$
| eval LogSize = round(LogSize * 1024,0)
| lookup SQLInstanceInformation ServerInstance OUTPUT Version
| stats values(host) as Hosts,values(Version) as Version, max(Size) as Size, max(ActiveConnections) as ActiveConnections, max(DataSpaceUsage) as DataSpaceUsage, max(IndexSpaceUsage) as IndexSpaceUsage, max(LogSize) as LogSize, max(SpaceAvailable) as SpaceAvailable by Name,ServerInstance
| rename ActiveConnections as "Active Connections", DataSpaceUsage as "Data Usage (kB)", IndexSpaceUsage as "Index Usage (kB)", LogSize as "Log Usage (kB)", SpaceAvailable as "Space Available (kB)"
| sort -Size
			</searchTemplate>
			<earliestTime>-10m</earliestTime>
			<latestTime>now</latestTime>
			<option name="showPager">true</option>
			<drilldown>
				<link><![CDATA[/app/Splunk_for_SQLServer/ops_database?form.DatabaseName=$row.Name$&form.ServerInstance=$row.ServerInstance$]]></link>
			</drilldown>
		</table>
	</row>
</form>