
########################
#
# DataCube Macros for SI
#
########################

[Fortigate-Virus-DataCube]
definition = index=summary DataCube = virus | fields *

[Fortigate-IPS-DataCube]
definition = index=summary DataCube = ips | fields *

[Fortigate-App-ctrl-DataCube]
definition = index=summary DataCube = app-ctrl | fields *

[Fortigate-Traffic-DataCube]
definition = index=summary DataCube = traffic | fields *

[Fortigate-Webfilter-DataCube]
definition = index=summary DataCube = webfilter | fields *

########################
#
# DataCube Macros
#
########################

[Fortigate-Virus-DataCube]
definition =`fortigate_virus` | bin _time span=5m | fillnull device_name vdom source_ip user destination_ip priority malware dtype subtype service file profile url policyid |stats count by device_name vdom source_ip user destination_ip priority malware dtype subtype service file profile url policyid _time


[Fortigate-IPS-DataCube]
definition =`fortigate_ips` | bin _time span=5m | fillnull device_name vdom source_ip user group destination_ip severity description action subtype service sensor policyid |stats count by device_name vdom source_ip user group destination_ip severity description action subtype service sensor policyid _time

[Fortigate-App-ctrl-DataCube]
definition =`fortigate_app-ctrl` | bin _time span=5m | fillnull device_name vdom source_ip destination_ip source_interface destination_interface user group app_type application destination_port session_type action app_list policyid category_and_application |stats count by device_name vdom source_ip destination_ip source_interface destination_interface user group app_type application destination_port session_type action app_list policyid category_and_application _time

[Fortigate-Traffic-DataCube]
definition = `fortigate_traffic` | fillnull device_name vdom source_interface source_ip user group destination_interface destination_ip session_type destination_port application service action policy_id bytes_sent bytes_received destination_country | stats count by device_name vdom source_interface source_ip user group destination_interface destination_ip session_type destination_port application service action policy_id bytes_sent bytes_received destination_country _time

[Fortigate-Webfilter-DataCube]
definition =`fortigate_webfilter` | bin _time span=5m | fillnull device_name vdom source_ip destination_ip source_interface destination_interface site service categorization user group status profile policyid bytes_sent bytes_received | stats count by device_name vdom source_ip destination_ip source_interface destination_interface site service categorization user group status profile policyid bytes_sent bytes_received _time

[Fortigate-Event-DHCP-DataCube]
definition =`fortigate_event_dhcp` | bin _time span=5m | fillnull device_name vdom client_hostname mac_address client_ip dhcp_message direction message | stats count by device_name vdom client_hostname mac_address client_ip dhcp_message direction message _time

[Fortigate-Event-Auth-Captive-Portal-DataCube]
definition =`fortigate_event_auth_captive_portal` | bin _time span=5m | fillnull device_name vdom user group source_ip policy_id status message | stats count by  device_name vdom user group source_ip policy_id status message _time


[Fortigate-Event-Pattern-DataCube]
definition =`fortigate_event_pattern` | bin _time span=5m | fillnull device_name date time vdom priority status message | eval split_1=split(message,")") | eval split_avdb=mvindex(split_1,-5) | eval split_ipsdb=mvindex(split_1,-4) | eval split_aven=mvindex(split_1,-3) | eval split_ipsen=mvindex(split_1,-2) | eval avdb=split(split_avdb,"(") | eval antivirus_db=mvindex(avdb,-1) |  eval ipsdb=split(split_ipsdb,"(") | eval ips_db=mvindex(ipsdb,-1) |  eval aven=split(split_aven,"(") | eval antivirus_engine=mvindex(aven,-1) |  eval ipsen=split(split_ipsen,"(") | eval ips_engine=mvindex(ipsen,-1) | stats count by device_name vdom priority status antivirus_db ips_db antivirus_engine ips_engine _time

[Fortigate-Event-His-Performance-DataCube]
definition =`fortigate_event_his_performance` | bin _time span=5m | fillnull device_name vdom cpu memory simultaneous_sessions  message | stats count by  device_name vdom cpu memory simultaneous_sessions  message _time

[Fortigate-Sslvpn-DataCube]
definition =`fortigate_sslvpn` | bin _time span=5m | fillnull device_name vdom tunnel_type tunnel_id source_ip tunnel_ip user group dst_host reason duration bytes_sent bytes_received message ssl_subtype action | stats count by device_name vdom tunnel_type tunnel_id source_ip tunnel_ip user group dst_host reason duration  bytes_sent bytes_received message ssl_subtype _time action

[Fortigate-Sslvpn-Portal-Tunnel-Traffic-DataCube]
definition = `fortigate_traffic` | bin _time span=5m | fillnull device_name vdom source_interface source_ip user group destination_interface destination_ip session_type destination_port service action policy_id bytes_sent bytes_received destination_country vpn_type | stats count by device_name vdom source_interface source_ip user group destination_interface destination_ip session_type destination_port service action policy_id bytes_sent bytes_received destination_country vpn_type _time


########################
#
# PostProcess Macros
#
########################

[Fortigate-Traffic-DataCube-Bytes-Transfered-Over-Time]
definition = search action!=deny | eval total_megabytes_received=(bytes_received/(1024*1024)) | eval total_megabytes_sent=(bytes_sent/(1024*1024)) | timechart span=5m sum(total_megabytes_received) as MB_Received sum(total_megabytes_sent) as MB_Sent by device_name usenull=f

[Fortigate-Traffic-DataCube-App-Bytes]
definition = search application!=0 action!=deny | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by application

[Fortigate-Traffic-DataCube-App-Request]
definition = search application!=0 action!=deny | stats count by application

[Fortigate-Traffic-DataCube-Top-Src-IP-Bytes]
definition = search source_ip!=0 action!=deny | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by source_ip

[Fortigate-Traffic-DataCube-Top-Src-IP]
definition = search source_ip!=0 action!=deny | stats count by source_ip

[Fortigate-Traffic-DataCube-Top-Dst-Port]
definition = search destination_port!=0 action!=deny | stats count by destination_port

[Fortigate-Traffic-DataCube-Top-Dst-IP-Bytes]
definition = search destination_ip!=0 action!=deny | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by destination_ip

[Fortigate-Traffic-DataCube-Top-Dst-IP]
definition = search destination_ip!=0 action!=deny | stats count by destination_ip

[Fortigate-Traffic-DataCube-Top-User-Bytes]
definition = search user!=0 action!=deny | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by user

[Fortigate-Traffic-DataCube-Top-Src-User]
definition = search user!=0 action!=deny | stats count by user

[Fortigate-Traffic-DataCube-Top-Device]
definition = search source_ip!=0 action!=deny | eval device_vdom=device_name.":".vdom| eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by device_vdom

[Fortigate-Traffic-DataCube-Top-Device_2]
definition = search source_ip!=0 action!=deny | eval device_vdom=device_name.":".vdom | eval total_megabytes_received=(bytes_received/(1024*1024)) | eval total_megabytes_sent=(bytes_sent/(1024*1024)) | stats  sum(total_megabytes_received) sum(total_megabytes_sent) as MBytes_sent sum(total_megabytes_received) as MBytes_received by device_vdom

[Fortigate-Traffic-DataCube-Top-Country-Bytes]
definition = search destination_country!=0 action!=deny | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by destination_country

[Fortigate-Traffic-DataCube-Outbound-Bytes]
definition =  search application!=0 action!=deny | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | eval devname_dst_interface=device_name.":".vdom.":".destination_interface | stats sum(mbytes_transfered) as MBytes by devname_dst_interface | sort -MBytes

[Fortigate-Traffic-DataCube-Inbound-Bytes]
definition =  search application!=0 action!=deny | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | eval devname_src_interface=device_name.":".vdom.":".source_interface | stats sum(mbytes_transfered) as MBytes by devname_src_interface | sort -MBytes

[Fortigate-Traffic-DataCube-Liste-Dst-Port-Bytes]
definition =  search destination_port!=0 action!=deny | replace "1" with "ICMP", "6" with "TCP", "17" with "UDP" in session_type | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by service, session_type,destination_port | sort -MBytes

[Fortigate-Traffic-DataCube-Liste-User-Bytes]
definition = search user!=0 action!=deny | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by user,source_ip | sort -MBytes

[Fortigate-Traffic-DataCube-Liste-Src-IP-Byte]
definition = search source_ip!=0 action!=deny | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by source_ip,user | sort -MBytes

[Fortigate-Traffic-DataCube-Liste-Dst-IP-Byte]
definition = search destination_ip!=0 action!=deny | replace "1" with "ICMP", "6" with "TCP", "17" with "UDP" in session_type | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by destination_ip, destination_country, session_type, destination_port | sort -MBytes

############################# Traffic denied #####################################

[Fortigate-Traffic-DataCube-Deny-Over-Time]
definition = search action=deny | timechart count by action usenull=f

[Fortigate-Traffic-DataCube-Deny-Top-Src-IP]
definition = search source_ip!=0 action=deny | stats count by source_ip

[Fortigate-Traffic-DataCube-Deny-Top-Src-User]
definition = search user!=0 action=deny | stats count by user

[Fortigate-Traffic-DataCube-Deny-Top-User-Group]
definition = search group!=0 action=deny | stats count by group

[Fortigate-Traffic-DataCube-Deny-Device]
definition = search device_name!=0 action=deny |  eval devname_vdom=device_name.":".vdom | stats count by devname_vdom

[Fortigate-Traffic-DataCube-Deny-Device-Policy]
definition =  search device_name!=0 action=deny | eval devname_vdom_policy_id=device_name.":".vdom.":policy_id ".policy_id | stats count by devname_vdom_policy_id

[Fortigate-Traffic-DataCube-Deny-Top-Dst-IP]
definition = search destination_ip!=0 action=deny | stats count by destination_ip

[Fortigate-Traffic-DataCube-Deny-Top-Country]
definition = search destination_country!=0 action=deny | stats count by destination_country

[Fortigate-Traffic-DataCube-Deny-Top-Dst-Port]
definition = search destination_port!=0 action=deny | replace "1" with "ICMP", "6" with "TCP", "17" with "UDP" in session_type | eval full_dst_port=session_type."_".destination_port | stats count by full_dst_port

[Fortigate-Traffic-DataCube-Deny-Activity]
definition = search destination_ip!=0 action=deny | replace "1" with "ICMP", "6" with "TCP", "17" with "UDP" in session_type | stats count by _time, device_name, vdom, source_ip, user, group, destination_ip, destination_country, session_type, destination_port, application, policy_id, action | sort -_time

############### Virus ##############

[Fortigate-Virus-DataCube-Log-Subtype]
definition = timechart count by subtype

[Fortigate-Virus-DataCube-RISK]
definition = timechart count by priority

[Fortigate-Virus-DataCube-Top-ThreatID]
definition = stats count by malware

[Fortigate-Virus-DataCube-Top-Service]
definition = stats count by service

[Fortigate-Virus-DataCube-Top-Policy]
definition = eval device_vdom=device_name.":".vdom | stats count by device_vdom

[Fortigate-Virus-DataCube-Top-Src-IP]
definition = stats count by source_ip

[Fortigate-Virus-DataCube-Top-Severity]
definition = stats count by priority

[Fortigate-Virus-DataCube-Top-Dst-IP]
definition = stats count by destination_ip

[Fortigate-Virus-DataCube-Top-File]
definition = stats count by file

[Fortigate-Virus-DataCube-Top-User]
definition = stats count by user

[Fortigate-Virus-DataCube-Top-Profile]
definition =  eval device_vdom_profile=device_name.":".vdom.":".profile | stats count by device_vdom_profile

[Fortigate-Virus-DataCube-Activty-Top-Virus]
definition = search malware!="N/A" | top limit=100 malware,service

[Fortigate-Virus-DataCube-Activty-Top-Src-IP]
definition = search malware!="N/A" | top limit=100 source_ip,user

[Fortigate-Virus-DataCube-Activty-Top-Src-User]
definition = search malware!="N/A" | top limit=100 source_ip,user,malware

######## IPS #############

[Fortigate-IPS-DataCube-Top-Action]
definition = search description!=0 | timechart count  by action

[Fortigate-IPS-DataCube-Severity]
definition = search severity!=0 | stats count by severity

[Fortigate-IPS-DataCube-Top-ThreatID]
definition =  search description!=0 | stats count by description

[Fortigate-IPS-DataCube-Top-Service]
definition =  search service!=0 | stats count by service

[Fortigate-IPS-DataCube-Top-Policy]
definition =  eval device_vdom=device_name.":".vdom | stats count by device_vdom

[Fortigate-IPS-DataCube-Top-Src-IP]
definition =  search source_ip!=0 | stats count by source_ip

[Fortigate-IPS-DataCube-Top-User]
definition =  search user!=0 | stats count by user

[Fortigate-IPS-DataCube-Top-Dst-IP]
definition =  search destination_ip!=0 | stats count by destination_ip

[Fortigate-IPS-DataCube-Top-Status]
definition =  search action!=0 | stats count by action

[Fortigate-IPS-DataCube-Top-Profile]
definition =  search sensor!=0 | eval device_vdom_sensor=device_name.":".vdom.":".sensor | stats count by device_vdom_sensor

[Fortigate-IPS-DataCube-Top-Subtype]
definition =  search description!=0 | stats count by subtype

[Fortigate-IPS-DataCube-Activty-Top-Attack]
definition =  search description!=0 | top limit=100 description,service

[Fortigate-IPS-DataCube-Activty-Top-Src-IP]
definition = search source_ip!=0 | top limit=100 source_ip,user

[Fortigate-IPS-DataCube-Activty-Top-Dest-IP]
definition = search destination_ip!=0 | top limit=100 destination_ip,service

################# Application Control ##########################

[Fortigate-App-ctrl-DataCube-Top-Application-Time]
definition = timechart count by application

[Fortigate-App-ctrl-DataCube-Top-ApplicationType]
definition = search application!=0 | stats count by app_type

[Fortigate-App-ctrl-DataCube-Top-Application]
definition = search application!=0 | stats count by application

[Fortigate-App-ctrl-DataCube-Top-Description]
definition = search application!=0 | stats count by category_and_application

[Fortigate-App-ctrl-DataCube-Top-Policy]
definition =  eval device_vdom=device_name.":".vdom | stats count by device_vdom

[Fortigate-App-ctrl-DataCube-Top-Src-IP]
definition = stats count by source_ip

[Fortigate-App-ctrl-DataCube-Top-Dst-IP]
definition = stats count by destination_ip

[Fortigate-App-ctrl-DataCube-Top-User]
definition = stats count by user

[Fortigate-App-ctrl-DataCube-Top-Status]
definition = stats count by action

[Fortigate-App-ctrl-DataCube-Top-Profile]
definition = eval device_vdom_profile=device_name.":".vdom.":".app_list | stats count by device_vdom_profile

[Fortigate-App-ctrl-DataCube-Activty-Top-Application]
definition =  search application!=0 | top limit=100 category_and_application

[Fortigate-App-ctrl-DataCube-Activty-Top-Application-by-Dest-Port]
definition = search application!=0 | replace "1" with "ICMP", "6" with "TCP", "17" with "UDP" in session_type | top limit=100 application,session_type,destination_port

[Fortigate-App-ctrl-DataCube-Activty-Top-Application-by-action]
definition = search application!=0 | top limit=100 category_and_application,action

################# Webfilter ########################

[Fortigate-Webfilter-DataCube-Top-Category-Time]
definition = timechart count by categorization

[Fortigate-Webfilter-DataCube-Top-Category]
definition = stats count by categorization

[Fortigate-Webfilter-DataCube-Top-Websites]
definition = stats count by site

[Fortigate-Webfilter-DataCube-Top-Service]
definition = stats count by service

[Fortigate-Webfilter-DataCube-Top-Policy]
definition = eval device_vdom=device_name.":".vdom | stats count by device_vdom

[Fortigate-Webfilter-DataCube-Top-Src-IP]
definition = stats count by source_ip

[Fortigate-Webfilter-DataCube-Top-Dst-IP]
definition = stats count by destination_ip

[Fortigate-Webfilter-DataCube-Top-User]
definition = stats count by user

[Fortigate-Webfilter-DataCube-Top-Status]
definition = stats count by status

[Fortigate-Webfilter-DataCube-Top-Profile]
definition = eval device_vdom_profile=device_name.":".vdom.":".profile | stats count by device_vdom_profile

[Fortigate-Webfilter-DataCube-Category-Bytes]
definition =  search service!=0 | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by categorization

[Fortigate-Webfilter-DataCube-Sites-Bytes]
definition = search service!=0 | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by site,categorization,service | sort -MBytes

[Fortigate-Webfilter-DataCube-Top-Src-IP-Bytes]
definition = search source_ip!=0 | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by source_ip,service | sort -MBytes

[Fortigate-Webfilter-DataCube-Sites-Users-Service]
definition = search service!=0 | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by user,service | sort -MBytes

[Fortigate-Webfilter-DataCube-Activty-Top-Dst-Hostname]
definition = top limit=100 site, categorization 

[Fortigate-Webfilter-DataCube-Activty-Web-Summary]
definition = search site!=0 | stats values(site) as "Site(s)" by _time, device_name, source_ip, user, categorization, status

##################### DHCP EVENTS ###################


[Fortigate-Event-DHCP-DataCube-DHCP-Event]
definition = search message!=0 | eval full_devname_vdom=device_name."_".vdom | timechart count by full_devname_vdom 

[Fortigate-Event-DHCP-DataCube-Activity]
definition = search message!=0 | stats count by _time, device_name, vdom, client_hostname, mac_address, client_ip, dhcp_message, direction, message  | sort -_time

#################### HIS Performance Events ###########

[Fortigate-Event-His-Performance-DataCube-CPU]
definition = eval device_vdom=device_name.":".vdom | timechart  span=30m eval(max(cpu)) by device_vdom usenull=f

[Fortigate-Event-His-Performance-DataCube-Memory]
definition = eval device_vdom=device_name.":".vdom | timechart  span=30m eval(max(memory)) by device_vdom usenull=f

[Fortigate-Event-His-Performance-DataCube-Sessions]
definition = eval device_vdom=device_name.":".vdom | timechart span=30m eval(max(simultaneous_sessions)) by device_vdom usenull=f

################################### Pattern Events ######################

[Fortigate-Event-Pattern-DataCube-Update-Event]
definition = search status=update | sort -_time | dedup device_name | table device_name, antivirus_engine, antivirus_db, ips_engine, ips_db

################################## Authentication Captive Portal #############################

[Fortigate-Event-Auth-Captive-Portal-DataCube-Failure-Time]
definition = search status=failure | eval devname_vdom=device_name."-".vdom | timechart count by devname_vdom

[Fortigate-Event-Auth-Captive-Portal-DataCube-Failure]
definition = search status=failure | stats count by _time, device_name,vdom, user, source_ip, status, message | sort -_time

[Fortigate-Event-Auth-Captive-Portal-DataCube-Success]
definition = search status=success | stats count by _time, device_name,vdom, user, group, source_ip, status, message | sort -_time

##################################### VPN SSL ##################################

[Fortigate-Sslvpn-DataCube-Events-Time]
definition = timechart count by message

[Fortigate-Sslvpn-DataCube-Auth]
definition = search ssl_subtype="sslvpn-user" | eval session_duration=case(duration=0, "N/A", duration!=0, tostring(duration,"duration")) | stats count by _time, device_name,vdom, user, group, source_ip, tunnel_type, tunnel_id, reason, session_duration, message | sort -_time, session_duration

[Fortigate-SSLvpn-DataCube-Top-User-Bytes]
definition = search user!=0 | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by user

[Fortigate-SSLvpn-DataCube-Top-Group-Bytes]
definition = search group!=0 | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by group

[Fortigate-SSLvpn-DataCube-Top-Tunnel-Type-Bytes]
definition = search tunnel_type!=0 | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | replace "ssl-tunnel" with "Tunnel_mode", "ssl-web" with "Portal_mode" in tunnel_type | stats sum(mbytes_transfered) as MBytes by tunnel_type

[Fortigate-SSLvpn-DataCube-Duration]
definition = search ssl_subtype="sslvpn-user" AND duration!=0 | eval repartition=case(duration<=1800, "less than 30 min", duration>1800 AND duration<=3600, "betweenn 30 min and 1 hour", duration>3600 AND duration<=7200, "between 1 and 2 hours", duration>7200 AND duration<=10800, "between 2 and 3 hours", duration>10800 AND duration<=14400, "between 3 and 4 hours", duration>14400 , "more than 4 hours") | stats count by repartition 

##################################### VPN SSL - Portal Mode ##########################

[Fortigate-Sslvpn-Portal-DataCube-User-by-Time]
definition =  search vpn_type="sslvpn" | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | timechart sum(mbytes_transfered) as MBytes by user

[Fortigate-Sslvpn-Portal-Traffic-DataCube-Bytes-Transfered-Over-Time]
definition = search vpn_type="sslvpn" | eval total_megabytes_received=(bytes_received/(1024*1024)) | eval total_megabytes_sent=(bytes_sent/(1024*1024)) | timechart sum(total_megabytes_received) as MB_Received sum(total_megabytes_sent) as MB_Sent by device_name

[Fortigate-Sslvpn-Portal-Traffic-DataCube-Service-Bytes]
definition = search service!=0 AND vpn_type="sslvpn" | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by service

[Fortigate-Sslvpn-Portal-Traffic-DataCube-Service-Request]
definition = search service!=0 AND vpn_type="sslvpn" | stats count by service

[Fortigate-Sslvpn-Portal-Traffic-DataCube-Top-Dst-IP-Bytes]
definition = search destination_ip!=0 AND vpn_type="sslvpn" | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by destination_ip

[Fortigate-Sslvpn-Portal-Traffic-DataCube-Top-Dst-IP]
definition = search destination_ip!=0 AND vpn_type="sslvpn" | stats count by destination_ip

[Fortigate-Sslvpn-Portal-Traffic-DataCube-Top-User-Bytes]
definition = search tunnel_type="ssl-web" AND action="tunnel-down" | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by user
#definition = search user!=0 AND vpn_type="sslvpn" | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by user

[Fortigate-Sslvpn-Portal-Traffic-DataCube-Top-User-Bytes-List]
definition = search tunnel_type="ssl-web" AND action="tunnel-down" AND bytes_received!=0 AND bytes_sent!=0 | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | eval total_session_duration=case(duration!=0, tostring(duration,"duration")) | stats sum(mbytes_transfered) as MBytes by user, group, device_name, vdom, total_session_duration | sort -MBytes

[Fortigate-Sslvpn-Portal-Traffic-DataCube-Top-Device]
definition = search vpn_type="sslvpn" | eval device_vdom=device_name.":".vdom| eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by device_vdom

[Fortigate-Sslvpn-Portal-Traffic-DataCube-Top-Country-Bytes]
definition = search destination_country!=0 AND vpn_type="sslvpn" | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by destination_country

##################################### VPN SSL - Tunnel Mode ##########################

[Fortigate-Sslvpn-Tunnel-DataCube-Device-by-Time]
definition =  eval ssl_int="ssl.".vdom | where source_interface=ssl_int | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | eval devname_vdom=device_name.":".vdom | timechart sum(mbytes_transfered) as MBytes by devname_vdom

[Fortigate-Sslvpn-Tunnel-Traffic-DataCube-Bytes-Transfered-Over-Time]
definition = search source_interface="ssl.root" | eval total_megabytes_received=(bytes_received/(1024*1024)) | eval total_megabytes_sent=(bytes_sent/(1024*1024)) | timechart sum(total_megabytes_received) as MB_Received sum(total_megabytes_sent) as MB_Sent by device_name

[Fortigate-Sslvpn-Tunnel-Traffic-DataCube-Service-Bytes]
definition = search service!=0 AND source_interface="ssl.root" | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by service

[Fortigate-Sslvpn-Tunnel-Traffic-DataCube-Service-Request]
definition = search service!=0 AND source_interface="ssl.root" | stats count by service

[Fortigate-Sslvpn-Tunnel-Traffic-DataCube-Top-Dst-IP-Bytes]
definition =  eval ssl_int="ssl.".vdom | where source_interface=ssl_int | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by destination_ip

[Fortigate-Sslvpn-Tunnel-Traffic-DataCube-Top-Dst-IP]
definition =  eval ssl_int="ssl.".vdom | where source_interface=ssl_int | stats count by destination_ip

[Fortigate-Sslvpn-Tunnel-Traffic-DataCube-Top-User-Bytes]
definition = search tunnel_type="ssl-tunnel" AND action="tunnel-down" | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by user

[Fortigate-Sslvpn-Tunnel-Traffic-DataCube-IP-User]
definition = search fields tunnel_id, user, tunnel_ip, group, tunnel_type, action,_time | search (tunnel_type="ssl-tunnel" AND (action="tunnel-up" OR action="tunnel-down")) | transaction tunnel_id, user, action | table _time, tunnel_ip, user, action | sort -_time

[Fortigate-Sslvpn-Tunnel-Traffic-DataCube-Top-User-Bytes-List]
definition = search tunnel_type="ssl-tunnel" AND action="tunnel-down" | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | eval total_session_duration=case(duration!=0, tostring(duration,"duration")) | stats sum(mbytes_transfered) as MBytes by user, group, device_name, vdom, total_session_duration | sort -MBytes

[Fortigate-Sslvpn-Tunnel-Traffic-DataCube-Top-Device]
definition =  eval ssl_int="ssl.".vdom | where source_interface=ssl_int | eval device_vdom=device_name.":".vdom| eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by device_vdom

[Fortigate-Sslvpn-Tunnel-Traffic-DataCube-Top-Country-Bytes]
definition =  eval ssl_int="ssl.".vdom | where source_interface=ssl_int | eval mbytes_transfered=((bytes_received+bytes_sent)/(1024*1024)) | stats sum(mbytes_transfered) as MBytes by destination_country
