<?xml version='1.0' encoding='utf-8'?>
<form script="application.js, home.js" stylesheet="application.css, home.css">

   <label>Home</label>
   <description>This is the app's main dashboard</description>

   <fieldset autoRun="true">
      <input type="time" searchWhenChanged="true">
         <label>Time range:</label>
         <default>
            <earliestTime>-1d</earliestTime>
            <latestTime>now</latestTime>
         </default>
      </input>
      <input type="text" token="FilterString">
         <label>Filter:</label>
         <default></default>
         <prefix></prefix>
         <suffix></suffix>
      </input>
      <input type="text" token="HostFilter">
         <label>Host:</label>
         <default></default>
         <prefix>*</prefix>
         <suffix>*</suffix>
      </input>
      <input type="dropdown" token="Sourcetype" id="Input_Sourcetype" searchWhenChanged="true" >
         <choice value="=*">All</choice>
         <choice value="=hksm:main">HK Systems Management: Framework</choice>
         <choice value="!=hksm:main">All except HK Systems Management: Framework</choice>
         <default>*</default>
         <label>Script messages to display:</label>
         <prefix>sourcetype</prefix>
         <suffix></suffix>
         <search>
            <query>
               index=hksm sourcetype!="hksm:main" | eval EqualsSourcetype="=".sourcetype | stats count by EqualsSourcetype sourcetype
            </query>
         </search>
         <fieldForLabel>sourcetype</fieldForLabel>
         <fieldForValue>EqualsSourcetype</fieldForValue>
      </input>
   </fieldset>

   <!-- First row -->
   <row>
      <panel>
         <search id="Search_Base_Row1">
            <query>
               index=hksm $Sourcetype$ | search host=*$HostFilter$* $FilterString$ | stats dc(sourcetype) as NumberOfScripts dc(host) as NumberOfHosts count as NumberOfMessages
            </query>
         </search>

         <single id="Single_NumberOfScripts">
            <search base="Search_Base_Row1">
            </search>
            <option name="field">NumberOfScripts</option>
            <option name="beforeLabel">Script count:</option>
            <option name="refresh.time.visible">false</option>
         </single>
         <single id="Single_NumberOfHosts">
            <search base="Search_Base_Row1">
            </search>
            <option name="field">NumberOfHosts</option>
            <option name="beforeLabel">Host count:</option>
            <option name="refresh.time.visible">false</option>
         </single>
         <single id="Single_NumberOfMessages">
            <search base="Search_Base_Row1">
            </search>
            <option name="field">NumberOfMessages</option>
            <option name="beforeLabel">Message count:</option>
            <option name="refresh.time.visible">false</option>
         </single>
      </panel>
   </row>

   <!-- Second row -->
   <row>
      <panel>
         <chart>
            <title>Message count over time by script</title>
            <search>
               <!-- Dynamic timechart span hack -->
               <query>
                  <![CDATA[index=hksm $Sourcetype$ | search host=*$HostFilter$* $FilterString$ | eval Script=sourcetype | timechart count [stats count | addinfo | eval range = info_max_time-info_min_time | eval span = "span=" . case(range < 4000, "1m", range < 90000, "30m", range < 700000, "6h", 1=1, "1d") | return $span] by Script]]>
               </query>
            </search>
            <option name="height">300px</option>
            <option name="charting.chart">column</option>
            <option name="charting.chart.stackMode">stacked</option>
            <option name="charting.legend.placement">right</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
            <option name="charting.axisTitleY.visibility">collapsed</option>
         </chart>      
      </panel>
   </row>

   <!-- Base search -->
   <search id="Search_Base_Row3">
      <query>
         index=hksm $Sourcetype$ | search host=*$HostFilter$* $FilterString$ | eval Script=sourcetype | eval "Message Text"=coalesce(message,_raw) | sistats count by Script "Message Text"
      </query>
   </search>
         
   <!-- Third row -->
   <row>
      <panel>
         <!-- First column -->
         <chart>
            <title>Message count by script (top 10)</title>
            <search base="Search_Base_Row3">
               <query>
                  stats count as "Count per script" by Script | sort -"Count per script" | head 10
               </query>
            </search>
            <option name="height">300px</option>
            <option name="charting.chart">bar</option>
            <option name="charting.legend.placement">none</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
            <option name="charting.axisTitleY.visibility">collapsed</option>
         </chart>
      </panel>

      <!-- Second column -->
      <panel>
         <chart>
            <title>Message count by message content (top 10)</title>
            <search base="Search_Base_Row3">
               <query>
                  stats count as "Count per content" by "Message Text" | sort -"Count per content" | head 10
               </query>
            </search>
            <option name="height">300px</option>
            <option name="charting.chart">bar</option>
            <option name="charting.legend.placement">none</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
            <option name="charting.axisTitleY.visibility">collapsed</option>
         </chart>
      </panel>
   </row>

   <!-- Fourth row -->
   <row>
      <!-- First column -->
      <panel>
         <table>
            <title>All messages</title>
            <search>
               <query>
                  index=hksm $Sourcetype$ | search host=*$HostFilter$* $FilterString$ | eval Script=sourcetype | eval "Message text"=coalesce(message,_raw) | table _time host Script "Message text"
               </query>
            </search>
            <option name="count">30</option>
         </table>
      </panel>
   </row>

</form>