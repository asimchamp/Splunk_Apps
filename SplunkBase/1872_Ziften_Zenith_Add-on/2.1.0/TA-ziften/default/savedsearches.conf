[Alert | Incremental Update | NVD]
action.email.inline = 1
action.email.reportServerEnabled = 0
alert.suppress = 0
alert.track = 1
auto_summarize.dispatch.earliest_time = -1d@h
counttype = number of events
cron_schedule = */15 * * * *
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.visualizations.charting.chart = area
display.visualizations.show = 0
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:zenith:processinventory\
    |table _time agentguid message_type imagefilemd5 imagefilepath accountname ipaddress port companyname\
    |join imagefilemd5 [|inputlookup nvd_md5_to_cve.csv|rename md5 as imagefilemd5]\
    |rename cve as details\
    |eval feed="nvd"\
    |eval message_type="vulnerability" \
    |table _time agentguid message_type imagefilemd5 imagefilepath accountname ipaddress port details score feed\
    |collect index=main sourcetype=ziften:zenith:alert

[Alert | Full Population | OTX]
action.email.reportServerEnabled = 0
alert.track = 0
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = area
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:zenith:networkconnect \
    |table _time agentguid imagefilemd5 imagefilepath accountname ipaddress port\
    |join type=left agentguid imagefilemd5 ipaddress [search sourcetype=ziften:alert:otx feed=otx]\
    |where isnull(feed)\
    |table _time agentguid imagefilemd5 imagefilepath accountname ipaddress port\
    |lookup otxlookup ipaddress\
    |where isnotnull(classification)\
    |rename classification as details\
    |eval score=risk."/10"\
    |eval feed="otx"\
    |eval message_type="network_alert" \
    |table _time agentguid message_type imagefilemd5 imagefilepath accountname ipaddress port details score feed revision\
    |collect index=main sourcetype=ziften:zenith:alert

[Alert | Full Population | NVD]
action.email.reportServerEnabled = 0
alert.track = 0
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = area
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:zenith:processinventory\
    |table _time agentguid imagefilemd5 imagefilepath accountname ipaddress port companyname\
    |join type=left agentguid imagefilemd5 [search sourcetype=ziften:alert:vulnerablity feed=nvd]\
    |where isnull(feed)\
    |table _time agentguid message_type imagefilemd5 imagefilepath accountname ipaddress port companyname\
    |join imagefilemd5 [|inputlookup nvd_md5_to_cve.csv|rename md5 as imagefilemd5]\
    |rename cve as details\
    |eval feed="nvd"\
    |eval message_type="vulnerability" \
    |table _time agentguid message_type imagefilemd5 imagefilepath accountname ipaddress port companyname details score feed\
    |collect index=main sourcetype=ziften:zenith:alert

[Alert | Incremental Update | New User]
action.email.reportServerEnabled = 0
alert.severity = 2
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 30 * * * *
dispatch.earliest_time = -1h
dispatch.latest_time = now
display.general.type = statistics
display.visualizations.charting.chart = area
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = |inputlookup users.csv\
    |eval _time=first_seen\
    |sort _time\
    |streamstats count by agentguid\
    |dedup agentguid sortby -_time\
    |where count > 1 AND first_seen > now()-3600\
    |eval message_type="new_user_alert"\
    |eval feed="user" \
    |table _time agentguid message_type accountname feed\
    |collect index=main sourcetype=ziften:alert:newuser

[Lookup Population | Incremental Update | Virus Total]
action.email.inline = 1
action.email.reportServerEnabled = 0
alert.digest_mode = True
alert.suppress = 0
alert.track = 0
auto_summarize.dispatch.earliest_time = -1d@h
cron_schedule = */10 * * * *
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = area
display.visualizations.show = 0
enableSched = 1
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = |inputlookup image.csv\
    |join imagefilemd5 type=left [inputlookup vthistory.csv|rename md5 as imagefilemd5]\
    |where isnull(lookup_time)\
    |rename imagefilemd5 as md5\
    |head 30\
    |lookup vtlookup md5

[Alert | Incremental Update | OXT]
action.email.inline = 1
action.email.reportServerEnabled = 0
alert.suppress = 0
alert.track = 1
auto_summarize.dispatch.earliest_time = -1d@h
counttype = number of events
cron_schedule = */10 * * * *
dispatch.earliest_time = -10m
dispatch.latest_time = now
display.general.type = statistics
display.visualizations.charting.chart = area
display.visualizations.show = 0
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=networkconnect \
    |lookup otxlookup ipaddress\
    |where isnotnull(classification)\
    |rename classification as details\
    |eval score=risk."/10"\
    |eval feed="otx"\
    |eval message_type="network_alert" \
    |table _time agentguid message_type imagefilemd5 imagefilepath accountname ipaddress port details score feed\
    |collect index=main sourcetype=ziften:zenith:alert

[Lookup Population | Full Population | System Info]
action.email.reportServerEnabled = 0
alert.track = 0
cron_schedule = */5 * * * *
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = line
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:zenith:systeminventory |stats latest(osname) as osname latest(computername) as computername by agentguid|eval osname=replace(osname,"\|.*", "")| append [inputlookup systems.csv]|stats first(osname) as osname first(computername) as computername by agentguid|outputlookup systems.csv

[Lookup Population | Full Population | System Users]
action.email.reportServerEnabled = 0
alert.track = 0
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = area
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* | where isnotnull(accountname) AND accountname!="LOCAL SERVICE" AND accountname!="NETWORK SERVICE" AND accountname!="SYSTEM" AND agentguid!="00000000-0000-0000-0000-000000000000" | stats min(_time) as first_seen by accountname agentguid| append [inputlookup users.csv]|stats min(first_seen) as first_seen by accountname agentguid|outputlookup users.csv

[Alert | Full Population | User]
action.email.reportServerEnabled = 0
alert.track = 0
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = area
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* \
    |where isnotnull(accountname) AND accountname!="LOCAL SERVICE" AND accountname!="NETWORK SERVICE" AND accountname!="SYSTEM" AND agentguid!="00000000-0000-0000-0000-000000000000" \
    |stats min(_time) as first_seen by accountname agentguid\
    |eval _time=first_seen\
    |sort _time\
    |streamstats count by agentguid\
    |dedup agentguid sortby -_time\
    |where count > 1\
    |eval message_type="new_user_alert"\
    |table _time first_seen agentguid message_type accountname\
    |join type=left agentguid accountname [search sourcetype=ziften:zenith:alert feed=user]\
    |where isnull(feed)\
    |eval feed="user" \
    |table _time first_seen agentguid message_type accountname feed\
    |collect index=main sourcetype=ziften:zenith:alert

[Lookup Population | Daily Update | Image Info]
action.email.reportServerEnabled = 0
alert.track = 0
cron_schedule = 0 0 * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
display.general.type = statistics
display.visualizations.charting.chart = line
display.visualizations.show = 0
enableSched = 1
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = |savedsearch "Lookup Population | Full Population | Image Info"

[Lookup Population | Daily Update | System Info]
action.email.reportServerEnabled = 0
alert.track = 0
cron_schedule = 0 0 * * *
dispatch.earliest_time = 0
dispatch.latest_time = now
display.general.type = statistics
display.visualizations.charting.chart = area
display.visualizations.charting.chart.stackMode = stacked
display.visualizations.show = 0
enableSched = 1
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = |savedsearch "Lookup Population | Full Population | System Info"

[Lookup Population | Incremental Update | Image Info]
action.email.reportServerEnabled = 0
alert.track = 0
cron_schedule = */5 * * * *
dispatch.earliest_time = -10m
dispatch.latest_time = now
display.general.type = statistics
display.visualizations.charting.chart = line
display.visualizations.show = 0
enableSched = 1
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = |savedsearch "Lookup Population | Full Population | Image Info"

[Lookup Population | Incremental Update | System Info]
action.email.reportServerEnabled = 0
alert.track = 0
cron_schedule = */5 * * * *
dispatch.earliest_time = -10m
dispatch.latest_time = now
display.general.type = statistics
display.visualizations.charting.chart = area
display.visualizations.charting.chart.stackMode = stacked
display.visualizations.show = 0
enableSched = 1
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = |savedsearch "Lookup Population | Full Population | System Info"

[Lookup Population | Incremental Update | System Users]
action.email.reportServerEnabled = 0
alert.track = 0
cron_schedule = */15 * * * *
dispatch.earliest_time = -15m
dispatch.latest_time = now
display.general.type = statistics
display.visualizations.charting.chart = area
display.visualizations.show = 0
enableSched = 1
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = |savedsearch "Lookup Population | Full Population | System Users"

[Alert | Incremental Update | Virus Total]
action.email.reportServerEnabled = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 30 * * * *
dispatch.earliest_time = -1h
dispatch.latest_time = now
display.general.type = statistics
display.visualizations.charting.chart = area
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:zenith:* imagefilemd5!=""\
    |table _time agentguid message_type imagefilemd5 imagefilepath accountname ipaddress port\
    |join imagefilemd5 [|inputlookup vt_current_data.csv|dedup md5 | rename md5 as imagefilemd5]\
    |where hits > 2\
    |eval feed="vt"\
    |eval message_type="binary_alert"\
    |eval event_time=_time\
    |bucket _time span=1d \
    |dedup _time agentguid imagefilemd5\
    |eval _time=event_time\
    |table _time agentguid message_type imagefilemd5 imagefilepath accountname ipaddress port details score feed\
    |eval basename = replace(trim(imagefilepath,"\""), ".*\\\\", "")|eval signature = details|rex field=signature mode=sed "s/.*]//g"\
    |collect index=main sourcetype=ziften:zenith:alert

[Alert | Full Population | Virus Total]
action.email.reportServerEnabled = 0
alert.track = 0
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = area
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:zenith:* imagefilemd5!="" \
    |table _time agentguid imagefilemd5 imagefilepath accountname ipaddress port\
    |join type=left agentguid imagefilemd5 [search sourcetype=ziften:zenith:alert feed=vt]\
    |where isnull(feed)\
    |table _time agentguid message_type imagefilemd5 imagefilepath accountname ipaddress port\
    |join imagefilemd5 [|inputlookup vt_current_data.csv|dedup md5 | rename md5 as imagefilemd5]\
    |where hits > 2\
    |eval feed="vt"\
    |eval message_type="binary_alert"\
    |eval event_time=_time\
    |bucket _time span=1d \
    |dedup _time agentguid imagefilemd5\
    |eval _time=event_time\
    |table _time agentguid message_type imagefilemd5 imagefilepath accountname ipaddress port details score feed\
    |eval basename = replace(trim(imagefilepath,"\""), ".*\\\\", "")|eval signature = details|rex field=signature mode=sed "s/.*]//g"\
    |collect index=main sourcetype=ziften:zenith:alert

[Lookup Population | Full Population | Image Info]
action.email.reportServerEnabled = 0
alert.track = 0
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = line
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=processinventory OR message_type=osxsoftwareinventory |eval os=if(match(message_type,"osx.*"), "OSX", "Win")|eval first_seen=_time|stats first(imagefilepath) as sample_path first(os) as OS min(first_seen) as first_seen first(fileversion) as fileversion first(productversion) as productversion first(companyname) as companyname by imagefilemd5|append [inputlookup image.csv]|stats first(sample_path) as sample_path first(OS) as OS min(first_seen) as first_seen first(fileversion) as fileversion first(productversion) as productversion first(companyname) as companyname by imagefilemd5|outputlookup image.csv
[Anomaly|ExcessiveApplicationFaults]
action.email.reportServerEnabled = 0
alert.track = 0
description = A given system and application combination exhibit excessive fault events.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = line
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=eventlogrecord earliest = -30d  sourcename="Application *" | rex field=imagefilepath ".*\\\\(?<filename>.*)" | stats c(sourcename) as events latest(imagefilepath) as filepath latest(modulefilename) as modulefilename by agentguid, filename | where events >= 10 | sort 0 - events

[Anomaly|ExcessiveServiceEvents]
action.email.reportServerEnabled = 0
alert.track = 0
description = A given system and service combination exhibit excessive service events.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = line
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=eventlogrecord earliest = -30d  sourcename="Service Control Manager" | rex field=_raw "message=\"\"\d*\"\s\"(?<service>[^\"]*)" | stats c(sourcename) as events latest(imagefilepath) as filepath by agentguid, service | where events >= 50 | sort 0 - events

[Anomaly|FilepathSuspectDir]
action.email.reportServerEnabled = 0
alert.track = 0
description = Suspicious directory (typical of malware) included in filepath.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=processinventory earliest=-30d | stats latest(imagefilemd5) as md5, latest(fileversion) as fileversion by agentguid, imagefilepath | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9\-\. ]*\\\\/\\\\users\\\\...\\\\/"  | eventstats dc(agentguid) as fp_systems by filepath | eventstats dc(agentguid) as md5_systems by md5 | where NOT like(filepath,"%\\trend micro\\%") AND fp_systems <= 10 AND md5_systems <= 10 AND (like(filepath,"%\\appdata%") OR like(filepath,"%\\users%") OR like(filepath,"%\\temp%") OR like(filepath,"%\\tmp%")) | sort 0 filepath

[Anomaly|FrequentInterferenceByUnusualMd5]
action.email.reportServerEnabled = 0
alert.track = 0
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = line
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* earliest = -30d  message_type=interferingprocess | eventstats dc(agentguid) as systems by imagefilemd5 | stats sum(numberintervals) as interferences, latest(imagefilepath) as imagefilepath, latest(systems) as systems by agentguid, imagefilemd5 | where isnotnull(imagefilemd5) and systems <= 10 and interferences >= 100 | sort 0 - interferences/systems | head 100

[Anomaly|HighComplianceDelta]
action.email.reportServerEnabled = 0
alert.track = 0
description = High disparity between in-compliance and out-of-compliance policy status (greater than 10%)
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = line
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* earliest = -30d  message_type=policystatus | stats c(eval(policystatus=3)) as incomp, c(eval(policystatus=4)) as outcomp by agentguid | eval comp_delta=outcomp - incomp | where comp_delta * 5 > incomp | sort 0 - comp_delta | head 100

[Anomaly|HighLogonSidEntropy]
action.email.reportServerEnabled = 0
alert.track = 0
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = line
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=eventlogrecord earliest=-30d Microsoft-Windows-Winlogon | rex field=_raw "message=[\"\d\s]*(?<SID>S[-\d]+)" | stats c(SID) as events by agentguid, SID | eventstats c(events) as SIDs sum(events) as totalevents by agentguid | eval ent = -(events/totalevents)*log(events/totalevents,2) | eval SIDevents = SID.": ".events | stats sum(ent) as SIDentropy, values(SIDevents) as "SID: events" by agentguid | sort 0 -SIDentropy | head 100

[Anomaly|HighPrevFilenameLowPrevFilepath]
action.email.reportServerEnabled = 0
alert.track = 0
description = Rare MD5 for such a common executable, raises suspicion.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=processinventory earliest=-30d | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9\-\. ]*\\\\/\\\\users\\\\...\\\\/"  | stats dc(agentguid) as fp_systems values(agentguid) as systems values(fileversion) as fileversions values(imagefilemd5) as md5s by filepath | eval filename = lower(replace(filepath,".*\\\\","")) | eventstats sum(fp_systems) as fn_systems max(fp_systems) as max_fp_sys by filename | regex filepath!=".*(tmp|temp)\\\\.*" | eval rarity = fp_systems/fn_systems | where rarity < 0.005 and 3*max_fp_sys > fn_systems and md5s!="" | sort 0 rarity, filename | head 100

[Anomaly|HighPrevFilenameLowPrevMD5]
action.email.reportServerEnabled = 0
alert.track = 0
description = Rare MD5 for such a common executable, raises suspicion.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=processinventory earliest=-30d | eval filename=lower(replace(trim(imagefilepath,"\""),".*\\\\","")) | eventstats dc(agentguid) as fn_systems by filename | stats dc(agentguid) as md5_systems values(agentguid) as systems max(fn_systems) as fn_systems  latest(fileversion) as fileversion by filename, imagefilemd5 | eventstats max(md5_systems) as max_md5_sys by filename | eval rarity = md5_systems/fn_systems | where rarity < 0.005 and 5*max_md5_sys > fn_systems | sort 0 rarity, filename | head 100

[Anomaly|HighPrevFilepathLowPrevMD5]
action.email.reportServerEnabled = 0
alert.track = 0
description = Rare MD5 for such a common executable, raises suspicion.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=processinventory earliest=-30d | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9\-\. ]*\\\\/\\\\users\\\\...\\\\/"  | eventstats dc(agentguid) as fp_systems by filepath | stats dc(agentguid) as md5_systems values(agentguid) as systems max(fp_systems) as fp_systems  latest(fileversion) as fileversion by filepath, imagefilemd5 | eventstats max(md5_systems) as max_md5_sys by filepath | eval rarity = md5_systems/fp_systems | where rarity < 0.005 and 5*max_md5_sys > fp_systems | sort 0 rarity, filepath | head 100

[Anomaly|HighPrevFilepathLowPrevPort]
action.email.reportServerEnabled = 0
alert.track = 0
description = Rare port usage for such a common executable, raises suspicion.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=networkconnect earliest=-30d | stats latest(imagefilemd5) as md5 by agentguid,imagefilepath,port | where isnotnull(md5) | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9\-\. ]*\\\\/\\\\users\\\\...\\\\/"  | stats max(md5) as md5 by agentguid,filepath,port | eventstats dc(agentguid) as fp_systems by filepath | eventstats dc(agentguid) as port_systems by filepath, port | eval rarity =  port_systems/fp_systems | sort 0 rarity, agentguid | head 100

[Anomaly|LowPrevActiveX]
action.email.reportServerEnabled = 0
alert.track = 0
description = Unusual ActiveX module present
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=activex earliest = -90d | stats latest(description) as description, latest(registrylocation) as registrylocation, latest(imagefilemd5) as md5 by agentguid, imagefilepath | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9\-\. ]*\\\\/\\\\users\\\\...\\\\/"  | eventstats dc(agentguid) as fp_systems by filepath | eventstats dc(agentguid) as md5_systems by md5 | where fp_systems <= 10 AND md5_systems <= 10 | sort 0 description

[Anomaly|LowPrevAutorun]
action.email.reportServerEnabled = 0
alert.track = 0
description = Unusual autorun present
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=autostarts earliest = -90d | stats latest(imagefilemd5) as md5, latest(entrypath) as entrypath by agentguid, imagefilepath | eval filename=replace(trim(imagefilepath,"\""),".*\\\\","") | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9\-\. ]*\\\\/\\\\users\\\\...\\\\/"  | eventstats dc(agentguid) as fp_systems by filepath | eventstats dc(agentguid) as md5_systems by md5 | where fp_systems <= 10 AND md5_systems <= 10 | sort 0 filename

[Anomaly|LowPrevBackgroundOverPort443]
action.email.reportServerEnabled = 0
alert.track = 0
description = Low prevalence background processes using port 443.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = line
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=resourceusage OR (message_type=networkconnect AND port=443) earliest=-30d | stats dc(agentguid) as systems c(eval(message_type="resourceusage")) as fg c(eval(message_type="networkconnect")) as connects by imagefilepath | where fg=0 | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9\-\. ]*\\\\/\\\\users\\\\...\\\\/" | stats sum(systems) as systems, sum(connects) as connects by filepath | where systems <= 10 | sort 0 filepath

[Anomaly|LowPrevBootExecutable]
action.email.reportServerEnabled = 0
alert.track = 0
description = Unusual boot-time executable present
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=bootanalysis earliest = -30d | stats latest(commandline) as commandline, latest(imagefilemd5) as md5 by agentguid, imagefilepath | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9\-\. ]*\\\\/\\\\users\\\\...\\\\/"  | eval filename = replace(filepath,".*\\\\","") | eventstats dc(agentguid) as fp_systems by filepath | eventstats dc(agentguid) as md5_systems by md5 | where fp_systems <= 10 AND md5_systems <= 10 | sort 0 filename

[Anomaly|LowPrevOfficePlugin]
action.email.reportServerEnabled = 0
alert.track = 0
description = Unusual Microsoft Office plugin  module present
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=officeplugins earliest = -90d | stats latest(friendlyname) as friendlyname, latest(description) as description, latest(imagefilemd5) as md5 by agentguid, imagefilepath | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9\-\. ]*\\\\/\\\\users\\\\...\\\\/"  | eventstats dc(agentguid) as fp_systems by filepath | eventstats dc(agentguid) as md5_systems by md5 | where fp_systems <= 10 AND md5_systems <= 10 | sort 0 friendlyname

[Anomaly|LowPrevPortPromiscuity]
action.email.reportServerEnabled = 0
alert.track = 0
description = Rare MD5 for such a common executable, raises suspicion.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=networkconnect earliest = -30d | eval filename=replace(trim(imagefilepath,"\""),".*\\\\","") | stats dc(ipaddress) as ips dc(agentguid) as systems dc(port) as ports values(fileversion) as fileversions values(imagefilemd5) as md5s by filename | where systems <= 5 and ports >= 5 and ips >= 5 | sort 0 - ports | head 100

[Anomaly|LowPrevService]
action.email.reportServerEnabled = 0
alert.track = 0
description = Unusual service present
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=services earliest = -90d | stats latest(displayname) as displayname, latest(binarypathname) as binarypathname, latest(imagefilemd5) as md5 by agentguid, imagefilepath | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9\-\. ]*\\\\/\\\\users\\\\...\\\\/"  | eventstats dc(agentguid) as fp_systems by filepath | eventstats dc(agentguid) as md5_systems by md5 | where fp_systems <= 10 AND md5_systems <= 10 | sort 0 displayname

[Anomaly|Network|LowPrevHighConnect]
action.email.reportServerEnabled = 0
alert.track = 0
description = Low prevalence apps connecting to high number of distinct IP addresses
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=networkconnect earliest=-30d | eval filename=replace(trim(imagefilepath,"\""),".*\\\\","") | stats dc(ipaddress) as ips dc(agentguid) as fn_systems values(agentguid) as systems values(imagefilemd5) as md5s by filename | where fn_systems < 50 AND ips > 50 | sort - ips

[Anomaly|SystemBugCheck]
action.email.reportServerEnabled = 0
alert.track = 0
description = A given system experienced a BugCheck event (BSOD).
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = line
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=eventlogrecord earliest = -30d  sourcename="BugCheck" | stats c(sourcename) as events latest(timestamp) by agentguid | sort 0 - events,agentguid

[Anomaly|UnusualFilepath]
action.email.reportServerEnabled = 0
alert.track = 0
description = Executable filepath exhibits unusual characteristics.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=processinventory earliest=-30d | stats latest(imagefilemd5) as md5, latest(fileversion) as fileversion by agentguid, imagefilepath | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9\-\. ]*\\\\/\\\\users\\\\...\\\\/"  | eventstats dc(agentguid) as fp_systems by filepath | eventstats dc(agentguid) as md5_systems by md5 | makemv delim="\\" filepath | mvexpand filepath | streamstats c(filepath) as fpindx, first(md5) as md5, first(fileversion) as fileversion, first(fp_systems) as fp_systems, first(md5_systems) as md5_systems by agentguid,imagefilepath | eventstats count as fpcnt by filepath | eventstats count as fplvlcnt by filepath, fpindx | eval rarity=fplvlcnt/fpcnt | sort 0 rarity | head 100

[Anomaly|UnusualSystem32Filename]
action.email.reportServerEnabled = 0
alert.track = 0
description = Rare filename in System32 directory, raises suspicion.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=processinventory earliest=-30d | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | search "\\windows\\system32\\"  | stats latest(imagefilemd5) as md5, latest(fileversion) as fileversion by agentguid, filepath | eval filename = lower(replace(filepath,".*\\\\","")) | eventstats dc(agentguid) as win_systems | eventstats dc(agentguid) as fn_systems values(agentguid) as systems by filename | stats first(win_systems) as win_systems, first(fn_systems) as fn_systems, values(systems) as systems values(fileversion) as fileversions, values(md5) as md5s by filename | eval rarity = fn_systems/win_systems | where rarity < 0.005 and md5s!="" | sort 0 rarity, filename | head 100

[Anomaly|HighPrevCompanyLowPrevProduct]
action.email.reportServerEnabled = 0
alert.track = 0
description = A highly prevalent company name (in the version metadata) is associated with a very low prevalence product name.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.charting.chart = line
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* earliest = -30d  message_type=processinventory | stats dc(agentguid) as one by companyname,productname,agentguid | fields - one | eventstats dc(agentguid) as company_systems by companyname | stats dc(agentguid) as product_systems, first(company_systems) as company_systems, values(agentguid) as systems by companyname,productname | eval rarity=product_systems/company_systems | where rarity <= 0.002 | sort 0 rarity

[Anomaly|HighestConnectsDuringOffHours]
action.email.reportServerEnabled = 0
alert.track = 0
description = Anomaly score ranking the highest numbers of network connects for each hour weighted inversely by total enterprise connects for that hour.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=networkconnect earliest=-15d | eval hr = strftime(_time, "%H")| stats count as connects by agentguid,hr | eventstats sum(connects) as all | eventstats sum(connects) as total by hr  | eventstats dc(agentguid) as agents | eval ratio = connects*agents/total | eval weight = all/total/24 | eval hr_score = round(weight*connects) | stats sum(hr_score) as score by agentguid | eventstats avg(score) as avg_score | eval score_ratio = round(score/avg_score) | sort 0 - score_ratio | head 100 | streamstats count as rank | fields - avg_score

[Anomaly|LowPrevLongHoursTemp]
action.email.reportServerEnabled = 0
alert.track = 0
description = A low prevalence executable on a temp/tmp path that is observed for a suspiciouly long duration.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=processinventory earliest=-60d | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9@\-\. ]*\\\\/\\\\users\\\\...\\\\/"  | where like(filepath,"%tmp\\%") OR like(filepath,"%temp\\%") | eventstats dc(agentguid) as prevalence by filepath | where prevalence <= 10 | stats earliest(_time) as start latest(_time) as end by agentguid,filepath,imagefilemd5 | eval temp_hours = round((end-start)/3600) | where temp_hours > 2 | convert ctime(start) ctime(end) | sort 0 - temp_hours |  head 100

[Anomaly|UserProfileUnusualDirectory]
action.email.reportServerEnabled = 0
alert.track = 0
description = An unusual user profile directory for an executable filepath.
dispatch.earliest_time = 0
display.general.type = statistics
display.visualizations.show = 0
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = sourcetype=ziften:* message_type=processinventory users earliest=-30d | eval filepath=lower(replace(trim(imagefilepath,"\""),".*:","")) | rex field=filepath mode=sed "s/^\\\\users\\\\[A-Za-z0-9@\-\. ]*\\\\/\\\\users\\\\...\\\\/"  | eval fp_el3 = mvindex(split(filepath,"\\"),3) | stats dc(agentguid) as fp_el3_systems values(filepath) as filepaths values(agentguid) as systems values(fileversion) as fileversions values(imagefilemd5) as md5s by fp_el3 |  where fp_el3_systems <= 10 | eval filename = lower(replace(filepath,".*\\\\","")) | sort 0 fp_el3_systems, filepath | head 100


[Lookup Population | Incremental Cleanup | Virus Total]
action.email.reportServerEnabled = 0
action.email.useNSSubject = 1
action.keyindicator.invert = 0
alert.track = 0
cron_schedule = */5 * * * *
description = Periodically clean up the VT data to only house the latest data.
display.general.type = statistics
display.page.search.tab = statistics
display.visualizations.show = 0
enableSched = 1
request.ui_dispatch_app = ziften
request.ui_dispatch_view = search
search = | inputlookup vthistory.csv|eval foo=relative_time(now(),"-14d")|where hits > 2 |table md5 details score hits sources lookup_time|outputlookup vt_current_data.csv
