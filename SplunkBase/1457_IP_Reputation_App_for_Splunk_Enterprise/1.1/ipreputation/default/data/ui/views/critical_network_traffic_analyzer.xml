<form>
  <label>Critical Network Traffic Analyzer</label>
  <fieldset submitButton="true">
    <input type="text" token="filter_token">
      <label>Filter Data:</label>
      <default>tag=network tag=communicate action=allowed</default>
    </input>
    <input type="multiselect" token="multiselect_source_filter">
      <label>Internal Source IP</label>
      <choice value="*">All</choice>
      <search>
        <query>* |stats count by src_ip</query>
      </search>
      <fieldForLabel>Source IP</fieldForLabel>
      <fieldForValue>src_ip</fieldForValue>
      <default>*</default>
    </input>
    <input type="time" token="field1">
      <label></label>
      <default>
        <earliest>-60m@m</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>
  <row>
    <panel>
      <html>
      <h3>How it works</h3>
      <p>This page shows your network communication from internal hosts to malicious destinations. Data will be enriched at Search Time from the threat intelligence database of Project Honey Pot Organisation via DNS data exchange. Ensure you filter down your data to avoid to many DNS lookups.</p> 
      <p>Think about to analyse and review communication which happened a while back and enrich it with threat intelligence knowledge today.</p>
  
    </html>
    </panel>
  </row>
  <row>
    <panel>
      <single>
        <title>% of Bad Destinations in Your Network</title>
        <search>
          <query>$filter_token$ $multiselect_source_filter$ | stats count by src_ip dest_ip dest_port | lookup threatscore clientip AS dest_ip | sort -threatscore | stats count(dest_ip) as total_connections count(eval(threatscore&gt;0)) as count_bad | eval percentage = count_bad * 100/total_connections | table percentage | eval percentage = round(percentage,2) | rename percentage as "Percentage ip destinations bad"</query>
        </search>
        <option name="list.drilldown">full</option>
        <option name="list.wrap">1</option>
        <option name="maxLines">5</option>
        <option name="raw.drilldown">full</option>
        <option name="rowNumbers">0</option>
        <option name="table.drilldown">all</option>
        <option name="table.wrap">1</option>
        <option name="type">list</option>
        <option name="count">10</option>
        <fields>["host","source","sourcetype"]</fields>
        <option name="drilldown">none</option>
        <option name="afterLabel">%</option>
        <option name="underLabel">blacklisted IP destination</option>
        <option name="linkView">search</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>No. of Malware Destinations</title>
        <search>
          <query>$filter_token$  $multiselect_source_filter$  | stats count by src_ip dest_ip dest_port | lookup threatscore clientip AS dest_ip | sort -threatscore | where threatscore&gt;0 | stats dc(dest_ip) as "Malware-IP"</query>
        </search>
        <option name="afterLabel">Malware IP-Destinations</option>
        <option name="linkView">search</option>
        <option name="drilldown">none</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>potential infected Clients</title>
        <search>
          <query>$filter_token$  $multiselect_source_filter$  | stats count by src_ip dest_ip dest_port | lookup threatscore clientip AS dest_ip | sort -threatscore | where threatscore&gt;0 | stats dc(src_ip) as "Potential Infected Clients"</query>
        </search>
        <option name="afterLabel">Active Infected Client</option>
        <option name="linkView">search</option>
        <option name="drilldown">none</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <single>
        <title>Malware Destination Ports Used</title>
        <search>
          <query>$filter_token$  $multiselect_source_filter$  | stats count by src_ip dest_ip dest_port | lookup threatscore clientip AS dest_ip | sort -threatscore | where threatscore&gt;0 | stats dc(dest_port) as "Malware-Port"</query>
        </search>
        <option name="afterLabel">different ports used</option>
        <option name="linkView">search</option>
        <option name="drilldown">none</option>
      </single>
    </panel>
    <panel>
      <table>
        <title>Realtime Communication to BAD IP</title>
        <search>
          <query>$filter_token$  $multiselect_source_filter$  | stats count by src_ip dest_ip dest_port | lookup threatscore clientip AS dest_ip | sort -threatscore | where threatscore&gt;0</query>
          <earliest>rt-5m</earliest>
          <latest>rt</latest>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">heatmap</option>
        <option name="displayRowNumbers">true</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
        <option name="drilldown">cell</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>Communication to BAD IP - Threatscore&gt;0 Table</title>
        <search>
          <query>$filter_token$  $multiselect_source_filter$  | stats count by src_ip dest_ip dest_port | lookup threatscore clientip AS dest_ip | sort -threatscore | where threatscore&gt;0</query>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="count">10</option>
      </table>
    </panel>
    <panel>
      <chart>
        <title>Bubble Chart Malicious Traffic Volume</title>
        <search>
          <query>$filter_token$ $multiselect_source_filter$ | lookup threatscore clientip AS dest_ip | sort -threatscore | where threatscore&gt;0 | search   (threatscore&gt;0)   | rename action AS SearchObject.action app AS SearchObject.app bytes AS SearchObject.bytes bytes_in AS SearchObject.bytes_in bytes_out AS SearchObject.bytes_out bytes_received AS SearchObject.bytes_received bytes_sent AS SearchObject.bytes_sent config_ver AS SearchObject.config_ver date_hour AS SearchObject.date_hour date_mday AS SearchObject.date_mday date_minute AS SearchObject.date_minute date_month AS SearchObject.date_month date_second AS SearchObject.date_second date_wday AS SearchObject.date_wday date_year AS SearchObject.date_year date_zone AS SearchObject.date_zone dest AS SearchObject.dest dest_ip AS SearchObject.dest_ip dest_port AS SearchObject.dest_port dest_translated_ip AS SearchObject.dest_translated_ip dest_translated_port AS SearchObject.dest_translated_port domain AS SearchObject.domain dvc AS SearchObject.dvc elapsed AS SearchObject.elapsed eventtype AS SearchObject.eventtype flags AS SearchObject.flags from AS SearchObject.from inbound_if AS SearchObject.inbound_if index AS SearchObject.index linecount AS SearchObject.linecount logset AS SearchObject.logset outbound_if AS SearchObject.outbound_if packets AS SearchObject.packets padding AS SearchObject.padding product AS SearchObject.product proto AS SearchObject.proto punct AS SearchObject.punct receive_time AS SearchObject.receive_time repeatcnt AS SearchObject.repeatcnt rule AS SearchObject.rule serial AS SearchObject.serial sessionid AS SearchObject.sessionid splunk_server AS SearchObject.splunk_server src AS SearchObject.src src_ip AS SearchObject.src_ip src_port AS SearchObject.src_port src_translated_ip AS SearchObject.src_translated_ip src_translated_port AS SearchObject.src_translated_port start AS SearchObject.start subtype AS SearchObject.subtype tag AS SearchObject.tag tag::eventtype AS SearchObject.tag::eventtype threatscore AS SearchObject.threatscore time_generated AS SearchObject.time_generated time_received AS SearchObject.time_received to AS SearchObject.to transport AS SearchObject.transport type AS SearchObject.type vendor AS SearchObject.vendor vendor_action AS SearchObject.vendor_action vsys AS SearchObject.vsys | stats dedup_splitvals=t sum("SearchObject.bytes") AS "Bytes Transfered" median("SearchObject.threatscore") AS "Median of threatscore" dc("SearchObject.src_ip") AS "Distinct Count of src_ip"  by "SearchObject.threatscore", "SearchObject.dest_port" | sort limit=100 -"Bytes Transfered" | fields - _span  | rename "SearchObject.threatscore" AS threatscore "SearchObject.dest_port" AS dest_port  | fillnull "Distinct Count of src_ip" | fields threatscore, dest_port, "Bytes Transfered", "Median of threatscore", "Distinct Count of src_ip"</query>
          <earliest></earliest>
          <latest></latest>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">bubble</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>Critical Network Traffic - Last 60 Minutes</title>
        <search>
          <query>$filter_token$  $multiselect_source_filter$  | stats count by src_ip dest_ip dest_port | lookup threatscore clientip AS dest_ip | sort -threatscore</query>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
</form>