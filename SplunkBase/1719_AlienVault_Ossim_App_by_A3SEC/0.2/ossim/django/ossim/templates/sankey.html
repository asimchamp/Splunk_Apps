{% extends "toolkit_controls_base.html" %}

{% load splunkmvc %}
{% load splunk_wftoolkit %}

{% block title %}Promiscuous Hosts Visual{% endblock title %}

{% block css %}
{{block.super}}
<style type="text/css">
#sankey1{
    height: 600px;
    width: 1200px;
}
#messagetext{
    text-align:center;
    font-size:18px;
}

</style>
{% endblock css %}


    {% block heading %}Sankey{% endblock heading %}

    {% block content %}
	<div id="messagetext">Last 24 Hrs Promiscuous Hosts</div>
        <div id="graph">
         {%  sankey
                id="sankey1"
                managerid="search1"
        %}
        </div>
    {% endblock content %}
{% block managers %}

    {% searchmanager id="search1"
        search='sourcetype=ossim_action RIESGO>=1 earliest=-24h@h | head 200 | stats count by src_ip,dst_ip'
        cache=True
    %}

{% endblock managers %}

{% block js %}
{{block.super}} 
<script>
require(["splunkjs/ready!", "underscore"], function(mvc, _) {

        // Customize the sankey component.  As described in
        // sankeychart.js, the formatLabel is an option that expects a
        // function.  That function takes a name from the search and
        // returns a formatted name.  In this case, replace access_log
        // strings for mobile clients with more readable names.
        var sankey = mvc.Components.getInstance('sankey1');
        var formatLabelDropdown = mvc.Components.getInstance("format-name");
        var formatTooltipDropdown = mvc.Components.getInstance("format-tooltip");

        var NAME_FORMATTERS = {
            "default": _.identity,
            "state": function(name) {
                return name.split(", ")[1];
            },
            "caps": function(name) {
                return name.toUpperCase();
            }
        };

        var TOOLTIP_FORMATTERS = {
            "default": function(d) {
                return (d.source.name + ' -> ' + d.target.name +
                        ': ' + d.value);
            },
            "custom": function(d) {
                return _.template("From <%= source.name %> to <%= target.name %>: <%= value %>", d);
            }
        };

        sankey.settings.set({
            'formatLabel': NAME_FORMATTERS['default']
        });

        formatLabelDropdown.settings.set({
            "choices": [
                {label: "Default", value: "default" },
                {label: "States", value: "state" },
                {label: "All Caps", value: "caps" }
            ]
        });
        formatLabelDropdown.on("change", function(val) {
            sankey.settings.set("formatLabel", NAME_FORMATTERS[val]);
        });

        formatTooltipDropdown.settings.set({
            "choices": [
                {label: "Default", value: "default" },
                {label: "Custom", value: "custom" }
            ]
        });
        formatTooltipDropdown.on("change", function(val) {
            sankey.settings.set("formatTooltip", TOOLTIP_FORMATTERS[val]);
        });

        sankey.on("click:link", function(e){
            console.log("Link click");
            console.log(e);
        });
        sankey.on("click:node", function(e){
            console.log("Node click");
            console.log(e);
        });
    });

</script>
{% endblock js %}
