<form stylesheet="easy_button.css,spgt_modal.css,tabs.css,table_cell_highlighting.css,table_cell_highlighting2.css,table_cell_highlighting_string.css,table_decorations.css" script="tabs.js,table_cell_highlighting.js,table_cell_highlighting2.js,table_cell_highlighting_string.js,table_row_highlighting.js,custom_layout_width.js,spgt_modal.js,autodiscover.js">
  <search id="globalSearch">
    <query>index=index_utilization_summary        
    | lookup customers idx OUTPUT group, micro_lic_GB        
    | search group="$group$" 
    | timechart span=1d sum(total_volume) by idx</query>
    <earliest>$time_tok.earliest$</earliest>
    <latest>$time_tok.latest$</latest>
  </search>
  <search id="globalCalc">
    <query>| rest /services/data/indexes splunk_server=*
    | rename title as idx 
    | join type=outer max=0 idx [| inputlookup customers.csv]
    | dedup group idx percent_ownership 
    | search group=$group|s$
    
    | eval license_rate          = $license_rate$
    | eval hot_warm_storage_rate = $hot_warm_storage_rate$
    | eval cold_storage_rate     = $cold_storage_rate$
    | eval rep_factor            = $rep_factor$
    | eval "Years Retention"     = round(frozenTimePeriodInSecs/31536000,2)
    
    | rex field=micro_lic_GB mode=sed "s/^(\.)/0./g"
    
    | foreach *MB [ eval &lt;&lt;MATCHSTR&gt;&gt;GB = '&lt;&lt;FIELD&gt;&gt;' / 1024 ]
    
    | eval hot_warm_calc_gb      = if('homePath.maxDataSizeGB' == 0, maxTotalDataSizeGB, 'homePath.maxDataSizeGB')
    | eval hot_warm_calc_gb      = if('storage_size_override_hot_warm' == 0, hot_warm_calc_gb, 'storage_size_override_hot_warm')
    | eval hot_warm_storage_cost = hot_warm_calc_gb * hot_warm_storage_rate * rep_factor * percent_ownership / 100
    
    | eval cold_calc_gb          = maxTotalDataSizeGB - 'homePath.maxDataSizeGB'
    | eval cold_calc_gb          = if('coldPath.maxDataSizeGB' == 0 AND 'homePath.maxDataSizeGB' = 0, 0, cold_calc_gb)
    | eval cold_calc_gb          = if('storage_size_override_cold' == 0, hot_warm_calc_gb, 'storage_size_override_cold')
    | eval cold_storage_cost     = cold_calc_gb * cold_storage_rate * rep_factor * percent_ownership / 100
    
    | eval total_storage_conf_gb = hot_warm_calc_gb + cold_calc_gb
    
    | eval stor_cost = (hot_warm_storage_cost + cold_storage_cost) * percent_ownership / 100 * $duration$
    | eval lic_cost  = micro_lic_GB * license_rate * percent_ownership / 100 * $duration$
    
    | eval homePathmaxDataSizeGB  = 'homePath.maxDataSizeGB'
    | eval coldPathmaxDataSizeGB  = 'coldPath.maxDataSizeGB'
    | eval totalPathmaxDataSizeGB = homePathmaxDataSizeGB + coldPathmaxDataSizeGB
    
    | addcoltotals lic_cost stor_cost hot_warm_storage_cost cold_storage_cost         
    | eval total_cost = lic_cost+stor_cost              
    
    | foreach *_cost *GB *gb cold_calc_gb [ eval &lt;&lt;FIELD&gt;&gt; = round( '&lt;&lt;FIELD&gt;&gt;' , 2 ) ]
    
    | table idx, "Years Retention", splunk_server, eai:acl.app, micro_lic_GB, license_rate, lic_cost, currentDBSizeGB, homePath_expanded, coldPath_expanded, maxTotalDataSizeGB, totalEventCount, disabled, years_retention, hot_warm_calc_gb, hot_warm_storage_rate, hot_warm_storage_cost, cold_calc_gb, cold_storage_rate, cold_storage_cost, stor_cost, percent_ownership, total_cost, total_storage_conf_gb, group, homePathmaxDataSizeGB, coldPathmaxDataSizeGB, totalPathmaxDataSizeGB, rep_factor, owner_email
    
    | sort  idx, splunk_server, eai:acl.app, micro_lic_GB, license_rate, lic_cost, currentDBSizeGB, homePath_expanded, coldPath_expanded, maxTotalDataSizeGB, totalEventCount, disabled, years_retention, hot_warm_calc_gb, hot_warm_storage_rate, hot_warm_storage_cost, cold_calc_gb, cold_storage_rate, cold_storage_cost, stor_cost, percent_ownership, total_cost, total_storage_conf_gb, group, homePathmaxDataSizeGB, coldPathmaxDataSizeGB, totalPathmaxDataSizeGB, rep_factor, owner_email
    
    | rename idx AS Index, splunk_server AS "Splunk Server", micro_lic_GB AS "Micro License GB", license_rate AS "License Rate", lic_cost AS "License Cost", stor_cost AS "Storage Cost", total_cost AS "Total Cost", currentDBSizeGB AS "Current GB Used", maxTotalDataSizeGB AS "Max Total Index Size GB", eai:acl.app AS "App ACL", totalEventCount AS "Event Count", disabled AS Disabled, percent_ownership AS "Percent Ownership", hot_warm_calc_gb AS "Hot/Warm Calc GB", cold_calc_gb AS "Cold Calc GB", hot_warm_storage_rate AS "Hot/Warm Storage Rate", cold_storage_rate AS "Cold Storage Rate", hot_warm_storage_cost AS "Hot/Warm Storage Cost", cold_storage_cost AS "Cold Storage Cost", total_storage_conf_gb AS "Total Storage Conf GB",homePathmaxDataSizeGB AS "Hot/Warm Max Size GB", coldPathmaxDataSizeGB AS "Cold Max Size GB", totalPathmaxDataSizeGB AS "Max Hot/Warm/Cold Total", rep_factor AS "Replication Factor"</query>
  </search>
  <label>Chargeback</label>
  <fieldset autoRun="true" submitButton="false">
    <input type="dropdown" token="group" searchWhenChanged="true">
      <label>Select a Group</label>
      <default>*</default>
      <choice value="*">All</choice>
      <search>
        <query>| inputlookup customers.csv | dedup group | sort + group</query>
        <earliest>-30d@d</earliest>
        <latest>now</latest>
      </search>
      <fieldForLabel>group</fieldForLabel>
      <fieldForValue>group</fieldForValue>
    </input>
    <input type="radio" token="currency_symbol" searchWhenChanged="true">
      <label>Currency Symbol</label>
      <default>$</default>
      <choice value="$">$</choice>
      <choice value="€">€</choice>
      <choice value="£">£</choice>
      <choice value="¥">¥</choice>
    </input>
    <input type="text" token="license_rate" searchWhenChanged="true">
      <label>Daily Maint. Rate</label>
      <default>2</default>
      <initialValue>2</initialValue>
    </input>
    <input type="text" token="hot_warm_storage_rate" searchWhenChanged="true">
      <label>Hot/Warm Storage Rate</label>
      <default>.002</default>
      <initialValue>.002</initialValue>
    </input>
    <input type="text" token="cold_storage_rate" searchWhenChanged="true">
      <label>Cold Storage Rate</label>
      <default>.001</default>
      <initialValue>.001</initialValue>
    </input>
    <input type="dropdown" token="rep_factor" searchWhenChanged="true" id="resized_input">
      <label>Replication Factor</label>
      <default>2</default>
      <choice value="1">1</choice>
      <choice value="2">2</choice>
      <choice value="3">3</choice>
      <choice value="4">4</choice>
      <choice value="5">5</choice>
    </input>
    <input type="radio" searchWhenChanged="true" token="duration">
      <label>Billing Duration</label>
      <choice value="365">Yearly</choice>
      <choice value="92.25">Quarterly</choice>
      <choice value="30.417">Monthly</choice>
      <choice value="1">Daily</choice>
      <default>365</default>
      <initialValue>365</initialValue>
    </input>
  </fieldset>
  <row id="tabs">
    <panel>
      <html id="btn_element1">
      <div class="btn-group1">
        <a href="/app/lookup_editor/lookup_edit?owner=admin&amp;namespace=chargeback&amp;lookup=customers.csv&amp;type=csv" target="_blank" class="btn-pill">
          Edit Config
        </a>
      </div>
    </html>
      <html>
      <ul id="tabs" class="nav nav-tabs">
        <li class="active">
          <a href="#" class="toggle-tab" data-toggle="tab" data-elements="tab_calc,tab_cost,tab_util_sankey" data-token="control_token_cost">Customer Costs</a>
        </li>          
        <li>
          <a href="#" class="toggle-tab" data-toggle="tab" data-elements="tab_util,tab_util_charts,history_detail">Index Utilization/Prediction and Alerts</a>
        </li>
        <li>
          <a href="#" class="toggle-tab" data-toggle="tab" data-elements="tab_cvs_title,tab_audit,tab_lic_title,tab_license">Configuration Audit</a>
        </li>     
        <li>
          <a href="#" class="toggle-tab" data-toggle="tab" data-elements="tab_lic_review">License Review</a>
        </li>
        <li>
          <a href="#" class="toggle-tab" data-toggle="tab" data-elements="tab_lic_detail">License Calculation Details</a>
        </li>
        <li>
          <a href="#" class="toggle-tab" data-toggle="tab" data-elements="tab_stor_detail">Storage Calculation Details</a>
        </li>
        <li>
          <a href="#" class="toggle-tab" data-toggle="tab" data-elements="instructions" style="color:#FF0000;">App Instructions</a>
        </li>
      </ul>
    </html>
    </panel>
  </row>
  
  <row id="instructions">
  <panel>
      <html>
        <div style="width: 100%; height: 600px; overflow: auto;">
            <div class="modal-header">
              <h4 class="modal-title">
                <i class="icon-info-circle icon-modal-xlarge icon-color-info"/>The Chargeback App: How to use. 
              </h4>
            </div>
            <div class="modal-body">
              <div class="hdr-spgt-modal">
                This menu contains three major sections - App Dependancy Check, Index Configuration, and App Configuration.  See the README for details on how the calculations work.
              </div>
              <HR COLOR="65a637" WIDTH="100%" SIZE="4"/>
                <strong>App Check</strong>
                <br/>
                <br/>
              This app requires two other Apps to be installed and enabled.  Below are the required apps:<br/>
              <br/>"<a href="https://splunkbase.splunk.com/app/3112/" target="_blank" style="color:#FF0000;">Sankey Diagram - Custom Visualization</a>"<br/>
              <br/>"<a href="https://splunkbase.splunk.com/app/1724/" target="_blank" style="color:#FF0000;">File Lookup Editor App</a>"<br/>
              <br/><i class="icon-alert"/>You will see a "Edit Config" button in the top of the App.  This will allow you to easily update customers.csv in the final steps below.

              <HR COLOR="65a637" WIDTH="100%" SIZE="4"/>
                <strong>Index Configuration</strong>
                <br/>
                <br/>
              You will need to create a new summary index "index_utilization_summary".  Place the following indexes.conf file in the appropriate place for your architecture:
              <br/>
                <br/>
              <p class="tab">[index_utilization_summary]</p>
              <p class="tab">coldPath = $SPLUNK_DB/index_utilization_summary/colddb</p>
              <p class="tab">homePath = $SPLUNK_DB/index_utilization_summary/db</p>
              <p class="tab">maxTotalDataSizeMB = 512000</p>
              <p class="tab">thawedPath = $SPLUNK_DB/index_utilization_summary/thaweddb</p>
              <br/>
              This index will contain the daily sum of data consumption by index.  This index is used to:
              <br/>
                <br/>
              <p class="tab">Help you quickly visualize your index utilization</p>
              <p class="tab">Run predictive analysis over long periods of time</p>
              <p class="tab">Determine where there have been utilization violations by Index</p>
              <br/>
              To back fill this summary index, run the following command from the bin directory on a search head.  Feel free to move on to the next step as this runs.:
              <br/>
                <br/>
              ./splunk cmd python fill_summary_index.py -app chargeback -name "Index Utilization by Index" -et -30d@d -lt now -owner admin
              <br/>
              
              <HR COLOR="65a637" WIDTH="100%" SIZE="4"/>
                <strong>App Configuration</strong>
                <br/>
                <br/>
              For first time configurations, build your customers.csv file with the following search command.  <strong>This will overwrite the lookup file if one exists!</strong>:
              <br/>
                <br/>
              <p class="tab">        
| rest /services/data/indexes 
| dedup title 
| search NOT title=_* NOT title=*summary* 
| rename title AS idx 
| fillnull value=0 storage_size_override_hot_warm storage_size_override_cold 
| fillnull value=100 percent_ownership 
| fillnull value=UNDEF group 
| fillnull value=email@yourdomain.com owner_email 
| join idx
    [ search index=index_utilization_summary 
    | stats max(total_volume) AS micro_lic_GB by idx
    | eval micro_lic_GB=ceil(micro_lic_GB)] 
| table group, idx, micro_lic_GB, percent_ownership, storage_size_override_hot_warm, storage_size_override_cold, owner_email
        | outputlookup customers.csv
        </p>               
              <br/>
              After you run the command above:
              <br/>
                <br/>
              <p class="tab">1) Fill in the appropriate group.</p>
              <p class="tab">2) Adjust the micro_lic_GB as needed.</p>
              <p class="tab">3) To account for an index that is owned by multiple groups, add new lines for each group.  Be sure to have the same micro_lic_GB values for al of them, or it will not be calculated properly. Then adjust the group and percent_ownership for each line.</p>
              <p class="tab">4) Determine if you need to override the automated storage calculations.</p>
              <p class="tab">5) Define the email address(es) to be notified when the Micro License is violated.  A comma separated list will work.</p>
             <br/>
              <strong>Column Headers</strong> - DO NOT ALTER THE NAME OF THE COLUMN HEADERS:<br/>
              <br/>
              group, idx, micro_lic_GB, percent_ownership, storage_size_override_hot_warm, storage_size_override_cold, and owner_email
              <br/>
                <br/>
              <strong>group</strong> - These are the different departments that you are providing Splunk as a service to. They are your customers.<br/>
              <br/>
              <strong>idx</strong> - These are the indexes that you have configured and will account for the cost associated with.  Match the names exactly and include all of them that are not internal or summary indexes.  Internal indexes begin with an underscore and summary indexes should have "summary" in their name.<br/>
              <br/>
              <strong>micro_lic_GB</strong> - This is the maximum daily data volume in GBs that your customer is going to use per index.  It can be thought of as a "Micro License", but has no impact on internal Splunk licensing.  This is used to calculate the total cost to the customer.  This number is always the same, even if more than one group shares an index (use the total).  This is also used as a threshold for alerting against groups that use more than their allocated share of the license.<br/>
              <br/>
              <strong>percent_ownership</strong> - When more than one group shares an index, this is the percentage of ownership assigned to each group.  The total percent_ownership across all groups must equal 100.<br/>
              <br/>
              <strong>storage_size_override_hot_warm</strong> - Manual override for hot/warm total storage size.  Use this if you only reference time when configuring indexes in indexes.conf.<br/>
              <br/>
              <strong>storage_size_override_cold</strong> - Manual override  for cold total storage size.  Use this if you only reference time when configuring indexes in indexes.conf.<br/>
              <br/>
              <strong>owner_email</strong> - A comma separated list of email addresses to be notified when the Micro License is violated.<br/>
              <br/>
              <strong>Read the README</strong> - You will be happy that you did.<br/>
            </div>
          </div>
    </html>
    </panel>
  </row>
  
  <row id="tab_calc">
    <panel>
      <table>
        <title>License Charges for $group|s$</title>
        <search base="globalCalc">
          <query>table Index, "Micro License GB", "License Rate", "Percent Ownership", "License Cost"               
          | eval "Percent Ownership"='Percent Ownership'+" %"            
          | eval "License Cost"="$currency_symbol$".tostring('License Cost',"commas")</query>
        </search>
        <option name="count">15</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <table>
        <title>Storage Charges for $group|s$</title>
        <search base="globalCalc">
          <query>table Index, "Replication Factor", "Percent Ownership", "Max Total Index Size GB", "Hot/Warm Calc GB", "Hot/Warm Calc GB", "Hot/Warm Storage Rate", "Hot/Warm Storage Cost", "Cold Calc GB", "Cold Storage Rate", "Cold Storage Cost", "Storage Cost"                       
          | eval "Percent Ownership"='Percent Ownership'+" %"             
          | eval "Hot/Warm Storage Cost"="$currency_symbol$".tostring('Hot/Warm Storage Cost',"commas")             
          | eval "Cold Storage Cost"="$currency_symbol$".tostring('Cold Storage Cost',"commas")          
          | eval "Storage Cost"="$currency_symbol$".tostring('Storage Cost',"commas")</query>
        </search>
        <option name="count">15</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row id="tab_cost">
    <panel>
      <chart>
        <title>"Micro License" Sum Distribution for $group|s$</title>
        <search base="globalCalc">
          <query>eval idx_lic = 'Micro License GB' * 'Percent Ownership' / 100                          
          |  chart sum(idx_lic) AS "Micro License GB Sum" over Index by group</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">-45</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisTitleY.text">Max GB per Day</option>
      </chart>
    </panel>
    <panel>
      <single>
        <title>Total Charges for $group|s$</title>
        <search base="globalCalc">
          <query>fields "Total Cost" | sort - "Total Cost" | head 1</query>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.00</option>
        <option name="rangeColors">["0x65a637","0x65a637","0x65a637"]</option>
        <option name="rangeValues">[0,1000]</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="trendInterval">auto</option>
        <option name="unit">$currency_symbol$</option>
        <option name="unitPosition">before</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
  </row>
  <row id="tab_util_sankey">
    <panel>
      <viz type="sankey_diagram_app.sankey_diagram">
        <search>
          <query>| rest /services/data/indexes        
               | rename title as idx        
               | join type=outer max=0 idx [| inputlookup customers.csv]       
               | dedup group idx percent_ownership  
               | search group="$group$"
               | rename group AS from, idx AS to 
               | stats count by from to percent_ownership
               | fields - count</query>
          <sampleRatio>1</sampleRatio>
        </search>
      </viz>
    </panel>
  </row>
  <row id="tab_util">
    <panel>
      <title>Index Utilization for Group $group|s$ with Predictive Analysis</title>
      <input type="time" token="time_tok" searchWhenChanged="true">
        <label></label>
        <default>
          <earliest>-30d@d</earliest>
          <latest>now</latest>
        </default>
      </input>
      <chart>
        <title>Click on an index for predictive view.</title>
        <search base="globalSearch"></search>
        <option name="charting.chart">column</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <drilldown>
          <!-- Use set to specify the new token to be created.
               Use any token from the page or from the click event to produce the value needed. -->
          <set token="index">$click.name2$</set>
        </drilldown>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">GB</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
      </chart>
      <chart id="detail" depends="$index$">
        <title>Predictive Analysis for index: $index$</title>
        <search>
          <query>index=index_utilization_summary                
          | lookup customers idx OUTPUT group, micro_lic_GB                
          | search group="$group$"         
          | timechart span=1d sum(total_volume) by idx  
          | table _time $index$ micro_lic_GB                             
          | appendcols [ search index=index_utilization_summary              
          | lookup customers idx OUTPUT group, micro_lic_GB                             
          | search group="$group$" idx=$index$              
          | timechart max(micro_lic_GB) as micro_lic_GB]             
          | predict $index$</query>
          <earliest>$time_tok.earliest$</earliest>
          <latest>$time_tok.latest$</latest>
        </search>
        <option name="charting.chart.overlayFields">micro_lic_GB</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">GB</option>
      </chart>
    </panel>
  </row>
  <row id="tab_util_charts">
    <panel>
      <title>Index Utilization Stats by Index</title>
      <table>
        <search>
          <query>index=index_utilization_summary                           
            | lookup customers idx OUTPUT group micro_lic_GB                         
            | search group="$group$"                         
            | stats sparkline AS "Utilization Over Time in GB/Day", max(total_volume) AS "Max GB", min(total_volume) AS "Min GB", avg(total_volume) AS "Avg GB" by idx                                       
            | sort + idx                         
            | join idx              
            [             
            | inputlookup customers.csv                    
            | dedup group idx percent_ownership             
            | rex field=micro_lic_GB mode=sed "s/^(\.)/0./g"                          
            | stats sum(micro_lic_GB) AS total_license by idx             
            | eval total_license=round(total_license,6)             
            ]             
            | rename idx as Index, total_license AS "Maximum License in GB (micro_lic_GB)"</query>
          <earliest>$time_tok.earliest$</earliest>
          <latest>$time_tok.latest$</latest>
        </search>
        <!-- Set sparkline options here; make sure that field matches field name of the search results -->
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">row</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format field="Utilization Over Time in GB/Day" type="sparkline">
          <option name="lineWidth">1.5</option>
          <option name="spotRadius">3</option>
          <option name="lineColor">#5379af</option>
          <option name="maxSpotColor">#d6563c</option>
          <option name="fillColor">#a2cc3e</option>
        </format>
      </table>
    </panel>
    <panel depends="$show_no_results_6$">
      <title>Index Utilization Alerts</title>
      <html>
      <h1>
        <center>
          <font color="#65a637">
            No Index Utilization Violations Detected
          </font>
        </center>
      </h1>
    </html>
    </panel>
    <panel depends="$show_panel_6$">
      <title>ALERTS! - Yesterday's "Micro License" Violations</title>
      <table id="master">
        <title>Click on row to view 3 day history</title>
        <search base="globalCalc">
          <query>stats sum("Micro License GB") AS total_license by Index owner_email             
            | rename Index AS idx                         
            | join idx 
            [
            search earliest=-1d@d latest=@d index=index_utilization_summary
            ]             
            | table idx total_volume total_license owner_email                         
            | eval "Alert Condiition"=case('total_license' &lt; 'total_volume', "Total Utilized Volume is Greater than the Micro License (micro_lic_GB)")
            | search "Alert Condiition"=*                          
            | table idx, total_volume, total_license, "Alert Condiition", owner_email                          
            | rename idx AS Index, total_license AS "Total License (micro_lic_GB)", total_volume AS "Total Utilized Volume"</query>
          <progress>
            <!-- match attribute for condition uses eval-like expression (see Splunk search language 'eval' command) -->
            <!-- logic: if resultCount is 0, then show a static html element, and hide the chart element -->
            <condition match="'job.resultCount' &gt; 0">
              <set token="show_panel_6">true</set>
              <unset token="show_no_results_6"></unset>
            </condition>
            <condition match="'job.resultCount' == 0">
              <unset token="show_panel_6"></unset>
              <set token="show_no_results_6">true</set>
            </condition>
          </progress>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
        <option name="drilldown">row</option>
        <drilldown>
          <!-- Use set to specify the new token to be created.
               Use any token from the page or from the click event to produce the value needed. -->
          <set token="index_history">$row.Index$</set>
        </drilldown>
      </table>
    </panel>
    <panel>
      <html> 
      <h2>
        <center>
          <b>Links to Splunk's Management Console, which monitors disk utilization:</b>
        </center>
      </h2>
      <ul>
        <font size="3">
          <p>
            <a href="/app/splunk_monitoring_console/indexes_and_volumes_instance" target="_blank">Indexes and Volumes: Instance</a>
          </p>
          <p>
            <a href="/app/splunk_monitoring_console/index_detail_instance" target="_blank">Index Detail: Instance</a>
          </p>
          <p>
            <a href="/app/splunk_monitoring_console/volume_detail_instance" target="_blank">Volume Detail: Instance</a>
          </p>
        </font>
      </ul>
    </html>
    </panel>
  </row>
  <row id="history_detail">
    <panel depends="$index_history$">
      <chart id="detail_history">
        <title>Utilization by host</title>
        <search>
          <query>index=_internal source=*license_usage.log type="Usage" idx=$index_history$ startdaysago=3                                  
            | timechart sum(b) by h span=1h</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisEnd</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">GB</option>
      </chart>
    </panel>
  </row>
  <row id="tab_cvs_title">
    <panel>
      <html> 
      <h1>
        <center>
          Customers.csv Audit
        </center>
      </h1>
    </html>
    </panel>
  </row>
  <row id="tab_audit">
    <panel depends="$show_no_results_1$">
      <title>Indexes Accounted For (idx)</title>
      <html>
      <h1>
        <center>
          <font color="#65a637">
            All Indexes Accounted For
          </font>
        </center>
      </h1>
    </html>
    </panel>
    <panel depends="$show_panel_1$">
      <table>
        <title>Indexes Accounted For (idx)</title>
        <search>
          <progress>
            <!-- match attribute for condition uses eval-like expression (see Splunk search language 'eval' command) -->
            <!-- logic: if resultCount is 0, then show a static html element, and hide the chart element -->
            <condition match="'job.resultCount' &gt; 0">
              <set token="show_panel_1">true</set>
              <unset token="show_no_results_1"></unset>
            </condition>
            <condition match="'job.resultCount' == 0">
              <unset token="show_panel_1"></unset>
              <set token="show_no_results_1">true</set>
            </condition>
          </progress>
          <query>| set diff 
    [| inputlookup customers.csv 
    | dedup idx 
    | fields idx 
    | search NOT idx=*summary* 
    | rename idx AS "Index not defined in customers.csv or not configured in Splunk"] 
    [| rest /services/data/indexes 
    | search isInternal=0 
    | search NOT title=*summary* 
    | dedup title 
    | fields title 
    | rename title AS "Index not defined in customers.csv or not configured in Splunk"]</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel depends="$show_no_results_2$">
      <title>Total Ownership Percentage by Index (percent_ownership)</title>
      <html>
      <h1>
        <center>
          <font color="#65a637">
            Total Ownership = 100% for all Indexes
          </font>
        </center>
      </h1>
    </html>
    </panel>
    <panel depends="$show_panel_2$">
      <table>
        <title>Total Ownership Percentage by Index (percent_ownership)</title>
        <search>
          <progress>
            <!-- match attribute for condition uses eval-like expression (see Splunk search language 'eval' command) -->
            <!-- logic: if resultCount is 0, then show a static html element, and hide the chart element -->
            <condition match="'job.resultCount' &gt; 0">
              <set token="show_panel_2">true</set>
              <unset token="show_no_results_2"></unset>
            </condition>
            <condition match="'job.resultCount' == 0">
              <unset token="show_panel_2"></unset>
              <set token="show_no_results_2">true</set>
            </condition>
          </progress>
          <query>| inputlookup customers.csv                  
          | dedup group idx percent_ownership
          | stats sum(percent_ownership) by idx
          | eval "Alert Condiition"=case('sum(percent_ownership)' &lt; 100, "Total Index Ownership Under Subscription Detected", 'sum(percent_ownership)' &gt; 100, "Total Index Ownership Over Subscription Detected")
          | search "Alert Condiition"=*             
          | rename idx AS Index, sum(percent_ownership) AS "Total Index Ownership Percentage"  
          | table "Index", "Total Index Ownership Percentage", "Alert Condiition"</query>
          <earliest>0</earliest>
          <latest></latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="drilldown">cell</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
      </table>
    </panel>
    <panel depends="$show_no_results_3$">
      <title>"Micro License" Consistency (micro_lic_GB)</title>
      <html>
      <h1>
        <center>
          <font color="#65a637">
            Max License Sum is 100% for each Index
          </font>
        </center>
      </h1>
    </html>
    </panel>
    <panel depends="$show_panel_3$">
      <table>
        <title>"Micro License" Consistency (micro_lic_GB)</title>
        <search>
          <progress>
            <!-- match attribute for condition uses eval-like expression (see Splunk search language 'eval' command) -->
            <!-- logic: if resultCount is 0, then show a static html element, and hide the chart element -->
            <condition match="'job.resultCount' &gt; 0">
              <set token="show_panel_3">true</set>
              <unset token="show_no_results_3"></unset>
            </condition>
            <condition match="'job.resultCount' == 0">
              <unset token="show_panel_3"></unset>
              <set token="show_no_results_3">true</set>
            </condition>
          </progress>
          <query>| inputlookup customers.csv                               
          | dedup idx micro_lic_GB
          | stats count(idx) by idx
          | eval "Alert Condiition"=case('count(idx)' &gt; 1, "\"micro_lic_GB\" is not the same value for every instance in customers.csv")
          | search "Alert Condiition"=*
          | rename idx AS Index, count(idx) AS "Number of \"micro_lic_GB\" values"               
          | table "Index", "Number of \"micro_lic_GB\" values", "Alert Condiition"</query>
          <earliest>0</earliest>
          <latest></latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="drilldown">cell</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
      </table>
    </panel>
    <panel>
      <table>
        <title>"Micro License" Total (micro_lic_GB)</title>
        <search>
          <query>| inputlookup customers.csv 
| dedup idx micro_lic_GB 
| rex field=micro_lic_GB mode=sed "s/^(\.)/0./g" 
| stats sum(micro_lic_GB) 
| rename sum(micro_lic_GB) AS "Total Max License GB" 
| table "Total Max License GB"</query>
          <earliest>0</earliest>
          <latest></latest>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row id="tab_lic_title">
    <panel>
      <html> 
      <h1>
        <center>
          Index Configuration Audit - Are The Hot/Warm and/or Cold Volumes Too Large?
        </center>
      </h1>
    </html>
    </panel>
  </row>
  <row id="tab_license">
    <panel depends="$show_panel_5$">
      <table>
        <title>Splunk Index Sizes in Indexes.conf (parameter name in parenthesis).  * Note that all configuration lines are in MB.</title>
        <search base="globalCalc">
          <progress>
            <!-- match attribute for condition uses eval-like expression (see Splunk search language 'eval' command) -->
            <!-- logic: if resultCount is 0, then show a static html element, and hide the chart element -->
            <condition match="'job.resultCount' &gt; 0">
              <set token="show_panel_5">true</set>
              <unset token="show_no_results_5"></unset>
            </condition>
            <condition match="'job.resultCount' == 0">
              <unset token="show_panel_5"></unset>
              <set token="show_no_results_5">true</set>
            </condition>
          </progress>
          <query>| dedup Index 
          | eval "Max Hot/Warm Size MB (homePath.maxDataSizeMB)" = 'Hot/Warm Max Size GB' * 1024
          | eval "Max Cold Size MB (coldPath.maxDataSizeMB)"     = 'Cold Max Size GB' * 1024
          | eval "Max Index Size MB (maxTotalDataSizeMB)"        = 'Max Total Index Size GB' * 1024
          | eval "Max Hot/Warm/Cold Total MB"                    = 'Max Hot/Warm/Cold Total' * 1024
          | eval "Alert Condiition"=case('Max Total Index Size GB' &lt; 'Hot/Warm Max Size GB', "Hot/Warm Max Size GB is Too Big", 'Max Total Index Size GB' &lt; 'Cold Max Size GB', "Cold Max Size GB is Too Big", 'Max Total Index Size GB' &lt; 'Max Hot/Warm/Cold Total', "Max Hot/Warm/Cold Total is Too Big") 
          | search "Alert Condiition"=* Disabled=0
          | table Index, "Max Hot/Warm Size MB (homePath.maxDataSizeMB)", "Max Cold Size MB (coldPath.maxDataSizeMB)", "Max Hot/Warm/Cold Total MB", "Max Index Size MB (maxTotalDataSizeMB)", "Alert Condiition"</query>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="drilldown">row</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
      </table>
    </panel>
    <panel depends="$show_no_results_5$">
      <title>Splunk Index Sizes in Indexes.conf.</title>
      <html>
      <h1>
        <center>
          <font color="#65a637">
            Valid Index Configuration Specs for Hot/Warm and Cold
          </font>
        </center>
      </h1>
    </html>
    </panel>
  </row>
  <row id="tab_lic_review">
    <panel>
      <table>
        <title>Installed License Review</title>
        <search>
          <query>| rest splunk_server=* /services/licenser/licenses/              
          | fields label type quota expiration_time group_id splunk_server stack_id status updated               
          | eval license_GB=round(quota/1024/1024/1024,0) 
          | eval valid_lic=if(status=="VALID",license_GB,0)              
          | addcoltotals license_GB,valid_lic              
          | rename label AS Label, type AS Type, quota AS Quota, expiration_time AS "Experation Time", group_id AS "Group ID", splunk_server AS "Splunk Server", stack_id AS "Stack ID", status AS Status, updated AS Updated, license_GB AS "License in GB", valid_lic AS "Valid License"</query>
          <earliest>0</earliest>
          <latest></latest>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row id="tab_lic_detail">
    <panel>
      <table id="highlight">
        <title>License Calculation Detail</title>
        <search base="globalCalc">
          <query>table Index, "App ACL", "Event Count", "Micro License GB", "License Rate", "Percent Ownership", "License Cost", Disabled</query>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="drilldown">cell</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">100</option>
      </table>
    </panel>
  </row>
  <row id="tab_stor_detail">
    <panel>
      <table id="highlight2">
        <title>Storage Calculation Detail</title>
        <search base="globalCalc">
          <query>table Index, "Years Retention", "Current GB Used", "Replication Factor", "Percent Ownership", "Max Total Index Size GB", "Hot/Warm Max Size GB", "Hot/Warm Calc GB", "Hot/Warm Storage Rate", "Hot/Warm Storage Cost", "Cold Max Size GB", "Cold Calc GB", "Cold Storage Rate", "Cold Storage Cost", "Storage Cost", "Total Cost"</query>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
</form>