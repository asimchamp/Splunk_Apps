<form version="1.1" stylesheet="css/common.css" theme="light">
  <init>
    <set token="dh_tok"></set>
    <set token="user_tok"></set>
  </init>
  <label>Unapproved Applications and SaaS - Common Processes Running Non-Standard Ports and Protocols</label>
  <search id="baseSearch">
    <query>
        `nvm_flowdata_index` $pn_tok$ $user_tok$ $ppn_tok$ $ph_tok$ $dh_tok$ NOT [| inputlookup standard_ports_process_protocols.csv | table pn,dp,transport]  NOT pap=* OR (pap!=Administrator AND pap!=LOCAL AND pap!=SYSTEM AND pap!=_netbios AND pap!=NETWORK AND pap!=linuxuid_0 AND pap!=softwareupdate AND pap!=nobody AND pap!=_mdnsreponder AND pap!=_lp AND pap!=_locationd AND pap!=root pap!=UpdateUser) | fields _time, udid, da, sp,dp, pn, ppn, dh, transport, user, sa,sp, iid, liuid | join udid [ | inputlookup unique_endpoints | search $vsn_tok$ ] | eval dh = if(dh="Unknown", da, dh) | fields - _raw | table _time, vsn, osn, ose, osv, sm, user, da, dp, dh, sa, sp , pn, ppn, udid
    </query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="byteComputationSearch">
    <query>
        `nvm_flowdata_index` $pn_tok$ $user_tok$ $ppn_tok$ $ph_tok$ $dh_tok$ NOT [| inputlookup standard_ports_process_protocols.csv | table pn,dp,transport] NOT pap=* OR (pap!=Administrator AND pap!=LOCAL AND pap!=SYSTEM AND pap!=_netbios AND pap!=NETWORK AND pap!=linuxuid_0 AND pap!=softwareupdate AND pap!=nobody AND pap!=_mdnsreponder AND pap!=_lp AND pap!=_locationd AND pap!=root pap!=UpdateUser) | join udid [ | inputlookup unique_endpoints | search $vsn_tok$ ]  | fields udid, dh, _time, bytes_in, bytes_out, iid,user  | eval ip_version=(if(isnull(sa), "ipv6", "ipv4"))  | eval dh = if(dh="Unknown", da, dh) | eval protocol=(case(pr==17, "udp", pr==6, "tcp", pr==1, "icmp", pr==47, "gre", pr==58, "icmp6", true(), pr))  | eval src_address=(if(isnull(sa6), sa, sa6))  | eval dst_address=(if(isnull(da6), da, da6))  | eval mb_out = ((bytes_out/1024)/1024)  | eval mb_in = ((bytes_in/1024)/1024)
    </query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <description>Shows activity on all non-whitelisted ports and protocols - to configure your whitelist go to Settings-&gt;Lookups and edit the "standard_ports_process_protocols.csv" files for the CiscoNVM app</description>
  <fieldset submitButton="true">
    <input type="time" token="time">
      <label>Time</label>
      <default>
        <earliest>-7d@d</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="multiselect" token="vsn_tok" searchWhenChanged="false">
      <label>Device(s)</label>
      <default>*</default>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>vsn="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>vsn</fieldForLabel>
      <fieldForValue>vsn</fieldForValue>
      <search>
        <query>| inputlookup unique_endpoints | stats count by vsn</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="multiselect" token="pn_tok" searchWhenChanged="false">
      <label>Process(es)</label>
      <default>*</default>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>pn="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>pn</fieldForLabel>
      <fieldForValue>pn</fieldForValue>
      <search>
        <query>| inputlookup unique_processes | stats count by pn</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="multiselect" token="ppn_tok" searchWhenChanged="false">
      <label>Parent Process(es)</label>
      <default>*</default>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>ppn="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>ppn</fieldForLabel>
      <fieldForValue>ppn</fieldForValue>
      <search>
        <query>`nvm_flowdata_index` NOT [| inputlookup whitelist.csv | rename host as dh]   | stats count by ppn</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="multiselect" token="user_tok" searchWhenChanged="false">
      <label>Users</label>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>user="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>user</fieldForLabel>
      <fieldForValue>user</fieldForValue>
      <search>
        <query>`nvm_flowdata_index` ph!="" | stats count by user</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="text" token="ph_tok" searchWhenChanged="false">
      <label>Process Hash</label>
      <initialValue>*</initialValue>
    </input>
    <input type="text" token="dh_tok" searchWhenChanged="false">
      <label>Destination</label>
      <prefix>dh="</prefix>
      <suffix>"</suffix>
      <initialValue>*</initialValue>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Device(s)</title>
      <single>
        <search base="baseSearch" id="vsn_count">
          <query>| dedup vsn | stats count(vsn)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>User(s)</title>
      <single>
        <search base="baseSearch" id="sa_count">
          <query>| dedup user | stats count(user)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Process(es)</title>
      <single>
        <search base="baseSearch" id="app_count">
          <query> | dedup pn | stats count(pn)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Flow(s)</title>
      <single>
        <search base="baseSearch" id="sa_trend">
          <query>| stats count</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Flow Count Trend</title>
      <single>
        <search base="baseSearch" id="device_trend_count">
          <query>| timechart count by vsn</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="underLabel">7 Day Trend</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Inbound Volume</title>
      <single>
        <search base="byteComputationSearch" id="mb_in_volume_total">
          <query> | stats sum(mb_in)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0.0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="unit">MB</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Outbound Volume</title>
      <single>
        <search base="byteComputationSearch" id="mb_out_volume_total">
          <query> | stats sum(mb_out)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0.0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="unit">MB</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Inbound Trend</title>
      <single>
        <search base="byteComputationSearch" id="mb_in_trend">
          <query> | timechart sum(mb_in) </query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="underLabel">7 Day Trend</option>
        <option name="unit">MB</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Outbound Trend</title>
      <single>
        <search base="byteComputationSearch" id="mb_out_trend">
          <query> | timechart sum(mb_out)  </query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0.0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="underLabel">7 Day Trend</option>
        <option name="unit">MB</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>Device Volume In/Out (MB)</title>
      <chart>
        <search base="byteComputationSearch" id="vsn_volume_in_out">
          <query> | timechart sum(mb_in) as in sum(mb_out) as out by vsn</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">collapsed</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">log</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">zero</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisEnd</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
    <panel id="applications_area_chart">
      <title>Endpoint Activity</title>
      <chart>
        <search base="baseSearch" id="endpoint_activity">
          <!-- <latest>now</latest> -->
          <progress>
            <!-- Set the token to Show Spinner when the search is running -->
            <set token="showSpinner">true</set>
          </progress>
          <done>
            <!-- Unset the token to Hide Spinner when the search completes -->
            <unset token="showSpinner"></unset>
          </done>
          <done>
            <eval token="timeEarliest">strftime($time.earliest$,"%m/%d/%y %H:%M:%S")</eval>
            <eval token="timeLatest">strftime($time.latest$,"%m/%d/%y %H:%M:%S")</eval>
          </done>
          <query> | timechart count by vsn</query>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel id="applications_area_chart2">
      <title>User Volume In/Out (MB)</title>
      <chart>
        <search base="byteComputationSearch" id="user_activity">&gt;<!-- <latest>now</latest> -->
          <progress>
            <!-- Set the token to Show Spinner when the search is running -->
            <set token="showSpinner">true</set>
          </progress>
          <done>
            <!-- Unset the token to Hide Spinner when the search completes -->
            <unset token="showSpinner"></unset>
          </done>
          <done>
            <eval token="timeEarliest">strftime($time.earliest$,"%m/%d/%y %H:%M:%S")</eval>
            <eval token="timeLatest">strftime($time.latest$,"%m/%d/%y %H:%M:%S")</eval>
          </done>
          <query>| timechart sum(mb_in) as in sum(mb_out) as out by user</query>
        </search>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.size">large</option>
      </chart>
    </panel>
    <panel>
      <title>Internal Clients Acting as Servers</title>
      <chart>
        <search base="baseSearch" id="internal_clients_servers">
          <query>| where sp&lt;=49152 AND (sa="10.0.0.0/8" OR sa="172.16.0.0/12" OR sa="192.168.0.0/16") AND ibc &gt; 0 | timechart count by liuid</query>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel id="src_dest_dist_chart">
      <title>Source Port Activity</title>
      <chart>
        <search base="baseSearch" id="sp_activity">
          <!-- <latest>now</latest> -->
          <progress>
            <!-- Set the token to Show Spinner when the search is running -->
            <set token="showSpinner">true</set>
          </progress>
          <done>
            <!-- Unset the token to Hide Spinner when the search completes -->
            <unset token="showSpinner"></unset>
          </done>
          <done>
            <eval token="timeEarliest">strftime($time.earliest$,"%m/%d/%y %H:%M:%S")</eval>
            <eval token="timeLatest">strftime($time.latest$,"%m/%d/%y %H:%M:%S")</eval>
          </done>
          <query>| top sp</query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Dest Port Activity</title>
      <chart>
        <search base="baseSearch" id="dp_activity">
          <query>| top dp</query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Process Flow Volume</title>
      <chart>
        <search base="baseSearch" id="pn_flow_volume">
          <query>| stats count(pn) by pn</query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Parent Process Flow Volume</title>
      <chart>
        <search base="baseSearch" id="ppn_flows">
          <query> | stats count(ppn) by ppn</query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Flow(s)</title>
      <table>
        <search base="baseSearch" id="flow_summary">
          <query>| rename vsn As Device, count(pn) AS Flows, pn AS Application, osn AS Platform, pn AS "Application", pa AS "Process Account", ppn AS "Parent Process", ppa AS "Parent Process Account", mnl AS "Module Name List", mhl AS "Module Hash List", ph AS "Hash", user as "User", sa As "Src Ip", da As "Dst Ip", dh as "Host", ds as "Source"</query>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <format type="number" field="ph"></format>
        <format type="number" field="Score">
          <option name="useThousandSeparators">false</option>
        </format>
                <drilldown>
          <condition field="Hash">
            <eval token="sourcetype">replace('row.Src', "\\\\", "\\\\")</eval>
            <set token="tokHideShow">show fade</set>
            <unset token="showChart"></unset>
            <link>/app/CiscoNVM/process_info?processName=$row.Hash$</link>
          </condition>
          <condition field="Src">
            <eval token="sourcetype">replace('row.Src', "\\\\", "\\\\")</eval>
            <set token="tokHideShow">show fade</set>
            <unset token="showChart"></unset>
            <link>/app/CiscoNVM/process_info?processName=$row.Src$</link>
          </condition>
          <!--  <link>/app/CiscoNVM/process_info?processName=$row.Hash$</link>-->
        </drilldown>
      </table>
    </panel>
  </row>
</form>
