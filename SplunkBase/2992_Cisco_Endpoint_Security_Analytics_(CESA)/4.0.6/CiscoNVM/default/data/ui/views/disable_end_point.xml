<form version="1.1" stylesheet="css/common.css">
  <init>
    <set token="dh_tok"></set>
    <set token="user_tok"></set>
    <set token="pn_tok"></set>
    <set token="ph_tok"></set>
  </init>
  <search>
    <query>| rest /servicesNS/admin/CiscoNVM/configs/conf-nvm | fields endpoint_agents | rename endpoint_agents as agents</query>
    <earliest>-1d@d</earliest>
    <latest>@d</latest>
    <done>
      <eval token="tokEndpointAgents">$agents$</eval>
    </done>
    <finalized>
      <condition match=" 'job.resultCount' != 0">
        <set token="tokEndpointAgents">$result.agents$</set>
      </condition>
      <condition>
        <set token="tokEndpointAgents"></set>
      </condition>
    </finalized>
  </search>
  <label>Security Evasion - Users Disabling Endpoint Services</label>
  <description>Endpoints that have stopped reported after a set period of time. By default NVM agent is included in this search, additional monitoring services can be set in the Process(es) field below</description>
  <search id="baseSearch">
    <query>
        `nvm_flowdata_index` $pn_tok$ $user_tok$ $ph_tok$ $dh_tok$ 
        | join udid [ | inputlookup unique_endpoints | search $vsn_tok$ ] 
        | eval days_since = round((now() - _time),2) / 86400  
        | rename vsn as Device, liuid as User, days_since As "Days Since Last Log Entry", "''" As "Unknown" 
        | fields - _raw 
        | table _time, "Days Since Last Log Entry", Device, osn, ose, osv, sm, user, da, dp, dh, sa, sp , pn, ppn, udid, pph, ph, dh
    </query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="byteComputationSearch">
    <query>
        `nvm_flowdata_index` $pn_tok$ $user_tok$ $ph_tok$ $dh_tok$ 
        | join udid [ | inputlookup unique_endpoints | search $vsn_tok$ ] 
        | eval days_since = round((now() - _time),2) / 86400  
        | rename vsn as Device, liuid as User, days_since As "Days Since Last Log Entry", "''" As "Unknown" 
        | fields - _raw 
        | table _time, "Days Since Last Log Entry", Device, osn, ose, osv, sm, user, da, dp, dh, sa, sp , pn, ppn, udid, bytes_in,bytes_out, pph, ph, dh
        | eval mb_out = ((bytes_out/1024)/1024)  | eval mb_in = ((bytes_in/1024)/1024)
    </query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <fieldset submitButton="true">
    <input type="time" token="time">
      <label>Time</label>
      <default>
        <earliest>-7d@d</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="multiselect" token="vsn_tok" searchWhenChanged="false">
      <label>Device(s)</label>
      <default>*</default>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>vsn="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>vsn</fieldForLabel>
      <fieldForValue>vsn</fieldForValue>
      <search>
        <query>`nvm_sysdata_index` | stats count by vsn</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="multiselect" token="pn_tok" searchWhenChanged="false">
      <label>Process(es)</label>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>pn="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>pn</fieldForLabel>
      <fieldForValue>pn</fieldForValue>
      <search>
        <query>`nvm_flowdata_index` | stats count by pn</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="multiselect" token="user_tok" searchWhenChanged="false">
      <label>Users</label>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>user="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>user</fieldForLabel>
      <fieldForValue>user</fieldForValue>
      <search>
        <query>`nvm_flowdata_index` ph!="" | stats count by user</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="text" token="ph_tok" searchWhenChanged="false">
      <label>Process Hash</label>
    </input>
    <input type="text" token="dh_tok" searchWhenChanged="false">
      <label>Destination</label>
      <prefix>dh="</prefix>
      <suffix>"</suffix>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Device(s)</title>
      <single>
        <search base="baseSearch" id="vsn_count">
          <query>| dedup Device | stats count(Device)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>User(s)</title>
      <single>
        <search base="baseSearch" id="sa_count">
          <query>| dedup user | stats count(user)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Process(es)</title>
      <single>
        <search base="baseSearch" id="app_count">
          <query> | dedup pn | stats count(pn)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Flow(s)</title>
      <single>
        <search base="baseSearch" id="sa_trend">
          <query>| stats count</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Flow Count Trend</title>
      <single>
        <search base="baseSearch" id="device_trend_count">
          <query>| timechart count by vsn</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="underLabel">7 Day Trend</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Inbound Volume</title>
      <single>
        <search base="byteComputationSearch" id="mb_in_volume_total">
          <query> | stats sum(mb_in)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0.0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="unit">MB</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Outbound Volume</title>
      <single>
        <search base="byteComputationSearch" id="mb_out_volume_total">
          <query> | stats sum(mb_out)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0.0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="unit">MB</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Inbound Trend</title>
      <single>
        <search base="byteComputationSearch" id="mb_in_trend">
          <query> | timechart sum(mb_in) </query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="underLabel">7 Day Trend</option>
        <option name="unit">MB</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Outbound Trend</title>
      <single>
        <search base="byteComputationSearch" id="mb_out_trend2">
          <query> | timechart sum(mb_out)  </query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0.0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="underLabel">7 Day Trend</option>
        <option name="unit">MB</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>NVM Monitoring Age Chart by User</title>
      <chart>
        <search base="baseSearch" id="nvm_age_chart">
          <query>| dedup user | table user, "Days Since Last Log Entry"</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Device Volume In/Out (MB)</title>
      <chart>
        <search base="byteComputationSearch" id="vsn_volume_in_out">
          <query> | timechart sum(mb_in) as in sum(mb_out) as out by vsn</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">collapsed</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">log</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">zero</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisEnd</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
    <panel id="applications_area_chart51">
      <title>Endpoint Activity</title>
      <chart>
        <search base="baseSearch" id="endpoint_activity">
          <!-- <latest>now</latest> -->
          <progress>
            <!-- Set the token to Show Spinner when the search is running -->
            <set token="showSpinner">true</set>
          </progress>
          <done>
            <!-- Unset the token to Hide Spinner when the search completes -->
            <unset token="showSpinner"></unset>
          </done>
          <done>
            <eval token="timeEarliest">strftime($time.earliest$,"%m/%d/%y %H:%M:%S")</eval>
            <eval token="timeLatest">strftime($time.latest$,"%m/%d/%y %H:%M:%S")</eval>
          </done>
          <query> | timechart count by vsn</query>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel id="applications_area_chart">
      <title>Disabled Endpoint Monitoring - Device Activity</title>
      <chart>
        <search base="baseSearch" id="disable_end_point_activity">
          <!-- <latest>now</latest> -->
          <progress>
            <!-- Set the token to Show Spinner when the search is running -->
            <set token="showSpinner">true</set>
          </progress>
          <done>
            <!-- Unset the token to Hide Spinner when the search completes -->
            <unset token="showSpinner"></unset>
          </done>
          <done>
            <eval token="timeEarliest">strftime($time.earliest$,"%m/%d/%y %H:%M:%S")</eval>
            <eval token="timeLatest">strftime($time.latest$,"%m/%d/%y %H:%M:%S")</eval>
          </done>
          <query>|  timechart count by vsn</query>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Disabled Endpoint Monitoring - Inbound Volume Destinations</title>
      <chart>
        <search base="byteComputationSearch" id="mb_in_trend_2">
          <query>| stats sum(mb_in) by dh</query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Disabled Endpoint Monitoring - Outbound Volume Destinations</title>
      <chart>
        <search base="byteComputationSearch" id="mb_out_trend_2">
          <query>| stats sum(mb_out) by dh</query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Device(s) Inactive &gt; 60 Days</title>
      <table id="nvmFilterApp">
        <title>All Flow Records from filtered results, you can click the hashe(s) to initiate reputation lookup, or click on the Flow time to see the detailed Splunk Query</title>
        <search base="baseSearch" id="flow_sumamry">
          <query>| dedup user, Device, osn | table udid, Device, user, pn, "Days Since Last Log Entry", osn, ose, osv, sm | rename "Days Since Last Log Entry" as "Age", pn as "Process Name", osn as "OS", user as "User"
|  where Age &gt; 60</query>
        </search>
        <option name="count">25</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <condition field="Hash">
            <eval token="sourcetype">replace('row.Src', "\\\\", "\\\\")</eval>
            <set token="tokHideShow">show fade</set>
            <unset token="showChart"></unset>
            <link>/app/CiscoNVM/process_info?processName=$row.Hash$</link>
          </condition>
          <condition field="Src">
            <eval token="sourcetype">replace('row.Src', "\\\\", "\\\\")</eval>
            <set token="tokHideShow">show fade</set>
            <unset token="showChart"></unset>
            <link>/app/CiscoNVM/process_info?processName=$row.Src$</link>
          </condition>
          <!--  <link>/app/CiscoNVM/process_info?processName=$row.Hash$</link>-->
        </drilldown>
      </table>
    </panel>
  </row>
</form>
