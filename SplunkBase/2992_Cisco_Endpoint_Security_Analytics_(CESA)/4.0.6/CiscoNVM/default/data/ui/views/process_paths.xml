<form version="1.1" stylesheet="css/common.css">
  <label>Process Path Investigation</label>
  <description>This analytic contains a built in filter by whitelisted process(es) - to configure your whitelist go Settings-&gt;Lookups and edit the file "process_whitelist_by_pn.csv"</description>
  <init>
    <set token="dh_tok"></set>
    <set token="user_tok"></set>
  </init>
  <search id="baseSearch">
    <query>
        `nvm_flowdata_index` NOT [| inputlookup process_whitelist_by_pn.csv| table pn ] $ppath_tok$ $pn_tok$ $user_tok$ $ph_tok$ $dh_tok$ $parg_tok$ NOT pap=* OR (pap!=Administrator AND pap!=LOCAL AND pap!=SYSTEM AND pap!=_netbios AND pap!=NETWORK AND pap!=linuxuid_0 AND pap!=softwareupdate AND pap!=nobody AND pap!=_mdnsreponder AND pap!=_lp AND pap!=_locationd AND pap!=root pap!=UpdateUser) | fields udid, sa, sp, da, dp, transport, ph, pn, user, ppn, dh, ppath, parg | eval dh = if(dh="Unknown", da, da) | join udid [| inputlookup unique_endpoints] 
    </query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <search id="byteComputationSearch">
    <query>
        `nvm_flowdata_index` NOT [| inputlookup process_whitelist_by_pn.csv| table pn] $ppath_tok$ $pn_tok$ $user_tok$ $ph_tok$ $dh_tok$ $parg_tok$ NOT pap=* OR (pap!=Administrator AND pap!=LOCAL AND pap!=SYSTEM AND pap!=_netbios AND pap!=NETWORK AND pap!=linuxuid_0 AND pap!=softwareupdate AND pap!=nobody AND pap!=_mdnsreponder AND pap!=_lp AND pap!=_locationd AND pap!=root pap!=UpdateUser) | fields udid, sa, sp, da, dp, transport, ph, pn, user, ppn, dh, bytes_in, bytes_out | eval dh = if(dh="Unknown", da, da) | join udid [| inputlookup unique_endpoints ] | eval mb_out = ((bytes_out/1024)/1024)  | eval mb_in = ((bytes_in/1024)/1024)
    </query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
  </search>
  <fieldset submitButton="true">
    <input type="time" token="time">
      <label>Time</label>
      <default>
        <earliest>-7d@d</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="multiselect" token="vsn_tok" searchWhenChanged="false">
      <label>Device</label>
      <default>*</default>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>vsn="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>vsn</fieldForLabel>
      <fieldForValue>vsn</fieldForValue>
      <search>
        <query>`nvm_sysdata_index` | stats count by vsn</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="multiselect" token="pn_tok" searchWhenChanged="false">
      <label>Process(es)</label>
      <default>*</default>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>pn="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>pn</fieldForLabel>
      <fieldForValue>pn</fieldForValue>
      <search>
        <query>`nvm_flowdata_index` | stats count by pn</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="multiselect" token="ppath_tok" searchWhenChanged="false">
      <label>Path(s)</label>
      <default>*</default>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>ppath="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>ppath</fieldForLabel>
      <fieldForValue>ppath</fieldForValue>
      <search>
        <query>`nvm_flowdata_index` | stats count by ppath</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="text" token="parg_tok" searchWhenChanged="false">
      <label>Cmd Arugments</label>
      <initialValue>*</initialValue>
    </input>
    <input type="multiselect" token="user_tok" searchWhenChanged="false">
      <label>Users</label>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>user="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>user</fieldForLabel>
      <fieldForValue>user</fieldForValue>
      <search>
        <query>`nvm_flowdata_index` ph!="" | stats count by user</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="text" token="ph_tok" searchWhenChanged="false">
      <label>Process Hash</label>
      <initialValue>*</initialValue>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Device(s)</title>
      <single>
        <search base="baseSearch" id="vsn_count">
          <query>| dedup vsn | stats count(vsn)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>User(s)</title>
      <single>
        <search base="baseSearch" id="sa_count">
          <query>| dedup user | stats count(user)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Process(es)</title>
      <single>
        <search base="baseSearch" id="app_count">
          <query> | dedup pn | stats count(pn)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Flow(s)</title>
      <single>
        <search base="baseSearch" id="sa_trend">
          <query>| stats count</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Flow Count Trend</title>
      <single>
        <search base="baseSearch" id="device_trend_count">
          <query>| timechart count by vsn</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="underLabel">7 Day Trend</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Inbound Volume</title>
      <single>
        <search base="byteComputationSearch" id="mb_in_volume_total">
          <query> | stats sum(mb_in)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0.0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="unit">MB</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Outbound Volume</title>
      <single>
        <search base="byteComputationSearch" id="mb_out_volume_total">
          <query> | stats sum(mb_out)</query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0.0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="unit">MB</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Inbound Trend</title>
      <single>
        <search base="byteComputationSearch" id="mb_in_trend">
          <query> | timechart sum(mb_in) </query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="underLabel">7 Day Trend</option>
        <option name="unit">MB</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Outbound Trend</title>
      <single>
        <search base="byteComputationSearch" id="mb_out_trend">
          <query> | timechart sum(mb_out)  </query>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0.0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="underLabel">7 Day Trend</option>
        <option name="unit">MB</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
  </row>
  <row>
    <panel id="applications_area_chart6">
      <title>Least Common Path and Process Activity</title>
      <table>
        <search base="baseSearch" id="user_activity3">&gt;<!-- <latest>now</latest> -->
          <progress>
            <!-- Set the token to Show Spinner when the search is running -->
            <set token="showSpinner">true</set>
          </progress>
          <done>
            <!-- Unset the token to Hide Spinner when the search completes -->
            <unset token="showSpinner"></unset>
          </done>
          <done>
            <eval token="timeEarliest">strftime($time.earliest$,"%m/%d/%y %H:%M:%S")</eval>
            <eval token="timeLatest">strftime($time.latest$,"%m/%d/%y %H:%M:%S")</eval>
          </done>
          <query>|  rare ppath by pn,parg limit=10 | join udid [search sourcetype="cisco:nvm:flowdata" | table user]
|  fields - percent
|  table pn, user, ppath, parg, count 
|  rename parg as "Arguments", ppath as "Path", pn as "Process Name", user as "User", count as "Count" | sort Count</query>
        </search>
        <option name="count">7</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">true</option>
        <option name="wrap">false</option>
        <drilldown>
          <condition field="Path">
            <set token="ppath_tok">$click.value$</set>
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel id="applications_area_chart4">
      <title>Acitivty by Process Path</title>
      <chart>
        <search base="baseSearch" id="user_activity2">&gt;<!-- <latest>now</latest> -->
          <progress>
            <!-- Set the token to Show Spinner when the search is running -->
            <set token="showSpinner">true</set>
          </progress>
          <done>
            <!-- Unset the token to Hide Spinner when the search completes -->
            <unset token="showSpinner"></unset>
          </done>
          <done>
            <eval token="timeEarliest">strftime($time.earliest$,"%m/%d/%y %H:%M:%S")</eval>
            <eval token="timeLatest">strftime($time.latest$,"%m/%d/%y %H:%M:%S")</eval>
          </done>
          <query>| timechart count by ppath</query>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel id="applications_area_chart">
      <title>Server Flow Activity</title>
      <chart>
        <search base="baseSearch" id="sa_timechart">
          <!-- <latest>now</latest> -->
          <progress>
            <!-- Set the token to Show Spinner when the search is running -->
            <set token="showSpinner">true</set>
          </progress>
          <done>
            <!-- Unset the token to Hide Spinner when the search completes -->
            <unset token="showSpinner"></unset>
          </done>
          <done>
            <eval token="timeEarliest">strftime($time.earliest$,"%m/%d/%y %H:%M:%S")</eval>
            <eval token="timeLatest">strftime($time.latest$,"%m/%d/%y %H:%M:%S")</eval>
          </done>
          <query> | timechart count by sa</query>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel id="applications_area_chart2">
      <title>User Volume In/Out (MB)</title>
      <chart>
        <search base="byteComputationSearch" id="user_activity">&gt;<!-- <latest>now</latest> -->
          <progress>
            <!-- Set the token to Show Spinner when the search is running -->
            <set token="showSpinner">true</set>
          </progress>
          <done>
            <!-- Unset the token to Hide Spinner when the search completes -->
            <unset token="showSpinner"></unset>
          </done>
          <done>
            <eval token="timeEarliest">strftime($time.earliest$,"%m/%d/%y %H:%M:%S")</eval>
            <eval token="timeLatest">strftime($time.latest$,"%m/%d/%y %H:%M:%S")</eval>
          </done>
          <query>| timechart sum(mb_in) as in sum(mb_out) as out by user</query>
        </search>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.size">large</option>
      </chart>
    </panel>
    <panel>
      <title>Inbound/Outbound Volume</title>
      <chart>
        <search base="byteComputationSearch" id="dns_in_out">
          <query>| timechart sum(mb_in) as inbound sum(mb_out) as outbound by vsn</query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel id="applications_area_chart1">
      <title>Endpoint Activity</title>
      <chart>
        <search base="baseSearch" id="endpoint_activity">
          <!-- <latest>now</latest> -->
          <progress>
            <!-- Set the token to Show Spinner when the search is running -->
            <set token="showSpinner">true</set>
          </progress>
          <done>
            <!-- Unset the token to Hide Spinner when the search completes -->
            <unset token="showSpinner"></unset>
          </done>
          <done>
            <eval token="timeEarliest">strftime($time.earliest$,"%m/%d/%y %H:%M:%S")</eval>
            <eval token="timeLatest">strftime($time.latest$,"%m/%d/%y %H:%M:%S")</eval>
          </done>
          <query> | timechart count by vsn</query>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>NVM Flow Records</title>
      <table>
        <search base="baseSearch" id="dns_flows">
          <query>| table _time, vsn, ppath, pn, user, sa, sp,da,dp, transport, ds, dh | rename pn AS Application, ppath AS "Path", pn AS "Process Name", pa AS "Process Account", ppn AS "Parent Process Name", ppa AS "Parent Process Account", mnl AS "Module Name List", mhl AS "Module Hash List", ph AS "Process Hash", vsn As "Device", sa AS "Src", da AS "Dest", sp As "Src Port", dp AS "Dest Port", dh as "Host", transport As "Transport", pph As "Parent Process Hash", user as "User"</query>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <option name="wrap">false</option>
        <drilldown>
          <condition field="Hash">
            <eval token="sourcetype">replace('row.Src', "\\\\", "\\\\")</eval>
            <set token="tokHideShow">show fade</set>
            <unset token="showChart"></unset>
            <link>/app/CiscoNVM/process_info?processName=$row.Hash$</link>
          </condition>
          <condition field="Src">
            <eval token="sourcetype">replace('row.Src', "\\\\", "\\\\")</eval>
            <set token="tokHideShow">show fade</set>
            <unset token="showChart"></unset>
            <link>/app/CiscoNVM/process_info?processName=$row.Src$</link>
          </condition>
          <!--  <link>/app/CiscoNVM/process_info?processName=$row.Hash$</link>-->
        </drilldown>
      </table>
    </panel>
  </row>
</form>
