<form version="1.1" stylesheet="styles/css/common.css" theme="light">
  <label>Zero Trust - Suspicious LDAP Activity</label>
  <description>Shows activity on all non-whitelisted applications and domains - to configure your whitelist go to Settings-&gt;Lookups and edit the "whitelist_processes.csv" files for the CiscoNVM app</description>
  <fieldset submitButton="false">
    <input type="time" token="time">
      <label>Time</label>
      <default>
        <earliest>-7d@d</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="multiselect" token="user_tok" searchWhenChanged="true">
      <label>Users</label>
      <default>*</default>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>user="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>user</fieldForLabel>
      <fieldForValue>user</fieldForValue>
      <search>
        <query>`nvm_flowdata_index` ph!="" | stats count by user</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="multiselect" token="pn_tok" searchWhenChanged="true">
      <label>Process(es)</label>
      <default>*</default>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>pn="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>pn</fieldForLabel>
      <fieldForValue>pn</fieldForValue>
      <search>
        <query>sourcetype=cisco:nvm:flowdata | stats count by pn</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="text" token="ph_tok" searchWhenChanged="true">
      <label>Process Hash</label>
      <initialValue>*</initialValue>
    </input>
    <input type="multiselect" token="ppn_tok" searchWhenChanged="true">
      <label>Parent Process(es)</label>
      <default>*</default>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>ppn="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>ppn</fieldForLabel>
      <fieldForValue>ppn</fieldForValue>
      <search>
        <query>sourcetype=cisco:nvm:flowdata NOT [| inputlookup whitelist.csv | rename host as dh]   | stats count by ppn</query>
        <earliest>0</earliest>
      </search>
    </input>
    <input type="text" token="dh_tok" searchWhenChanged="true">
      <label>Domain</label>
      <initialValue>*</initialValue>
    </input>
    <input type="multiselect" token="vsn_tok" searchWhenChanged="true">
      <label>Device</label>
      <default>*</default>
      <!-- Each value will be surrounded by the valuePrefix and valueSuffix -->
      <valuePrefix>vsn="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">ALL</choice>
      <fieldForLabel>vsn</fieldForLabel>
      <fieldForValue>vsn</fieldForValue>
      <search>
        <query>`nvm_sysdata_index` | stats count by vsn</query>
        <earliest>0</earliest>
      </search>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Non-WL Devices</title>
      <single>
        <search>
          <query>`nvm_flowdata_index`  $pn_tok$ $user_tok$ $ppn_tok$ ph="$ph_tok$" dh="$dh_tok$" NOT [| inputlookup whitelist_processes.csv | table ph ] | table pn, ph, sa, udid, _time | join udid [|search `nvm_sysdata_index` $vsn_tok$] | fields vsn | dedup vsn| stats count(vsn)</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Non-WL Device Flow Count</title>
      <single>
        <search>
          <query>`nvm_flowdata_index`  $pn_tok$ $user_tok$ $pn_tok$ ph="$ph_tok$" dh="$dh_tok$"  NOT [| inputlookup whitelist_processes.csv | table ph ] | table udid, ph, pn, user, _time | join udid [|search `nvm_sysdata_index` $vsn_tok$] | fields _time, vsn, ph, pn, user | timechart count(vsn) by vsn</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="underLabel">7 Day Trend</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Non-WL Host(s)</title>
      <single>
        <search>
          <query>`nvm_flowdata_index`  $pn_tok$ $user_tok$ $pn_tok$ ph="$ph_tok$" dh="$dh_tok$" NOT [| inputlookup whitelist_processes.csv | table ph ] | table udid, ph, pn, user, _time, sa | join udid [|search `nvm_sysdata_index` $vsn_tok$] | fields _time, vsn, ph, pn, user, sa | dedup sa | stats count(sa)</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Non-WL Host Flow Count</title>
      <single>
        <search>
          <query>`nvm_flowdata_index`  $pn_tok$ $user_tok$ $pn_tok$ ph="$ph_tok$" dh="$dh_tok$" NOT [| inputlookup whitelist_processes.csv | table ph ] | table udid, ph, pn, user, _time, sa | join udid [|search `nvm_sysdata_index` $vsn_tok$] | fields _time, vsn, ph, pn, user, sa | timechart count(sa) by sa</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="underLabel">7 Day Trend</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Non-WL Application Count</title>
      <single>
        <search>
          <query>`nvm_flowdata_index`  $pn_tok$ $user_tok$ $pn_tok$ ph="$ph_tok$" dh="$dh_tok$"  NOT [| inputlookup whitelist_processes.csv | table ph ] | table udid, ph, pn, user, _time, sa | join udid [|search `nvm_sysdata_index` $vsn_tok$] | fields _time, vsn, ph, pn, user, sa | dedup pn | stats count(pn)</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Non-WL App Flow Count</title>
      <single>
        <search>
          <query>`nvm_flowdata_index`   $pn_tok$ $user_tok$ $pn_tok$ ph="$ph_tok$" dh="$dh_tok$" NOT [| inputlookup whitelist_processes.csv | table ph ] | table udid, ph, pn, user, _time, sa | join udid [|search `nvm_sysdata_index` $vsn_tok$] | fields _time, vsn, ph, pn, user, sa | timechart count(pn) by pn</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="colorBy">trend</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">inverse</option>
        <option name="trendDisplayMode">percent</option>
        <option name="trendInterval">-7d</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
  </row>
  <row>
    <panel id="applications_area_chart">
      <title>Non-WL Endpoint Activity</title>
      <chart>
        <search>
          <!-- <latest>now</latest> -->
          <progress>
            <!-- Set the token to Show Spinner when the search is running -->
            <set token="showSpinner">true</set>
          </progress>
          <done>
            <!-- Unset the token to Hide Spinner when the search completes -->
            <unset token="showSpinner"></unset>
          </done>
          <done>
            <eval token="timeEarliest">strftime($time.earliest$,"%m/%d/%y %H:%M:%S")</eval>
            <eval token="timeLatest">strftime($time.latest$,"%m/%d/%y %H:%M:%S")</eval>
          </done>
          <query>`nvm_flowdata_index`  $pn_tok$ $user_tok$ $ppn_tok$ ph="$ph_tok$" dh="$dh_tok$" NOT [| inputlookup whitelist_processes.csv | table ph ] | table udid, ph, ppn, pn, user, _time, vsn | join udid [|search `nvm_sysdata_index` $vsn_tok$] | timechart count by vsn</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Non-WL Process Flow Volume</title>
      <chart>
        <search>
          <query>`nvm_flowdata_index`  $pn_tok$ $user_tok$ $ppn_tok$ ph="$ph_tok$" dh="$dh_tok$" NOT [| inputlookup whitelist_processes.csv | table ph ] | table pn, ph, sa, udid, _time | join udid [|search `nvm_sysdata_index` $vsn_tok$] | fields pn, | stats count(pn) by pn</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Non-WL Parent Process Flow Volume</title>
      <chart>
        <search>
          <query>`nvm_flowdata_index`  $pn_tok$ $user_tok$ $ppn_tok$ ph="$ph_tok$" dh="$dh_tok$" NOT [| inputlookup whitelist_processes.csv | table ph ] | table pn,ppn, ph, sa, udid, _time | join udid [|search `nvm_sysdata_index` $vsn_tok$] | fields ppn, | stats count(ppn) by ppn</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel id="src_dest_dist_chart">
      <title>Non-WL Source Port Activity</title>
      <chart>
        <search>
          <!-- <latest>now</latest> -->
          <progress>
            <!-- Set the token to Show Spinner when the search is running -->
            <set token="showSpinner">true</set>
          </progress>
          <done>
            <!-- Unset the token to Hide Spinner when the search completes -->
            <unset token="showSpinner"></unset>
          </done>
          <done>
            <eval token="timeEarliest">strftime($time.earliest$,"%m/%d/%y %H:%M:%S")</eval>
            <eval token="timeLatest">strftime($time.latest$,"%m/%d/%y %H:%M:%S")</eval>
          </done>
          <query>`nvm_flowdata_index`  $pn_tok$ $user_tok$ $ppn_tok$ ph="$ph_tok$" dh="$dh_tok$"  NOT [| inputlookup whitelist_processes.csv | table ph ] | table udid, sp,dp, _time | join udid [|search `nvm_sysdata_index` $vsn_tok$] | top sp</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Non-WL Dest Port Activity</title>
      <chart>
        <search>
          <query>`nvm_flowdata_index`  $pn_tok$ $user_tok$ $ppn_tok$ ph="$ph_tok$" dh="$dh_tok$" NOT [| inputlookup whitelist_processes.csv | table ph ] | table udid, sp,dp, _time | join udid [|search `nvm_sysdata_index` $vsn_tok$] | top dp</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Non-WL Hash Activity</title>
      <chart>
        <search>
          <query>`nvm_flowdata_index`  $pn_tok$ $user_tok$ $ppn_tok$ ph="$ph_tok$" dh="$dh_tok$"  NOT [| inputlookup whitelist_processes.csv | table ph ] | table udid, ph, ppn, pn, user, _time, sa | join udid [|search `nvm_sysdata_index` $vsn_tok$] | timechart count by ph</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Non-WL Applications and Endpoints Flow Counts</title>
      <table>
        <search>
          <query>`nvm_flowdata_index`  $pn_tok$ $user_tok$ $ppn_tok$ ph="$ph_tok$" dh="$dh_tok$" NOT [| inputlookup whitelist_processes.csv | table ph ] | table _time, udid, vsn, pn, ppn, user, sa,da, dh, ds | join udid [|search `nvm_sysdata_index` $vsn_tok$] | stats count(pn) by udid, vsn, pn, ppn, user, sa, ds,da, dh | sort count(pn) desc| rename vsn As Device, count(pn) AS Flows, pn AS Application, osn AS Platform, pn AS "Application", pa AS "Process Account", ppn AS "Parent Process", ppa AS "Parent Process Account", mnl AS "Module Name List", mhl AS "Module Hash List", ph AS "Hash", user as "User", sa As "Src Ip", da As "Dst Ip", dh as "Host", ds as "Source"</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <format type="number" field="ph"></format>
        <format type="number" field="Score">
          <option name="useThousandSeparators">false</option>
        </format>
      </table>
    </panel>
  </row>
</form>
