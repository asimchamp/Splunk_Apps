{% extends "splunkdj:base_with_app_bar.html" %}

{% load splunkmvc %}

{% block title %}Goal Path{% endblock title %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}{{app_name}}/custom.css" />
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}splunkjs/css/dashboard.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/WebAnalytics/common.css" />
    <style>
        #mypiechart {
            height: 250px;
        }

        /*Page styles for the Toolkit charts*/
        #mysankeychart, #mypcchart {
            height: 500px;
        }

        #mysunburstchart {
            height: 500px;
        }

        #timerange {
            /* margin-top: 5px;
            float: left; */
        } 

        .panel {
            overflow: visible;
        }

        .panel-datalicious {
            float: left;
        } 
    </style>
{% endblock css %}

{% block content %}
<div class="dashboard-body container-fluid main-section-body">

    <!-- Search 1 -->
    <div class="dashboard-row">
        <div class="dashboard-header">
            <h2>Goal Path</h2>
        </div>
    </div>

    <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel">
                <div class="dashboard-element">
                    <div class="panel-body">
                      <div class="panel-datalicious">
                        <p>Domain:</p>
                        {% multidropdown id="websites"
                            managerid="dropdownsearch"
                            valueField="event.meta.host"
                            value="$website$"|token_safe %}
                      </div>
                      <div class="panel-datalicious">
                        <p>Goal:</p>
                        {% dropdown id="goals"
                            managerid="dropdownsearch-g"
                            valueField="event.goal.name"
                            value="$goal$"|token_safe %}
                      </div>
                      <div class="panel-datalicious">
                        <p>Visitor Source:</p>
                        {% dropdown id="visitors"
                            managerid="dropdownsearch-c"
                            labelField="label"
                            valueField="visitor"
                            default="person.id.cookie.optimahub3rd"
                            value="$visitor$"|token_safe %}
                      </div>
                      <div class="panel-datalicious">
                        <p>Time Range:</p>
                        {% timerange id="timerange" 
			   earliest_time="-4h@m"|token_safe
                           latest_time="now"|token_safe %}
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel">
                <div class="dashboard-element">
                    <div class="panel-head">
                        <h3>Reverse Conversion Flow</h3>
                    </div>
                    <div class="panel-body">
                        <div id="mysunburstchart"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div> 
{% endblock content%}

{% block managers %}
    {% searchmanager id="sunburstsearch1" search="source=webanalytics* [ | stats count | eval url2=\"$website$\" | eval urls=split(url2, \",\") | mvexpand urls | fields urls | rename urls as search | format ] | spath path=event.origin.id output=origin | spath path=event.id output=url | spath path=event.goal.step output=step | spath path=event.type output=type | spath path=event.goal.name output=goal_name | spath path=$visitor$ output=visitor | stats list(step) as steps list(url) as urls list(origin) as origins values(goal_name) as goal_name by visitor | search steps=Final* AND goal_name=\"$goal$\" | eval count_of_steps=mvcount(steps) | where count_of_steps>1 | eval x=mvzip(origins,urls) | mvexpand x | eval x = split(x,\",\") | eval engagement=mvindex(x,0) | eval conversion=mvindex(x,1) | stats count by conversion engagement | where engagement!=conversion | where count>1 | eval engagement=substr(engagement, 1, 55) | eval conversion=substr(conversion, 1, 55) | sort limit=20 - count"|token_safe
    preview=True cache=True status_buckets=0 auto_finalize_ec=100000 autostart=True %}

    {% searchmanager id="dropdownsearch" search="earliest=-24h@h source=webanalytics* | stats count by event.meta.host" cache=True preview=True %}

    {% searchmanager id="dropdownsearch-g" search="source=webanalytics* [ | stats count | eval url2=\"$website$\" | eval urls=split(url2, \",\") | mvexpand urls | fields urls | rename urls as search | format ] event.type=\"page|view|goal\" | stats count by event.goal.name"|token_safe
    preview=True cache=True status_buckets=0 auto_finalize_ec=100000 autostart=True %}
        
    {% searchmanager id="dropdownsearch-c" search="| inputlookup visitor_source.csv"|token_safe
    preview=True cache=True status_buckets=0 auto_finalize_ec=100000 autostart=True %}
        
{% endblock managers %}

{% block js %}    
<script>
    var deps = [
        "splunkjs/ready!",
	"splunkjs/mvc/multidropdownview",
        "splunkjs/mvc/searchmanager",
        "splunkjs/mvc/chartview",
        "splunkjs/mvc/timerangeview",

        // Use this if the /components folder is copied to your app:
        "jquery",
        "WebAnalytics/components/sankey/sankey"

    ];
    require(deps, function(mvc) {
        // Load individual components
	var MultiDropdownView = require("splunkjs/mvc/multidropdownview");
        var SearchManager = require("splunkjs/mvc/searchmanager");
        var ChartView = require("splunkjs/mvc/chartview");
        var TimeRangeView = require("splunkjs/mvc/timerangeview");

        // If the /components folder is copied to your app:
        var SunburstChart = require("WebAnalytics/components/sankey/sankey");

        // Create search managers and views
        var sunburstmysearch1 = mvc.Components.getInstance("sunburstsearch1");
        var ddsearch1 = mvc.Components.getInstance("dropdownsearch");
        var ddsearch2 = mvc.Components.getInstance("dropdownsearch-g");
        var ddsearch2 = mvc.Components.getInstance("dropdownsearch-c");
        var timerange1 = mvc.Components.getInstance("timerange");

        timerange1.on("change", function() {
            sunburstmysearch1.search.set(timerange1.val());
        });

        var mysbchart = new SunburstChart({
            id: "example-chart-sb",
            managerid: "sunburstsearch1",
            el: $("#mysunburstchart")
        }).render();

    });
</script>
{% endblock js %}

