<form script="link_switcher.js" stylesheet="common.css">
  <label>Audience Geography</label>
  <!-- use the autoRun attribute so the form runs when loaded -->
  <fieldset autoRun="true">
    <!-- Specify search when changed for the inputs -->
    <!-- Add time range picker -->
    <input type="dropdown" token="website" searchWhenChanged="true">
      <label>Domain:</label>
      <default>www.datalicious*</default>
      <choice value="www.datalicious*">www.datalicious.com</choice>
      <choice value="*">All</choice>
      <search>
        <query>`webanalytics_page_data` | stats count by event.meta.host</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
      <fieldForLabel>event.meta.host</fieldForLabel>
      <fieldForValue>event.meta.host</fieldForValue>
    </input>
    <input type="dropdown" token="visitor" searchWhenChanged="true">
      <label>Visitor Source:</label>
      <default>person.id.cookie.optimahub3rd</default>
      <populatingSearch earliest="-24h@h" latest="now" fieldForLabel="label" fieldForValue="visitor">| inputlookup visitor_source.csv</populatingSearch>
    </input>
    <input type="time" searchWhenChanged="true">
      <label>Time Range:</label>
      <default>
        <earliestTime>-24h@h</earliestTime>
        <latestTime>now</latestTime>
      </default>
    </input>
    <input type="dropdown" token="span_period" searchWhenChanged="true">
      <label>Time Interval:</label>
      <default>""</default>
      <choice value="">Automatic</choice>
      <prefix>span=</prefix>
      <suffix></suffix>
      <populatingSearch earliest="-24h@h" latest="now" fieldForLabel="label" fieldForValue="span_period">| inputlookup time_periods.csv</populatingSearch>
    </input>
  </fieldset>
  <searchTemplate>source=webanalytics* (event.meta.scheme="http" OR event.meta.scheme="https") event.meta.host=$website$
    | spath path=person.segments{}.name output=name
    | spath path=person.segments{}.value output=value
    | eval x=mvzip(name,value)
    | mvexpand x
    | eval x = split(x,",")
    | eval name=mvindex(x,0)
    | eval value=mvindex(x,1)
    | search name="language"
    | eval value=lower(value)
    | rename value AS language
    | bin _time span=30m 
    | stats count by _time,session.id, person.id.browser.fingerprintjs, person.id.cookie.datacollector3rd, person.id.cookie.optimahub3rd, person.id.cookie.supertag1st, person.id.ip, event.location.coordinates, event.location.country, event.location.region, event.location.city, language</searchTemplate>
  <earliestTime>$earliest$</earliestTime>
  <latestTime>$latest$</latestTime>
  <row>
    <panel>
      <html>
      <h2>Visitor Location</h2>
      <!-- Placeholder/container for the link switcher to appear -->
      <div class="link-switcher" data-items="link1,link2,link3">Select a view:<!--Links go here-->
      </div>
    </html>
      <map id="link1">
        <title>Map</title>
        <searchPostProcess>dedup $visitor$
       | rex field=event.location.coordinates "(?&lt;lat&gt;[^,]*),"
       | rex field=event.location.coordinates ",(?&lt;lon&gt;.*)"
       | where lon!=0
       | geostats count</searchPostProcess>
        <option name="mapping.markerLayer.markerMaxSize">20</option>
        <option name="mapping.map.center">(-26.75,137.37)</option>
        <option name="mapping.data.maxClusters">100</option>
        <option name="mapping.map.zoom">3</option>
        <option name="mapping.markerLayer.markerMinSize">10</option>
        <option name="mapping.markerLayer.markerOpacity">0.8</option>
        <option name="mapping.tileLayer.url">http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png</option>
        <option name="mapping.tileLayer.subdomains">[a,b,c]</option>
        <option name="mapping.tileLayer.minZoom">0</option>
        <option name="mapping.tileLayer.maxZoom">20</option>
        <option name="mapping.drilldown">none</option>
      </map>
      <chart id="link2">
        <title>Chart</title>
        <searchPostProcess>dedup $visitor$
        | lookup country_codes.csv Country_Code AS event.location.country OUTPUT Country
        | top Country</searchPostProcess>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisTitleY.text">Visitors</option>
      </chart>
      <chart id="link3">
        <title>Timechart</title>
        <searchPostProcess>lookup country_codes.csv Country_Code AS event.location.country OUTPUT Country
          | timechart $span_period$ dc($visitor$) by Country usenull=f</searchPostProcess>
        <earliestTime>$earliest$</earliestTime>
        <latestTime>$latest$</latestTime>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Visitors</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <html>
        <h2>Visitors By State/Region</h2>
      <!-- Placeholder/container for the link switcher to appear -->
      <div class="link-switcher" data-items="link4,link5,link6">Select a view:<!--Links go here-->
      </div>
    </html>
      <chart id="link4">
        <title>Chart</title>
        <searchPostProcess>dedup $visitor$
          | rex field=event.location.region "(?&lt;region&gt;[a-zA-Z]+)"
          | top region</searchPostProcess>
        <earliestTime>$earliest$</earliestTime>
        <latestTime>$latest$</latestTime>
        <option name="charting.axisTitleX.text">State</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Visitors</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
      </chart>
      <table id="link5">
        <title>Table</title>
        <searchPostProcess>dedup $visitor$
          | rex field=event.location.region "(?&lt;region&gt;[a-zA-Z]+)"
          | top region</searchPostProcess>
        <earliestTime>$earliest$</earliestTime>
        <latestTime>$latest$</latestTime>
        <option name="charting.axisTitleX.text">State</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Visitors</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="count">10</option>
      </table>
      <chart id="link6">
        <title>Timechart</title>
        <searchPostProcess>rex field=event.location.region "(?&lt;region&gt;[a-zA-Z]+)"
          | timechart $span_period$ dc($visitor$) by region usenull=f</searchPostProcess>
        <earliestTime>$earliest$</earliestTime>
        <latestTime>$latest$</latestTime>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Visitors</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <html>
      <h2>Visitors By City</h2>
      <!-- Placeholder/container for the link switcher to appear -->
      <div class="link-switcher" data-items="link7,link8,link9">Select a view:<!--Links go here-->
      </div>
    </html>
      <chart id="link7">
        <title>Chart</title>
        <searchPostProcess>dedup $visitor$
          | rex field=event.location.city "(?&lt;city&gt;[a-zA-Z]+)"
          | top city</searchPostProcess>
        <earliestTime>$earliest$</earliestTime>
        <latestTime>$latest$</latestTime>
        <option name="charting.axisTitleX.text">City</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Visitors</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
      </chart>
      <table id="link8">
        <title>Table</title>
        <searchPostProcess>dedup $visitor$
          | rex field=event.location.city "(?&lt;city&gt;[a-zA-Z]+)"
          | top city</searchPostProcess>
        <earliestTime>$earliest$</earliestTime>
        <latestTime>$latest$</latestTime>
        <option name="charting.axisTitleX.text">City</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Visitors</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="count">10</option>
      </table>
      <chart id="link9">
        <title>Timechart</title>
        <searchPostProcess>rex field=event.location.city "(?&lt;city&gt;[a-zA-Z]+)"
            | timechart $span_period$ dc($visitor$) by city usenull=f</searchPostProcess>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Visitors</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <html>
              <h2>
                Visitor Language
            </h2>
            <!-- Placeholder/container for the link switcher to appear -->
            <div class="link-switcher" data-items="link10,link11">Select a view: <!--Links go here-->
      </div>
        </html>
      <chart id="link10">
        <title>Chart</title>
        <searchPostProcess>dedup $visitor$
          | top language
          | table language, percent</searchPostProcess>
        <earliestTime>$earliest$</earliestTime>
        <latestTime>$latest$</latestTime>
        <option name="charting.axisTitleX.text">Language</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Percentage</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY.maximumNumber">100</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
      </chart>
      <chart id="link11">
        <title>Timechart</title>
        <searchPostProcess>timechart $span_period$ dc($visitor$) by language usenull=f</searchPostProcess>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Visitors</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">none</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>
</form>