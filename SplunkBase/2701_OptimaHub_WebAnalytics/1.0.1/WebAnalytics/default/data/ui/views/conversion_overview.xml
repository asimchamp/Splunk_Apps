<form script="forminput_panels.js, link_switcher.js, autodiscover.js" stylesheet="common.css, forminput_panels.css, table_data_bar.css">
  <label>Conversion Overview</label>
  <fieldset autoRun="True">
    <!-- Specify search when changed for the inputs -->
    <input type="multiselect" token="website" searchWhenChanged="true">
      <label>Domain:</label>
      <!-- <default></default> -->
      <default>*</default>
      <!-- The final value will be surrounded by prefix and suffix -->
      <prefix>(</prefix>
      <suffix>)</suffix>
      <!-- All the values and their valuePrefix and valueSuffix will be concatenated together with the delimiter between them -->
      <delimiter> OR </delimiter>
      <choice value="*">All</choice>
      <search>
        <query>`webanalytics_page_data` | stats count by event.meta.host</query>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </search>
      <fieldForLabel>event.meta.host</fieldForLabel>
      <fieldForValue>event.meta.host</fieldForValue>
    </input>
    <input type="dropdown" token="goal" searchWhenChanged="true">
      <label>Goal:</label>
      <!-- <default>Carhistory Report purchase</default> -->
      <search>
        <query>`webanalytics_page_data` $website$ event.type="page|view|goal" | stats count by event.goal.name</query>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </search>
      <fieldForLabel>event.goal.name</fieldForLabel>
      <fieldForValue>event.goal.name</fieldForValue>
    </input>
    <input type="dropdown" token="visitor" searchWhenChanged="true">
      <label>Visitor Source:</label>
      <default>person.id.cookie.optimahub3rd</default>
      <populatingSearch earliest="-24h@h" latest="now" fieldForLabel="label" fieldForValue="visitor">| inputlookup visitor_source.csv</populatingSearch>
    </input>
    <!-- Add time range picker -->
    <input type="time" searchWhenChanged="true">
      <label>Time Range:</label>
      <default>
        <earliestTime>-24h@h</earliestTime>
        <latestTime>now</latestTime>
      </default>
    </input>
    <input type="dropdown" token="span_period" searchWhenChanged="true">
      <label>Time Interval:</label>
      <default>""</default>
      <choice value="">Automatic</choice>
      <prefix>span=</prefix>
      <suffix></suffix>
      <populatingSearch earliest="-24h@h" latest="now" fieldForLabel="label" fieldForValue="span_period">| inputlookup time_periods.csv</populatingSearch>
    </input>
  </fieldset>
  <row>
    <table>
      <title>Conversion Overview (Visits)</title>
      <searchString>source=webanalytics* $website$
| spath path=event.id output=url        
| spath path=event.goal.step output=step      
| spath path=event.type output=type      
| spath path=event.goal.name output=goal_name        
| spath path=$visitor$ output=visitor
| stats list(step) as steps, list(goal_name) as goal_names by visitor 
| rex field=steps "(?&lt;steps_only&gt;\d+)" 
| eval count_of_steps=mvcount(steps_only)  
| eval e=mvzip(steps_only,goal_names)  
| rex field=e "(?&lt;e2&gt;\d+,$goal$)" 
| rex field=e2 "(?&lt;e3&gt;\d+)" 
| eval e4=mvcount(e3) 
| eval c=mvzip(steps,goal_names)  
| rex field=c "(?&lt;c2&gt;Final.*$goal$)" 
| rex field=c2 "(?&lt;c3&gt;Final)"  
| eval c4=mvcount(c3)
| stats dc(visitor) as Awareness, sum(e4) as Engagement, sum(c4) as Conversion
| table Awareness Engagement Conversion 
| transpose 
| rename column as Funnel 
| rename "row 1" as Visits</searchString>
      <option name="drilldown">none</option>
    </table>
    <table>
      <title>Conversion Overview (Drop-Offs)</title>
      <searchString>source=webanalytics* $website$
| spath path=event.id output=url        
| spath path=event.goal.step output=step      
| spath path=event.type output=type      
| spath path=event.goal.name output=goal_name        
| spath path=$visitor$ output=visitor
| stats list(step) as steps, list(goal_name) as goal_names by visitor 
| rex field=steps "(?&lt;steps_only&gt;\d+)" 
| eval count_of_steps=mvcount(steps_only)  
| eval e=mvzip(steps_only,goal_names)  
| rex field=e "(?&lt;e2&gt;\d+,$goal$)" 
| rex field=e2 "(?&lt;e3&gt;\d+)" 
| eval e4=mvcount(e3) 
| eval c=mvzip(steps,goal_names)  
| rex field=c "(?&lt;c2&gt;Final.*$goal$)" 
| rex field=c2 "(?&lt;c3&gt;Final)"  
| eval c4=mvcount(c3)
| stats dc(visitor) as Awareness, sum(e4) as Engagement, sum(c4) as Conversion
| eval Engagement2=Awareness-Engagement 
| eval Conversion2=Engagement-Conversion 
| rename Engagement2 as Engagement
| rename Conversion2 as Conversion          
| table Engagement Conversion 
| transpose 
| rename column as Funnel 
| rename "row 1" as Drop-Offs</searchString>
      <option name="drilldown">none</option>
    </table>
    <table>
      <title>Conversion Overview (Percentage)</title>
      <searchString>source=webanalytics* $website$
| spath path=event.id output=url        
| spath path=event.goal.step output=step      
| spath path=event.type output=type      
| spath path=event.goal.name output=goal_name        
| spath path=$visitor$ output=visitor
| stats list(step) as steps, list(goal_name) as goal_names by visitor 
| rex field=steps "(?&lt;steps_only&gt;\d+)" 
| eval count_of_steps=mvcount(steps_only)  
| eval e=mvzip(steps_only,goal_names)  
| rex field=e "(?&lt;e2&gt;\d+,$goal$)" 
| rex field=e2 "(?&lt;e3&gt;\d+)" 
| eval e4=mvcount(e3) 
| eval c=mvzip(steps,goal_names)  
| rex field=c "(?&lt;c2&gt;Final.*$goal$)" 
| rex field=c2 "(?&lt;c3&gt;Final)"  
| eval c4=mvcount(c3)
| stats dc(visitor) as Awareness, sum(e4) as Engagement, sum(c4) as Conversion
| eval Engagement_perc=round((Engagement/Awareness)*100, 2)
| eval Engagement=Engagement_perc + "%"
| eval Conversion_perc=round((Conversion/Awareness)*100, 2)
| eval Conversion=Conversion_perc + "%"
| table Engagement Conversion
| transpose 
| rename column as Funnel 
| rename "row 1" as "Percentage"</searchString>
      <option name="drilldown">none</option>
    </table>
  </row>
  <row>
    <panel>
      <html>
      <h2>Goal Flow</h2>
      <!-- Placeholder/container for the link switcher to appear -->
      <div class="link-switcher" data-items="link1,link2,link3">Select a view:<!--Links go here-->
      </div>
    </html>
      <chart id="link1">
        <title>Chart</title>
        <searchString>source=webanalytics* $website$ event.goal.name="$goal$" 
        | spath path=event.goal.step output=step 
        | spath path=$visitor$ output=visitor 
        | replace "Final Step" with "Conversion" in step         
        | stats list(step) as step by visitor 
        | stats count by step
        | reverse 
        | delta count AS drop-offs 
        | reverse</searchString>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
      </chart>
      <table id="link2">
        <title>Table</title>
        <searchString>source=webanalytics* $website$ event.goal.name="$goal$" 
        | spath path=event.goal.step output=step  
        | rex field=Step "(?&lt;Step&gt;\d+)" 
        | spath path=event.id output=url    
        | spath path=$visitor$ output=visitor 
        | replace "Final Step" with "Conversion" in step         
        | stats list(step) as steps, list(url) as urls by visitor
        | eval x=mvzip(steps,urls)
        | mvexpand x 
        | eval x=split(x,",") 
        | eval step=mvindex(x,0) 
        | eval url=mvindex(x,1) 
        | stats count by step url
        | sort - count</searchString>
        <option name="drilldown">none</option>
      </table>
      <chart id="link3">
        <title>Timechart</title>
        <searchString>source=webanalytics* $website$ event.goal.name="$goal$" 
        | spath path=event.goal.step output=Step           
        | rex field=Step "(?&lt;Step&gt;\d+)"                 
        | spath path=$visitor$ output=visitor 
        | transaction visitor
        | replace "Final Step" with "Conversion" in Step       
        | timechart $span_period$ count by Step</searchString>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>
  <row>
    <table>
      <title>Conversion Details (Engagement)</title>
      <searchString>source=webanalytics* $website$
| spath path=event.id output=url        
| spath path=event.goal.step output=step      
| spath path=event.type output=type      
| spath path=event.goal.name output=goal_name        
| spath path=$visitor$ output=visitor
| search step!="Final*" 
| search goal_name="$goal$"        
| stats list(url) AS engagement by visitor
| stats count by engagement   
| eval engagement=substr(engagement, 1, 55)        
| sort - count</searchString>
      <option name="drilldown">none</option>
    </table>
    <table>
      <title>Conversion Details (Conversion)</title>
      <searchString>source=webanalytics* $website$
| spath path=event.id output=url        
| spath path=event.goal.step output=step      
| spath path=event.type output=type      
| spath path=event.goal.name output=goal_name        
| spath path=$visitor$ output=visitor
| search step="Final*" 
| search goal_name="$goal$"        
| stats list(url) AS conversion by visitor
| stats count by conversion      
| eval conversion=substr(conversion, 1, 55)        
| sort - count</searchString>
      <option name="drilldown">none</option>
    </table>
  </row>
  <!--  - Disabled 27/9 - LH
  
  <row>
    <panel>
      <table id="table1">
        <title>Days Before Conversion</title>
        <searchString>`webanalytics_web_data` $website$ 
earliest=[ stats count 
| addinfo 
| eval search=info_min_time-(90*60*60*24)]           
| dedup session.id          
| spath path=event.goal.step output=step  
| spath path=$visitor$ output=visitor 
| streamstats current=f count by visitor step  
| sort visitor
| where (count=0 AND step=="Final Step") OR count=1
| stats earliest(_time) AS earliesttime latest(_time) AS latesttime by visitor        
| addinfo           
| eval currentstarttime=info_min_time+(90*60*60*24)           
| eval currentendtime=info_max_time           
| where latesttime>currentstarttime           
| eval timedelta=currentstarttime-earliesttime           
| eval daysdiff=if(timedelta&lt;0,0,timedelta/86400)           
| eval range=case(daysdiff&lt;1, "0", daysdiff&gt;=1 AND daysdiff&lt;=2, "1", daysdiff&gt;2 AND 
          daysdiff&lt;=3, "2", daysdiff&gt;3 AND daysdiff&lt;=4, "3", daysdiff&gt;4 AND 
          daysdiff&lt;=5, "4", daysdiff&gt;5 AND daysdiff&lt;=10, "5-10", daysdiff&gt;10 AND 
          daysdiff&lt;=30, "10-30", daysdiff&gt;30 AND daysdiff&lt;=60, "30-60", daysdiff&gt;60 AND daysdiff&lt;=90, "60-90" )           
| stats count by range           
| rename range AS "Days Since Last Session", count AS "Visitors"           
| eventstats sum(Visitors) as totalCount           
| eval percent=round(Visitors*100/totalCount,1)           
| fields - totalCount           
| sort "Days Since Last Session"
          </searchString>
        <option name="drilldown">none</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.text">Visitor</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Days</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
      </table>
    </panel>
  </row> -->
  <row>
    <table>
      <title>Page Conversion Participation</title>
      <searchString>source=webanalytics* $website$ event.goal.step="Final*" event.goal.name="$goal$"
| spath path=event.origin.id output=origin 
| spath path=event.id output=conversion  
| spath path=$visitor$ output=visitor
| stats list(origin) AS origin, list(conversion) AS conversion by visitor
| eval x=mvzip(origin,conversion) 
| mvexpand x 
| eval x = split(x,",") 
| eval Origin=mvindex(x,0) 
| eval Conversion=mvindex(x,1) 
| stats count by Origin Conversion       
| sort - count</searchString>
      <option name="drilldown">none</option>
    </table>
  </row>
  <row>
    <panel>
      <html>
      <h2>Customer Conversions</h2>
      <!-- Placeholder/container for the link switcher to appear -->
      <div class="link-switcher" data-items="link5,link6,link7">Select a view:<!--Links go here-->
      </div>
    </html>
      <chart id="link5">
        <title>Chart</title>
        <searchString>source=webanalytics* $website$ event.goal.step="Final*" event.goal.name="$goal$"   
| spath path=person.id.email.default.hashed output=personidemaildefault 
| spath path=event.origin.id output=origin 
| spath path=event.id output=conversion  
| spath path=$visitor$ output=visitor  
| stats list(origin) AS origin, list(conversion) AS conversion by visitor
| where isnotnull(personidemaildefault)             
| stats list(conversion) AS Conversion by visitor   
| stats count by Conversion       
| sort - count</searchString>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.text">Conversion Pages</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Page Views</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
      </chart>
      <table id="link6">
        <title>Table</title>
        <searchString>`webanalytics_web_data` $website$ 
| spath path=event.goal.step output=step
| spath path=event.id output=event_id
| spath path=event.goal.name output=goal_name
| spath path=$visitor$ output=visitor          
| spath path=person.id.email.default.hashed output=personidemaildefault    
| eval conversion=step.":".event_id
| transaction mvlist=t visitor
| search (eventcount&gt;1 AND step="Final*" AND goal_name="$goal$")
| stats values(conversion) AS "Conversion2", count AS Visits, sum(eventcount) AS "PageViews" by personidemaildefault
| where isnotnull(personidemaildefault)             
| rex field=Conversion2 "Final Step:(?&lt;Conversion&gt;.*)"
| eval PagesPerVisit=round((PageViews/Visits),2)            
| rename PagesPerVisit AS "Page Views / Visit", Email AS "Customer ID", PageViews AS "Page Views"
| table Conversion Visits "Page Views" "Page Views / Visit"</searchString>
        <option name="drilldown">none</option>
      </table>
      <chart id="link7">
        <title>Timechart</title>
        <searchString>source=webanalytics* $website$ event.goal.step="Final*" event.goal.name="$goal$"        
| spath path=event.id output=Conversion      
| spath path=person.id.email.default.hashed output=personidemaildefault 
| spath path=$visitor$ output=visitor           
| where isnotnull(personidemaildefault)             
| stats list(Conversion) AS Conversion by visitor _time 
| timechart $span_period$ count by Conversion</searchString>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Page Views</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>
</form>
