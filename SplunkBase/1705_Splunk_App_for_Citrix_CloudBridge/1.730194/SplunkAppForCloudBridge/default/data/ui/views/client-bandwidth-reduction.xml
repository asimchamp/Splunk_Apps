<?xml version='1.0' encoding='utf-8'?>
<form>
  <label>Client Bandwidth Reduction</label>
  
  <searchTemplate>

    index=cloudbridge  observationPointId="$observerId$" (TemplateName="256_INGRESS" OR TemplateName="257_EGRESS")  |
    stats count by sourceIPv4Address `CONNECTION` |
    join type=inner `CONNECTION` [
      search index=cloudbridge  observationPointId="$observerId$" TemplateName="604_ACCELERATED" |
      eval clearText = decompressionClearTextDeltaBytes + compressionClearTextDeltaBytes |
      eval cipherText = decompressionCipherTextDeltaBytes + compressionCipherTextDeltaBytes |
      stats sum(clearText) AS clearTextSum sum(cipherText) AS cipherTextSum BY `CONNECTION` |
      where clearTextSum > 0 AND cipherTextSum > 0
    ] |
    stats sum(clearTextSum) AS clearTextSumClient sum(cipherTextSum) AS cipherTextSumClient by sourceIPv4Address |
    eval dataReduction=clearTextSumClient - cipherTextSumClient |
    eval dataReduction_mb=dataReduction/1000000 |
    eval compressionRatio=round(clearTextSumClient / cipherTextSumClient, 2) 

  </searchTemplate>
  

  <fieldset autoRun="true">
    <input type="time">
      <default>Last 60 minutes</default>
    </input>
    <input type="dropdown" token="observerId">
       <label>Observer</label>
       <choice value="*">All</choice>
       <populatingSearch fieldForValue="observationPointId" fieldForLabel="Address">
           | inputlookup CloudBridgeObserver.csv
       </populatingSearch>
       <default>*</default>
    </input>
  </fieldset>
    
  <row>
    <chart>
      <title>Data Reduction By Top Clients</title>
      <searchPostProcess>eval p=round(dataReduction_mb,2)
                         | chart max(p) BY sourceIPv4Address
                         | sort -num(max(p)) 
                         | head 10
      </searchPostProcess>
      <option name="charting.chart">column</option>
      <option name="charting.axisTitleX.text">Client</option> 
      <option name="charting.axisTitleY.text">MB</option> 
      <option name="charting.legend.placement">none</option>
      <drilldown><link>/app/SplunkAppForCloudBridge/client-detail?form.sourceIPv4Address=$click.value$</link></drilldown>   
    </chart>
    
    <chart>
      <title>Compression Ratio By Top Clients</title>
      <searchPostProcess>chart max(compressionRatio) BY sourceIPv4Address
                             | sort -num(max(compressionRatio)) 
                             | head 10
      </searchPostProcess>
      <option name="charting.chart">column</option>      
      <option name="charting.legend.placement">none</option>
      <option name="charting.axisTitleX.text">Client</option> 
      <option name="charting.axisTitleY.text">Compression Ratio</option> 
      <option name="charting.legend.placement">none</option>
      <drilldown><link>/app/SplunkAppForCloudBridge/client-detail?form.sourceIPv4Address=$click.value$</link></drilldown>   
    </chart>
  </row>
  
  <row>
    <table>
      <title>Details By Client</title>
      <searchPostProcess>
	eval "Data Reduction"=`formatBytes(dataReduction)` |
	eval "Compression Ratio"=compressionRatio |
	table sourceIPv4Address "Data Reduction" "Compression Ratio"
        sort -num(compressionRatio)  
      </searchPostProcess>
      <drilldown><link>/app/SplunkAppForCloudBridge/client-detail?form.sourceIPv4Address=$click.value$</link></drilldown>   
    </table>
  </row>
</form>
