<?xml version='1.0' encoding='utf-8'?>
<form>
  <label>Partner Bandwidth Reduction</label>
  
  <searchTemplate>
    index=cloudbridge observationPointId="$observerId$" TemplateName="604_ACCELERATED"
    | eval clearText = decompressionClearTextDeltaBytes + compressionClearTextDeltaBytes 
    | eval cipherText = decompressionCipherTextDeltaBytes + compressionCipherTextDeltaBytes 
    | stats sum(clearText) AS sumClearText sum(cipherText) AS sumCipherText BY partnerCbInstanceId 
    | eval compressionRatio= round(sumClearText/sumCipherText, 2)
    | eval dataReduction=sumClearText-sumCipherText 
    | eval dataReduction_mb=dataReduction/1000000
      </searchTemplate>
  

  <fieldset autoRun="true">
    <input type="time">
      <default>Last 60 minutes</default>
    </input>
    <input type="dropdown" token="observerId">
       <label>Observer</label>
       <choice value="*">All</choice>
       <populatingSearch fieldForValue="observationPointId" fieldForLabel="Address">
           | inputlookup CloudBridgeObserver.csv
       </populatingSearch>
       <default>*</default>
    </input>
  </fieldset>
    
  <row>
    <chart>
      <title>Data Reduction By Top Partners</title>
      <searchPostProcess>|sort -num(max(dataReduction)) |chart max(dataReduction_mb) BY partnerCbInstanceId | head 10</searchPostProcess>
      <option name="charting.chart">column</option>
      <option name="charting.axisTitleX.text">Partner</option> 
      <option name="charting.axisTitleY.text">Data Reduction (Bytes)</option> 
      <option name="charting.legend.placement">none</option>
      <drilldown><link>/app/SplunkAppForCloudBridge/partner-detail?form.partnerCbInstanceId=$click.value$</link></drilldown>   
    </chart>
    
    <chart>
      <title>Compression Ratio By Top Partners</title>
      <searchPostProcess>  chart max(compressionRatio) BY partnerCbInstanceId 
                         | sort -num(compressionRatio) 
                         | head 10
      </searchPostProcess>
      <option name="charting.chart">column</option>      <option name="charting.legend.placement">none</option>
      <option name="charting.axisTitleX.text">Partner</option> 
      <option name="charting.axisTitleY.text">Compression Ratio</option> 
      <option name="charting.legend.placement">none</option>
      <drilldown><link>/app/SplunkAppForCloudBridge/partner-detail?form.partnerCbInstanceId=$click.value$</link></drilldown>   
    </chart>
  </row>
  
  <row>
    <table>
      <title>Details By Partner</title>
      <searchPostProcess>
          eval "Data Reduction"=`formatBytes(dataReduction)` 
        | eval "Partner IP"= partnerCbInstanceId 
        | eval "Compression Ratio"=compressionRatio 
        | table "Partner IP" "Data Reduction" "Compression Ratio"
        | sort -num(compressionRatio)  
      </searchPostProcess>
      <drilldown><link>/app/SplunkAppForCloudBridge/partner-detail?form.partnerCbInstanceId=$click.value$</link></drilldown>   
    </table>
  </row>
</form>
