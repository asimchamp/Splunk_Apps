<?xml version='1.0' encoding='utf-8'?>
<form>
  <label>Application Bandwidth Reduction</label>8
  
  <searchTemplate>
      index=cloudbridge  observationPointId="$observerId$" (TemplateName="256_INGRESS" OR TemplateName="257_EGRESS") 
    | stats count by appName `CONNECTION` 
    | join type=inner `CONNECTION` 
      [
          search index=cloudbridge  observationPointId="$observerId$" TemplateName="604_ACCELERATED" 
        | eval clearText = decompressionClearTextDeltaBytes + compressionClearTextDeltaBytes 
        | eval cipherText = decompressionCipherTextDeltaBytes + compressionCipherTextDeltaBytes 
        | stats sum(clearText) AS clearTextSum sum(cipherText) AS cipherTextSum BY `CONNECTION` 
        | where clearTextSum > 0 AND cipherTextSum > 0
      ]
    | stats sum(clearTextSum) AS clearTextSumApp sum(cipherTextSum) AS cipherTextSumApp values(appName) as appName by `CONNECTION`
    | `ICA_APP_NAME_FIX(appName)`
    | stats sum(clearTextSumApp) AS clearTextSumApp sum(cipherTextSumApp) AS cipherTextSumApp by appName
    | eval dataReduction=clearTextSumApp - cipherTextSumApp 
    | eval dataReduction_mb=dataReduction/1000000 
    | eval compressionRatio=round(clearTextSumApp / cipherTextSumApp, 2)
  </searchTemplate>
 
  <fieldset autoRun="true">
    <input type="time">
      <default>Last 60 minutes</default>
    </input>
    <input type="dropdown" token="observerId">
       <label>Observer</label>
       <choice value="*">All</choice>
       <populatingSearch fieldForValue="observationPointId" fieldForLabel="Address">
           | inputlookup CloudBridgeObserver.csv
       </populatingSearch>
       <default>*</default>
    </input>
  </fieldset>
  
  <row>
    <chart>
      <title>Data Reduction By Top Applications</title>
  
      <searchPostProcess>eval p=round(dataReduction_mb,2)
                         | chart max(p) BY appName
                         | sort -num(max(p)) 
                         | head 10
      </searchPostProcess>
      <option name="charting.chart">column</option>
      <option name="charting.axisTitleX.text">Application</option> 
      <option name="charting.axisTitleY.text">MB</option> 
      <option name="charting.legend.placement">none</option>
      <drilldown><link>/app/SplunkAppForCloudBridge/app-detail?form.appName=$click.value$</link></drilldown>   
    </chart>
    
    <chart>
      <title>Compression Ratio By Top Applications</title>
      <searchPostProcess>eval p=round(compressionRatio,2)
                         | chart max(p) BY appName
                         | sort -num(max(p)) 
                         | head 10 
      </searchPostProcess>
      <option name="charting.chart">column</option>      <option name="charting.legend.placement">none</option>
      <option name="charting.axisTitleX.text">Application</option> 
      <option name="charting.axisTitleY.text">Compression Ratio</option> 
      <option name="charting.legend.placement">none</option>
      <drilldown><link>/app/SplunkAppForCloudBridge/app-detail?form.appName=$click.value$</link></drilldown>   
    </chart>
  </row>
  
  <row>
    <table>
      <title>Details By Application</title>
      <searchPostProcess>
          eval "Data Reduction"=`formatBytes(dataReduction)` 
        | eval "Compression Ratio"=compressionRatio 
        | eval Application= appName 
        | table Application "Data Reduction" "Compression Ratio" 
        | sort -num(compressionRatio)  
      </searchPostProcess>
      <drilldown><link>/app/SplunkAppForCloudBridge/app-detail?form.appName=$click.value$</link></drilldown>   
    </table>
  </row>
  
</form>
