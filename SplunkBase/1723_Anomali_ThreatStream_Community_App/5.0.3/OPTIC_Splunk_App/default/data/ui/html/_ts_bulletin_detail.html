<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Bulletin Detail</title>
    <link rel="shortcut icon" href="{{SPLUNKWEB_URL_PREFIX}}/static/img/favicon.ico" />
        <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/build/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/build/pages/dashboard-simple-bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/OPTIC_Splunk_App/dashboard.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/OPTIC_Splunk_App/overview.css" />
</head>
<body class="simplexml preload locale-en">
<!--
BEGIN LAYOUT
This section contains the layout for the dashboard. Splunk uses proprietary
styles in <div> tags, similar to Bootstrap's grid system.
-->
<a class="navSkip" href="#navSkip" tabindex="1">Screen reader users, click here to skip the navigation bar</a>
<div class="header splunk-header">
        <div id="placeholder-splunk-bar">
            <a href="{{SPLUNKWEB_URL_PREFIX}}/app/launcher/home" class="brand" title="splunk &gt; listen to your data">splunk<strong>&gt;</strong></a>
        </div>
            <div id="placeholder-app-bar"></div>
</div>
<a id="navSkip"></a>
<div class="dashboard-body container-fluid main-section-body" data-role="main">
    <div class="dashboard-header clearfix" style="margin-bottom: 0;">
        <h2>Bulletin Detail</h2>
    </div>
	
	<div class="dashboard-row dashboard-row1">
      <div class="" style="overflow: auto; padding: 10px; padding-top: 0;">
        <div class="headerTop">
          <h3 id="bulletinName"></h3>
        </div>
        <div class="clearfix">
          <div class="topContainer">
            <div class="tabHeader">
              <span id="tsLink"></span>
            </div>
            <div class="topBody">
              <ul>
                <li>
                  <span class="listKey">Associated IOCs</span>
                  <span id ="ioccount" class="listValue"></span>
                </li>
                <li>
                  <span class="listKey">Tags</span>
                  <span id ="btags" class="listValue tags"></span>
                </li>
                <li>
                  <span class="listKey">Posted on</span>
                  <span class="postinfo listValue"></span>
                </li>
                <li>
                  <span class="listKey">Posted by</span>
                  <span class="postby listValue"></span>
                </li>
              </ul>
            </div>
          </div>
          <div class="topContainer">
            <div class="tabHeader">
              <span class="matchesLink"></span>
            </div>
            <div class="topBody">
              <ul>
                <li class="totalIocs">0</li>
                <li style="font-size:15px; display:block; text-align:center; padding-top:0;">Matches</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="tabContainer clearfix">
          <ul class="tabHeader">
            <li class="matchesHeader active">Matched IOCs</li>
            <li class="detailsHeader">Bulletin Details</li>
          </ul>
          <div class="tabs bblock matches">
            <div class="matchedIocs"></div>
          </div>
          <div class="tabs bblock details" style="display:none;">
            <div class="bodydetail"></div>
          </div>
        </div>
      </div>
    </div>

<!-- <div id="row1" class="dashboard-row dashboard-row1">
   <div class="" style="overflow: auto; padding: 10px;">
       	<div style="float:right; padding-top: 5px; ">Cloud IOC Matching&nbsp;<a href="#" class="toggler off">&nbsp;</a></div>
		<div id = "check_btn" style="float:right; margin-right: 50px;"><button type="button" style="" class="btn btn-primary">Scan Now</button></div>
        <h3 class="modal-title" style="font-size:20px;">
        	<span id="bulletinName" style="font-weight: bold; font-size: 15px;">No bulletin found.</span>
        </h3>
       	<div id = "check_info" style="display: none;">
           	<div class="bblock" id = "checked_summary" >Summary view</div>
           	<div class="bblock" id = "checked_view" ></div>
     	</div>
       	<div class="bblock">
        	<div style="font-size: 14px;">Tags: <span id ="ioccount" style="float: right;" ></span><span id ="btags"></span></div>
        	<div style="font-size: 14px; padding: 5px 0;" class="postinfo"></div>
        	<div class="bodydetail"></div>
       	</div>
    </div>
</div> -->
<div class="footer"></div>

<!--
END LAYOUT
-->

<script src="{{SPLUNKWEB_URL_PREFIX}}/config?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/i18n.js"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/i18ncatalog?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/app/OPTIC_Splunk_App/share/remarkable.js"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/build/simplexml.min/config.js"></script>
<script type="text/javascript">
// <![CDATA[
require.config({
	paths: {
    	cloudMatch: '../app/OPTIC_Splunk_App/cloudMatch'
    },
    baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
    waitSeconds: 0 // Disable require.js load timeout
});

//
// LIBRARY REQUIREMENTS
//
// In the require function, we include the necessary libraries and modules for
// the HTML dashboard. Then, we pass variable names for these libraries and
// modules as function parameters, in order.
//
// When you add libraries or modules, remember to retain this mapping order
// between the library or module and its function parameter. You can do this by
// adding to the end of these lists, as shown in the commented examples below.

require([
    "splunkjs/mvc",
    "splunkjs/mvc/utils",
    "splunkjs/mvc/tokenutils",
    "underscore",
    "jquery",
    "cloudMatch",
    "splunkjs/mvc/simplexml",
    "splunkjs/mvc/headerview",
    "splunkjs/mvc/footerview",
    "splunkjs/mvc/simplexml/dashboardview",
    "splunkjs/mvc/simplexml/dashboard/panelref",
    "splunkjs/mvc/simplexml/element/chart",
    "splunkjs/mvc/simplexml/element/event",
    "splunkjs/mvc/simplexml/element/html",
    "splunkjs/mvc/simplexml/element/list",
    "splunkjs/mvc/simplexml/element/map",
    "splunkjs/mvc/simplexml/element/single",
    "splunkjs/mvc/simplexml/element/table",
    "splunkjs/mvc/tableview",
    "splunkjs/mvc/simpleform/formutils",
    "splunkjs/mvc/simplexml/eventhandler",
    "splunkjs/mvc/simpleform/input/dropdown",
    "splunkjs/mvc/simpleform/input/radiogroup",
    "splunkjs/mvc/simpleform/input/multiselect",
    "splunkjs/mvc/simpleform/input/checkboxgroup",
    "splunkjs/mvc/simpleform/input/text",
    "splunkjs/mvc/simpleform/input/timerange",
    "splunkjs/mvc/simpleform/input/submit",
    "splunkjs/mvc/searchmanager",
    "splunkjs/mvc/savedsearchmanager",
    "splunkjs/mvc/postprocessmanager",
    "splunkjs/mvc/simplexml/urltokenmodel",
    "util/moment"
    // Add comma-separated libraries and modules manually here, for example:
    // ..."splunkjs/mvc/simplexml/urltokenmodel",
    // "splunkjs/mvc/tokenforwarder"
    ],
    function(
        mvc,
        utils,
        TokenUtils,
        _,
        $,
        cloudMatch,
        DashboardController,
        HeaderView,
        FooterView,
        Dashboard,
        PanelRef,
        ChartElement,
        EventElement,
        HtmlElement,
        ListElement,
        MapElement,
        SingleElement,
        TableElement,
        TableView,
        FormUtils,
        EventHandler,
        DropdownInput,
        RadioGroupInput,
        MultiSelectInput,
        CheckboxGroupInput,
        TextInput,
        TimeRangeInput,
        SubmitButton,
        SearchManager,
        SavedSearchManager,
        PostProcessManager,
        UrlTokenModel,
		moment
        // Add comma-separated parameter names here, for example:
        // ...UrlTokenModel,
        // TokenForwarder
        ) {

        var pageLoading = true;

		var basicUrl = "{{SPLUNKWEB_URL_PREFIX}}";
		var bid = Splunk.util.getParameter("bid");

        //test
        var remarkable = new Remarkable({
		  html:         true,        // Enable HTML tags in source
		  xhtmlOut:     true,        // Use '/' to close single tags (<br />)
		  breaks:       true,        // Convert '\n' in paragraphs into <br>
		  langPrefix:   'language-',  // CSS language prefix for fenced blocks
		  linkify:      true,        // Autoconvert URL-like text to links

		  // Enable some language-neutral replacement + quotes beautification
		  typographer:  false,

		  // Double + single quotes replacement pairs, when typographer enabled,
		  // and smartquotes on. Set doubles to '«»' for Russian, '„“' for German.
		  quotes: '“”‘’',

		  // Highlighter function. Should return escaped HTML,
		  // or '' if the source string is not changed
		  highlight: function (/*str, lang*/) { return ''; }
		});
		console.log(remarkable.render('# Remarkable rulezz!'));

        var ep = 'configs/conf-savedsearches/Generating and Uploading Summaries';
        var service = mvc.createService({ owner: "nobody" });

        function getCloudMatchStatus() {
        	service.get(ep, null, function(err, result) {
                 if (err) {
                 	console.warn('service.get error', err);
                 } else {
                	var isDisabled = result.data.entry[0].content.disabled;
 			    	console.log(isDisabled);
 			    	if(isDisabled) {
 			    		 $('a.toggler').addClass("off");
 			    	} else {
 			    		 $('a.toggler').removeClass("off");
 			    	}
                 }
        	})
        }

        function toggleCloudMatchStatus(flag) {
        	var record = {
        		"disabled": !flag,
        	};
        	var callback = function(err, response) {
                if (err) {
                    console.log('error while toggleSearch: ' + err);
                } else {
                    console.log('toggleSearch is successful');
                }
            };
        	service.request(ep, 'POST', null,  null, JSON.stringify(record), {
        		'Content-Type': 'application/json'
        	},  callback);
        }

        getCloudMatchStatus();

        $('a.toggler').click(function() {
        	var elem = $(this);
        	if(elem.hasClass("off")) {
        		cloudMatch.toggleCloudIOCMatch(true, function() {
        			elem.toggleClass('off');
        		});
        	} else {
        		cloudMatch.toggleCloudIOCMatch(false, function() {
        			elem.toggleClass('off');
        		});
        	}
            //$(this).toggleClass('off');
        });

		//check bulletin id
		var curr_name, curr_bid;
		if(bid) {
			curr_bid = bid;
			//_bsearch = "| inputlookup tm_tipreport | search id=" + bid + " | fields _time, name, owner_org_name, status, threat_actor, source, id, body, intelligence, tags";
			_bsearch = '| inputlookup tm_tipreport |search id=' + bid + ' | addinfo | eval info_max_time=if(info_max_time=="+Infinity", info_search_time, info_max_time) | where _time >= info_min_time AND _time <= info_max_time | sort - _time | fields _time, name, owner_org_name, id, body, intelligence, tags, endpoint, composition | rename id as Action, _time as Time, name as Name, owner_org_name as Author, endpoint as Type  | convert ctime(Time) | eval Type= if(Type=="breach", "Breaking News", if (composition=="nested", "Bulletin", "Threat Briefing")) | join type=outer Action [|inputlookup ts_ioc_matches | addinfo |  eval info_max_time=if(info_max_time=="+Infinity", info_search_time, info_max_time) | where _time >= info_min_time AND _time <= info_max_time | search ts_tb_id=*' + bid + '* | eval ts_tb_id=trim(split(ts_tb_id, ",")) | mvexpand ts_tb_id | stats dc(ts_lookup_key_value) as match_count by ts_tb_id | fillnull value=0 match_count | rename ts_tb_id as Action]';
			_timerange = "-2h@h";
			var infoSearch = new SearchManager({
		      "id": "_bsearch",
		      "status_buckets": 0,
		      "earliest_time": "0",
		      "latest_time": "now",
		      "search": _bsearch,
		      "cancelOnUnload": true,
		      "auto_cancel": 90,
		      "preview": true,
		      "runWhenTimeIsUndefined": true
			}, {tokens: true, tokenNamespace: "submitted"});

			var _results = infoSearch.data("results", {
				count: 100
			});

			_results.on("data", function() {
			    if (_results.hasData()) {
			        var data = _results.data(), rows = data.rows;
			        if(rows.length == 0) {
			        	return;
			        }
			        var row = rows[0];
		        	var bulletin = {
		        		time: row[0],
		        		name: row[1],
		        		owner_org_name: row[2] || "",
		        		id: row[3] || "",
		        		body: row[4] || "",
		        		intelligence: row[5] || "",
		        		tags: row[6] || "",
		        		scanned_result: row[10] || 0
		        	}
		        	//update page
		        	$("#bulletinName").html('"' + bulletin.name + '"');
		        	curr_name = bulletin.name;
		       		//tags
		       		var tagsArr = bulletin.tags.split(",") || [],
                  		tagsHtml = "";
		            tagsArr.forEach(function(tag) {
		            	if(tag) {
		                  	tagsHtml += "<span class='single-tag' title='"+tag+"'>"+tag+"</span>";
		                }
		            });
    			    $("#btags").html(tagsHtml);
    			    if(bulletin.tsLink) {
	   	                $("#tsLink").html("Open in ThreatStream");
	   	                $("#tsLink").on("click", function() {
	   	                    window.open(bulletin.tsLink);
	   	                });
	   	            }
		       		//ioc
		       		var iocs = bulletin.intelligence.split(",");
		       		var len = iocs.length;
		       		if(len == 1 && iocs[0] == "[]") {
		       			len = 0;
		       		}
		       		$("#ioccount").html(len);
		            $(".totalIocs").html(bulletin.scanned_result);
		            if(bulletin.scanned_result > 0) {
		                $('.matchesLink').html('Triage Matching Events');
		                var matchesUrl = basicUrl + "/app/OPTIC_Splunk_App/_ts_triage?bid=" + curr_bid;
		      			    $('.matchesLink').on('click', function() {
		                  window.open(matchesUrl,"_self");
		                });
		              }
		       		//posted
		       		$(".postinfo").html(bulletin.time ? moment(bulletin.time).format("MMM Do YYYY, HH:mm:ss Z") : "");
		            $(".postby").html(bulletin.owner_org_name);
		       		//body
		       		var bodyhtml = remarkable.render(bulletin.body);
		       		$(".bodydetail").html(bodyhtml);
		       		//check info
		        	toggleCheckView(true);
		        	if(len == 0) {
		       			$("#check_btn").hide();
		       		}
		        }
			});


			_results.on("error", function() {
				console.log("error");
			});



			//processBulletinCheck(bid);
		}
		
		// Matched IOCs table view
	    $(".tabHeader > li.matchesHeader").on("click", function() {
	      toggleTabs("matches");
	    });
	    $(".tabHeader > li.detailsHeader").on("click", function() {
	      toggleTabs("details");
	    });
	    function toggleTabs(tab) {
	      var matches = $(".tabs.matches"),
	          details = $(".tabs.details");
	      switch(tab){
	        case 'matches':
	          matches.show();
	          details.hide();
	          $(".tabHeader > li.matchesHeader").addClass('active');
	          $(".tabHeader > li.detailsHeader").removeClass('active');
	          break;
	        case 'details':
	          details.show();
	          matches.hide();
	          $(".tabHeader > li.matchesHeader").removeClass('active');
	          $(".tabHeader > li.detailsHeader").addClass('active');
	          break;
	        default:
	          break;
	      }
	    }

	 	// custom time cell renderer
	    var CustomTimeRenderer = TableView.BaseCellRenderer.extend({
	      canRender: function(cellData) {
	        return cellData.field === 'Time';
	      },
	      render: function ($td, cellData) {
	        var dt = moment.unix(+cellData.value).format("MMM Do YYYY, HH:mm:ss Z");
	        $td.html(dt);
	      }
	    });

		if(bid) {
			var _iSearch = '| inputlookup ts_ioc_matches | addinfo | eval info_max_time=if(info_max_time=="+Infinity", info_search_time, info_max_time) | where _time >= info_min_time AND _time <= info_max_time | search ts_tb_id=*'+ bid +'* | table _time, host, sourcetype, ts_victim,  ts_lookup_key_value, ts_itype, ts_confidence, ts_severity, count | foreach *  [eval <<FIELD>>=split(<<FIELD>>, ";")] '+
			               '| mvexpand ts_lookup_key_value | stats max(_time) as _time, values(ts_victim) as Victim, values(sourcetype) as Sourcetype, values(ts_itype) as iType, values(ts_confidence) as Confidence, values(ts_severity) as Severity, sum(count) as Occurrences by ts_lookup_key_value | rename ts_lookup_key_value as Indicator | table _time, Indicator, Victim, Sourcetype, iType, Confidence, Severity | rename _time as Time';
	        var _iocSearch = new SearchManager({
			      "id": "_iocSearch",
			      "status_buckets": 0,
			      "earliest_time": "0",
			      "latest_time": "now",
			      "search": _iSearch,
			      "cancelOnUnload": true,
			      "auto_cancel": 90,
			      "preview": true,
			      "runWhenTimeIsUndefined": true
				}, {tokens: true, tokenNamespace: "submitted"});

	        var ioc_table = new TableView({
	            id: "ioc-table",
	            managerid: "_iocSearch",
	            drilldown: "row",
	            dataOverlayMode: "none",
	            pageSize: "10",
	            el: $(".matchedIocs"),
	            wrap: true
	        });

	        ioc_table.addCellRenderer(new CustomTimeRenderer());
	        ioc_table.render();

	        ioc_table.on("click", emitDrilldown);

            function emitDrilldown(e) {
                e.preventDefault();
                var data = e.data;
                var prefix = Splunk.util.make_full_url("/") + "app/OPTIC_Splunk_App/";
                var query = "search?q=sourcetype=$row.Sourcetype$ $row.Indicator$ &earliest=$earliest$&latest=$latest$";
                var url = TokenUtils.replaceTokenNames(prefix + query, _.extend(submittedTokenModel.toJSON(), data), TokenUtils.getEscaper('url'));
                window.open(url, "_self");
            }

		}

		//button click to check status
        $("#check_btn").on("click", function() {
        	if(curr_bid) {
        		processBulletinCheck(curr_bid, curr_name);
        	}
        })

		function toggleCheckView(flag) {
        	if(flag) {
           		$("#check_btn").show();
           		$("#check_info").hide();
        	} else {
           		$("#check_btn").hide();
           		$("#check_info").show();
        	}
        }

        var searchMap = {};
        function processBulletinCheck(bid, name) {
        	toggleCheckView(false);
        	//loading
        	$("#checked_view").html("<div><i class='icon icon-rotate'></i>&nbsp;Waiting for check...</div>");
        	$("#checked_summary").html("<div><i class='icon icon-rotate'></i>&nbsp;Waiting for check...</div>");
			//start check
    		var _csearch = '| tstats count as event_count, min(_time) as start, max(_time) as end from datamodel=TS_Optic by sourcetype | join type=outer sourcetype [| `ts_find_tip_matches('+ bid +')` | stats sum(count) as match_count by sourcetype] | fillnull value=0 match_count | eval "First Event"=round(start) | eval "Last Event"=round(end) | convert ctime("First Event") | convert ctime("Last Event") | table sourcetype, "First Event", "Last Event", event_count, match_count';
			var sid = "_checksearch" + bid;
    		var checkSearch = searchMap[sid];
    		if(!checkSearch) {
    			checkSearch = new SearchManager({
    		      "id": sid,
    		      "status_buckets": 0,
    		      "search": _csearch,
    		      "cancelOnUnload": true,
    		      "auto_cancel": 90,
    		      "earliest_time": _timerange,
    		      "latest_time": "now",
    		      "preview": true,
    		      "runWhenTimeIsUndefined": true
    			}, {tokens: true, tokenNamespace: "submitted"});
    			searchMap[sid] = checkSearch;
    		}
    		var check_results = checkSearch.data("results", {
    			count: 100
    		});
    		check_results.on("data", function(evt) {
    			if (check_results.hasData()) {
    				var data = evt._data, rows = data.rows;
    				//summary
    				renderCheckSummary(name, rows);
 					//detail
    				var html = renderCheckResult(rows);
					$("#checked_view").html(html);
    			}
    		});

    		checkSearch.on("search:done", function(state, job) {
    			if (state.content.resultCount === 0) {
    				//alert("no results");
    				$("#checked_summary").html("No result found.");
    				$("#checked_view").html("No result found");
    			}
    		});

    		function renderCheckSummary(name, rows) {
    			var html = '<div class="btitle">Scan Summary: ' + name + '</div>';
    			var tmatch = 0, tevents = 0;
    			for(var i = 0; i < rows.length; i++) {
    				var row = rows[i];
    				tmatch += parseInt(row[4]);
    				tevents += parseInt(row[3]);
    			}
    			html += "<div style='text-align: center;padding: 30px 0;'>";
    			if(tmatch > 0) {
    				html += "<i class='icon icon-warning-sign' style='font-size: 90px;'></i>";
    	   			html += "</div>";
    	   			html += "<div class='bulletin-name-big'>Found " + tmatch + " IOC matches: " + name + ".</div>";
       			} else {
    				html += "<i class='icon icon-check' style='font-size: 90px;'></i>";
    				html += "</div>";
    	   			html += "<div class='bulletin-name-big'>NO threats identified: " + name + ".</div>";
    			}
    			html += "<div class='sinfo' style='text-align: center; font-size: 12px; padding: 5px;'>Scanned " + tevents + " events across " +  rows.length + " sources";
    			if(tmatch > 0) {
    				var url = basicUrl + "/app/OPTIC_Splunk_App/_ts_triage?bid=" + bid;
    			    var earliest_time = _timerange, latest_time = "now";
    			    url += "&earliest=" + earliest_time + "&latest=" + latest_time;
    				html += " See <a href='" + url + "'>event triage</a> for detail"
    			}
    			html += ".</div>";
    			$("#checked_summary").html(html);
    		}

    		function renderCheckResult(rows) {
    			var html = "<div class='btitle'>Scan Detail</div><br>";
    			html += "<table style='width: 100%;'>";
    			html += "<tr style='border-bottom:1px solid #ccc;text-align:left;'><th>Source Type</th><th># Scanned Records</th><th>First events</th><th>Last events</th><th>Status</th><th>Comments</th></tr>";
    			for(var i = 0; i < rows.length; i++) {
    				var row = rows[i];
    				var mcount = row[4];
    				html += "<tr><td>" + row[0] + "</td>";
    				html += "<td>" + row[3] + "</td>";
    				html += "<td>" + row[1] + "</td>";
    				html += "<td>" + row[2] + "</td>";
    				if(mcount > 0) {
    					html += "<td><i class='icon icon-warning-sign'></i></td>";
    				} else {
    					html += "<td><i class='icon icon-check'></i></td>";
    				}
    				var comments = "Scan complete";
    				if(mcount > 0) {
    					comments = "Found "  + mcount + " events"
    				}
    				html += "<td>" + comments + "</td>";
    			}
    			return html;
    		}

			//
			//checkSearch.startSearch();

        }
        //
        // TOKENS
        //

        // Create token namespaces
        var urlTokenModel = new UrlTokenModel();
        mvc.Components.registerInstance('url', urlTokenModel);
        var defaultTokenModel = mvc.Components.getInstance('default', {create: true});
        var submittedTokenModel = mvc.Components.getInstance('submitted', {create: true});

        urlTokenModel.on('url:navigate', function() {
            defaultTokenModel.set(urlTokenModel.toJSON());
            if (!_.isEmpty(urlTokenModel.toJSON()) && !_.all(urlTokenModel.toJSON(), _.isUndefined)) {
                submitTokens();
            } else {
                submittedTokenModel.clear();
            }
        });

        // Initialize tokens
        defaultTokenModel.set(urlTokenModel.toJSON());

        function submitTokens() {
            // Copy the contents of the defaultTokenModel to the submittedTokenModel and urlTokenModel
            FormUtils.submitForm({ replaceState: pageLoading });
        }

        function setToken(name, value) {
            defaultTokenModel.set(name, value);
            submittedTokenModel.set(name, value);
        }

        function unsetToken(name) {
            defaultTokenModel.unset(name);
            submittedTokenModel.unset(name);
        }



        //
        // SEARCH MANAGERS
        //



        //
        // SPLUNK HEADER AND FOOTER
        //

        new HeaderView({
            id: 'header',
            section: 'dashboards',
            el: $('.header'),
            acceleratedAppNav: true,
            useSessionStorageCache: true,
            splunkbar: true,
            appbar: true,
            litebar: false,
        }, {tokens: true}).render();

        new FooterView({
            id: 'footer',
            el: $('.footer')
        }, {tokens: true}).render();


        //
        // DASHBOARD EDITOR
        //

        new Dashboard({
            id: 'dashboard',
            el: $('.dashboard-body'),
            showTitle: false,
            editable: true
        }, {tokens: true}).render();


        //
        // VIEWS: VISUALIZATION ELEMENTS
        //

        var element1 = new HtmlElement({
            "id": "element1",
            "useTokens": true,
            "el": $('#element1')
        }, {tokens: true, tokenNamespace: "submitted"}).render();

        DashboardController.addReadyDep(element1.contentLoaded());

        // Initialize time tokens to default
        if (!defaultTokenModel.has('earliest') && !defaultTokenModel.has('latest')) {
            defaultTokenModel.set({ earliest: '0', latest: '' });
        }

        submitTokens();


        //
        // DASHBOARD READY
        //

        DashboardController.ready();
        pageLoading = false;

        document.title = "Bulletin Detail";

    }
);
// ]]>
</script>
</body>
</html>