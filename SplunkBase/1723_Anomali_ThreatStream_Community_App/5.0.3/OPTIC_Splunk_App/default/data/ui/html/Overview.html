<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Overview</title>
    <link rel="shortcut icon" href="{{SPLUNKWEB_URL_PREFIX}}/static/img/favicon.ico" />
        <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/build/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/build/pages/dashboard-simple-bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/OPTIC_Splunk_App/dashboard.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/OPTIC_Splunk_App/overview.css" />
</head>
<body class="simplexml preload locale-en">
<!--
BEGIN LAYOUT
This section contains the layout for the dashboard. Splunk uses proprietary
styles in <div> tags, similar to Bootstrap's grid system.
-->
<a class="navSkip" href="#navSkip" tabindex="1">Screen reader users, click here to skip the navigation bar</a>
<div class="header splunk-header">
        <div id="placeholder-splunk-bar">
            <a href="{{SPLUNKWEB_URL_PREFIX}}/app/launcher/home" class="brand" title="splunk &gt; listen to your data">splunk<strong>&gt;</strong></a>
        </div>
            <div id="placeholder-app-bar"></div>
</div>
<a id="navSkip"></a>
<div class="dashboard-body container-fluid main-section-body" data-role="main">
    <div class="dashboard-header clearfix">
        <h2>Overview - Latest Threat Intelligence Briefing</h2>
    </div>


    <div id="row1" class="dashboard-row dashboard-row1">
	   <div class="" style="overflow: auto; padding: 10px;">
            <div style="float:right; padding-top: 5px; ">Cloud IOC Matching&nbsp;<a href="#" class="toggler off">&nbsp;</a></div>
	   		<div id = "check_btn" style="float:right; margin-right: 50px;"><button type="button" style="" class="btn btn-primary">Scan Now</button></div>
            <h3 class="modal-title" style="font-size:20px;">
            	<span id="bulletinName" style="font-weight: bold; font-size: 15px;">&nbsp;</span>
            </h3>
        	<div id = "check_info" style="display: none;">
            	<div class="bblock" id = "checked_summary" >Summary view</div>
            	<div class="bblock" id = "checked_view" ></div>
            </div>
        	<div class="bblock">
         		<div style="font-size: 14px;">Tags: <span id ="ioccount" style="float: right;" ></span><span id ="btags"></span></div>
         		<div style="font-size: 14px; padding: 5px 0;" class="postinfo"></div>
         		<div class="bodydetail"></div>
        	</div>
    	</div>
	</div>


<form name="actionControl" action="/en-US/manager/OPTIC_Splunk_App/saved/searches/multidelete" method="post">
		 <input type="hidden" name="splunk_form_key" value="685911503002287131" />
         <input type="hidden" name="ctrl" id="ctrl" value="enable"/>
         <input type="hidden" name="ctrl_link" id="ctrl_link" value="/servicesNS/admin/OPTIC_Splunk_App/saved/searches/Generating%20IOC%20Matches%20By%20Src/enable"/>
         <input type="hidden" name="ctrl_name" id="ctrl_name" value="Generating IOC Matches By Src"/>
         <input type="hidden" name="showAppContext" id="showAppContext" value="True"/>
         <input type="hidden" name="app_only" value="True"/>
</form>

<div class="footer"></div>

<!--
END LAYOUT
-->

<script src="{{SPLUNKWEB_URL_PREFIX}}/config?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/i18n.js"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/i18ncatalog?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/app/OPTIC_Splunk_App/share/remarkable.js"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/build/simplexml.min/config.js"></script>
<script type="text/javascript">
// <![CDATA[
require.config({
	paths: {
    	cloudMatch: '../app/OPTIC_Splunk_App/cloudMatch'
    },
    baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
    waitSeconds: 0 // Disable require.js load timeout
});

//
// LIBRARY REQUIREMENTS
//
// In the require function, we include the necessary libraries and modules for
// the HTML dashboard. Then, we pass variable names for these libraries and
// modules as function parameters, in order.
//
// When you add libraries or modules, remember to retain this mapping order
// between the library or module and its function parameter. You can do this by
// adding to the end of these lists, as shown in the commented examples below.

require([
    "splunkjs/mvc",
    "splunkjs/mvc/utils",
    "splunkjs/mvc/tokenutils",
    "underscore",
    "jquery",
    "cloudMatch",
    "splunkjs/mvc/simplexml",
    "splunkjs/mvc/headerview",
    "splunkjs/mvc/footerview",
    "splunkjs/mvc/simplexml/dashboardview",
    "splunkjs/mvc/simplexml/dashboard/panelref",
    "splunkjs/mvc/simplexml/element/chart",
    "splunkjs/mvc/simplexml/element/event",
    "splunkjs/mvc/simplexml/element/html",
    "splunkjs/mvc/simplexml/element/list",
    "splunkjs/mvc/simplexml/element/map",
    "splunkjs/mvc/simplexml/element/single",
    "splunkjs/mvc/simplexml/element/table",
    "splunkjs/mvc/simpleform/formutils",
    "splunkjs/mvc/simplexml/eventhandler",
    "splunkjs/mvc/simplexml/searcheventhandler",
    "splunkjs/mvc/simpleform/input/dropdown",
    "splunkjs/mvc/simpleform/input/radiogroup",
    "splunkjs/mvc/simpleform/input/linklist",
    "splunkjs/mvc/simpleform/input/multiselect",
    "splunkjs/mvc/simpleform/input/checkboxgroup",
    "splunkjs/mvc/simpleform/input/text",
    "splunkjs/mvc/simpleform/input/timerange",
    "splunkjs/mvc/simpleform/input/submit",
    "splunkjs/mvc/searchmanager",
    "splunkjs/mvc/savedsearchmanager",
    "splunkjs/mvc/postprocessmanager",
    "splunkjs/mvc/simplexml/urltokenmodel"
    // Add comma-separated libraries and modules manually here, for example:
    // ..."splunkjs/mvc/simplexml/urltokenmodel",
    // "splunkjs/mvc/tokenforwarder"
    ],
    function(
        mvc,
        utils,
        TokenUtils,
        _,
        $,
        cloudMatch,
        DashboardController,
        HeaderView,
        FooterView,
        Dashboard,
        PanelRef,
        ChartElement,
        EventElement,
        HtmlElement,
        ListElement,
        MapElement,
        SingleElement,
        TableElement,
        FormUtils,
        EventHandler,
        SearchEventHandler,
        DropdownInput,
        RadioGroupInput,
        LinkListInput,
        MultiSelectInput,
        CheckboxGroupInput,
        TextInput,
        TimeRangeInput,
        SubmitButton,
        SearchManager,
        SavedSearchManager,
        PostProcessManager,
        UrlTokenModel

        // Add comma-separated parameter names here, for example:
        // ...UrlTokenModel,
        // TokenForwarder
        ) {

        var pageLoading = true;

		var basicUrl = "{{SPLUNKWEB_URL_PREFIX}}";
		var bid = Splunk.util.getParameter("bid");
		console.log(cloudMatch);

        //test
        var remarkable = new Remarkable({
		  html:         true,        // Enable HTML tags in source
		  xhtmlOut:     true,        // Use '/' to close single tags (<br />)
		  breaks:       true,        // Convert '\n' in paragraphs into <br>
		  langPrefix:   'language-',  // CSS language prefix for fenced blocks
		  linkify:      true,        // Autoconvert URL-like text to links

		  // Enable some language-neutral replacement + quotes beautification
		  typographer:  false,

		  // Double + single quotes replacement pairs, when typographer enabled,
		  // and smartquotes on. Set doubles to '«»' for Russian, '„“' for German.
		  quotes: '“”‘’',

		  // Highlighter function. Should return escaped HTML,
		  // or '' if the source string is not changed
		  highlight: function (/*str, lang*/) { return ''; }
		});

		console.log(remarkable.render('# Remarkable rulezz!'));

        var ep = 'configs/conf-savedsearches/Generating and Uploading Summaries';
        var service = mvc.createService({ owner: "nobody" });

        function getCloudMatchStatus() {
        	service.get(ep, null, function(err, result) {
                 if (err) {
                 	console.warn('service.get error', err);
                 } else {
                	var isDisabled = result.data.entry[0].content.disabled;
 			    	console.log(isDisabled);
 			    	if(isDisabled) {
 			    		 $('a.toggler').addClass("off");
 			    	} else {
 			    		 $('a.toggler').removeClass("off");
 			    	}
                 }
        	})
        }

        function toggleCloudMatchStatus(flag) {
        	var record = {
        		"disabled": !flag,
        	};
        	var callback = function(err, response) {
                if (err) {
                    console.log('error while toggleSearch: ' + err);
                } else {
                console.log('toggleSearch is successful');
                }
            };
        	service.request(ep, 'POST', null,  null, JSON.stringify(record), {
        		'Content-Type': 'application/json'
        	},  callback);
        }

        //set init status
        getCloudMatchStatus();


        $('a.toggler').click(function() {
        	var elem = $(this);
        	if(elem.hasClass("off")) {
        		cloudMatch.toggleCloudIOCMatch(true, function() {
        			elem.toggleClass('off');
        		});
        	} else {
        		cloudMatch.toggleCloudIOCMatch(false, function() {
        			elem.toggleClass('off');
        		});
        	}
            //$(this).toggleClass('off');
        });

        //check bulletin id
		var curr_name, curr_bid;
		_bsearch = "| inputlookup tm_tipreport | fields _time, name, owner_org_name, status, threat_actor, source, id, body, intelligence, tags | sort - _time";
		_timerange = "-2h@h";
		var infoSearch = new SearchManager({
	      "id": "_bsearch",
	      "status_buckets": 0,
	      "earliest_time": _timerange,
	      "latest_time": "now",
	      "search": _bsearch,
	      "cancelOnUnload": true,
	      "auto_cancel": 90,
	      "preview": true,
	      "runWhenTimeIsUndefined": true
		}, {tokens: true, tokenNamespace: "submitted"});

		var _results = infoSearch.data("results", {
			count: 100
		});

		_results.on("data", function() {
		    if (_results.hasData()) {
		        var data = _results.data(), rows = data.rows;
		        if(rows.length == 0) {
		        	return;
		        }
		        var row = rows[0];
	        	var bulletin = {
	        		time: row[0],
	        		name: row[1],
	        		owner_org_name: row[2] || "",
	        		status: row[3] || "",
	        		threat_actor: row[4] || "",
	        		id: row[6] || "",
	        		body: row[7] || "",
	        		intelligence: row[8] || "",
	        		tags: row[9] || ""
	        	}
				curr_bid = bulletin.id;
	        	curr_name = bulletin.name;

	        	//update page
	        	$("#bulletinName").html('"' + bulletin.name + '"');
	       		//tags
	       		$("#btags").html(bulletin.tags);
	       		//ioc
	       		var iocs = bulletin.intelligence.split(",");
	       		var len = iocs.length;
	       		if(len == 1 && iocs[0] == "[]") {
	       			len = 0;
	       		}
	       		var iocs_line = "Associated IOCs: " + len;
	       		$("#ioccount").html(iocs_line);
	       		//posted
	       		var posted_line = "Posted on " + bulletin.time + " by " + bulletin.owner_org_name;
	       		$(".postinfo").html(posted_line);
	       		//body
	       		var bodyhtml = remarkable.render(bulletin.body);
	       		$(".bodydetail").html(bodyhtml);
	       		//check info
	        	toggleCheckView(true);
	       		if(len == 0) {
	       			$("#check_btn").hide();
	       		}
		    }
		});


		_results.on("error", function() {
			console.log("error");
		});


		//button click to check status
        $("#check_btn").on("click", function() {
        	if(curr_bid) {
        		processBulletinCheck(curr_bid, curr_name);
        	}
        })

		function toggleCheckView(flag) {
        	if(flag) {
           		$("#check_btn").show();
           		$("#check_info").hide();
        	} else {
           		$("#check_btn").hide();
           		$("#check_info").show();
        	}
        }

        var searchMap = {};
        function processBulletinCheck(bid, name) {
        	toggleCheckView(false);
        	//loading
        	$("#checked_view").html("<div><i class='icon icon-rotate'></i>&nbsp;Waiting for check...</div>");
        	$("#checked_summary").html("<div><i class='icon icon-rotate'></i>&nbsp;Waiting for check...</div>");
			//start check
            //var _csearch = '| tstats count as event_count, min(_time) as start, max(_time) as end from datamodel=TS_Optic by sourcetype | eval "First Event"= round(start) | eval "Last Event" = round(end) | join type=outer sourcetype [|inputlookup ts_ioc_matches| addinfo | eval info_max_time=if(info_max_time=="+Infinity", info_search_time, info_max_time) | where _time >= info_min_time AND _time <= info_max_time | search ts_tb_id=' + bid + ' | stats count as match_count by sourcetype] | fillnull value=0 match_count | convert ctime("First Event") | convert ctime("Last Event")| table sourcetype, "First Event", "Last Event", event_count, match_count';
            var _csearch = '| tstats count as event_count, min(_time) as start, max(_time) as end from datamodel=TS_Optic by sourcetype | join type=outer sourcetype [| `ts_find_tip_matches('+ bid +')` | stats sum(count) as match_count by sourcetype] | fillnull value=0 match_count | eval "First Event"=round(start) | eval "Last Event"=round(end) | convert ctime("First Event") | convert ctime("Last Event") | table sourcetype, "First Event", "Last Event", event_count, match_count';
            var sid = "_checksearch" + bid;
    		var checkSearch = searchMap[sid];
    		if(!checkSearch) {
    			checkSearch = new SearchManager({
    		      "id": sid,
    		      "status_buckets": 0,
    		      "search": _csearch,
    		      "cancelOnUnload": true,
    		      "auto_cancel": 90,
    		      "earliest_time": _timerange,
    		      "latest_time": "now",
    		      "preview": true,
    		      "runWhenTimeIsUndefined": true
    			}, {tokens: true, tokenNamespace: "submitted"});
    			searchMap[sid] = checkSearch;
    		}
    		var check_results = checkSearch.data("results", {
    			count: 100
    		});
    		check_results.on("data", function(evt) {
    			if (check_results.hasData()) {
    				var data = evt._data, rows = data.rows;
    				//summary
    				renderCheckSummary(name, rows);
 					//detail
    				var html = renderCheckResult(rows);
					$("#checked_view").html(html);
    			}
    		});

    		checkSearch.on("search:done", function(state, job) {
    			if (state.content.resultCount === 0) {
    				//alert("no results");
    				$("#checked_summary").html("No result found.");
    				$("#checked_view").html("No result found");
    			}
    		});

    		function renderCheckSummary(name, rows) {
    			var html = '<div class="btitle">Scan Summary: ' + name + '</div>';
    			var tmatch = 0, tevents = 0;
    			for(var i = 0; i < rows.length; i++) {
    				var row = rows[i];
    				tmatch += parseInt(row[4]);
    				tevents += parseInt(row[3]);
    			}
    			html += "<div style='text-align: center;padding: 30px 0;'>";
    			if(tmatch > 0) {
    				html += "<i class='icon icon-warning-sign' style='font-size: 90px;'></i>";
    	   			html += "</div>";
    	   			html += "<div class='bulletin-name-big'>Found " + tmatch + " IOC matches: " + name + ".</div>";
       			} else {
    				html += "<i class='icon icon-check' style='font-size: 90px;'></i>";
    				html += "</div>";
    	   			html += "<div class='bulletin-name-big'>NO threats identified: " + name + ".</div>";
    			}
    			html += "<div class='sinfo' style='text-align: center; font-size: 12px; padding: 5px;'>Scanned " + tevents + " events across " +  rows.length + " sources";
    			if(tmatch > 0) {
    				var url = basicUrl + "/app/OPTIC_Splunk_App/_ts_triage?bid=" + bid;
    			    var earliest_time = _timerange, latest_time = "now";
    			    url += "&earliest=" + earliest_time + "&latest=" + latest_time;
    				html += " See <a href='" + url + "'>event triage</a> for detail"
    			}
    			html += ".</div>";
    			$("#checked_summary").html(html);
    		}

    		function renderCheckResult(rows) {
    			var html = "<div class='btitle'>Scan Detail</div><br>";
    			html += "<table style='width: 100%;'>";
    			html += "<tr style='border-bottom:1px solid #ccc;text-align:left;'><th>Source Type</th><th># Scanned Records</th><th>First events</th><th>Last events</th><th>Status</th><th>Comments</th></tr>";
    			for(var i = 0; i < rows.length; i++) {
    				var row = rows[i];
    				var mcount = row[4];
    				html += "<tr><td>" + row[0] + "</td>";
    				html += "<td>" + row[3] + "</td>";
    				html += "<td>" + row[1] + "</td>";
    				html += "<td>" + row[2] + "</td>";
    				if(mcount > 0) {
    					html += "<td><i class='icon icon-warning-sign'></i></td>";
    				} else {
    					html += "<td><i class='icon icon-check'></i></td>";
    				}
    				var comments = "Scan complete";
    				if(mcount > 0) {
    					comments = "Found "  + mcount + " events"
    				}
    				html += "<td>" + comments + "</td>";
    			}
    			return html;
    		}

			//
			//checkSearch.startSearch();

        }

        //
        // TOKENS
        //

        // Create token namespaces
        var urlTokenModel = new UrlTokenModel();
        mvc.Components.registerInstance('url', urlTokenModel);
        var defaultTokenModel = mvc.Components.getInstance('default', {create: true});
        var submittedTokenModel = mvc.Components.getInstance('submitted', {create: true});

        urlTokenModel.on('url:navigate', function() {
            defaultTokenModel.set(urlTokenModel.toJSON());
            if (!_.isEmpty(urlTokenModel.toJSON()) && !_.all(urlTokenModel.toJSON(), _.isUndefined)) {
                submitTokens();
            } else {
                submittedTokenModel.clear();
            }
        });

        // Initialize tokens
        defaultTokenModel.set(urlTokenModel.toJSON());

        function submitTokens() {
            // Copy the contents of the defaultTokenModel to the submittedTokenModel and urlTokenModel
            FormUtils.submitForm({ replaceState: pageLoading });
        }

        function setToken(name, value) {
            defaultTokenModel.set(name, value);
            submittedTokenModel.set(name, value);
        }

        function unsetToken(name) {
            defaultTokenModel.unset(name);
            submittedTokenModel.unset(name);
        }



        //
        // SEARCH MANAGERS
        //



        //
        // SPLUNK HEADER AND FOOTER
        //

        new HeaderView({
            id: 'header',
            section: 'dashboards',
            el: $('.header'),
            acceleratedAppNav: true,
            useSessionStorageCache: true,
            splunkbar: true,
            appbar: true,
            litebar: false,
        }, {tokens: true}).render();

        new FooterView({
            id: 'footer',
            el: $('.footer')
        }, {tokens: true}).render();


        //
        // DASHBOARD EDITOR
        //

        new Dashboard({
            id: 'dashboard',
            el: $('.dashboard-body'),
            showTitle: true,
            editable: true
        }, {tokens: true}).render();


        //
        // VIEWS: VISUALIZATION ELEMENTS
        //

        var element1 = new HtmlElement({
            "id": "element1",
            "useTokens": true,
            "el": $('#element1')
        }, {tokens: true, tokenNamespace: "submitted"}).render();

        DashboardController.addReadyDep(element1.contentLoaded());

        // Initialize time tokens to default
        if (!defaultTokenModel.has('earliest') && !defaultTokenModel.has('latest')) {
            defaultTokenModel.set({ earliest: '0', latest: '' });
        }

        submitTokens();


        //
        // DASHBOARD READY
        //

        DashboardController.ready();
        pageLoading = false;

    }
);
// ]]>
</script>
</body>
</html>