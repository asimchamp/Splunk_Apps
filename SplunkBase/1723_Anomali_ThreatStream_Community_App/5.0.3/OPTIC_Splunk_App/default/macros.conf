[_tsi_all]
definition = inputlookup tsi_ip | inputlookup append=t tsi_domain | inputlookup append=t tsi_md5 | inputlookup append=t tsi_url | inputlookup append=t tsi_email
iseval = 0

[ts_inputlookup_all]
definition = inputlookup ts_lookup_srcip | inputlookup append=t ts_lookup_domain | inputlookup append=t ts_lookup_md5 | inputlookup append=t ts_lookup_url | inputlookup append=t ts_lookup_email

[ts_network(1)]
args = constraints
definition = tstats local=false count from datamodel=TS_Optic where TS_Optic.src!= "unknown" AND TS_Optic.dest!="unknown" by _time, sourcetype, host, TS_Optic.src, TS_Optic.src_port, TS_Optic.dest, TS_Optic.dest_port, TS_Optic.action span=10m | rename TS_Optic.* as * | search ((src!= 192.168.0.0/16 src!=10.0.0.0/8 src!=172.16.0.0/12) OR (dest!=10.0.0.0/8  dest!=192.168.0.0/16 dest!=172.16.0.0/12)) | rename _time as event_time | table event_time, sourcetype, host, src, src_port, dest, dest_port, action, count | outputcsv src_dest_summary.csv

[ts_web(1)]
args = constraints
definition = tstats local=false count from datamodel=TS_Optic where TS_Optic.url!="unknown" by _time, TS_Optic.src, TS_Optic.dest, TS_Optic.action, TS_Optic.url, sourcetype, host span=10m | rename TS_Optic.* as * | search ((src!= 192.168.0.0/16 src!=10.0.0.0/8 src!=172.16.0.0/12) OR (dest!=10.0.0.0/8  dest!=192.168.0.0/16 dest!=172.16.0.0/12)) | eval url=substr(url, 1, 1024) | rename _time as event_time | table event_time, sourcetype, host, src, dest, action, url, count | outputcsv url_summary.csv

[ts_filehash(1)]
args = constraints
definition = tstats local=false count from datamodel=TS_Optic where TS_Optic.file_hash!="unknown" by _time, TS_Optic.src, TS_Optic.file_hash, TS_Optic.file_name, sourcetype, host span=10m | rename TS_Optic.src as src | rename TS_Optic.file_hash as file_hash | rename TS_Optic.file_name as file_name | rename _time as event_time | table event_time, sourcetype, host, src, file_hash, file_name, count | outputcsv filehash_summary.csv

[ts_email(1)]
args = constraints
definition = tstats local=false count from datamodel=TS_Optic by _time, TS_Optic.recipient, TS_Optic.src_user, sourcetype, host span=10m | rename TS_Optic.src_user as sender | rename TS_Optic.recipient as receiver | rename _time as event_time | table event_time, sourcetype, host, sender, receiver, count | outputcsv email_summary.csv

[ts_find_ioc_matches]
definition = `_ts_dm` | appendpipe [| `ts_collect_scan_stats`] | `_ts_joiniocs` |search id=* |`_ts_fields` |`_ts_rename_fields` | eval status="new" | eval ts_tb_id=replace(ts_tb_id, "(^\[)|(\]$)", "")

[ts_find_tip_matches(1)]
args	= tm_id
definition = `ts_find_tm_matches("tipreport", $tm_id$)` | `_ts_fields` |`_ts_rename_fields` | eval status="new" | eval ts_tb_id=replace(ts_tb_id, "(^\[)|(\]$)", "") | outputlookup append=true ts_ioc_matches

[ts_find_tm_matches(2)]
args	= tm_name,tm_id
definition = `_ts_dm` | `_ts_joiniocs` | search id=* | `_ts_fields` | `_ts_extract_tm_ids_in_ioc($tm_name$)` | eval filtered_ids = mvfilter(ids=$tm_id$) | search filtered_ids=* | fields - filtered_ids,ids

[ts_collect_scan_stats]
definition = stats sum(count) as scan_count, min(_time) as first_et, max(_time) as last_et by sourcetype | addinfo | eval _time=info_min_time | eval first_et=round(first_et) | eval last_et=round(last_et) | table _time, sourcetype, first_et, last_et, scan_count | outputlookup append=true ts_scan_stats
iseval = 0

################################
#sub-macros
################################
[_ts_dm]
definition = tstats count from datamodel=TS_Optic by sourcetype, host, source, TS_Optic.src, TS_Optic.dest, TS_Optic.url, TS_Optic.file_hash, TS_Optic.src_user, TS_Optic.recipient, _time span=10m| rename source as event_source | rename TS_Optic.* as * | eval victim = "unknown"  

[_ts_joiniocs]
definition = `_ts_j("src","tsi_ip","dest")` | `_ts_j("dest","tsi_ip", "src")` | `_ts_j("src","tsi_domain","dest")` | `_ts_j("dest","tsi_domain", "src")` | `_ts_j("url","tsi_url", "src")` | `_ts_j("file_hash","tsi_md5", "src")` | `_ts_j("src_user","tsi_email", "recipient")` 

[_ts_j(3)]
args	= field,iocs,victim
definition = join type=left $field$ [inputlookup $iocs$| eval $field$=lookup_key_value] | eval victim=if(victim == "unknown", $victim$, victim)

[_ts_fields] 
definition = fields _time, count, src, dest, url, file_hash, src_user, recipient, actor, compaign, tipreport, sourcetype, event_source, host, asn, classification, confidence, country, date_first, date_last, itype, type, lat, lon, maltype, org, severity, source, lookup_key_value, id, detail, resource_uri, victim



[_ts_rename_fields] 
definition = rename * as ts_* | rename ts__time as _time | rename ts_count as count | rename ts_sourcetype as sourcetype | rename ts_event_source as source | rename ts_host as host | rename ts_src as src | rename ts_dest as dest | rename ts_url as url | rename ts_file_hash as file_hash | rename ts_src_user as src_user | rename ts_recipient as recipient | rename ts_tipreport as ts_tb_id | rename ts_actor as ts_actor_id

[_ts_extract_tm_ids_in_ioc(1)]
args	= tm_name
definition = eval m = trim($tm_name$, "]") | eval n = substr(m, 2) | eval ids = split(n,",") | fields - m, n | mvexpand ids


