{% extends "splunkdj:base_with_app_bar.html" %}

{% load splunkmvc %}

{% block title %}Watchlist {% endblock title %}

{% block css %}
<style type="text/css" media="screen">
* {
  border-color: #ccc;
}
a.delete_object_link {
  cursor: pointer;
  text-decoration: none;
  color: #CCC;
  font-size: 1.4em;
}
a.delete_object_link:hover,
a.delete_object_link:focus {
  color: #555;
  text-decoration: none;
}

.ManagerBar {
  clear: both;
  color: rgb(51, 51, 51);
  display: block;
  font-family: Roboto, Droid, 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 1em;
  height: 24px;
  overflow-x: hidden;
  overflow-y: hidden;
  padding-bottom: 15px;
  padding-left: 20px;
  padding-right: 20px;
  padding-top: 15px;
  zoom: 1;
}
h1.ManagerPageTitle {
  color: rgb(51, 51, 51);
  display: block;
  font-family: Roboto, Droid, 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 24px;
  font-weight: 200;
  height: 24px;
  line-height: 24px;
  margin-bottom: 0px;
  margin-left: 0px;
  margin-right: 0px;
  margin-top: 0px;
  width: 1534px;
  zoom: 1;  
}
.adminContent {
  clear: both;
  color: rgb(51, 51, 51);
  display: block;
  font-family: Roboto, Droid, 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 1em;
  min-height: 400px;
}
div.dataInputsWrapper {
  -webkit-background-clip: border-box;
  -webkit-background-origin: padding-box;
  -webkit-background-size: auto;
  background-attachment: scroll;
  background-clip: border-box;
  background-color: rgb(255, 255, 255);
  background-image: none;
  background-origin: padding-box;
  background-size: auto;
  border-bottom-color: rgb(204, 204, 204);
  border-left-color: rgb(204, 204, 204);
  border-right-color: rgb(204, 204, 204);
  border-top-color: rgb(204, 204, 204);
  border-top-style: solid;
  border-top-width: 1px;
  color: rgb(51, 51, 51);
  display: block;
  font-family: Roboto, Droid, 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 1em;
  min-height: 420px;
  padding: 20px;
}
div.dataInputsDesc {
  color: rgb(51, 51, 51);
  display: block;
  font-family: Roboto, Droid, 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 1em;
  height: 14px;
  margin-bottom: 15px;
  margin-top: 5px;
}

table.splTable {
  background-color: #fff;
  border-color: #999;
  margin-bottom: 15px;
  border-bottom: 0;
  border: 0px;
  border-spacing: 0px;
}
table.splTable th {
  font-size: 1.1em;
  border-color: #999;
  padding: 3px 5px;
  text-align: left;
  border-bottom-width: 1px;
  border-bottom-style: solid;
  vertical-align: top;
}
table.splTable td {
  padding: 10px 5px;
  border-bottom: 1px solid #EEE;
  vertical-align: middle;
}
table.splTable td select, table.splTable td input {
  margin: 0;
}

table.splTable {
    counter-reset: rowNumber;
}

table.splTable > tbody#arcontent > tr {
    counter-increment: rowNumber;
}

table.splTable > tbody#arcontent > tr > td:first-child::before {
    content: counter(rowNumber);
    min-width: 1em;
    margin-right: 0.5em;
}
</style>
{% endblock css %}

{% block content %}
<div class="ManagerBar">
  <h1 class="ManagerPageTitle">Watchlist</h1>
</div>
<div class="adminContent">
  <div class="dataInputsWrapper">
    <div class="dataInputsDesc">Specify up to 25 objects to monitor closely for events. This list is applicable to Deep Discovery Inspector.</div>

    <form method="post" action=".">
      {% csrf_token %}
      <table class="splTable" id="dataInputs" style="display:none;">
        <thead>
          <tr>
            <th></th>
            <th>Type</th>
            <th>Object</th>
            <th>Description</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="arcontent">
        </tbody>
        <tbody>
          <tr>
            <td></td>
            <td colspan="4" id="add_more_link"></td>
          </tr>
        </tbody>
        <tbody>
          <tr>
            <td colspan="5" style="background-color:#EEE;">
              <a href="." id="button_l" class="btn btn-default" style="margin:0 10px;">Cancel</a> 
              <button id="button_r" class="btn btn-primary submit" style="margin:0 10px;float:right;">Save</button>
            </td>
          </tr>
        </tbody>
      </table>
    </form>

  </div>
</div>
{% endblock content%}

{% block managers %}
{% endblock managers %}

{% block js %}
<script>
  require.config({
      waitSeconds: 60
  })
  var deps_1 = [
      "splunkjs/mvc",
      "splunkjs/ready!",
      "underscore",
      "jquery",
  ];
  var deps_2 = [
      "splunkjs/mvc/utils",
      "splunkjs/mvc/tokenutils",
      "splunkjs/mvc/headerview",
      "splunkjs/mvc/footerview",
      "splunkjs/mvc/textinputview",
      "splunkjs/mvc/searchmanager",
      "splunkjs/mvc/chartview",
      "splunkjs/mvc/tableview",
      "splunkjs/mvc/savedsearchmanager",
  ];
  require(deps_1, function(mvc) {
    require(deps_2, function(mvc) {
        $("#add_more_link").append(
          $('<a href="#" style="margin: 0 5px;">Add object...</a>').on(
            "click", function(e) {
              e.preventDefault();
              $("#arcontent tr:hidden").first().show();
              if ($("#arcontent > tr:hidden").length > 0) {
                $("#add_more_link").show();
              } else {
                $("#add_more_link").hide();
              }
            }
          )
        ).hide();

        var genInput = function(idx, lbt, lbj, lbd, typ, obj, dsc) {
          var sel1 = $('<select name="lbt[]"></select>');
          sel1.append('<option></option>');
          sel1.append('<option value="Host">Host name</option>');
          sel1.append('<option value="IP">IP address</option>');
          sel1.append('<option value="Email">Email Address</option>');
          var inp1 = $('<input type="text" name="lbj[]">');
          var inp2 = $('<input type="text" name="lbd[]">');

          var delete_object_link = $('<a href="#" class="delete_object_link" title="Delete object">&times;</a>').on("click", function(e) {
            e.preventDefault();

            var _tr = $(this).closest("tr");
            $("select", _tr).val('');
            $("input", _tr).val('');
            var _tr_clone = _tr.clone();
            _tr_clone.hide();
            
            $("#arcontent").append(_tr_clone);
            _tr.remove();

            if ($("#arcontent > tr:hidden").length > 0) {
              $("#add_more_link").show();
            } else {
              $("#add_more_link").hide();
            }
          });

          var tr = $('<tr></tr>');
          if (!typ || typ == '') {
            tr.hide();
          } else {
            sel1.val(typ);
            inp1.val(obj);
            inp2.val(dsc);
          }

          tr
            .append( $('<td></td>') )
            .append( $('<td></td>').append(sel1) )
            .append( $('<td></td>').append(inp1) )
            .append( $('<td></td>').append(inp2) )
            .append( $('<td></td>').append(delete_object_link) );
          return tr;
        }
        {% autoescape off %}
        var myJSONList = {{alis}};
        {% endautoescape %}
        
        var typ, obj;
        for (i in myJSONList) {
          if (i > 0) {

            var el = myJSONList[i];
            var typ = "", obj = "";
            if (el[0] != "") {
              typ = "IP";
              obj = el[0]
            } else 
            if (el[1] != "") {
              typ = "Host";
              obj = el[1]
            } else 
            if (el[2] != "") {
              typ = "Email";
              obj = el[2]
            }
            
            $("#arcontent").append(
              genInput(i, "t_"+i, "j_"+i, "d_"+i, typ, obj, el[3])
            );
          }
        }

        if ($("#arcontent > tr:hidden").length > 0) {
          $("#add_more_link").show();
        } else {
          $("#add_more_link").hide();
        }
        $("#dataInputs").show();
    });
  });
</script>
{% endblock js %}
