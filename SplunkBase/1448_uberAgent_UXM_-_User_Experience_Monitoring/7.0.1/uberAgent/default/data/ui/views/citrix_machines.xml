<?xml version='1.0' encoding='utf-8'?>
<form version="1.1" script="main.js" stylesheet="main.css">

   <label>Citrix Virtual Apps and Desktops Machines</label>
   <description>This dashboard displays detailed information about machines in Citrix Virtual Apps and Desktops (service) sites.</description>

   <fieldset autoRun="true">
      <input type="time" searchWhenChanged="true">
         <label>Time range:</label>
         <default>
            <earliest>-1h</earliest>
            <latest>now</latest>
         </default>
         <change>
            <eval token="TimeRangePickerSpan">relative_time(now(), latest) - relative_time(now(), earliest)</eval>
            <eval token="PivotPeriodAutoSolo">case('TimeRangePickerSpan' &lt; 350000, "auto", 'TimeRangePickerSpan' &lt; 610000, "hour", 1=1, "auto")</eval>
            <eval token="PivotPeriodAutoTimechart">case('TimeRangePickerSpan' &lt; 1200, "second", 'TimeRangePickerSpan' &lt; 300000, "minute", 'TimeRangePickerSpan' &lt; 700000, "hour", 1=1, "day")</eval>
         </change>
      </input>
      <input type="dropdown" token="SiteFilterString" searchWhenChanged="true">
         <choice value="*">All</choice>
         <default>*</default>
         <label>Site:</label>
         <allowCustomValues>false</allowCustomValues>
         <fieldForLabel>SiteNameExtended</fieldForLabel>
         <fieldForValue>SiteGuid</fieldForValue>
         <search>
            <query>
               | pivot `uA_DM_Citrix_Machines` Citrix_Machines
                  latest(SiteNameExtended) as SiteNameExtended
                  splitrow 
                     SiteGuid
               | eval sortfield = lower (SiteNameExtended)
               | sort sortfield
               | table
                  SiteNameExtended
                  SiteGuid
            </query>
         </search>
      </input>

      <input type="dropdown" token="CatalogFilterString" searchWhenChanged="true">
         <choice value="*">All</choice>
         <default>*</default>
         <label>Machine catalog:</label>
         <allowCustomValues>false</allowCustomValues>
         <fieldForLabel>Name</fieldForLabel>
         <fieldForValue>Id</fieldForValue>
         <search>
            <query>
               | pivot `uA_DM_Citrix_Catalogs` Citrix_Catalogs
                  latest(Name) as Name
                  splitrow 
                     Id
                  filter SiteGuid is $SiteFilterString|s$
               | eval sortfield = lower (Name)
               | sort sortfield
               | table
                  Name
                  Id
            </query>
         </search>
      </input>
      
      <input type="dropdown" token="DeliveryGroupFilterString" searchWhenChanged="true">
         <choice value="*">All</choice>
         <default>*</default>
         <label>Delivery group:</label>
         <allowCustomValues>false</allowCustomValues>
         <fieldForLabel>Name</fieldForLabel>
         <fieldForValue>Id</fieldForValue>
         <search>
            <query>
               | pivot `uA_DM_Citrix_DesktopGroups` Citrix_DesktopGroups
                  latest(Name) as Name
                  splitrow 
                     Id
                  filter SiteGuid is $SiteFilterString|s$
               | eval sortfield = lower (Name)
               | sort sortfield
               | table
                  Name
                  Id
            </query>
         </search>
      </input>
      
      <input type="text" token="NameHostFilterString">
         <default>*</default>
         <label>Host:</label>
      </input>
   </fieldset>

   <search id="Search_Single">
      <query>
         | pivot `uA_DM_Citrix_Machines` Citrix_Machines
            dc(SiteGuid) as SiteCount
            filter SiteGuid is $SiteFilterString|s$
         | appendcols
         [
         | pivot `uA_DM_Citrix_Machines` Citrix_Machines
            latest(CatalogId) as CatalogId
            latest(DesktopGroupId) as DesktopGroupId
            latest(IsRegisteredNumber) as IsRegisteredNumber
            splitrow
               Id
            filter IsVDA is "1"
            filter SiteGuid is $SiteFilterString|s$
            filter NameHost in ("$NameHostFilterString$")
         | search 
            ([| makeresults | eval SubsearchFilter = if ("$DeliveryGroupFilterString$" = "*", "(NOT DesktopGroupId = \"*\") OR DesktopGroupId = \"*\"", "DesktopGroupId = \"$DeliveryGroupFilterString$\"") | return $SubsearchFilter])
            AND
            ([| makeresults | eval SubsearchFilter = if ("$CatalogFilterString$" = "*", "(NOT CatalogId = \"*\") OR CatalogId = \"*\"", "CatalogId = \"$CatalogFilterString$\"") | return $SubsearchFilter])
         | eval HasDeliveryGroup = if (isNotNull(DesktopGroupId), 1, 0)
         | stats
            count as VDACount
            sum(HasDeliveryGroup) as VDAsWithDeliveryGroup
            sum(IsRegisteredNumber) as RegisteredCount
         | eval UnregisteredCount = VDACount - RegisteredCount
         | eval RegisteredPercent = round (RegisteredCount / VDACount * 100, 1)
         ]
         | appendcols
         [
         | pivot `uA_DM_Citrix_Machines` Citrix_Machines
            count(Citrix_Machines)
            splitrow
               Id
            filter IsDDC is "1"
            filter SiteGuid is $SiteFilterString|s$
         | stats
            count as DDCCount
         ]
         | appendcols
         [
         | pivot `uA_DM_Citrix_Catalogs` Citrix_Catalogs
            dc(Id) as CatalogCount
            filter SiteGuid is $SiteFilterString|s$
            filter CatalogId is $CatalogFilterString|s$
         ]
         | appendcols
         [
         | pivot `uA_DM_Citrix_DesktopGroups` Citrix_DesktopGroups
            dc(Id) as DeliveryGroupCount
            filter SiteGuid is $SiteFilterString|s$
            filter DesktopGroupId is $DeliveryGroupFilterString|s$
         ]
      </query>
   </search>
   
   <!-- Row 1 -->
   <row>
      <panel>
         <title>Overview</title>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">SiteCount</option>
            <option name="uberAgent.uberagent-singlevalue.1-title">#Sites:</option>
            <option name="uberAgent.uberagent-singlevalue.1-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.2-field">CatalogCount</option>
            <option name="uberAgent.uberagent-singlevalue.2-title">#Machine catalogs:</option>
            <option name="uberAgent.uberagent-singlevalue.2-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.3-field">DeliveryGroupCount</option>
            <option name="uberAgent.uberagent-singlevalue.3-title">#Delivery groups:</option>
            <option name="uberAgent.uberagent-singlevalue.3-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.4-field">DDCCount</option>
            <option name="uberAgent.uberagent-singlevalue.4-title">#Delivery controllers:</option>
            <option name="uberAgent.uberagent-singlevalue.4-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.5-field">VDACount</option>
            <option name="uberAgent.uberagent-singlevalue.5-title">#VDAs total:</option>
            <option name="uberAgent.uberagent-singlevalue.5-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.6-field">VDAsWithDeliveryGroup</option>
            <option name="uberAgent.uberagent-singlevalue.6-title">#VDAs with delivery group:</option>
            <option name="uberAgent.uberagent-singlevalue.6-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.7-field">UnregisteredCount</option>
            <option name="uberAgent.uberagent-singlevalue.7-title">#Unregistered VDAs:</option>
            <option name="uberAgent.uberagent-singlevalue.7-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.8-field">RegisteredCount</option>
            <option name="uberAgent.uberagent-singlevalue.8-title">#Registered VDAs:</option>
            <option name="uberAgent.uberagent-singlevalue.8-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.9-field">RegisteredPercent</option>
            <option name="uberAgent.uberagent-singlevalue.9-title">%Registered VDAs:</option>
            <option name="uberAgent.uberagent-singlevalue.9-afterLabel">%</option>
         </viz>
      </panel>
   </row>

   <!-- Row 2 -->
   <row>

      <panel>
         <title>Machine registration count over time</title>
         <input type="dropdown" token="Panel21GroupBy" searchWhenChanged="true">
            <choice value="CatalogDisplayName">Machine catalog</choice>
            <choice value="DesktopGroupDisplayName">Delivery group</choice>
            <default>CatalogDisplayName</default>
            <label>Group by:</label>
         </input>
         <chart>
            <search>
               <query>
                  | pivot `uA_DM_Citrix_Machines` Citrix_Machines
                     latest(IsRegistered) as IsRegistered
                     latest($Panel21GroupBy$) as $Panel21GroupBy$
                     splitrow
                        _time
                        period $PivotPeriodAutoTimechart$
                     splitrow
                        Id
                     filter IsRegistered is "1"
                     filter SiteGuid is $SiteFilterString|s$
                     filter CatalogId is $CatalogFilterString|s$
                     filter DesktopGroupId is $DeliveryGroupFilterString|s$
                     filter NameHost in ("$NameHostFilterString$")
                  | timechart
                     `uberAgent_dynamic_span`
                     dc(Id) as RegisteredCount
                     by $Panel21GroupBy$
               </query>
            </search>
            <option name="height">250</option>
            <option name="charting.chart">column</option>
            <option name="charting.chart.stackMode">stacked</option>
            <option name="charting.legend.placement">bottom</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
            <option name="charting.axisTitleY.visibility">collapsed</option>
            <option name="charting.drilldown">none</option>
         </chart>
      </panel>
      
      <panel>
         <title>User session count over time</title>
         <input type="dropdown" token="Panel22GroupBy" searchWhenChanged="true">
            <choice value="CatalogDisplayName">Machine catalog</choice>
            <choice value="DesktopGroupDisplayName">Delivery group</choice>
            <default>CatalogDisplayName</default>
            <label>Group by:</label>
         </input>
         <chart>
            <search>
               <query>
                  | pivot `uA_DM_Citrix_Machines` Citrix_Machines
                     avg(CurrentSessionCount) as CurrentSessionCount
                     latest($Panel22GroupBy$) as $Panel22GroupBy$
                     splitrow
                        _time
                        period $PivotPeriodAutoTimechart$
                     splitrow
                        Id
                     filter IsVDA is "1"
                     filter SiteGuid is $SiteFilterString|s$
                     filter CatalogId is $CatalogFilterString|s$
                     filter DesktopGroupId is $DeliveryGroupFilterString|s$
                     filter NameHost in ("$NameHostFilterString$")
                  | timechart partial=false
                     `uberAgent_dynamic_span`
                     sum(CurrentSessionCount) as CurrentSessionCount
                     by $Panel22GroupBy$
               </query>
            </search>
            <option name="height">250</option>
            <option name="charting.chart">column</option>
            <option name="charting.chart.stackMode">stacked</option>
            <option name="charting.legend.placement">bottom</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
            <option name="charting.axisTitleY.visibility">collapsed</option>
            <option name="charting.drilldown">none</option>
         </chart>
      </panel>
   </row>

   <!-- Row 3 -->
   <row>

      <!-- Column 1 -->
      <panel>
         <title>Machine catalogs</title>
         <table>
            <search>
               <query>
                  | pivot `uA_DM_Citrix_Catalogs` Citrix_Catalogs
                     latest(Name) as "Machine catalog"
                     latest(ProvisioningTypeDisplayName) as "Provisioning type"
                     latest(SessionSupportDisplayName) as "Session support"
                     latest(AllocationTypeDisplayName) as "Allocation type"
                     latest(PersistentUserChangesDisplayName) as "Persistent user changes"
                     splitrow
                        CatalogId
                     filter SiteGuid is $SiteFilterString|s$
                     filter CatalogId is $CatalogFilterString|s$
                  | join type=outer CatalogId
                  [
                     | pivot `uA_DM_Citrix_Machines` Citrix_Machines
                        latest(IsVDANumber) as IsVDANumber
                        latest(IsRegisteredNumber) as IsRegisteredNumber
                        splitrow
                           CatalogId
                        splitrow
                           Id
                        filter SiteGuid is $SiteFilterString|s$
                        filter NameHost in ("$NameHostFilterString$")
                     | stats
                        sum(IsVDANumber) as VDACount
                        sum(IsRegisteredNumber) as RegisteredCount
                        by CatalogId
                  ]
                  | eval "%Registered" = round (RegisteredCount / VDACount * 100, 1)
                  | rename VDACount as "#VDAs"
                  | rename RegisteredCount as "#Registered"
                  | sort "Machine catalog"
                  | fillnull
                  | table
                     "Machine catalog"
                     "Session support"
                     "Provisioning type"
                     "Allocation type"
                     "Persistent user changes"
                     "#VDAs"
                     "#Registered"
                     "%Registered"               
               </query>
            </search>
            <option name="count">10</option>
            <option name="drilldown">row</option>
            <drilldown>
                <set token="DrilldownFilterBy3Label">machine catalog</set>
                <set token="DrilldownFilterBy3Field">CatalogDisplayName</set>
                <set token="DrilldownFilterBy3Value">$click.value$</set>
                <set token="DrilldownOther3Label">Delivery group</set>
                <set token="DrilldownOther3Field">DesktopGroupDisplayName</set>
            </drilldown>
         </table>
      </panel>

      <!-- Column 2 -->
      <panel>
         <title>Delivery groups</title>
         <table>
            <search>
               <query>
                  | pivot `uA_DM_Citrix_DesktopGroups` Citrix_DesktopGroups
                     latest(Name) as "Delivery group"
                     latest(DesktopKindDisplayName) as "Allocation type"
                     latest(SessionSupportDisplayName) as "Session support"
                     latest(IsRemotePC) as "Remote PC?"
                     splitrow
                        DesktopGroupId
                     filter SiteGuid is $SiteFilterString|s$
                     filter DesktopGroupId is $DeliveryGroupFilterString|s$
                  | join type=outer DesktopGroupId
                  [
                     | pivot `uA_DM_Citrix_Machines` Citrix_Machines
                        latest(IsVDANumber) as IsVDANumber
                        latest(IsRegisteredNumber) as IsRegisteredNumber
                        splitrow
                           DesktopGroupId
                        splitrow
                           Id
                        filter SiteGuid is $SiteFilterString|s$
                        filter NameHost in ("$NameHostFilterString$")
                     | stats
                        sum(IsVDANumber) as VDACount
                        sum(IsRegisteredNumber) as RegisteredCount
                        by DesktopGroupId
                  ]
                  | eval "%Registered" = round (RegisteredCount / VDACount * 100, 1)
                  | rename VDACount as "#VDAs"
                  | rename RegisteredCount as "#Registered"
                  | sort "Delivery group"
                  | fillnull
                  | table
                     "Delivery group"
                     "Session support"
                     "Allocation type"
                     "Remote PC?"
                     "#VDAs"
                     "#Registered"
                     "%Registered"
               </query>
            </search>
            <option name="count">10</option>
            <option name="drilldown">row</option>
            <drilldown>
                <set token="DrilldownFilterBy3Label">delivery group</set>
                <set token="DrilldownFilterBy3Field">DesktopGroupDisplayName</set>
                <set token="DrilldownFilterBy3Value">$click.value$</set>
                <set token="DrilldownOther3Label">Machine catalog</set>
                <set token="DrilldownOther3Field">CatalogDisplayName</set>
            </drilldown>
         </table>
      </panel>
   </row>

   <row depends="$DrilldownFilterBy3Label$">
      <panel>
         <title>Machine detail: $DrilldownFilterBy3Label$ = $DrilldownFilterBy3Value$</title>
         <table>
            <search>
               <query>
                  | pivot `uA_DM_Citrix_Machines` Citrix_Machines
                     latest($DrilldownOther3Field$) as "$DrilldownOther3Label$"
                     latest(IsRegistered) as "Registered?"
                     latest(IsInMaintenanceMode) as "Maint. mode?"
                     latest(EffectiveLoadIndex) as "Load index"
                     latest(CurrentSessionCount) as "#Sessions"
                     latest(CPUCoresLogical) as "#CPU cores"
                     latest(RAMSizeGB) as "RAM (GB)"
                     latest(HwIsVirtualMachine) as "Is VM?"
                     latest(HwHypervisorVendor) as "Hypervisor"
                     latest(HwModel) as "Hardware model"
                     latest(OsVersion) as "OS version #"
                     latest(OsBuild) as "OS build #"
                     latest(AgentVersion) as "VDA version"
                     values(TagsSplit) as TagsSplit
                     splitrow
                        NameHost as Name
                     filter NameHost in ("$NameHostFilterString$")
                     filter $DrilldownFilterBy3Field$ is $DrilldownFilterBy3Value|s$
                     filter SiteGuid is $SiteFilterString|s$
                  | eval Tags = mvjoin (TagsSplit, ", ")
                  | table
                     Name
                     "$DrilldownOther3Label$"
                     "Registered?"
                     "Maint. mode?"
                     "Load index"
                     "#Sessions"
                     "#CPU cores"
                     "RAM (GB)"
                     "Is VM?"
                     "Hypervisor"
                     "Hardware model"
                     "OS version #"
                     "OS build #"
                     "VDA version"
                     Tags
               </query>
            </search>
            <option name="count">10</option>
            <option name="drilldown">row</option>
            <drilldown>
               <link>
                  <![CDATA[
                     single_machine_detail?earliest=$earliest$&latest=$latest$&form.FilterField=shost&form.FilterOperator=in&form.FilterExpression=$click.value$
                  ]]>
               </link>
            </drilldown>
         </table>
      </panel>
   </row>

   <!-- Row 6 -->
   <row>
      <panel>
         <title>Unregistered machines</title>
         <table>
            <search>
               <query>
                  | pivot `uA_DM_Citrix_Machines` Citrix_Machines
                     latest(CatalogId) as CatalogId
                     latest(DesktopGroupId) as DesktopGroupId
                     latest(IsInMaintenanceMode) as "Maint. mode?"
                     latest(SiteNameExtended) as Site
                     latest(CatalogDisplayName) as "Machine catalog"
                     latest(DesktopGroupDisplayName) as "Delivery group"
                     latest(FaultStateDisplayName) as "Fault state"
                     latest(LastDeregisteredCodeDisplayName) as "Last deregistered code"
                     latest(LastDeregisteredDate) as "Last deregistered date"
                     latest(RegistrationStateChangeDate) as "Registration change date"
                     latest(AgentVersion) as "VDA version"
                     latest(Sid) as Sid
                     splitrow
                        Name
                     filter IsRegistered is "0"
                     filter IsDDC is "0"
                     filter SiteGuid is $SiteFilterString|s$
                     filter NameHost in ("$NameHostFilterString$")
                  | search 
                     ([| makeresults | eval SubsearchFilter = if ("$DeliveryGroupFilterString$" = "*", "(NOT DesktopGroupId = \"*\") OR DesktopGroupId = \"*\"", "DesktopGroupId = \"$DeliveryGroupFilterString$\"") | return $SubsearchFilter])
                     AND
                     ([| makeresults | eval SubsearchFilter = if ("$CatalogFilterString$" = "*", "(NOT CatalogId = \"*\") OR CatalogId = \"*\"", "CatalogId = \"$CatalogFilterString$\"") | return $SubsearchFilter])
                  | table
                     Name
                     "Maint. mode?"
                     Site
                     "Machine catalog"
                     "Delivery group"
                     "Fault state"
                     "Last deregistered code"
                     "Last deregistered date"
                     "Registration change date"
                     "VDA version"
                     Sid
               </query>
            </search>
            <option name="count">10</option>
            <option name="drilldown">row</option>
            <drilldown>
               <link>
                  <![CDATA[
                     single_machine_detail?earliest=$earliest$&latest=$latest$&form.FilterField=shost&form.FilterOperator=in&form.FilterExpression=$click.value$
                  ]]>
               </link>
            </drilldown>
         </table>
      </panel>
   </row>

</form>
