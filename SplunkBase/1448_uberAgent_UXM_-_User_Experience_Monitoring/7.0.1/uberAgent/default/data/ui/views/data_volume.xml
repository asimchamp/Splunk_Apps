<?xml version='1.0' encoding='utf-8'?>
<form version="1.1" script="main.js" stylesheet="main.css">

   <label>Data Volume</label>
   <description>This dashboard displays information about the volume of data generated by uberAgent. It is based on data from license_usage.log, stored in the _internal index on the Splunk license master. If this dashboard is empty, configure forwarding of the license master's _internal index to your indexers. In larger implementations the data volume cannot be determined per individual host due to squashing. Please note that enabling ESA also increases the UXM data volume because additional fields are populated in UXM sourcetypes, too.</description>

   <fieldset autoRun="true">
      <input type="time" searchWhenChanged="true">
         <label>Time range:</label>
         <default>
            <earliest>-1d</earliest>
            <latest>now</latest>
         </default>
         <change>
            <eval token="TimeRangePickerSpan">relative_time(now(), latest) - relative_time(now(), earliest)</eval>
            <eval token="PivotPeriodAutoSolo">case('TimeRangePickerSpan' &lt; 350000, "auto", 'TimeRangePickerSpan' &lt; 610000, "hour", 1=1, "auto")</eval>
            <eval token="PivotPeriodAutoTimechart">case('TimeRangePickerSpan' &lt; 1200, "second", 'TimeRangePickerSpan' &lt; 300000, "minute", 'TimeRangePickerSpan' &lt; 700000, "hour", 1=1, "day")</eval>
            <set token="IndexFilter">idx=`uberAgent_index` idx!=uberagent_log idx!=ua_meta*</set>
         </change>
      </input>
   </fieldset>

   <search id="Search_Single">
      <query>
         index=_internal
            source="*license_usage.log" 
            type=Usage
            $IndexFilter$
         | lookup lookup_uA_sourcetypes_metrics Sourcetype as st OUTPUTNEW uAMetric as "uberAgent metric" uAProduct as "uberAgent product"
         | stats
            sum(b) as SumBytes
            by "uberAgent metric" "uberAgent product"
         | eventstats sum(SumBytes) as TotalBytes
         | eval HostCount=
         [
            search index=`uberAgent_index` sourcetype=uberAgent:Application:AppNameIdMapping
            | stats
               dc(host) as HostCount
            | fields + HostCount
            | return $HostCount
         ]
         | eval TotalMegabytesRounded = round (TotalBytes / 1048576, 2)
         | appendcols
         [
         search index=_internal
            source="*license_usage.log" 
            type=Usage
            $IndexFilter$
         | lookup lookup_uA_sourcetypes_metrics Sourcetype as st OUTPUTNEW uAMetric as "uberAgent metric" uAProduct as "uberAgent product"
         | stats
            sum(b) as SumBytes
            by "uberAgent metric" "uberAgent product"
         | eventstats sum(SumBytes) as TotalBytes
         | eval HostCount=
         [
            search index=`uberAgent_index` sourcetype=uberAgent:Application:AppNameIdMapping
            | stats
               dc(host) as HostCount
            | fields + HostCount
            | return $HostCount
         ]
         | eventstats max(HostCount) as HostCount
         | eval AvgVolumePerHost = round (TotalBytes / 1048576 / HostCount, 2)
         ]
         | appendcols
         [
         search index=_internal
            source="*license_usage.log" 
            type=Usage
            $IndexFilter$
         | lookup lookup_uA_sourcetypes_metrics Sourcetype as st OUTPUTNEW uAMetric as "uberAgent metric" uAProduct as "uberAgent product"
         | stats
            sum(b) as SumBytes
            by "uberAgent metric" "uberAgent product"
         | eventstats sum(SumBytes) as TotalBytes
         | eval HostCount=
         [
            search index=`uberAgent_index` sourcetype=uberAgent:Application:AppNameIdMapping
            | stats
               dc(host) as HostCount
            | fields + HostCount
            | return $HostCount
         ]
         | where 'uberAgent product' = "UXM"
         | stats
            sum(SumBytes) as SumBytes
         | eval VolumeUxmMB = round (SumBytes / 1048576, 2)
         ]
         | appendcols
         [
         search index=_internal
            source="*license_usage.log" 
            type=Usage
            $IndexFilter$
         | lookup lookup_uA_sourcetypes_metrics Sourcetype as st OUTPUTNEW uAMetric as "uberAgent metric" uAProduct as "uberAgent product"
         | stats
            sum(b) as SumBytes
            by "uberAgent metric" "uberAgent product"
         | eventstats sum(SumBytes) as TotalBytes
         | eval HostCount=
         [
            search index=`uberAgent_index` sourcetype=uberAgent:Application:AppNameIdMapping
            | stats
               dc(host) as HostCount
            | fields + HostCount
            | return $HostCount
         ]
         | where 'uberAgent product' = "ESA"
         | stats
            sum(SumBytes) as SumBytes
         | eval VolumeEsaMB = round (SumBytes / 1048576, 2)
         ]
      </query>
   </search>
   
   <!-- Row 1 -->
   <row>
      <panel>
         <title>Total data volume</title>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">TotalMegabytesRounded</option>
            <option name="uberAgent.uberagent-singlevalue.1-title"></option>
            <option name="uberAgent.uberagent-singlevalue.1-afterLabel">MB</option>
         </viz>
      </panel>
      <panel>
         <title>Data volume per product</title>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">VolumeUxmMB</option>
            <option name="uberAgent.uberagent-singlevalue.1-title">uberAgent UXM:</option>
            <option name="uberAgent.uberagent-singlevalue.1-afterLabel">MB</option>
            <option name="uberAgent.uberagent-singlevalue.2-field">VolumeEsaMB</option>
            <option name="uberAgent.uberagent-singlevalue.2-title">uberAgent ESA:</option>
            <option name="uberAgent.uberagent-singlevalue.2-afterLabel">MB</option>
         </viz>
      </panel>
      <panel>
         <title>Average data volume per host</title>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">AvgVolumePerHost</option>
            <option name="uberAgent.uberagent-singlevalue.1-title">Avg. volume per host:</option>
            <option name="uberAgent.uberagent-singlevalue.1-afterLabel">MB</option>
            <option name="uberAgent.uberagent-singlevalue.2-field">HostCount</option>
            <option name="uberAgent.uberagent-singlevalue.2-title">#Hosts:</option>
            <option name="uberAgent.uberagent-singlevalue.2-afterLabel"></option>
         </viz>
      </panel>
   </row>

   <!-- Row 2 -->
   <row>
      <panel>
         <title>Data volume per uberAgent index</title>
         <table>
            <search>
               <query>
                  index=_internal 
                     source="*license_usage.log" 
                     type=Usage
                     $IndexFilter$
                  | stats
                     sum(b) as SumBytes
                     dc(h) as HostCount
                     by idx
                  | eventstats sum(SumBytes) as TotalBytes
                  | eval "Data volume (MB)" = round (SumBytes / 1048576, 2)
                  | eval "Data volume (%)" = round (SumBytes / TotalBytes * 100, 3)
                  | eval "Avg. volume per host (MB)" = round (SumBytes / 1048576 / HostCount, 2)
                  | rename idx as Index
                  | rename HostCount as "#Hosts"
                  | table
                     Index
                     "Data volume (MB)"
                     "Data volume (%)"
                     "#Hosts"
                     "Avg. volume per host (MB)"
               </query>
            </search>
            <option name="count">50</option>
            <option name="drilldown">none</option>
         </table>
      </panel>   
   
   </row>
   
   <!-- Row 3 -->
   <row>
      <panel>
         <title>Data volume per uberAgent metric</title>
         <table>
            <search base="Search_Single">
               <query>
                  eval "Data volume (MB)" = round (SumBytes / 1048576, 2)
                  | eval "Data volume (%)" = round (SumBytes / TotalBytes * 100, 2)
                  | table
                     "uberAgent metric"
                     "uberAgent product"
                     "Data volume (MB)"
                     "Data volume (%)"
               </query>
            </search>
            <option name="count">50</option>
            <option name="drilldown">none</option>
         </table>
      </panel>

      <panel>
         <title>Data volume per uberAgent endpoint</title>
         <table>
            <search>
               <query>
                  index=_internal 
                     source="*license_usage.log" 
                     type=Usage
                     $IndexFilter$
                  | stats
                     sum(b) as SumBytes
                     by h
                  | eventstats sum(SumBytes) as TotalBytes
                  | eval "Data volume (MB)" = round (SumBytes / 1048576, 2)
                  | eval "Data volume (%)" = round (SumBytes / TotalBytes * 100, 3)
                  | rename h as Host
                  | table
                     Host
                     "Data volume (MB)"
                     "Data volume (%)"
               </query>
            </search>
            <option name="count">50</option>
            <option name="drilldown">none</option>
         </table>
      </panel>
   </row>

</form>
