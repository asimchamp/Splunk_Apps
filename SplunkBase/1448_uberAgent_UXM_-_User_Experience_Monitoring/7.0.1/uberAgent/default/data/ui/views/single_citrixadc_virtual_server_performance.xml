<?xml version="1.0" encoding="utf-8"?>
<form version="1.1" script="main.js" stylesheet="main.css">

   <label>Single Virtual Server Performance</label>
   <description>This dashboard displays performance information about virtual servers and bound services as well as service groups. uberAgent only collects performance data from the primary Citrix ADC.</description>

  <fieldset autoRun="true">
    <input type="time" searchWhenChanged="true">
      <label>Time range:</label>
      <default>
        <earliest>-1h</earliest>
        <latest>now</latest>
      </default>
      <change>
         <eval token="TimeRangePickerSpan">relative_time(now(), latest) - relative_time(now(), earliest)</eval>
         <eval token="PivotPeriodAutoSolo">case('TimeRangePickerSpan' &lt; 350000, "auto", 'TimeRangePickerSpan' &lt; 610000, "hour", 1=1, "auto")</eval>
         <eval token="PivotPeriodAutoTimechart">case('TimeRangePickerSpan' &lt; 1200, "second", 'TimeRangePickerSpan' &lt; 300000, "minute", 'TimeRangePickerSpan' &lt; 700000, "hour", 1=1, "day")</eval>
      </change>
    </input>
    <input type="dropdown" token="CitrixADCFilterString" searchWhenChanged="true">
         <choice value="*">All</choice>
         <default>*</default>
         <label>vServer:</label>
         <fieldForLabel>vServerName</fieldForLabel>
         <fieldForValue>vServerName</fieldForValue>
         <allowCustomValues>false</allowCustomValues>
         <search>
            <query>
               | pivot `uA_DM_CitrixADC_vServer` CitrixADC_vServer
                  splitrow vServerName
               | eval sortfield = lower (vServerName)
               | sort sortfield
               | table
                  vServerName
            </query>
         </search>
    </input>
  </fieldset>

   <search id="Search_Single">
    <query>
         | pivot `uA_DM_CitrixADC_vServer` CitrixADC_vServer
            latest(vServerName) as "Virtual server"
            latest(PrimaryIpAddress) as "IP address"
            latest(PrimaryPort) as Port
            latest(Type) as Protocol
            latest(State) as State
            latest(ActSvcs) as "Active services"
            latest(TotHits) as "#Hits"
            latest(TotalRequests) as "#Requests"
            latest(TotalResponses) as "#Responses"
            latest(Certificates) as Certificates
            filter vServerName is $CitrixADCFilterString|s$
         | eval Title = "Performance data: " . 'Virtual server'
         | eval Certificates = split(Certificates, ";")
      </query>
   </search>

   <!-- Row 1 -->
   <row>
      <!-- Column 1 -->
      <panel>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">Title</option>
            <option name="uberAgent.uberagent-singlevalue.1-title"></option>
         </viz>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">IP address</option>
            <option name="uberAgent.uberagent-singlevalue.1-title">IP address</option>
            <option name="uberAgent.uberagent-singlevalue.2-field">Port</option>
            <option name="uberAgent.uberagent-singlevalue.2-title">Port</option>
         </viz>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">Protocol</option>
            <option name="uberAgent.uberagent-singlevalue.1-title">Protocol</option>
            <option name="uberAgent.uberagent-singlevalue.2-field">State</option>
            <option name="uberAgent.uberagent-singlevalue.2-title">State</option>
            <option name="uberAgent.uberagent-singlevalue.3-field">#Hits</option>
            <option name="uberAgent.uberagent-singlevalue.3-title">#Hits</option>
            <option name="uberAgent.uberagent-singlevalue.4-field">#Requests</option>
            <option name="uberAgent.uberagent-singlevalue.4-title">#Requests</option>
            <option name="uberAgent.uberagent-singlevalue.5-field">#Responses</option>
            <option name="uberAgent.uberagent-singlevalue.5-title">#Responses</option>
         </viz>
      </panel>
   </row>
   <!-- Row 2 -->
   <row>
    <!-- Column 1 -->
    <panel>
      <title>Data volume over time</title>
      <chart>
        <search>
          <query>
            | pivot `uA_DM_CitrixADC_vServer` CitrixADC_vServer
               sum(RequestBytesRate) as RequestBytesRate
               sum(ResponseBytesRate) as ResponseBytesRate
               splitrow
                _time 
                period $PivotPeriodAutoTimechart$
               filter vServerName is $CitrixADCFilterString|s$
            | eval RequestMBRate = round(RequestBytesRate/1024/1024,1)
            | eval ResponseMBRate = round(ResponseBytesRate/1024/1024,1)
            | stats 
               avg(RequestMBRate) as RequestMBRate
               avg(ResponseMBRate) as ResponseMBRate
                 by _time
            | timechart
               `uberAgent_dynamic_span`
               sum(RequestMBRate) as "Receive volume (MB)"
               sum(ResponseMBRate) as "Send volume (MB)"
          </query>
        </search>
        <option name="charting.axisTitleX.visibility">collapsed</option>
        <option name="charting.axisTitleY.visibility">collapsed</option>
        <option name="charting.axisTitleY2.visibility">collapsed</option>
        <option name="charting.axisY.includeZero">1</option>
        <option name="charting.axisY2.enabled">1</option>
        <option name="charting.axisY2.fields">"Send volume (MB)"</option>
        <option name="charting.axisY2.includeZero">1</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.nullValueMode">zero</option>
        <option name="charting.chart.overlayFields">"Receive volume (MB)"</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="height">250</option>
      </chart>
    </panel>
   </row>
   <!-- Row 3 -->
   <row>
    <!-- Column 1 -->
    <panel>
      <title>Other metrics over time</title>
      <input type="dropdown" token="Panel31GroupBy" searchWhenChanged="true">
        <choice value="State">State</choice>
        <choice value="ActSvcs">Active services</choice>
        <choice value="TotHits">Total hits</choice>
        <choice value="VSLBHealth">vServer health</choice>
        <default>State</default>
        <label>Show metric:</label>
        <prefix/>
        <suffix/>
        <change>
          <set token="Panel31Label">$label$</set>
        </change>
      </input>
      <chart>
        <search>
          <query>
            | pivot `uA_DM_CitrixADC_vServer` CitrixADC_vServer
               latest(State) as State
               latest(ActSvcs) as "Active services"
               latest(TotHits) as "#Hits"
               latest(VSLBHealth) as "vServer health"
               splitrow
                _time 
                period $PivotPeriodAutoSolo$
            filter vServerName is $CitrixADCFilterString|s$
            | eval "$Panel31Label$" = if("$Panel31Label$"=="State",case(lower(State)=="up",100,isnotnull(State),0),'$Panel31Label$')
            | table
              _time
              "$Panel31Label$"
          </query>
        </search>
        <option name="charting.axisTitleX.visibility">collapsed</option>
        <option name="charting.axisTitleY.visibility">collapsed</option>
        <option name="charting.axisY.includeZero">1</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="height">250</option>
      </chart>
    </panel>
   </row>
   <!-- Row 4 -->
   <row>
    <!-- Column 1 -->
    <panel>
      <table>
        <title>Bound policies</title>
        <search>
          <query>
            | pivot `uA_DM_CitrixADC_vServer` CitrixADC_vServer
              latest(ResponderPolicies) as "Responder policies"
              latest(RewritePolicies) as "Rewrite policies"
            filter vServerName is $CitrixADCFilterString|s$
            | eval "Responder policies" = split('Responder policies', ";")
            | eval "Rewrite policies" = split('Rewrite policies', ";")
            | transpose
            | sort column
            | rename
               column as Property
               "row 1" as Data
          </query>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
   </row>
   <!-- Row 5 -->
   <row>
    <!-- Column 1 -->
    <panel>
      <table>
        <title>Security settings</title>
        <search>
          <query>
            | pivot `uA_DM_CitrixADC_vServer` CitrixADC_vServer
               latest(SSL2) as "SSL 2"
               latest(SSL3) as "SSL 3"
               latest(TLS1) as "TLS 1"
               latest(TLS11) as "TLS 1.1"
               latest(TLS12) as "TLS 1.2"
               latest(TLS13) as "TLS 1.3"
               latest(HSTS) as "Strict Transport Security"
               latest(HSTSMaxAge) as "Strict Transport Security: max age"
               latest(HSTSInclSubdom) as "Strict Transport Security: include subdomains"
               latest(DiffieHellman) as "Diffie-Hellman"
               latest(Ciphers) as Ciphers
               latest(CipherSuites) as "Cipher suites"
               latest(Certificates) as Certificates
               latest(SSLProfile) as "SSL profile"
               latest(SessionTimeout) as "Session timeout"
            filter vServerName is $CitrixADCFilterString|s$
            | eval Ciphers = split(Ciphers, ";")
            | eval "Cipher suites" = split('Cipher suites', ";")
            | transpose
            | sort column
            | rename
               column as Property
               "row 1" as Data
          </query>
        </search>
        <option name="count">20</option>
        <option name="drilldown">none</option>
      </table>
    </panel>
   </row>
   <!-- Row 6 -->
   <row>
    <!-- Column 1 -->
    <panel>
      <title>Bound service groups</title>
      <table>
        <search>
          <query>
                  | pivot `uA_DM_CitrixADC_ServiceGroup` CitrixADC_ServiceGroup
                     latest(Protocol) as Protocol
                     latest(State) as State
                     latest(ServiceGroupMembers) as "Member servers"
                     latest(ServiceGroupMonitors) as "Bound monitors"
                     splitrow
                        ServiceGroupName as "Service group"
                     filter vServerName is $CitrixADCFilterString|s$
                  | eval "Member servers" = split('Member servers', ";")
                  | eval "Bound monitors" = split('Bound monitors', ";")
                  | table
                     "Service group"
                     Protocol
                     "Member servers"
                     "Bound monitors"
                     State
               </query>
        </search>
        <option name="count">10</option>
        <option name="drilldown">row</option>
        <drilldown>
          <set token="DrilldownFilterBy3Type">service group</set>
          <set token="DrilldownFilterBy3Dataset">ServiceGroup</set>
          <set token="DrilldownFilterBy3Datamodel">`uA_DM_CitrixADC_ServiceGroup`</set>
          <set token="DrilldownFilterBy3Filter">ServiceGroupName</set>
          <set token="DrilldownFilterBy3Avail">latest(EffectiveState)</set>
          <set token="DrilldownFilterBy3Name">$row.Service group$</set>
        </drilldown>
      </table>
    </panel>
    <!-- Column 2 -->
    <panel>
      <title>Bound services</title>
      <table>
        <search>
          <query>
                  | pivot `uA_DM_CitrixADC_Service` CitrixADC_Service
                     latest(Protocol) as Protocol
                     latest(PrimaryIpAddress) as "IP address"
                     latest(PrimaryPort) as Port
                     latest(ServiceMonitors) as "Bound monitors"
                     latest(State) as State
                     splitrow
                        ServiceName as Service
                     filter vServerName is $CitrixADCFilterString|s$
                  | eval "Bound monitors" = split('Bound monitors', ";")
                  | table
                     Service
                     Protocol
                     "IP address"
                     Port
                     "Bound monitors"
                     State
               </query>
        </search>
        <option name="count">10</option>
        <option name="drilldown">row</option>
        <drilldown>
          <set token="DrilldownFilterBy3Type">service</set>
          <set token="DrilldownFilterBy3Dataset">Service</set>
          <set token="DrilldownFilterBy3Datamodel">`uA_DM_CitrixADC_Service`</set>
          <set token="DrilldownFilterBy3Filter">ServiceName</set>
          <set token="DrilldownFilterBy3Avail">latest(State)</set>
          <set token="DrilldownFilterBy3Name">$row.Service$</set>
        </drilldown>
      </table>
    </panel>
   </row>
   <!-- Row 7 -->
   <row depends="$DrilldownFilterBy3Type$">
    <!-- Column 1 -->
    <panel>
      <title>Availability over time for $DrilldownFilterBy3Type$ = $DrilldownFilterBy3Name$</title>
      <chart>
        <search>
          <query>
                  | pivot $DrilldownFilterBy3Datamodel$ CitrixADC_$DrilldownFilterBy3Dataset$
                     $DrilldownFilterBy3Avail$ as Availability
                     splitrow
                        _time
                        period $PivotPeriodAutoSolo$
                   filter vServerName is $CitrixADCFilterString|s$
                   filter $DrilldownFilterBy3Filter$ is $DrilldownFilterBy3Name|s$
                   | eval Availability = case(lower(Availability)=="up",100,lower(Availability)=="partial-up",50,lower(Availability)=="partial-down",50,lower(Availability)=="down",0,lower(Availability)=="out of service",0)
               </query>
        </search>
        <option name="charting.axisTitleX.visibility">collapsed</option>
        <option name="charting.axisTitleY.visibility">collapsed</option>
        <option name="charting.axisY.includeZero">1</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.nullValueMode">connect</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">right</option>
        <option name="height">250</option>
      </chart>
    </panel>
   </row>
</form>
