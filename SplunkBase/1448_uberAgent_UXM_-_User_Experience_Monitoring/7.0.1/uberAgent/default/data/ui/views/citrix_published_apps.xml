<?xml version='1.0' encoding='utf-8'?>
<form version="1.1" script="main.js" stylesheet="main.css">

   <label>Citrix Virtual Apps and Desktops Applications &amp; Desktops</label>
   <description>This dashboard displays detailed information about published applications and desktops in Citrix Virtual Apps and Desktops (service) sites.</description>

   <fieldset autoRun="true">
      <input type="time" searchWhenChanged="true">
         <label>Time range:</label>
         <default>
            <earliest>-1h</earliest>
            <latest>now</latest>
         </default>
         <change>
            <eval token="TimeRangePickerSpan">relative_time(now(), latest) - relative_time(now(), earliest)</eval>
            <eval token="PivotPeriodAutoSolo">case('TimeRangePickerSpan' &lt; 350000, "auto", 'TimeRangePickerSpan' &lt; 610000, "hour", 1=1, "auto")</eval>
            <eval token="PivotPeriodAutoTimechart">case('TimeRangePickerSpan' &lt; 1200, "second", 'TimeRangePickerSpan' &lt; 300000, "minute", 'TimeRangePickerSpan' &lt; 700000, "hour", 1=1, "day")</eval>
         </change>
      </input>
      <input type="dropdown" token="SiteFilterString" searchWhenChanged="true">
         <choice value="*">All</choice>
         <default>*</default>
         <label>Site:</label>
         <allowCustomValues>false</allowCustomValues>
         <fieldForLabel>SiteNameExtended</fieldForLabel>
         <fieldForValue>SiteGuid</fieldForValue>
         <search>
            <query>
               | pivot `uA_DM_Citrix_Machines` Citrix_Machines
                  latest(SiteNameExtended) as SiteNameExtended
                  splitrow 
                     SiteGuid
               | eval sortfield = lower (SiteNameExtended)
               | sort sortfield
               | table
                  SiteNameExtended
                  SiteGuid
            </query>
         </search>
         <change>
            <condition value="*">
               <unset token="form.DeliveryGroupFilterString"></unset>
               <unset token="form.TagFilterString"></unset>
               <unset token="DrilldownFilterBy3Type"></unset>
            </condition>
         </change>
      </input>
      <input type="dropdown" token="DeliveryGroupFilterString" searchWhenChanged="true">
         <choice value="*">All</choice>
         <default>*</default>
         <label>Delivery group:</label>
         <allowCustomValues>false</allowCustomValues>
         <fieldForLabel>Name</fieldForLabel>
         <fieldForValue>Id</fieldForValue>
         <search>
            <query>
               | pivot `uA_DM_Citrix_DesktopGroups` Citrix_DesktopGroups
                  latest(Name) as Name
                  splitrow 
                     Id
                  filter SiteGuid is $SiteFilterString|s$
               | eval sortfield = lower (Name)
               | sort sortfield
               | table
                  Name
                  Id
            </query>
         </search>
         <change>
            <condition value="*">
               <unset token="form.TagFilterString"></unset>
               <unset token="DrilldownFilterBy3Type"></unset>
            </condition>
         </change>
      </input>
      <input type="dropdown" token="TagFilterString" searchWhenChanged="true">
         <choice value="*">All</choice>
         <default>*</default>
         <label>Tags:</label>
         <allowCustomValues>true</allowCustomValues>
         <fieldForLabel>Tag</fieldForLabel>
         <fieldForValue>Tag</fieldForValue>
         <search>
            <query>
               | pivot `uA_DM_Citrix_Applications` Citrix_Applications
                  values(TagsSplit) as Tags
                  filter SiteGuid is $SiteFilterString|s$
                  filter DesktopGroupId is $DeliveryGroupFilterString|s$
               | append
               [
                  | pivot `uA_DM_Citrix_PublishedDesktops` Citrix_PublishedDesktops
                     values(TagsSplit) as Tags
                     filter SiteGuid is $SiteFilterString|s$
                     filter DesktopGroupId is $DeliveryGroupFilterString|s$
               ]
               | mvexpand Tags
               | rename Tags as Tag
               | dedup Tag
               | eval sortfield = lower (Tag)
               | sort sortfield
               | table
                  Tag
            </query>
         </search>
         <change>
            <condition value="*">
               <unset token="DrilldownFilterBy3Type"></unset>
            </condition>
         </change>
      </input>
   </fieldset>

   <search id="Search_Single_Sites">
      <query>
         | pivot `uA_DM_Citrix_Machines` Citrix_Machines
            dc(SiteGuid) as SiteCount
            filter SiteGuid is $SiteFilterString|s$
      </query>
   </search>
   
   <search id="Search_Single">
      <query>
         | pivot `uA_DM_Citrix_DesktopGroups` Citrix_DesktopGroups
            latest(SiteGuid) as SiteGuid
            values(TagsSplit) as TagsSplit
            splitrow
               Id
            filter SiteGuid is $SiteFilterString|s$
            filter DesktopGroupId is $DeliveryGroupFilterString|s$
         | search 
            ([| makeresults | eval SubsearchFilter = if ("$TagFilterString$" = "*", "(NOT TagsSplit = \"*\") OR TagsSplit = \"*\"", "TagsSplit = \"$TagFilterString$\"") | return $SubsearchFilter])
         | stats
            dc(SiteGuid) as SiteCount
            dc(Id) as DeliveryGroupCount
         | appendcols
         [
         | pivot `uA_DM_Citrix_Applications` Citrix_Applications
            values(TagsSplit) as TagsSplit
            splitrow
               Id
            filter Enabled is "1"
            filter SiteGuid is $SiteFilterString|s$
            filter DesktopGroupId is $DeliveryGroupFilterString|s$
         | search 
            ([| makeresults | eval SubsearchFilter = if ("$TagFilterString$" = "*", "(NOT TagsSplit = \"*\") OR TagsSplit = \"*\"", "TagsSplit = \"$TagFilterString$\"") | return $SubsearchFilter])
         | stats
            dc(Id) as PublishedAppCount
         ]
         | appendcols
         [
         | pivot `uA_DM_Citrix_PublishedDesktops` Citrix_PublishedDesktops
            values(TagsSplit) as TagsSplit
            splitrow
               Id
            filter Enabled is "1"
            filter SiteGuid is $SiteFilterString|s$
            filter DesktopGroupId is $DeliveryGroupFilterString|s$
         | search 
            ([| makeresults | eval SubsearchFilter = if ("$TagFilterString$" = "*", "(NOT TagsSplit = \"*\") OR TagsSplit = \"*\"", "TagsSplit = \"$TagFilterString$\"") | return $SubsearchFilter])
         | stats
            dc(Id) as PublishedDesktopCount
         ]
      </query>
   </search>
   
   <!-- Row 1 -->
   <row>
      <panel>
         <title>Overview</title>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">SiteCount</option>
            <option name="uberAgent.uberagent-singlevalue.1-title">#Sites:</option>
            <option name="uberAgent.uberagent-singlevalue.1-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.2-field">DeliveryGroupCount</option>
            <option name="uberAgent.uberagent-singlevalue.2-title">#Delivery groups:</option>
            <option name="uberAgent.uberagent-singlevalue.2-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.3-field">PublishedAppCount</option>
            <option name="uberAgent.uberagent-singlevalue.3-title">#Published applications (enabled):</option>
            <option name="uberAgent.uberagent-singlevalue.3-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.4-field">PublishedDesktopCount</option>
            <option name="uberAgent.uberagent-singlevalue.4-title">#Published desktops (enabled):</option>
            <option name="uberAgent.uberagent-singlevalue.4-afterLabel"></option>
         </viz>
      </panel>
   </row>

   <!-- Row 2 -->
   <row>

      <!-- Column 1 -->
      <panel>
         <title>Published applications</title>
         <table>
            <search>
               <query>
                  | pivot `uA_DM_Citrix_Applications` Citrix_Applications
                     latest(Name) as Name
                     latest(DesktopGroupName) as "Delivery group"
                     latest(DesktopGroupId) as DesktopGroupId
                     latest(Enabled) as Enabled
                     values(TagsSplit) as TagsSplit
                     latest(ApplicationTypeDisplayName) as "Type"
                     latest(AdminFolder) as "Admin folder"
                     latest(ApplicationGroupName) as "Application group"
                     splitrow
                        Id
                     filter SiteGuid is $SiteFilterString|s$
                     filter DesktopGroupId is $DeliveryGroupFilterString|s$
                  | search 
                     ([| makeresults | eval SubsearchFilter = if ("$TagFilterString$" = "*", "(NOT TagsSplit = \"*\") OR TagsSplit = \"*\"", "TagsSplit = \"$TagFilterString$\"") | return $SubsearchFilter])
                  | eval Tags = mvjoin (TagsSplit, ", ")
                  | eval "Application group" = split('Application group', ";")
                  | eval "Delivery group" = split('Delivery group', ";")
                  | eval sortfield = lower (Name)
                  | sort sortfield
                  | table
                     DesktopGroupId
                     Name
                     "Delivery group"
                     "Application group"
                     Enabled
                     Tags
                     Type
                     "Admin folder"
               </query>
            </search>
            <fields>Name, "Delivery group", "Application group", Enabled, Tags, Type, "Admin folder"</fields>
            <option name="count">10</option>
            <option name="drilldown">row</option>
            <drilldown>
               <set token="DrilldownFilterBy3Type">application</set>
               <set token="DrilldownFilterBy3Name">$row.Name$</set>
               <set token="DrilldownFilterBy3DGName">$row.Delivery group$</set>
               <set token="DrilldownFilterBy3DGValue">$row.DesktopGroupId$</set>
            </drilldown>
         </table>
      </panel>

      <!-- Column 2 -->
      <panel>
         <title>Published desktops</title>
         <table>
            <search>
               <query>
                  | pivot `uA_DM_Citrix_PublishedDesktops` Citrix_PublishedDesktops
                     latest(Name) as Name
                     latest(DesktopGroupName) as "Delivery group"
                     latest(DesktopGroupId) as DesktopGroupId
                     latest(Enabled) as Enabled
                     values(TagsSplit) as TagsSplit
                     latest(IncludedUserFilterEnabled) as IncludedUserFilterEnabled
                     values(IncludedUsers) as IncludedUsers
                     splitrow
                        Id
                     filter SiteGuid is $SiteFilterString|s$
                     filter DesktopGroupId is $DeliveryGroupFilterString|s$
                  | search 
                     ([| makeresults | eval SubsearchFilter = if ("$TagFilterString$" = "*", "(NOT TagsSplit = \"*\") OR TagsSplit = \"*\"", "TagsSplit = \"$TagFilterString$\"") | return $SubsearchFilter])
                  | eval Tags = mvjoin (TagsSplit, ", ")
                  | eval "Excluded users" = if (ExcludedUserFilterEnabled = "1", mvjoin (ExcludedUsers, ", "), "[none]")
                  | eval "Included users" = if (IncludedUserFilterEnabled = "1", mvjoin (IncludedUsers, ", "), "[all]")
                  | eval sortfield = lower (Name)
                  | sort sortfield
                  | table
                     DesktopGroupId
                     Name
                     "Delivery group"
                     Enabled
                     Tags
                     "Excluded users"
                     "Included users"
               </query>
            </search>
            <fields>Name, "Delivery group", Enabled, Tags, "Excluded users", "Included users"</fields>
            <option name="count">10</option>
            <option name="drilldown">row</option>
            <drilldown>
               <set token="DrilldownFilterBy3Type">desktop</set>
               <set token="DrilldownFilterBy3Name">$row.Name$</set>
               <set token="DrilldownFilterBy3DGName">$row.Delivery group$</set>
               <set token="DrilldownFilterBy3DGValue">$row.DesktopGroupId$</set>
            </drilldown>
         </table>
      </panel>
   </row>

   <row depends="$DrilldownFilterBy3Type$">
      <panel>
         <title>Machine detail for selected $DrilldownFilterBy3Type$ $DrilldownFilterBy3Name$ (delivery group = $DrilldownFilterBy3DGName$)</title>
         <table>
            <search>
               <query>
                  | pivot `uA_DM_Citrix_Machines` Citrix_Machines
                     latest(IsRegistered) as "Registered?"
                     latest(IsInMaintenanceMode) as "Maint. mode?"
                     latest(EffectiveLoadIndex) as "Load index"
                     latest(CurrentSessionCount) as "#Sessions"
                     latest(CPUCoresLogical) as "#CPU cores"
                     latest(RAMSizeGB) as "RAM (GB)"
                     latest(HwIsVirtualMachine) as "Is VM?"
                     latest(HwHypervisorVendor) as "Hypervisor"
                     latest(HwModel) as "Hardware model"
                     latest(OsVersion) as "OS version #"
                     latest(OsBuild) as "OS build #"
                     latest(AgentVersion) as "VDA version"
                     values(TagsSplit) as TagsSplit
                     splitrow
                        NameHost as Name
                     filter DesktopGroupId is $DrilldownFilterBy3DGValue|s$
                     filter SiteGuid is $SiteFilterString|s$
                  | search 
                     ([| makeresults | eval SubsearchFilter = if ("$TagFilterString$" = "*", "(NOT TagsSplit = \"*\") OR TagsSplit = \"*\"", "TagsSplit = \"$TagFilterString$\"") | return $SubsearchFilter])
                  | eval Tags = mvjoin (TagsSplit, ", ")
                  | table
                     Name
                     "Registered?"
                     "Maint. mode?"
                     "Load index"
                     "#Sessions"
                     "#CPU cores"
                     "RAM (GB)"
                     "Is VM?"
                     "Hypervisor"
                     "Hardware model"
                     "OS version #"
                     "OS build #"
                     "VDA version"
                     Tags
               </query>
            </search>
            <option name="count">10</option>
            <option name="drilldown">row</option>
            <drilldown>
               <link>
                  <![CDATA[
                     single_machine_detail?earliest=$earliest$&latest=$latest$&form.FilterField=shost&form.FilterOperator=in&form.FilterExpression=$click.value$
                  ]]>
               </link>
            </drilldown>
         </table>
      </panel>
   </row>

</form>
