<?xml version='1.0' encoding='utf-8'?>
<form version="1.1" script="main.js, session_logoff_time.js" stylesheet="main.css">

   <label>User Logoff Duration</label>
   <description>This dashboard displays information about the duration of user logoffs.</description>

   <fieldset autoRun="true">
      <input type="time" searchWhenChanged="true">
         <label>Time range:</label>
         <default>
            <earliest>-1h</earliest>
            <latest>now</latest>
         </default>
         <change>
            <eval token="TimeRangePickerSpan">relative_time(now(), latest) - relative_time(now(), earliest)</eval>
            <eval token="PivotPeriodAutoSolo">case('TimeRangePickerSpan' &lt; 350000, "auto", 'TimeRangePickerSpan' &lt; 610000, "hour", 1=1, "auto")</eval>
            <eval token="PivotPeriodAutoTimechart">case('TimeRangePickerSpan' &lt; 1200, "second", 'TimeRangePickerSpan' &lt; 300000, "minute", 'TimeRangePickerSpan' &lt; 700000, "hour", 1=1, "day")</eval>
         </change>
      </input>
      <input type="dropdown" token="FilterField" id="Input_FilterField">
         <label>Filter field:</label>
      </input>
      <input type="dropdown" token="FilterOperator" id="Input_FilterOperator">
         <label>Filter operator:</label>
      </input>
      <input type="text" token="FilterExpression" id="Input_FilterExpression">
         <label>Filter expression:</label>
         <default>*</default>
      </input>
      <input type="dropdown" token="FilterField2" id="Input_FilterField2" depends="$FilterLevel2$">
      </input>
      <input type="dropdown" token="FilterOperator2" id="Input_FilterOperator2" depends="$FilterLevel2$">
      </input>
      <input type="text" token="FilterExpression2" id="Input_FilterExpression2" depends="$FilterLevel2$">
      </input>
      <input type="dropdown" token="FilterField3" id="Input_FilterField3" depends="$FilterLevel3$">
      </input>
      <input type="dropdown" token="FilterOperator3" id="Input_FilterOperator3" depends="$FilterLevel3$">
      </input>
      <input type="text" token="FilterExpression3" id="Input_FilterExpression3" depends="$FilterLevel3$">
      </input>
      <input type="dropdown" token="FilterField4" id="Input_FilterField4" depends="$FilterLevel4$">
      </input>
      <input type="dropdown" token="FilterOperator4" id="Input_FilterOperator4" depends="$FilterLevel4$">
      </input>
      <input type="text" token="FilterExpression4" id="Input_FilterExpression4" depends="$FilterLevel4$">
      </input>
      <input type="dropdown" token="FilterField5" id="Input_FilterField5" depends="$FilterLevel5$">
      </input>
      <input type="dropdown" token="FilterOperator5" id="Input_FilterOperator5" depends="$FilterLevel5$">
      </input>
      <input type="text" token="FilterExpression5" id="Input_FilterExpression5" depends="$FilterLevel5$">
      </input>
      <input type="dropdown" token="FilterField6" id="Input_FilterField6" depends="$FilterLevel6$">
      </input>
      <input type="dropdown" token="FilterOperator6" id="Input_FilterOperator6" depends="$FilterLevel6$">
      </input>
      <input type="text" token="FilterExpression6" id="Input_FilterExpression6" depends="$FilterLevel6$">
      </input>
      <input type="text" token="FilterLevels" id="Input_FilterLevels" depends="$FilterLevels_Hidden$">
      </input>
      <input type="text" token="FilterDatamodel" id="Input_FilterDatamodel" depends="$FilterDatamodel_Hidden$">
         <default>Logoff_LogoffDetail</default>
      </input>
   </fieldset>

   <search id="Search_Single">
      <query>
         | pivot `uA_DM_Logoff_LogoffDetail` Logoff_LogoffDetail
            avg(TotalLogoffTimeMs) as AvgTotalLogoffTimeMs
            avg(ProfileUnloadTimeMs) as AvgProfileUnloadTimeMs
            avg(GroupPolicyLogoffScriptTimeMs) as AvgGroupPolicyLogoffScriptTimeMs
            filter
               TotalLogoffTimeMs is "*"
            $SearchFilter$
         | eval AvgTotalLogoffTimeSRounded = if(isnull(AvgTotalLogoffTimeMs), "n/a", round(AvgTotalLogoffTimeMs/1000,2))
         | eval AvgProfileUnloadTimeSRounded = if(isnull(AvgProfileUnloadTimeMs), "n/a", round(AvgProfileUnloadTimeMs/1000,2))
         | eval AvgGroupPolicyLogoffScriptTimeSRounded = if(isnull(AvgGroupPolicyLogoffScriptTimeMs), "n/a", round(AvgGroupPolicyLogoffScriptTimeMs/1000,2))
      </query>
   </search>
   
   <!-- Row 1 -->
   <row>
      <panel>
         <title>Averages for all logoffs</title>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">AvgTotalLogoffTimeSRounded</option>
            <option name="uberAgent.uberagent-singlevalue.1-title">Total duration:</option>
            <option name="uberAgent.uberagent-singlevalue.1-afterLabel">s</option>
            <option name="uberAgent.uberagent-singlevalue.2-field">AvgProfileUnloadTimeSRounded</option>
            <option name="uberAgent.uberagent-singlevalue.2-title">User profile:</option>
            <option name="uberAgent.uberagent-singlevalue.2-afterLabel">s</option>
            <option name="uberAgent.uberagent-singlevalue.3-field">AvgGroupPolicyLogoffScriptTimeSRounded</option>
            <option name="uberAgent.uberagent-singlevalue.3-title">GP logoff script:</option>
            <option name="uberAgent.uberagent-singlevalue.3-afterLabel">s</option>
         </viz>
      </panel>
   </row>

   <!-- Row 2 -->
   <row>
      <panel>
         <title>Logoff duration over time</title>
         <chart id="Chart_Panel11">
            <search>
               <query>
                  | pivot `uA_DM_Logoff_LogoffDetail` Logoff_LogoffDetail
                     count(Logoff_LogoffDetail) as EventCount
                     sum(TotalLogoffTimeMs) as SumTotalLogoffTimeMs
                     sum(ProfileUnloadTimeMs) as SumProfileUnloadTimeMs
                     sum(GroupPolicyLogoffScriptTimeMs) as SumGroupPolicyLogoffScriptTimeMs
                     splitrow
                        _time
                        period $PivotPeriodAutoTimechart$
                     filter SessionLogoffTime is "*"
                     $SearchFilter$
                  | eval SumTotalLogoffTimeMs = coalesce(SumTotalLogoffTimeMs, 0)
                  | eval SumProfileUnloadTimeMs = coalesce(SumProfileUnloadTimeMs, 0)
                  | eval SumGroupPolicyLogoffScriptTimeMs = coalesce(SumGroupPolicyLogoffScriptTimeMs, 0)
                  | eval SumOtherMs = SumTotalLogoffTimeMs-SumProfileUnloadTimeMs-SumGroupPolicyLogoffScriptTimeMs
                  | eval SumOtherMs = if(SumOtherMs>0, SumOtherMs, 0)
                  | timechart
                     `uberAgent_dynamic_span`
                     eval(round(sum(SumOtherMs)/sum(EventCount)/1000,2)) as "Other (s)"
                     eval(round(sum(SumGroupPolicyLogoffScriptTimeMs)/sum(EventCount)/1000,2)) as "GP logoff script (s)"
                     eval(round(sum(SumProfileUnloadTimeMs)/sum(EventCount)/1000,2)) as "Profile unloading (s)"
               </query>
            </search>
            <option name="height">250</option>
            <option name="charting.chart">column</option>
            <option name="charting.chart.stackMode">stacked</option>
            <option name="charting.legend.placement">right</option>
            <option name="charting.axisY.includeZero">true</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
            <option name="charting.axisTitleY.visibility">collapsed</option>
            <option name="charting.drilldown">none</option>
         </chart>
      </panel>
   </row>

   <!-- Row 3 -->
   <row>

      <!-- Column 1 -->
      <panel>
         <title>Logoff duration per user (top 10)</title>
         <input type="dropdown" token="Panel31Function1" id="Input_Panel31Function1" searchWhenChanged="true">
            <choice value="avg">average</choice>
            <choice value="count">count</choice>
            <choice value="max">maximum</choice>
            <choice value="median">median</choice>
            <choice value="min">minimum</choice>
            <choice value="stdev">standard deviation</choice>
            <choice value="sum">sum</choice>
            <default>avg</default>
            <label>Function:</label>
            <prefix></prefix>
            <suffix></suffix>
         </input>
         <chart id="Chart_Panel31">
            <search>
               <query>
                  | pivot `uA_DM_Logoff_LogoffDetail` Logoff_LogoffDetail
                     $Panel31Function1$(TotalLogoffTimeMs) as "$Panel31Function1$(TotalLogoffTimeMs)"
                     latest(SessionGUID) as SessionGUID
                     $SearchFilter$
                     splitrow
                        User
                  | sort limit=10 - "$Panel31Function1$(TotalLogoffTimeMs)"
                  | eval "$Panel31Function1$(TotalLogoffTimeS) per user" = round ('$Panel31Function1$(TotalLogoffTimeMs)' / 1000, 2)
                  | fields
                     User
                     "$Panel31Function1$(TotalLogoffTimeS) per user"
               </query>
            </search>
            <option name="height">250</option>
            <option name="charting.chart">bar</option>
            <option name="charting.legend.placement">none</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
         </chart>
      </panel>

      <!-- Column 2 -->
      <panel>
         <title>Logoff duration per host (top 10)</title>
         <input type="dropdown" token="Panel32Function1" id="Input_Panel32Function1" searchWhenChanged="true">
            <choice value="avg">average</choice>
            <choice value="count">count</choice>
            <choice value="max">maximum</choice>
            <choice value="median">median</choice>
            <choice value="min">minimum</choice>
            <choice value="stdev">standard deviation</choice>
            <choice value="sum">sum</choice>
            <default>avg</default>
            <label>Function:</label>
            <prefix></prefix>
            <suffix></suffix>
         </input>
         <chart id="Chart_Panel32">
            <search>
               <query>
                  | pivot `uA_DM_Logoff_LogoffDetail` Logoff_LogoffDetail
                     $Panel32Function1$(TotalLogoffTimeMs) as "$Panel32Function1$(TotalLogoffTimeMs)"
                     latest(SessionGUID) as SessionGUID
                     $SearchFilter$
                     splitrow
                        host as Host
                  | sort limit=10 - "$Panel32Function1$(TotalLogoffTimeMs)"
                  | eval "$Panel32Function1$(TotalLogoffTimeS) per host" = round ('$Panel32Function1$(TotalLogoffTimeMs)' / 1000, 2)
                  | fields
                     Host
                     "$Panel32Function1$(TotalLogoffTimeS) per host"
               </query>
            </search>
            <option name="height">250</option>
            <option name="charting.chart">bar</option>
            <option name="charting.legend.placement">none</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
            <option name="charting.drilldown">none</option>
         </chart>
      </panel>
   </row>

   <!-- Row 4 -->
   <row>
      <panel>
         <title>Data table</title>
         <table id="Table_Panel41">
            <search>
               <query>
                  | pivot `uA_DM_Logoff_LogoffDetail` Logoff_LogoffDetail
                     latest(User) as User
                     latest(host) as Host
                     values(SessionLogoffTime) as SessionLogoffTime
                     sum(TotalLogoffTimeMs) as TotalLogoffTimeMs
                     sum(ProfileUnloadTimeMs) as ProfileUnloadTimeMs
                     sum(GroupPolicyLogoffScriptTimeMs) as GroupPolicyLogoffScriptTimeMs
                     splitrow
                        SessionGUID
                     filter SessionLogoffTime is "*"
                     $SearchFilter$
                  | eval "Logoff time"=strftime(strptime(SessionLogoffTime,"%Y-%m-%d %H:%M:%S.%Q %z"), "%Y-%m-%d %H:%M:%S")
                  | eval "Total duration"=round(TotalLogoffTimeMs/1000,2)
                  | eval "User profile"=round(ProfileUnloadTimeMs/1000,2)
                  | eval "GP logoff script"=round(GroupPolicyLogoffScriptTimeMs/1000,2)
                  | eval sortfield=lower('Logoff time')
                  | sort limit=0 -sortfield
                  | table
                     SessionGUID
                     User
                     Host
                     "Logoff time"
                     "Total duration"
                     "User profile"
                     "GP logoff script"
               </query>
            </search>
            <fields>User,Host,"Logoff time","Total duration","User profile","GP logoff script"</fields>
            <option name="count">50</option>
            <option name="drilldown">row</option>
         </table>

         <html src="session_logoff_time_explanation.html">
         </html>
      </panel>
   </row>

</form>
