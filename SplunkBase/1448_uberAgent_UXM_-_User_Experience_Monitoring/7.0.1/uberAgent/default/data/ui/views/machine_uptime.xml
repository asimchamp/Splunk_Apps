<?xml version='1.0' encoding='utf-8'?>
<form version="1.1" script="main.js" stylesheet="main.css">

   <label>Machine Uptime</label>
   <description>This dashboard shows each host's uptime (days since last boot).</description>

   <fieldset autoRun="true">
      <input type="time" id="TimeRange1" searchWhenChanged="true">
         <label>Time range:</label>
         <default>
            <earliest>-1h</earliest>
            <latest>now</latest>
         </default>
         <change>
            <eval token="TimeRangePickerSpan">relative_time(now(), latest) - relative_time(now(), earliest)</eval>
            <eval token="PivotPeriodAutoSolo">case('TimeRangePickerSpan' &lt; 350000, "auto", 'TimeRangePickerSpan' &lt; 610000, "hour", 1=1, "auto")</eval>
            <eval token="PivotPeriodAutoTimechart">case('TimeRangePickerSpan' &lt; 1200, "second", 'TimeRangePickerSpan' &lt; 300000, "minute", 'TimeRangePickerSpan' &lt; 700000, "hour", 1=1, "day")</eval>
         </change>
      </input>
      <input type="dropdown" token="FilterField" id="Input_FilterField">
         <label>Filter field:</label>
      </input>
      <input type="dropdown" token="FilterOperator" id="Input_FilterOperator">
         <label>Filter operator:</label>
      </input>
      <input type="text" token="FilterExpression" id="Input_FilterExpression">
         <label>Filter expression:</label>
         <default>*</default>
      </input>
      <input type="dropdown" token="FilterField2" id="Input_FilterField2" depends="$FilterLevel2$">
      </input>
      <input type="dropdown" token="FilterOperator2" id="Input_FilterOperator2" depends="$FilterLevel2$">
      </input>
      <input type="text" token="FilterExpression2" id="Input_FilterExpression2" depends="$FilterLevel2$">
      </input>
      <input type="dropdown" token="FilterField3" id="Input_FilterField3" depends="$FilterLevel3$">
      </input>
      <input type="dropdown" token="FilterOperator3" id="Input_FilterOperator3" depends="$FilterLevel3$">
      </input>
      <input type="text" token="FilterExpression3" id="Input_FilterExpression3" depends="$FilterLevel3$">
      </input>
      <input type="dropdown" token="FilterField4" id="Input_FilterField4" depends="$FilterLevel4$">
      </input>
      <input type="dropdown" token="FilterOperator4" id="Input_FilterOperator4" depends="$FilterLevel4$">
      </input>
      <input type="text" token="FilterExpression4" id="Input_FilterExpression4" depends="$FilterLevel4$">
      </input>
      <input type="dropdown" token="FilterField5" id="Input_FilterField5" depends="$FilterLevel5$">
      </input>
      <input type="dropdown" token="FilterOperator5" id="Input_FilterOperator5" depends="$FilterLevel5$">
      </input>
      <input type="text" token="FilterExpression5" id="Input_FilterExpression5" depends="$FilterLevel5$">
      </input>
      <input type="dropdown" token="FilterField6" id="Input_FilterField6" depends="$FilterLevel6$">
      </input>
      <input type="dropdown" token="FilterOperator6" id="Input_FilterOperator6" depends="$FilterLevel6$">
      </input>
      <input type="text" token="FilterExpression6" id="Input_FilterExpression6" depends="$FilterLevel6$">
      </input>
      <input type="text" token="FilterLevels" id="Input_FilterLevels" depends="$FilterLevels_Hidden$">
      </input>
      <input type="text" token="FilterDatamodel" id="Input_FilterDatamodel" depends="$FilterDatamodel_Hidden$">
         <default>System_MachineInventory</default>
      </input>
   </fieldset>

   <search id="Search_Single">
      <query>
         | pivot `uA_DM_Session_SessionDetail_Session0` Session_SessionDetail_Session0
            dc(host) as HostCount
            dc(HwModel) as HwModelCount
            $SearchFilter$
         | appendcols
         [
         | pivot `uA_DM_Session_SessionDetail_Session0` Session_SessionDetail_Session0
            latest(SessionLogonTime) as BootTime
            splitrow
               host as Host
            $SearchFilter$
         | eval BootTime = strptime (BootTime,"%Y-%m-%d %H:%M:%S.%Q %z")
         | eval Uptime = round ((now() - BootTime) / 86400, 2)
         | stats avg(Uptime) as AvgUptime
         | eval AvgUptime = round (AvgUptime, 1)
         ]
      </query>
   </search>
   
   <!-- Row 1 -->
   <row>
   
      <panel>
         <title>Overview</title>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">HostCount</option>
            <option name="uberAgent.uberagent-singlevalue.1-title">#Hosts</option>
            <option name="uberAgent.uberagent-singlevalue.1-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.2-field">HwModelCount</option>
            <option name="uberAgent.uberagent-singlevalue.2-title">#Hardware models</option>
            <option name="uberAgent.uberagent-singlevalue.2-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.3-field">AvgUptime</option>
            <option name="uberAgent.uberagent-singlevalue.3-title">Avg. uptime</option>
            <option name="uberAgent.uberagent-singlevalue.3-afterLabel">days</option>
         </viz>
      </panel>
      
   </row>

   <search id="Search_ByHardwareModel">
      <query>
         | pivot `uA_DM_Session_SessionDetail_Session0` Session_SessionDetail_Session0
            latest(SessionLogonTime) as BootTime
            latest($Panel21GroupBy$) as $Panel21GroupBy$
            splitrow
               host as Host
            $SearchFilter$
         | eval BootTime = strptime (BootTime,"%Y-%m-%d %H:%M:%S.%Q %z")
         | eval Uptime = round ((now() - BootTime) / 86400, 2)
         | stats
            avg(Uptime) as AvgUptime
            dc(Host) as "#Hosts"
            by $Panel21GroupBy$
         | rename $Panel21GroupBy$ as "$Panel31GroupByDisplay$"
         | eval "Avg. uptime (days)" = round (AvgUptime, 1)
      </query>
   </search>
   
   <!-- Row 2 -->
   <row>

      <panel>
         <title>Uptime grouped</title>
         <input type="dropdown" token="Panel21GroupBy" searchWhenChanged="true">
            <choice value="AdDomainDns">AD domain DNS</choice>
            <choice value="AdOu">AD OU</choice>
            <choice value="AdSite">AD site</choice>
            <choice value="CtxDeliveryGroupName">Citrix delivery group</choice>
            <choice value="CtxFarmName">Citrix site</choice>
            <choice value="CtxMachineCatalogName">Citrix machine catalog</choice>
            <choice value="HwManufacturer">Hardware manufacturer</choice>
            <choice value="HwModel">Hardware model</choice>
            <choice value="OsBuild">OS build number</choice>
            <choice value="OsType">OS type</choice>
            <choice value="OsVersion">OS version number</choice>
            <default>HwModel</default>
            <label>Group by:</label>
            <change>
               <condition value="*">
                  <set token="Panel31GroupByDisplay">$label$</set>
               </condition>
            </change>
         </input>
         <table>
            <search base="Search_ByHardwareModel">
               <query>
                  sort - "Avg. uptime (days)"
                  | table
                     "$Panel31GroupByDisplay$"
                     "#Hosts"
                     "Avg. uptime (days)"
               </query>
            </search>
            <option name="count">10</option>
            <option name="drilldown">none</option>
         </table>
      </panel>

      <panel>
         <title>Uptime by $Panel31GroupByDisplay$ (top 10)</title>
         <chart>
            <search base="Search_ByHardwareModel">
               <query>
                  sort limit=10 - "Avg. uptime (days)"
                  | fields
                     "$Panel31GroupByDisplay$"
                     "Avg. uptime (days)"
               </query>
            </search>
            <option name="height">250</option>
            <option name="charting.chart">bar</option>
            <option name="charting.legend.placement">bottom</option>
            <option name="charting.axisY.includeZero">true</option>
            <option name="charting.drilldown">none</option>
         </chart>
      </panel>

   </row>

   <!-- Row 3 -->
   <row>

      <panel>
         <title>Uptime by host</title>
         <table>
            <search>
               <query>
                  | pivot `uA_DM_Session_SessionDetail_Session0` Session_SessionDetail_Session0
                     latest(_time) as LastSeen
                     latest(SessionLogonTime) as BootTime
                     latest(HwModel) as "Hardware model"
                     splitrow
                        host as Host
                     $SearchFilter$
                  | eval BootTime = strptime (BootTime,"%Y-%m-%d %H:%M:%S.%Q %z")
                  | eval LastSeen = strptime (LastSeen, "%Y-%m-%dT%H:%M:%S.%Q%z")
                  | eval "Uptime (days)" = round ((now() - BootTime) / 86400, 1)
                  | eval "Last seen" = strftime (LastSeen, "%Y-%m-%d %H:%M:%S")
                  | eval "Last boot" = strftime (BootTime, "%Y-%m-%d %H:%M:%S")
                  | join type=outer Host
                     [
                        | pivot `uA_DM_Session_SessionDetail_Users` Session_SessionDetail_Users
                           latest(SessionLogonTime) as SessionLogonTime
                           splitrow
                              host as Host
                           $SearchFilter$
                        | eval "Last user logon"=strftime(strptime(SessionLogonTime,"%Y-%m-%d %H:%M:%S.%Q %z"), "%Y-%m-%d %H:%M:%S")
                        | eval SessionLogonTimeEpoch = strptime(SessionLogonTime,"%Y-%m-%d %H:%M:%S.%Q %z")
                        | fields + Host "Last user logon" SessionLogonTimeEpoch
                     ]
                  | eval "Last user logon (days)" = round ((now() - SessionLogonTimeEpoch) / 86400, 1)
                  | sort - "Uptime (days)"
                  | table
                     Host
                     "Hardware model"
                     "Uptime (days)"
                     "Last seen"
                     "Last boot"
                     "Last user logon"
                     "Last user logon (days)"
               </query>
            </search>
            <option name="count">50</option>
            <option name="drilldown">none</option>
         </table>
      </panel>

   </row>

</form>
