<?xml version='1.0' encoding='utf-8'?>
<form version="1.1" script="main.js" stylesheet="main.css">

   <label>Citrix Virtual Apps and Desktops Licensing</label>
   <description>This dashboard displays detailed information about Citrix Virtual Apps and Desktops licensing. It requires uberAgent to be installed on at least one delivery controller per site (Citrix Virtual Apps and Desktops 7.6 or newer). Supports on-premises installations only.</description>

   <fieldset autoRun="true">
      <input type="time" searchWhenChanged="true">
         <label>Time range:</label>
         <default>
            <earliest>-1d</earliest>
            <latest>now</latest>
         </default>
         <change>
            <eval token="TimeRangePickerSpan">relative_time(now(), latest) - relative_time(now(), earliest)</eval>
            <eval token="PivotPeriodAutoSolo">case('TimeRangePickerSpan' &lt; 350000, "auto", 'TimeRangePickerSpan' &lt; 610000, "hour", 1=1, "auto")</eval>
            <eval token="PivotPeriodAutoTimechart">case('TimeRangePickerSpan' &lt; 1200, "second", 'TimeRangePickerSpan' &lt; 300000, "minute", 'TimeRangePickerSpan' &lt; 700000, "hour", 1=1, "day")</eval>
         </change>
      </input>
   </fieldset>

   <search id="Search_Single">
      <query>
         | pivot `uA_DM_Citrix_Licenses` Citrix_Licenses
            dc(LicenseServerLower) as LicenseServerCount
            dc(LicenseProductName) as ProductCount
            dc(LicenseEdition) as ProductEditionCount
            dc(LicenseModel) as LicenseModelCount
            dc(LicenseType) as LicenseTypeCount
      </query>
   </search>
   
   <!-- Row 1 -->
   <row>
      <panel>
         <title>Overview</title>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">LicenseServerCount</option>
            <option name="uberAgent.uberagent-singlevalue.1-title">#License servers:</option>
            <option name="uberAgent.uberagent-singlevalue.1-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.2-field">ProductCount</option>
            <option name="uberAgent.uberagent-singlevalue.2-title">#Products:</option>
            <option name="uberAgent.uberagent-singlevalue.2-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.3-field">ProductEditionCount</option>
            <option name="uberAgent.uberagent-singlevalue.3-title">#Product editions:</option>
            <option name="uberAgent.uberagent-singlevalue.3-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.4-field">LicenseModelCount</option>
            <option name="uberAgent.uberagent-singlevalue.4-title">#License models:</option>
            <option name="uberAgent.uberagent-singlevalue.4-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.5-field">LicenseTypeCount</option>
            <option name="uberAgent.uberagent-singlevalue.5-title">#License types:</option>
            <option name="uberAgent.uberagent-singlevalue.5-afterLabel"></option>
         </viz>
      </panel>
   </row>

   <!-- Row 2 -->
   <row>

      <panel>
         <title>License usage over time</title>
         <input type="dropdown" token="DropdownLicensing" searchWhenChanged="true">
            <choice value="Available">Show available licenses</choice>
            <choice value="Consumed">Show consumed licenses</choice>
            <default>Show available licenses</default>
            <label>Show available or consumed licenses?</label>
            <allowCustomValues>false</allowCustomValues>
            <change>              
              <condition value="Available">
                 <set token="Chart_licensing_query">
                    | timechart `uberAgent_dynamic_span` latest(LicensesAvailable) by LicenseServerLower
                 </set>               
              </condition>
              <condition value="Consumed">
                 <set token="Chart_licensing_query">                  
                    | timechart `uberAgent_dynamic_span` latest(LicensesInUse) by LicenseServerLower
                 </set>               
              </condition>
            </change> 
         </input>
      <chart>
        <search>
          <query>
            | pivot `uA_DM_Citrix_Licenses` Citrix_Licenses 
               max(LicensesInUse) as MaxLicensesInUse
               max(LicensesAvailable) as MaxLicensesAvailable
               max(LicenseOverdraft) as MaxLicenseOverdraft
               splitrow 
                  _time
                     period $PivotPeriodAutoTimechart$
               splitrow 
                  LicenseServerLower
               splitrow 
                  LicenseProductNameDisplayName as Product
               splitrow
                  LicenseEditionDisplayName as ProductEdition
               splitrow
                  LicenseModelDisplayName as "License model"
               splitrow
                  LicenseTypeLocalized as "License type"
               splitrow 
                  LicenseSubscriptionAdvantageDate
            | stats 
               sum(MaxLicensesInUse) as LicensesInUse
               sum(MaxLicenseOverdraft) as LicenseOverdraft
               sum(MaxLicensesAvailable) as LicensesAvailable 
               by _time LicenseServerLower
            | eval LicensesInUse = LicensesInUse + LicenseOverdraft
            $Chart_licensing_query$
          </query>
        </search>
            <option name="height">250</option>
            <option name="charting.chart">line</option>
            <option name="charting.legend.placement">right</option>
            <option name="charting.axisY.includeZero">true</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
            <option name="charting.axisTitleY.text">count</option>
            <option name="charting.drilldown">none</option>
         </chart>
      </panel>
   </row>

   <!-- Row 3 -->
   <row>

      <panel>
         <title>Licenses</title>
         <table>
            <search>
               <query>
                  | pivot `uA_DM_Citrix_Licenses` Citrix_Licenses
                    latest(LicenseExpirationDate) as "Expiration date"
                    latest(LicenseSubscriptionAdvantageDate) as "SA date"
                    max(LicensesInUse) as MaxLicensesInUse
                    splitrow
                        LicenseServerLower as "License server"
                    splitrow
                        LicenseProductNameDisplayName as Product
                    splitrow
                        LicenseEditionDisplayName as ProductEdition
                    splitrow
                        LicenseModelDisplayName as "License model"
                    splitrow
                        LicenseTypeLocalized as "License type"
                    splitrow
                        LicenseOverdraft as Overdraft
                    splitrow
                        LicenseSubscriptionAdvantageDate
                    splitrow
                        LicensesAvailable as "Total licenses"               
                  | eval Product = Product . " " . ProductEdition
                  | eval "Max. used licenses" = round (MaxLicensesInUse, 0)
                  | table
                     "License server"
                     Product
                     "License model"
                     "License type"
                     "Max. used licenses"
                     "Total licenses"
                     Overdraft
                     "Expiration date"
                     "SA date"
               </query>
            </search>
            <option name="count">10</option>
            <option name="drilldown">none</option>
         </table>
      </panel>
   </row>

</form>
