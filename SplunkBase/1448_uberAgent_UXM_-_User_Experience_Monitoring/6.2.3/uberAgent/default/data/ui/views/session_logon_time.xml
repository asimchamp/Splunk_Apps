<?xml version='1.0' encoding='utf-8'?>
<form version="1.1" script="main.js, session_logon_time.js" stylesheet="main.css">

   <label>User Logon Duration</label>
   <description>This dashboard displays information about the duration of user logons.</description>

   <fieldset autoRun="true">
      <input type="time" searchWhenChanged="true">
         <label>Time range:</label>
         <default>
            <earliest>-1h</earliest>
            <latest>now</latest>
         </default>
         <change>
            <eval token="TimeRangePickerSpan">relative_time(now(), latest) - relative_time(now(), earliest)</eval>
            <eval token="PivotPeriodAutoSolo">case('TimeRangePickerSpan' &lt; 350000, "auto", 'TimeRangePickerSpan' &lt; 610000, "hour", 1=1, "auto")</eval>
            <eval token="PivotPeriodAutoTimechart">case('TimeRangePickerSpan' &lt; 1200, "second", 'TimeRangePickerSpan' &lt; 300000, "minute", 'TimeRangePickerSpan' &lt; 700000, "hour", 1=1, "day")</eval>
         </change>
      </input>
      <input type="dropdown" token="FilterField" id="Input_FilterField">
         <label>Filter field:</label>
      </input>
      <input type="dropdown" token="FilterOperator" id="Input_FilterOperator">
         <label>Filter operator:</label>
      </input>
      <input type="text" token="FilterExpression" id="Input_FilterExpression">
         <label>Filter expression:</label>
         <default>*</default>
      </input>
      <input type="dropdown" token="FilterField2" id="Input_FilterField2" depends="$FilterLevel2$">
      </input>
      <input type="dropdown" token="FilterOperator2" id="Input_FilterOperator2" depends="$FilterLevel2$">
      </input>
      <input type="text" token="FilterExpression2" id="Input_FilterExpression2" depends="$FilterLevel2$">
      </input>
      <input type="dropdown" token="FilterField3" id="Input_FilterField3" depends="$FilterLevel3$">
      </input>
      <input type="dropdown" token="FilterOperator3" id="Input_FilterOperator3" depends="$FilterLevel3$">
      </input>
      <input type="text" token="FilterExpression3" id="Input_FilterExpression3" depends="$FilterLevel3$">
      </input>
      <input type="dropdown" token="FilterField4" id="Input_FilterField4" depends="$FilterLevel4$">
      </input>
      <input type="dropdown" token="FilterOperator4" id="Input_FilterOperator4" depends="$FilterLevel4$">
      </input>
      <input type="text" token="FilterExpression4" id="Input_FilterExpression4" depends="$FilterLevel4$">
      </input>
      <input type="dropdown" token="FilterField5" id="Input_FilterField5" depends="$FilterLevel5$">
      </input>
      <input type="dropdown" token="FilterOperator5" id="Input_FilterOperator5" depends="$FilterLevel5$">
      </input>
      <input type="text" token="FilterExpression5" id="Input_FilterExpression5" depends="$FilterLevel5$">
      </input>
      <input type="dropdown" token="FilterField6" id="Input_FilterField6" depends="$FilterLevel6$">
      </input>
      <input type="dropdown" token="FilterOperator6" id="Input_FilterOperator6" depends="$FilterLevel6$">
      </input>
      <input type="text" token="FilterExpression6" id="Input_FilterExpression6" depends="$FilterLevel6$">
      </input>
      <input type="text" token="FilterLevels" id="Input_FilterLevels" depends="$FilterLevels_Hidden$">
      </input>
      <input type="text" token="FilterDatamodel" id="Input_FilterDatamodel" depends="$FilterDatamodel_Hidden$">
         <default>Logon_LogonDetail</default>
      </input>
   </fieldset>

   <search id="Search_Single">
      <query>
         | pivot `uA_DM_Logon_LogonDetail` Logon_LogonDetail
            avg(TotalLogonTimeMs) as AvgTotalLogonTimeMs
            avg(ProfileLoadTimeMs) as AvgProfileLoadTimeMs
            avg(GroupPolicyTotalProcessingTimeMs) as AvgGroupPolicyTotalProcessingTimeMs
            avg(ADLogonScriptTimeMs) as AvgADLogonScriptTimeMs
            avg(GroupPolicyLogonScriptTimeMs) as AvgGroupPolicyLogonScriptTimeMs
            avg(ShellStartupTimeMs) as AvgShellStartupTimeMs
            filter
               TotalLogonTimeMs is "*"
            $SearchFilter$
         | eval AvgTotalLogonTimeSRounded = if(isnull(AvgTotalLogonTimeMs), "n/a", round(AvgTotalLogonTimeMs/1000,2))
         | eval AvgProfileLoadTimeSRounded = if(isnull(AvgProfileLoadTimeMs), "n/a", round(AvgProfileLoadTimeMs/1000,2))
         | eval AvgGroupPolicyTotalProcessingTimeSRounded = if(isnull(AvgGroupPolicyTotalProcessingTimeMs), "n/a", round(AvgGroupPolicyTotalProcessingTimeMs/1000,2))
         | eval AvgADLogonScriptTimeSRounded = if(isnull(AvgADLogonScriptTimeMs), "n/a", round(AvgADLogonScriptTimeMs/1000,2))
         | eval AvgGroupPolicyLogonScriptTimeSRounded = if(isnull(AvgGroupPolicyLogonScriptTimeMs), "n/a", round(AvgGroupPolicyLogonScriptTimeMs/1000,2))
         | eval AvgShellStartupTimeSRounded = if(isnull(AvgShellStartupTimeMs), "n/a", round(AvgShellStartupTimeMs/1000,2))
      </query>
   </search>
   
   <!-- Row 1 -->
   <row>
      <panel>
         <title>Averages for all logons</title>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">AvgTotalLogonTimeSRounded</option>
            <option name="uberAgent.uberagent-singlevalue.1-title">Total duration:</option>
            <option name="uberAgent.uberagent-singlevalue.1-afterLabel">s</option>
            <option name="uberAgent.uberagent-singlevalue.2-field">AvgProfileLoadTimeSRounded</option>
            <option name="uberAgent.uberagent-singlevalue.2-title">User profile:</option>
            <option name="uberAgent.uberagent-singlevalue.2-afterLabel">s</option>
            <option name="uberAgent.uberagent-singlevalue.3-field">AvgGroupPolicyTotalProcessingTimeSRounded</option>
            <option name="uberAgent.uberagent-singlevalue.3-title">Group Policy:</option>
            <option name="uberAgent.uberagent-singlevalue.3-afterLabel">s</option>
            <option name="uberAgent.uberagent-singlevalue.4-field">AvgADLogonScriptTimeSRounded</option>
            <option name="uberAgent.uberagent-singlevalue.4-title">AD logon script:</option>
            <option name="uberAgent.uberagent-singlevalue.4-afterLabel">s</option>
            <option name="uberAgent.uberagent-singlevalue.5-field">AvgGroupPolicyLogonScriptTimeSRounded</option>
            <option name="uberAgent.uberagent-singlevalue.5-title">GP logon script:</option>
            <option name="uberAgent.uberagent-singlevalue.5-afterLabel">s</option>
            <option name="uberAgent.uberagent-singlevalue.6-field">AvgShellStartupTimeSRounded</option>
            <option name="uberAgent.uberagent-singlevalue.6-title">Shell start:</option>
            <option name="uberAgent.uberagent-singlevalue.6-afterLabel">s</option>
         </viz>
      </panel>
   </row>

   <!-- Row 2 -->
   <row>
      <panel>
         <title>Logon duration over time</title>
         <chart id="Chart_Panel11">
            <search>
               <query>
                  | pivot `uA_DM_Logon_LogonDetail` Logon_LogonDetail
                     count(Logon_LogonDetail) as EventCount
                     sum(TotalLogonTimeMs) as SumTotalLogonTimeMs
                     sum(ProfileLoadTimeMs) as SumProfileLoadTimeMs
                     sum(GroupPolicyTotalProcessingTimeMs) as SumGroupPolicyTotalProcessingTimeMs
                     sum(ADLogonScriptTimeMs) as SumADLogonScriptTimeMs
                     sum(GroupPolicyLogonScriptTimeMs) as SumGroupPolicyLogonScriptTimeMs
                     sum(ShellStartupTimeMs) as SumShellStartupTimeMs
                     splitrow
                        _time
                        period $PivotPeriodAutoTimechart$
                     filter SessionLogonTime is "*"
                     $SearchFilter$
                  | eval SumTotalLogonTimeMs = coalesce(SumTotalLogonTimeMs, 0)
                  | eval SumProfileLoadTimeMs = coalesce(SumProfileLoadTimeMs, 0)
                  | eval SumGroupPolicyTotalProcessingTimeMs = coalesce(SumGroupPolicyTotalProcessingTimeMs, 0)
                  | eval SumADLogonScriptTimeMs = coalesce(SumADLogonScriptTimeMs, 0)
                  | eval SumGroupPolicyLogonScriptTimeMs = coalesce(SumGroupPolicyLogonScriptTimeMs, 0)
                  | eval SumShellStartupTimeMs = coalesce(SumShellStartupTimeMs, 0)
                  | eval SumOtherMs = SumTotalLogonTimeMs-SumProfileLoadTimeMs-SumGroupPolicyTotalProcessingTimeMs-SumADLogonScriptTimeMs-SumGroupPolicyLogonScriptTimeMs-SumShellStartupTimeMs
                  | eval SumOtherMs = if(SumOtherMs>0, SumOtherMs, 0)
                  | timechart
                     `uberAgent_dynamic_span`
                     eval(round(sum(SumOtherMs)/sum(EventCount)/1000,2)) as "Other (s)"
                     eval(round(sum(SumShellStartupTimeMs)/sum(EventCount)/1000,2)) as "Shell startup (s)"
                     eval(round(sum(SumGroupPolicyLogonScriptTimeMs)/sum(EventCount)/1000,2)) as "GP logon script (s)"
                     eval(round(sum(SumADLogonScriptTimeMs)/sum(EventCount)/1000,2)) as "AD logon script (s)"
                     eval(round(sum(SumGroupPolicyTotalProcessingTimeMs)/sum(EventCount)/1000,2)) as "Group policy processing (s)"
                     eval(round(sum(SumProfileLoadTimeMs)/sum(EventCount)/1000,2)) as "Profile loading (s)"
               </query>
            </search>
            <option name="height">250</option>
            <option name="charting.chart">column</option>
            <option name="charting.chart.stackMode">stacked</option>
            <option name="charting.legend.placement">right</option>
            <option name="charting.axisY.includeZero">true</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
            <option name="charting.axisTitleY.visibility">collapsed</option>
            <option name="charting.drilldown">none</option>
         </chart>
      </panel>
   </row>

   <!-- Row 3 -->
   <row>

      <!-- Column 1 -->
      <panel>
         <title>Logon duration per user (top 10)</title>
         <input type="dropdown" token="Panel31Function1" id="Input_Panel31Function1" searchWhenChanged="true">
            <choice value="avg">average</choice>
            <choice value="count">count</choice>
            <choice value="max">maximum</choice>
            <choice value="median">median</choice>
            <choice value="min">minimum</choice>
            <choice value="stdev">standard deviation</choice>
            <choice value="sum">sum</choice>
            <default>avg</default>
            <label>Function:</label>
            <prefix></prefix>
            <suffix></suffix>
         </input>
         <chart id="Chart_Panel31">
            <search>
               <query>
                  | pivot `uA_DM_Logon_LogonDetail` Logon_LogonDetail
                     $Panel31Function1$(TotalLogonTimeMs) as "$Panel31Function1$(TotalLogonTimeMs)"
                     latest(SessionGUID) as SessionGUID
                     $SearchFilter$
                     splitrow
                        User
                  | sort limit=10 - "$Panel31Function1$(TotalLogonTimeMs)"
                  | eval "$Panel31Function1$(TotalLogonTimeS) per user" = round ('$Panel31Function1$(TotalLogonTimeMs)' / 1000, 2)
                  | fields
                     User
                     "$Panel31Function1$(TotalLogonTimeS) per user"
               </query>
            </search>
            <option name="height">250</option>
            <option name="charting.chart">bar</option>
            <option name="charting.legend.placement">none</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
         </chart>
      </panel>

      <!-- Column 2 -->
      <panel>
         <title>Logon duration per host (top 10)</title>
         <input type="dropdown" token="Panel32Function1" id="Input_Panel32Function1" searchWhenChanged="true">
            <choice value="avg">average</choice>
            <choice value="count">count</choice>
            <choice value="max">maximum</choice>
            <choice value="median">median</choice>
            <choice value="min">minimum</choice>
            <choice value="stdev">standard deviation</choice>
            <choice value="sum">sum</choice>
            <default>avg</default>
            <label>Function:</label>
            <prefix></prefix>
            <suffix></suffix>
         </input>
         <chart id="Chart_Panel32">
            <search>
               <query>
                  | pivot `uA_DM_Logon_LogonDetail` Logon_LogonDetail
                     $Panel32Function1$(TotalLogonTimeMs) as "$Panel32Function1$(TotalLogonTimeMs)"
                     latest(SessionGUID) as SessionGUID
                     $SearchFilter$
                     splitrow
                        host as Host
                  | sort limit=10 - "$Panel32Function1$(TotalLogonTimeMs)"
                  | eval "$Panel32Function1$(TotalLogonTimeS) per host" = round ('$Panel32Function1$(TotalLogonTimeMs)' / 1000, 2)
                  | fields
                     Host
                     "$Panel32Function1$(TotalLogonTimeS) per host"
               </query>
            </search>
            <option name="height">250</option>
            <option name="charting.chart">bar</option>
            <option name="charting.legend.placement">none</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
            <option name="charting.drilldown">none</option>
         </chart>
      </panel>
   </row>

   <!-- Row 4 -->
   <row>
      <panel>
         <title>Data table</title>
         <table id="Table_Panel41">
            <search>
               <query>
                  | pivot `uA_DM_Logon_LogonDetail` Logon_LogonDetail
                     latest(User) as User
                     latest(host) as Host
                     values(SessionLogonTime) as SessionLogonTime
                     sum(TotalLogonTimeMs) as TotalLogonTimeMs
                     sum(ProfileLoadTimeMs) as ProfileLoadTimeMs
                     sum(GroupPolicyTotalProcessingTimeMs) as GroupPolicyTotalProcessingTimeMs
                     sum(ADLogonScriptTimeMs) as ADLogonScriptTimeMs
                     sum(GroupPolicyLogonScriptTimeMs) as GroupPolicyLogonScriptTimeMs
                     sum(ShellStartupTimeMs) as ShellStartupTimeMs
                     splitrow
                        SessionGUID
                     filter SessionLogonTime is "*"
                     $SearchFilter$
                  | eval "Logon time"=strftime(strptime(SessionLogonTime,"%Y-%m-%d %H:%M:%S.%Q %z"), "%Y-%m-%d %H:%M:%S")
                  | eval "Total duration"=round(TotalLogonTimeMs/1000,2)
                  | eval "User profile"=round(ProfileLoadTimeMs/1000,2)
                  | eval "Group policy"=round(GroupPolicyTotalProcessingTimeMs/1000,2)
                  | eval "AD logon script"=round(ADLogonScriptTimeMs/1000,2)
                  | eval "GP logon script"=round(GroupPolicyLogonScriptTimeMs/1000,2)
                  | eval "Shell start"=round(ShellStartupTimeMs/1000,2)
                  | eval sortfield=lower('Logon time')
                  | sort limit=0 -sortfield
                  | table
                     SessionGUID
                     User
                     Host
                     "Logon time"
                     "Total duration"
                     "User profile"
                     "Group policy"
                     "AD logon script"
                     "GP logon script"
                     "Shell start"
               </query>
            </search>
            <fields>User,Host,"Logon time","Total duration","User profile","Group policy","AD logon script","GP logon script","Shell start"</fields>
            <option name="count">50</option>
            <option name="drilldown">row</option>
         </table>

         <html src="session_logon_time_explanation.html">
         </html>
      </panel>
   </row>

</form>
