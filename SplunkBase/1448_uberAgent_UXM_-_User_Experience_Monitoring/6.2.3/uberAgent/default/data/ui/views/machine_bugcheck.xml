<?xml version='1.0' encoding='utf-8'?>
<form version="1.1" script="main.js" stylesheet="main.css">

   <label>Stop Errors (Blue Screen &amp; Power Loss)</label>
   <description>This dashboard displays detailed information about three different types of stop errors: blue screen of death, hard power off and random restart. A blue screen is displayed when the system detects it cannot continue due to an error condition and stops after collecting rudimentary information. A hard power off happens when the user presses and holds the power button for at least 4 seconds. A random restart may be due to power loss or a hard hang; in either case the system cannot generate a blue screen any more.</description>

   <fieldset autoRun="true">
      <input type="time" searchWhenChanged="true">
         <label>Time range:</label>
         <default>
            <earliest>-1d</earliest>
            <latest>now</latest>
         </default>
         <change>
            <eval token="TimeRangePickerSpan">relative_time(now(), latest) - relative_time(now(), earliest)</eval>
            <eval token="PivotPeriodAutoSolo">case('TimeRangePickerSpan' &lt; 350000, "auto", 'TimeRangePickerSpan' &lt; 610000, "hour", 1=1, "auto")</eval>
            <eval token="PivotPeriodAutoTimechart">case('TimeRangePickerSpan' &lt; 1200, "second", 'TimeRangePickerSpan' &lt; 300000, "minute", 'TimeRangePickerSpan' &lt; 700000, "hour", 1=1, "day")</eval>
         </change>
      </input>
      <input type="dropdown" token="FilterField" id="Input_FilterField">
         <label>Filter field:</label>
      </input>
      <input type="dropdown" token="FilterOperator" id="Input_FilterOperator">
         <label>Filter operator:</label>
      </input>
      <input type="text" token="FilterExpression" id="Input_FilterExpression">
         <label>Filter expression:</label>
         <default>*</default>
      </input>
      <input type="dropdown" token="FilterField2" id="Input_FilterField2" depends="$FilterLevel2$">
      </input>
      <input type="dropdown" token="FilterOperator2" id="Input_FilterOperator2" depends="$FilterLevel2$">
      </input>
      <input type="text" token="FilterExpression2" id="Input_FilterExpression2" depends="$FilterLevel2$">
      </input>
      <input type="dropdown" token="FilterField3" id="Input_FilterField3" depends="$FilterLevel3$">
      </input>
      <input type="dropdown" token="FilterOperator3" id="Input_FilterOperator3" depends="$FilterLevel3$">
      </input>
      <input type="text" token="FilterExpression3" id="Input_FilterExpression3" depends="$FilterLevel3$">
      </input>
      <input type="dropdown" token="FilterField4" id="Input_FilterField4" depends="$FilterLevel4$">
      </input>
      <input type="dropdown" token="FilterOperator4" id="Input_FilterOperator4" depends="$FilterLevel4$">
      </input>
      <input type="text" token="FilterExpression4" id="Input_FilterExpression4" depends="$FilterLevel4$">
      </input>
      <input type="dropdown" token="FilterField5" id="Input_FilterField5" depends="$FilterLevel5$">
      </input>
      <input type="dropdown" token="FilterOperator5" id="Input_FilterOperator5" depends="$FilterLevel5$">
      </input>
      <input type="text" token="FilterExpression5" id="Input_FilterExpression5" depends="$FilterLevel5$">
      </input>
      <input type="dropdown" token="FilterField6" id="Input_FilterField6" depends="$FilterLevel6$">
      </input>
      <input type="dropdown" token="FilterOperator6" id="Input_FilterOperator6" depends="$FilterLevel6$">
      </input>
      <input type="text" token="FilterExpression6" id="Input_FilterExpression6" depends="$FilterLevel6$">
      </input>
      <input type="text" token="FilterLevels" id="Input_FilterLevels" depends="$FilterLevels_Hidden$">
      </input>
      <input type="text" token="FilterDatamodel" id="Input_FilterDatamodel" depends="$FilterDatamodel_Hidden$">
         <default>System_Bugcheck</default>
      </input>
   </fieldset>

   <search id="Search_Single">
      <query>
         | pivot `uA_DM_System_Bugcheck` System_Bugcheck
            dc(host) as HostCount
            $SearchFilter$
         | appendcols
         [
         | pivot `uA_DM_System_Bugcheck` System_Bugcheck
            count(System_Bugcheck) as BugcheckCount
            dc(BugcheckCode) as BugcheckCodeCount
            filter BugcheckCode > 0
            $SearchFilter$
         ]
         | appendcols
         [
         | pivot `uA_DM_System_Bugcheck` System_Bugcheck
            count(System_Bugcheck) as HardPowerOffCount
            filter BugcheckCode = 0
            filter PowerButtonTimestamp > 0
            $SearchFilter$
         ]
         | appendcols
         [
         | pivot `uA_DM_System_Bugcheck` System_Bugcheck
            count(System_Bugcheck) as RandomRestartCount
            filter BugcheckCode = 0
            filter PowerButtonTimestamp = 0
            $SearchFilter$
         ]
      </query>
   </search>
      
   <!-- Row 1 -->
   <row>
      <panel>
         <title>Overview</title>
         <viz type="uberAgent.uberagent-singlevalue">
            <search base="Search_Single" />
            <option name="uberAgent.uberagent-singlevalue.1-field">BugcheckCount</option>
            <option name="uberAgent.uberagent-singlevalue.1-title">#Blue screens:</option>
            <option name="uberAgent.uberagent-singlevalue.1-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.2-field">HardPowerOffCount</option>
            <option name="uberAgent.uberagent-singlevalue.2-title">#Hard power offs:</option>
            <option name="uberAgent.uberagent-singlevalue.2-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.3-field">RandomRestartCount</option>
            <option name="uberAgent.uberagent-singlevalue.3-title">#Random restarts:</option>
            <option name="uberAgent.uberagent-singlevalue.3-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.4-field">HostCount</option>
            <option name="uberAgent.uberagent-singlevalue.4-title">#Affected hosts:</option>
            <option name="uberAgent.uberagent-singlevalue.4-afterLabel"></option>
            <option name="uberAgent.uberagent-singlevalue.5-field">BugcheckCodeCount</option>
            <option name="uberAgent.uberagent-singlevalue.5-title">#Blue screen error codes:</option>
            <option name="uberAgent.uberagent-singlevalue.5-afterLabel"></option>
         </viz>
      </panel>
   </row>

   <!-- Row 2 -->
   <row>
      <panel>
         <title>Stop error count over time</title>
         <chart>
            <search>
               <query>
                  | pivot `uA_DM_System_Bugcheck` System_Bugcheck
                     count(BugcheckCodeDisplayName) as "#Stop errors"
                     splitrow
                        _time
                        period $PivotPeriodAutoSolo$
                     splitcol
                        BugcheckCodeDisplayName
                     $SearchFilter$
               </query>
            </search>
            <option name="height">250</option>
            <option name="charting.chart">column</option>
            <option name="charting.chart.stackMode">stacked</option>
            <option name="charting.legend.placement">right</option>
            <option name="charting.axisY.includeZero">false</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
            <option name="charting.drilldown">none</option>
         </chart>
      </panel>
   </row>

   <!-- Row 3 -->
   <row>

      <!-- Column 1 -->
      <panel>
         <title>Stop errors per host (top 10)</title>
         <chart>
            <search>
               <query>
                  | pivot `uA_DM_System_Bugcheck` System_Bugcheck
                     count(System_Bugcheck) as "#Stop errors"
                     splitrow
                        host
                     $SearchFilter$
                  | sort limit=10 - "#Stop errors"
                  | fields
                     host
                     "#Stop errors"
               </query>
            </search>
            <option name="height">250</option>
            <option name="charting.chart">bar</option>
            <option name="charting.legend.placement">none</option>
            <option name="charting.axisTitleX.visibility">collapsed</option>
            <drilldown>
                <set token="DrilldownFilterBy3Field">host</set>
                <set token="DrilldownFilterBy3Label">Host</set>
                <set token="DrilldownFilterBy3Value">$click.value$</set>
            </drilldown>
         </chart>
      </panel>

      <!-- Column 2 -->
      <panel>
         <title>Stop errors grouped</title>
         <input type="dropdown" token="Panel32GroupBy" searchWhenChanged="true">
            <choice value="AdDomainDns">AD domain DNS</choice>
            <choice value="AdOu">AD OU</choice>
            <choice value="AdSite">AD site</choice>
            <choice value="CtxDeliveryGroupName">Citrix delivery group</choice>
            <choice value="CtxFarmName">Citrix site</choice>
            <choice value="CtxMachineCatalogName">Citrix machine catalog</choice>
            <choice value="HwManufacturer">Hardware manufacturer</choice>
            <choice value="HwModel">Hardware model</choice>
            <choice value="host">Host</choice>
            <choice value="OsBuild">OS build number</choice>
            <choice value="OsType">OS type</choice>
            <choice value="OsVersion">OS version number</choice>
            <choice value="BugcheckCodeDisplayName">Stop error</choice>
            <default>BugcheckCodeDisplayName</default>
            <label>Group by:</label>
            <change>
               <condition value="*">
                  <set token="Panel32GroupByDisplay">$label$</set>
                  <unset token="DrilldownFilterBy3Value"></unset>
               </condition>
            </change>
         </input>
         <table>
            <search>
               <query>
                  | pivot `uA_DM_System_Bugcheck` System_Bugcheck
                     count(System_Bugcheck) as "#Stop errors"
                     dc(host) as "#Hosts"
                     dc(BugcheckCodeDisplayName) as "#Stop error types"
                     splitrow
                        $Panel32GroupBy$ as "$Panel32GroupByDisplay$"
                     $SearchFilter$
                  | table
                     "$Panel32GroupByDisplay$"
                     "#Stop errors"
                     "#Stop error types"
                     "#Hosts"
               </query>
            </search>
            <option name="count">25</option>
            <option name="drilldown">row</option>
            <drilldown>
                <set token="DrilldownFilterBy3Field">$Panel32GroupBy$</set>
                <set token="DrilldownFilterBy3Label">$Panel32GroupByDisplay$</set>
                <set token="DrilldownFilterBy3Value">$click.value$</set>
            </drilldown>
         </table>
      </panel>
   </row>
      
   <row depends="$DrilldownFilterBy3Value$">
      <panel>
         <title>Stop error detail: $DrilldownFilterBy3Label$ = $DrilldownFilterBy3Value$</title>
         <table>
            <search>
               <query>
                  | pivot `uA_DM_System_Bugcheck` System_Bugcheck
                     latest(_time) as BugcheckTime
                     latest(BugcheckCodeDisplayName) as "Stop error"
                     latest(BugcheckCode) as "StopErrorCode"
                     latest(BugcheckParameter1) as "Param 1"
                     latest(BugcheckParameter2) as "Param 2"
                     latest(BugcheckParameter3) as "Param 3"
                     latest(BugcheckParameter4) as "Param 4"
                     latest(PowerButtonTimestampEpoch) as PowerButtonTimestamp
                     latest(SleepInProgress) as "Sleep in progress"
                     latest(SystemSleepTransitionsToOn) as "System sleep transitions to on"
                     latest(ConnectedStandbyInProgress) as "Conn. standby in progress"
                     splitrow
                        _time
                        period second
                     splitrow
                        host as Host
                     filter "$DrilldownFilterBy3Field$" is $DrilldownFilterBy3Value|s$
                     $SearchFilter$
                  | eval "Time" = strftime(strptime(BugcheckTime, "%Y-%m-%dT%H:%M:%S.%Q%z"), "%Y-%m-%d %H:%M:%S")
                  | eval PowerButtonTimestamp = PowerButtonTimestamp / 1000
                  | eval "Power button timestamp" = strftime(PowerButtonTimestamp, "%Y-%m-%d %H:%M:%S")
                  | eval "Stop error code" = tostring(StopErrorCode, "hex")
                  | sort - _time
                  | table
                     Time
                     Host
                     "Stop error"
                     "Stop error code"
                     "Param 1"
                     "Param 2"
                     "Param 3"
                     "Param 4"
                     "Power button timestamp"
                     "Sleep in progress"
                     "System sleep transitions to on"
                     "Conn. standby in progress"
               </query>
            </search>
            <option name="count">50</option>
            <option name="drilldown">none</option>
         </table>
      </panel>
   </row>

</form>
