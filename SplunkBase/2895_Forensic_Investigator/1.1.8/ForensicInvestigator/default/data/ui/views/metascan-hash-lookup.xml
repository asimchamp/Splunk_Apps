<form stylesheet="custom.css">
  <label>Metascan Hash Lookup</label>
  <searchTemplate>| script reputation __EXECUTE__ metascan hash "$search_hash_url$" | spath input=ms</searchTemplate>
  <description>Enter the MD5 hash below.  Ex:  57f222d8fbe0e290b4bf8eaa994ac641.  Limit 1500 hash scans per hour.</description>
  <!-- Add time range picker -->
  <fieldset autoRun="True" submitButton="true">
    <!-- Add Wildcard Filter -->
    <input type="text" token="search_hash_url" searchWhenChanged="true">
      <label>Hash</label>
      <default>$url:UrlHash$</default>
    </input>
  </fieldset>
  <row>
    <panel>
      <single>
        <title>Metascan Hits</title>
        <search base="global">
          <query>| rex field=ms "(?:.*\"scan_details\":\s\{)(?P&lt;scan_details&gt;(.*))(?=(},.*))" | rex max_match=70 field=scan_details "(?P&lt;json_field&gt;\".*?\".*?{.*?})," | mvexpand json_field | spath input=json_field | rex max_match=70 field=json_field "(?:\"scan_result_i\":\s+)(?P&lt;Detected&gt;\d+)" | eval Detected=case(Detected=="0","Clean",Detected=="1", "Known Malware", Detected=="2","Suspicious",Detected=="3", "Failed to Scan",Detected=="5","Unknown") | rex field=ms "(?:\"total_avs\":\s)(?P&lt;total_engines&gt;\d+)" | where Detected="Known Malware" OR Detected="Suspicious" | stats count as Hits, first(total_engines) AS Engines by Detected | eval known=if(Detected=="Known Malware",Hits,0) | eval sus=if(Detected=="Suspicious",Hits,0) | stats sum(known) as pos sum(sus) as sus first(Engines) as Engines | eval total=pos+sus | eval misses=Engines-total | table total</query>
        </search>
        <option name="linkView">search</option>
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="numberPrecision">0</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Metascan Misses</title>
        <search base="global">
          <query>rex field=ms "(?:.*\"scan_details\":\s\{)(?P&lt;scan_details&gt;(.*))(?=(},.*))" | rex max_match=70 field=scan_details "(?P&lt;json_field&gt;\".*?\".*?{.*?})," | mvexpand json_field | spath input=json_field | rex max_match=70 field=json_field "(?:\"scan_result_i\":\s+)(?P&lt;Detected&gt;\d+)" | eval Detected=case(Detected=="0","Clean",Detected=="1", "Known Malware", Detected=="2","Suspicious",Detected=="3", "Failed to Scan",Detected=="5","Unknown") | rex field=ms "(?:\"total_avs\":\s)(?P&lt;total_engines&gt;\d+)" | where Detected="Known Malware" OR Detected="Suspicious" | stats count as Hits, first(total_engines) AS Engines by Detected | eval known=if(Detected=="Known Malware",Hits,0) | eval sus=if(Detected=="Suspicious",Hits,0) | stats sum(known) as pos sum(sus) as sus first(Engines) as Engines | eval total=pos+sus | eval misses=Engines-total | table misses</query>
        </search>
        <option name="linkView">search</option>
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="numberPrecision">0</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <single>
        <title>Total Engines</title>
        <search base="global">
          <query>| rex field=ms "(?:\"total_avs\":\s)(?P&lt;total_engines&gt;\d+)" | table total_engines</query>
        </search>
        <option name="linkView">search</option>
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="colorBy">value</option>
        <option name="colorMode">none</option>
        <option name="numberPrecision">0</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="useColors">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <chart>
        <title>Metascan Percentage</title>
        <search base="global">
          <query>|  rex field=ms "(?:.*\"scan_details\":\s\{)(?P&lt;scan_details&gt;(.*))(?=(},.*))" | rex max_match=70 field=scan_details "(?P&lt;json_field&gt;\".*?\".*?{.*?})," | mvexpand json_field | spath input=json_field | rex max_match=70 field=json_field "(?:\"scan_result_i\":\s+)(?P&lt;Detected&gt;\d+)" |eval Detected=case(Detected=="0","Clean",Detected=="1", "Known Malware", Detected=="2","Suspicious",Detected=="3", "Failed to Scan",Detected=="5","Unknown") | rex field=ms "(?:\"total_avs\":\s)(?P&lt;total_engines&gt;\d+)" | where Detected="Known Malware" OR Detected="Suspicious" | stats count as Hits, first(total_engines) AS Engines by Detected |eval known=if(Detected=="Known Malware",Hits,0) | eval sus=if(Detected=="Suspicious",Hits,0) | stats sum(known) as pos sum(sus) as sus first(Engines) as Engines | eval total=pos+sus |eval misses=Engines-total | eval hit_percentage=(total/Engines)*100 | eval hit_percentage=round(hit_percentage,0) | eval hit_pecentage=coalesce(hit_percentage,0) | eval miss_percentage=100-hit_percentage| eval miss_percentage=coalesce(miss_percentage,0) | table hit_percentage,miss_percentage | rename miss_percentage AS "AVs Missed", hit_percentage AS "AVs Flagged" | transpose</query>
        </search>
        <option name="height">80</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.chart.showLabels">true</option>
        <option name="charting.chart.showpercent">true</option>
        <option name="charting.fieldColors">{HitPercentage:0xFA0000,MissPercentage:0xB7B7B7}</option>
        <option name="list.drilldown">full</option>
        <option name="list.wrap">1</option>
        <option name="maxLines">5</option>
        <option name="raw.drilldown">full</option>
        <option name="rowNumbers">false</option>
        <option name="table.drilldown">all</option>
        <option name="table.wrap">1</option>
        <option name="type">list</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">none</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>File Type Info</title>
        <search base="global">
          <query>| rex field=ms "(?:.*\"scan_details\":\s\{)(?P&lt;scan_details&gt;(.*))(?=(},.*))" | table file_info.file_type_category,file_info.file_type_description, file_info.file_type_extension | rename file_info.file_type_category AS "Category", file_info.file_type_description AS "File Type", file_info.file_type_extension AS "Extension"</query>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="drilldown">cell</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>Metascan Hit Details</title>
        <search base="global">
          <query>| rex field=ms "(?:.*\"scan_details\":\s\{)(?P&lt;scan_details&gt;(.*))(?=(},.*))" | rex max_match=70 field=scan_details "(?P&lt;json_field&gt;\".*?\".*?{.*?})," | mvexpand json_field | spath input=json_field | rex max_match=70 field=json_field "(?:\"scan_result_i\":\s+)(?P&lt;Detected&gt;\d+)" | eval Detected=case(Detected=="0","Clean",Detected=="1", "Known Malware", Detected=="2","Suspicious",Detected=="3", "Failed to Scan", Detected=="4","Cleaned", Detected=="5","Unknown", Detected=="6","Quarantined", Detected=="7","Skipped Clean", Detected=="8","Skipped Dirty",Detected=="9","Exceeded Archive Depth",Detected=="10","Not Scanned",Detected=="11","Aborted",Detected=="12","Encrypted",Detected=="13","Exceeded Archive Size",Detected=="14","Exceeded Archive File Number") | rex max_match=70 field=json_field "\"(?&lt;Scanner&gt;.*?)\".*?{" | rex max_match=70 field=json_field "(?:\"def_time\":\s+\")(?P&lt;Definition_Date&gt;.*?[^\"]+)" | rex max_match=70 field=json_field "(?:\"threat_found\":\s+)(?P&lt;Threat&gt;.*?)," | eval Threat=if(Threat=="\"\"","Not Found",Threat) | table Scanner, Detected, Threat, Definition_Date | rename Definition_Date AS "Definition Date" | sort +Detected</query>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="count">70</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table>
        <title>Metascan Raw Response</title>
        <search base="global">
          <query>table ms | rename ms AS "Response"</query>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="count">70</option>
      </table>
    </panel>
  </row>
</form>