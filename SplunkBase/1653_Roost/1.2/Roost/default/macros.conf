[nest]
definition = eventtype=nest_base

[CTF(1)]
args = C
definition = "$C$ * 1.8 + 32"
iseval = true

[FTC(1)]
args = F
definition = if(1=1,($F$ - 32) / 1.8,0)
iseval = true

[nest_device_lookup_gen]
definition = `nest` | eval name = if(len(name)<1,"device.".serial_number,name) | stats count by name serial_number mac_address local_ip | fields - count| outputlookup nest_devices

[temp_base]
definition = eventtype=temperature_base

[inside_vs_outside_temp_rh(1)]
args = time_span
definition = `temp_base` | timechart span=$time_span$ avg(current_temperature) as "Inside Temperature (F)" avg(temp_f) as "Outside Temperature (F)" avg(relative_humidity) as "Outside Humidity (%)" avg(current_humidity) as "Inside Humidity (%)"

[leaf_status]
definition = earliest=-1w@w index=summary m="leaf_status" |append [ search earliest=@d+1m `nest` | `leaf_status_calc` ]| rangemap field=perc severe=0-9 medium=10-39 low=40-100 default=severe | eval md = if (month_day < 10, "0".month_day,month_day)|eval month=strftime(_time,"%m") |  eval rk = month."/".md.", ".weekday| xyseries rk range perc | sort  rk | fields rk low medium severe

[leaf_status_gen]
definition = earliest=-1d@d+1m latest=@d-1m `nest` | `leaf_status_calc` | eval m="leaf_status" | collect index=summary

[devices_table]
definition = inputlookup nest_devices | table name serial_number local_ip mac_address | rename name AS Name | rename serial_number as "S/N" | rename local_ip as "IP Address" | rename mac_address AS "MAC"

[energy_data_graph]
definition = index=summary earliest=-12w@w latest=+1w@w m="system_state" NOT (sys_op=* OR off=*) | eval total = if(isnotnull(fan),0,0) + if(isnotnull(heat),heat,0) + if(isnotnull(cool),cool,0) | timechart span=1h sum(total) as t | convert auto(_time) as ttime | fields ttime t | fields - _time | fillnull value=0 t

[multi_structures_table]
definition = inputlookup nest_structure | eval home_name = name | lookup nest_devices serial_number | eval home_key = home_name.":".postal_code | fields home_key home_name house_type local_ip mac_address measurement_scale name num_thermostats postal_code renovation_date serial_number structure_area | fillnull value="unknown"

[system_state_device(2)]
args = time_span, device_serial
definition = index=summary m="system_state" serial_number="$device_serial$"| timechart span=$time_span$ sum(heat) as Heating sum(cool) as Cooling sum(fan) as Fan

[temperature_diff(1)]
args = device_serial
definition = earliest=-7d@d serial_number="$device_serial$" OR device_name="$device_serial$" `nest` | eval ftt = `CTF(target_temperature)` | eval fct =  `CTF(current_temperature)`  |eval td = ftt - fct| timechart span=30m avg(td) as td  | timewrap 1d | rename td_*days_before AS "* Days Ago" | rename td_*day_before AS "* Day Ago" | rename td_latest_day AS "Today"

[current_state]
definition = marker="status" `nest` | eval ls = if(leaf=="True","Yes","No")| eval sys_op = if(hvac_heater_state=="True","Heating",if(hvac_ac_state=="True","Cooling",if(fan_control_state=="True","Fan","Off")))|eval current_temperature = if(temperature_scale=="F",`CTF(current_temperature)`,current_temperature)|eval target_temperature = if(temperature_scale=="F",`CTF(target_temperature)`,target_temperature) | eval txn_sn = serial_number |eval txn_device_name = if(len(device_name)<1,"device.".serial_number,device_name) | append [ search marker="structure" `nest` | eval serial_number = split(devices,"|") | mvexpand serial_number | eval txn_sn = serial_number]  | transaction maxspan=2m txn_sn | stats latest(temp_f) as out_temp latest(current_temperature) as in_temp latest(target_temperature) as target_temp latest(humidity) as out_rh latest(current_humidity) as in_rh latest(sys_op) as system_state latest(ls) as leaf_state by serial_number txn_device_name | fillnull value="N/A"
iseval = 0

[time_temp(1)]
args = device_serial
definition = marker="status" serial_number="$device_serial$" OR device_name="$device_serial$" `nest` | eval current_temperature = if(temperature_scale=="F",`CTF(current_temperature)`,current_temperature)|eval target_temperature = if(temperature_scale=="F",`CTF(target_temperature)`,target_temperature) | eval txn_sn = serial_number |eval txn_device_name = device_name | append [ search marker="structure" devices="*$device_serial$*" `nest` | eval serial_number = split(devices,"|") | mvexpand serial_number | eval txn_sn = serial_number]  | transaction maxspan=1m txn_sn | timechart span=30m avg(temp_f) as "Outside Temp" avg(current_temperature) as "Inside Temp" avg(target_temperature) as "Target Temp" avg(humidity) as "Outside Humidity"  avg(current_humidity) as "Inside Humidity" | fillnull value="N/A"
iseval = 0 

[system_state_status_gen]
definition = earliest=-1h@h latest=@h marker="status" `nest` | bin _time span=1h|  eval sys_op = if(hvac_heater_state=="True","heat",if(hvac_ac_state=="True","cool",if(hvac_fan_state=="True","fan","off"))) | stats count as scount by sys_op _time serial_number name | eval m = "system_state" | eval {sys_op} = scount | fields - sys_op scount | collect index=summary
iseval = 0

[system_state(1)]
definition = index=summary m="system_state" | timechart span=$time_span$ sum(heat) as Heating sum(cool) as Cooling sum(fan) as Fan by name
iseval = 0

[system_state_onoff(1)]
args = time_span
definition = index=summary m="system_state" name=*| eval on = if(isnotnull(heat),heat,0) + if(isnotnull(cool),cool,0) + if(isnotnull(fan),fan,0) | timechart span=1d sum(on) as On by name
iseval = 0

[leaf_status_calc]
definition = eval leaf_value = if(leaf=="True",100,0) | bin _time span=1d | stats avg(leaf_value) as perc by date_wday date_mday date_month date_year name backplate_serial_number|rename backplate_serial_number as serial_number| rename date_wday AS weekday | rename date_mday as month_day | rename date_month as month | rename date_year as year
iseval = 0

[structures_table]
definition = inputlookup nest_structure | eval structure_area_sqft = if(measurement_scale=="imperial",structure_area * 10.7639,structure_area)|table name house_type num_thermostats renovation_date structure_area_sqft postal_code | rename postal_code as ZipCode | rename name as Name | rename house_type as "Type"|rename num_thermostats AS "Thermostats"|rename renovation_date AS "Built" | rename structure_area_sqft as "Area (sqft)"
iseval = 0

[nest_structure_lookup_gen]
definition = marker="structure" `nest` |makemv delim="|" devices | eval serial_number = devices |eval name= if(len(name)<1,serial_number,name)|stats latest(num_thermostats) as num_thermostats latest(renovation_date) as renovation_date latest(house_type) as house_type latest(country_code) as country_code  latest(structure_area) as structure_area latest(measurement_scale) as measurement_scale latest(postal_code) as postal_code by serial_number name | outputlookup nest_structure
iseval = 0

[schedules]
definition = marker=schedule `nest` |spath output=schedule_out path=schedule| stats latest(schedule_out) as schedule latest(schedule_mode) as mode by schedule_name
