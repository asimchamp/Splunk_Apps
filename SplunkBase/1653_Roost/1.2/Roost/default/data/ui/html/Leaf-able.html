<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Leaf-able | Splunk</title>
    <link rel="shortcut icon" href="{{SPLUNKWEB_URL_PREFIX}}/static/img/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/pages/dashboard-simple-bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/jquery-ui.css" />
  	<link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/application.css"/>
    <!--[if IE 7]><link rel="stylesheet" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/sprites-ie7.css" /><![endif]-->
    
    <link rel="stylesheet" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/cal-heatmap-master/cal-heatmap.css" />    
</head>
<body class="simplexml preload">

<!-- 
BEGIN LAYOUT
This section contains the layout for the dashboard. Splunk uses proprietary
styles in <div> tags, similar to Bootstrap's grid system. 
-->

<div class="header">
    <div id="placeholder-splunk-bar">
        <a href="{{SPLUNKWEB_URL_PREFIX}}/app/launcher/home" class="brand" title="splunk &gt; listen to your data">splunk<strong>&gt;</strong></a>
    </div>
    <div id="placeholder-app-bar"></div>
</div>
<div class="dashboard-body container-fluid main-section-body" data-role="main">
    <div class="dashboard-header clearfix">
        <h2>Leaf-able</h2>
    </div>
    <div class="dashboard-row dashboard-row1">
        <div class="dashboard-cell" style="width: 50%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="element1" style="width: 95%">
                      <div id="date_graphs_accordion" style=" min-height: 300px;">
                        <h3 class="panel-head">Leaf Status - Last <span id="sizeRangeMonths">3</span> Months</h3>
                        <div class="panel-body" id="calendar_base" style="width: 90%; height:200px; margins:0;">
                          <div id="leaf_status_accordion" style='height:200px;'> </div>
                        </div>
                      
                        <h3 class="panel-head">System Heating or Cooling - Minutes per Hour - Last 7 Days</h3>
                        <div class="panel-body" id="calendar_base_heat_cool" style="width: 90%; height:200px; margins:0;">
                          <div id="heat_cool_accordion" style='height:200px;'></div>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="dashboard-cell" style="width: 50%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="element2" style="width: 100%">
                        <div class="panel-head">
                            <h3>System State - Minutes On</h3>
                        </div>
                        <div class="panel-body"></div>
                      <div id="system_state_google" name="system_state_google"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row dashboard-row2">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="element3" style="width: 100%">
                        <div class="panel-head">
                            <h3>System State - Heat/Cool/Fan - By Device</h3>
                        </div>
                        <div id="systemStateDevicesResults_accordion" style='min-height: 300px;'></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="footer"></div>

<!-- 
END LAYOUT
-->

<script src="{{SPLUNKWEB_URL_PREFIX}}/config?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/i18n.js"></script>
  <script type="text/javascript" src="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/d3.v3.min.js"></script>
<script type="text/javascript" src="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/cal-heatmap-master/cal-heatmap.min.js"></script>
  <script type="text/javascript" src="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/moment.min.js"></script>
  <script type="text/javascript" src="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/d3.v3.min.js"></script>
  <script type="text/javascript" src="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/jquery-1.10.2.min.js"></script>
  <script src="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/application.js"></script>  
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/build/simplexml.min/config.js"></script>
  
<script type="text/javascript">
  

require.config({
    baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
    waitSeconds: 0 // Disable require.js load timeout
});

//
// LIBRARY REQUIREMENTS
//
// In the require function, we include the necessary libraries and modules for
// the HTML dashboard. Then, we pass variable names for these libraries and
// modules as function parameters, in order.
// 
// When you add libraries or modules, remember to retain this mapping order
// between the library or module and its function parameter. You can do this by
// adding to the end of these lists, as shown in the commented examples below.
  
require([
    "splunkjs/mvc",
    "splunkjs/mvc/utils",
    "splunkjs/mvc/tokenutils",
    "underscore",
    "jquery",
    "splunkjs/mvc/simplexml",
    "splunkjs/mvc/headerview",
    "splunkjs/mvc/footerview",
    "splunkjs/mvc/simplexml/dashboard",
    "splunkjs/mvc/simplexml/element/chart",
    "splunkjs/mvc/simplexml/element/event",
    "splunkjs/mvc/simplexml/element/html",
    "splunkjs/mvc/simplexml/element/list",
    "splunkjs/mvc/simplexml/element/map",
    "splunkjs/mvc/simplexml/element/single",
    "splunkjs/mvc/simplexml/element/table",
    "splunkjs/mvc/simpleform/input/dropdown",
    "splunkjs/mvc/simpleform/input/radiogroup",
    "splunkjs/mvc/simpleform/input/text",
    "splunkjs/mvc/simpleform/input/timerange",
    "splunkjs/mvc/simpleform/input/submit",
    "splunkjs/mvc/searchmanager",
    "splunkjs/mvc/savedsearchmanager",
    "splunkjs/mvc/postprocessmanager",
    "splunkjs/mvc/simplexml/urltokenmodel"
    ],
    function(
        mvc,
        utils,
        TokenUtils,
        _,
        $,
        DashboardController,
        HeaderView,
        FooterView,
        Dashboard,
        ChartElement,
        EventElement,
        HtmlElement,
        ListElement,
        MapElement,
        SingleElement,
        TableElement,
        DropdownInput,
        RadioGroupInput,
        TextInput,
        TimeRangeInput,
        SubmitButton,
        SearchManager,
        SavedSearchManager,
        PostProcessManager,
        UrlTokenModel
        ) {

 require(["{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/jquery-ui.js"], function() {
  
$.fn.onAvailable = function(fn){
    var sel = this.selector;
    var timer;
    var self = this;
    if (this.length > 0) {
        fn.call(this);   
    }
    else {
        timer = setInterval(function(){
            if ($(sel).length > 0) {
                fn.call($(sel));
                clearInterval(timer);  
            }
        },50);  
    }
};

    });
        var pageLoading = true;


        // 
        // TOKENS
        //
        
        // Create token namespaces
        var urlTokenModel = new UrlTokenModel();
        mvc.Components.registerInstance('url', urlTokenModel);
        var defaultTokenModel = mvc.Components.getInstance('default', {create: true});
        var submittedTokenModel = mvc.Components.getInstance('submitted', {create: true});

        urlTokenModel.on('url:navigate', function() {
            defaultTokenModel.set(urlTokenModel.toJSON());
            if (!_.isEmpty(urlTokenModel.toJSON()) && !_.all(urlTokenModel.toJSON(), _.isUndefined)) {
                submitTokens();
            } else {
                submittedTokenModel.clear();
            }
        });

        // Initialize tokens
        defaultTokenModel.set(urlTokenModel.toJSON());

        var defaultUpdate = {};

        var submitTokens = function() {
            submitTokensSoon(pageLoading);
        };

        var submitTokensSoon = _.debounce(function(replaceState) {
            submittedTokenModel.set(defaultTokenModel.toJSON());
            urlTokenModel.saveOnlyWithPrefix('form\\.', defaultTokenModel.toJSON(), {
                replaceState: replaceState
            });
        });


        //
        // SEARCH MANAGERS
        //
  //
  		var deviceSearchManager = new SearchManager({
  			"id": "nest_devices",
            "cancelOnUnload": true,
            "status_buckets": 0,
            "search": "|inputlookup nest_devices | table serial_number name",
            "latest_time": "now",
            "earliest_time": "-1m@m",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": false
        }, {tokens: true, tokenNamespace: "submitted"});
  

		var sizeRange = Math.floor(( (3 / 896) * window.innerWidth) - ( 3/7 ) );
 		var splunkSizeRange = sizeRange * 31;
  		$("#sizeRangeMonths").html((sizeRange+1));
  		console.log("Number of Days:", splunkSizeRange);
  		leafStatusSearchString = "earliest=-"+splunkSizeRange+"d@d index=summary m=leaf_status |append [ search earliest=@d+1m `nest` | `leaf_status_calc` ] |eval timestamp = _time |  stats latest(perc) as percent by timestamp name";
  		console.log(leafStatusSearchString);
        var leafStatusSearch = new SearchManager({
            "id": "leafStatusSearch",
            "cancelOnUnload": true,
            "status_buckets": 0,
            "search": leafStatusSearchString,
            "latest_time": "now",
            "earliest_time": "-"+splunkSizeRange+"d@d",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": false
        }, {tokens: true, tokenNamespace: "submitted"});

        var search2 = new SearchManager({
            "id": "search2",
            "cancelOnUnload": true,
            "status_buckets": 0,
            "search": "`system_state_onoff(\"1d\")`",
            "latest_time": "now",
            "earliest_time": "-2w@w",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": true
        }, {tokens: true, tokenNamespace: "submitted"});

  		heatCoolMapSearchString = "earliest=-7d@h index=summary m=\"system_state\" name=* NOT off=* | eval s_count = if(isnotnull(heat),heat,0) + if(isnotnull(cool),cool,0)| bin span=1h _time | stats  sum(s_count) as scount latest(name) as device_name by name _time | convert mktime(_time) as ttime | fillnull value=0 scount | fields - name _time | fields ttime device_name scount";
		var heat_cool_map_search = new SearchManager({
  			"id": "heat_cool_map_search",
  			"cancelOnUnload": true,
            "status_buckets": 0,
  			"search": heatCoolMapSearchString,
			"latest_time": "now",
            "earliest_time": "-7d@h",
            "app": utils.getCurrentApp(),
            "auto_cancel": 120,
  			"max_count": 1000,
  			"max_time": 0,
  			
            "preview": false
        }, {tokens: true, tokenNamespace: "submitted"});
        //
        // SPLUNK HEADER AND FOOTER
        //

        new HeaderView({
            id: 'header',
            section: 'dashboards',
            el: $('.header'),
            acceleratedAppNav: true
        }, {tokens: true}).render();

        new FooterView({
            id: 'footer',
            el: $('.footer')
        }, {tokens: true}).render();


        //
        // DASHBOARD EDITOR
        //

        new Dashboard({
            id: 'dashboard',
            el: $('.dashboard-body')
        }, {tokens: true}).render();


        //
        // VIEWS: VISUALIZATION ELEMENTS
        //

        
 setTimeout( function() {
  var element2 = new ChartElement({
            "id": "element2",
            "charting.axisTitleX.visibility": "visible",
            "charting.chart.style": "shiny",
            "charting.axisY.scale": "linear",
            "charting.axisX.scale": "linear",
            "charting.legend.labelStyle.overflowMode": "ellipsisMiddle",
            "charting.drilldown": "all",
            "charting.layout.splitSeries": "0",
            "charting.legend.placement": "right",
            "charting.chart.sliceCollapsingThreshold": "0.01",
            "charting.chart.stackMode": "stacked",
            "charting.chart.nullValueMode": "gaps",
            "charting.axisTitleY.visibility": "visible",
            "resizable": true,
            "charting.axisTitleX.text": "Date",
            "charting.chart": "column",
            "managerid": "search2",
            "el": $('#element2')
  }, {tokens: true}).render();
  }, 500);
        
         
  
  
  //// Multi Device Accordion with Charts - System State
  
  var systemStateDevices = splunkjs.mvc.Components.getInstance("nest_devices");
  var systemStateDevicesResults = systemStateDevices.data("results");
  
 
  systemStateDevicesResults.on("data", function() {
  	var Searches = {};
  	var Charts = {};	  
    $('#systemStateDevicesResults_accordion').click( function(e) { 
  			console.log("clicked accordion header: ", e.target.id.replace("h1_",""));
  			$('#'+e.target.id.replace("h1_","").replace("Chart","")).children('.panel-footer').hide();
  			Charts[e.target.id.replace("h1_","")].render();
  	});
  	_.each(systemStateDevicesResults.data().rows, function (row, rowCount) 
              {
  				  record = systemStateDevicesResults.data().rows[rowCount];
  				  console.log("record: ",record);
  				  sn = record[0];
     		      
  				  console.log("appending and refreshing systemStateDevicesResults_accordion");
  				  $('#systemStateDevicesResults_accordion').append("<h1 id='h1_systemStateChart_"+sn+"' style='font-size: 1.3em; font-weight:bold;' class='accordion_toggle' >"+record[1]+" - "+record[0]+"</h1><div class='accordion_content' width='85%' id='systemState_"+sn+"'></div>");
  					
  					console.log("create search: systemState_"+sn);
  					
  					Searches["systemStateSearch_"+sn] = new SearchManager({
  						"id": "systemStateSearch_"+ sn,
  						"cancelOnUnload": true,
  						"status_buckets": 0,                        
  						"search": '`system_state_device("1d","'+sn+'")`',                        
  						"latest_time": "now",                        
  						"earliest_time": "-2w@w",                        
  						"app": utils.getCurrentApp(),                        
  						"auto_cancel": 90,                        
  						"preview": true                    
  				  		}, {tokens: true, tokenNamespace: "submitted"});
  				   			        			
                        console.log("create chart: systemStateChart_"+sn);
                        
  							Charts["systemStateChart_"+sn] = new ChartElement({
                                "id": "systemState_" + sn,
                                "charting.axisTitleX.visibility": "visible",
                                "charting.chart.style": "shiny",
                                "charting.axisY.scale": "linear",
                                "charting.axisX.scale": "linear",
                                "charting.legend.labelStyle.overflowMode": "ellipsisMiddle",
                                "charting.drilldown": "all",
                                "charting.layout.splitSeries": "0",
                                "charting.legend.placement": "right",
                                "charting.chart.sliceCollapsingThreshold": "0.01",
                                "charting.chart.stackMode": "stacked",
                                "charting.chart.nullValueMode": "gaps",
                                "charting.axisTitleY.visibility": "visible",
                                "resizable": true,
                                "charting.axisTitleX.text": "Date",
                                "charting.chart": "column",
                                "managerid": "systemStateSearch_"+sn,
                                "el": $('#systemState_'+sn)
                            }, {tokens: true}).render();
  							eval("var systemStateChart_"+sn+" = Charts['systemStateChart_"+sn+"']");
  						    $('#systemState_'+sn).children('.panel-footer').hide();
					
  				}); //end EAch
  		console.log("creating systemStateDevicesResults_accordion");
  		setTimeout(function (){ $('#systemStateDevicesResults_accordion').accordion({collapsible: true, active : 'none', heightStyle: 'content' }); }, 1500 );
  });// end ON
    		
  //// Accordion For Calendar Graphs
  		setTimeout(function() { $('#date_graphs_accordion').accordion({collapsible: true, active : 'none', heightStyle: 'fill'}); }, 1500 );
  
  //// Leaf Status Graph by Device
  		var leafStatusSearch = splunkjs.mvc.Components.getInstance("leafStatusSearch");
  		var leafStatusResults = leafStatusSearch.data("results");
  		leafStatusResults.on("data", function() {
  			StartTime = Number(moment().subtract('months', sizeRange).format("X"));
  			var jsonData = {};
  			_.each(leafStatusResults.data().rows, function(column, rowCount) {
  				timestamp = String(column[0]);
  				device_name = String(column[1]);
  				percent = Number(column[2]);
  				if ( !(String(column[1]) in jsonData ) ) { 
  					jsonData[device_name] = { "device_name" : device_name, data: {} }; 
  					$('#leaf_status_accordion').append("<h3>"+ device_name + "</h3><div id='cal_"+device_name+"' style='min-height: 300px'></div>"); 
  				}
  				jsonData[device_name].data[timestamp] = percent;
  			});
  			console.log(jsonData);
  			_.each(jsonData, function(device, deviceCount) {
  				options = { 
  					itemSelector: "#cal_" + device.device_name,
  					domain: "month",
  					subDomain: "x_day",
  					data: device.data,
  					start: new Date(Number(StartTime) * 1000),
  					range: sizeRange + 1,
  				    domainGutter: 10,
  					itemName: ["average leaf", "average leaves"],
  				    cellSize: 10, 
  				    legend: [5],
  				    legendColors: {
                       min: "#ef0000",
                       max: "#75dc10",
                       empty: "#efefef"
  					}	
  				};
  				new CalHeatMap().init(options);
  			});
  			setTimeout(function() { $('#leaf_status_accordion').accordion({collapsible: true, heightStyle: "content",active : 'none'}); }, 1500 );
  		});

  ////// Heat Cool by Hour by Device
  		var heatcoolSearch = splunkjs.mvc.Components.getInstance("heat_cool_map_search");
  		var myHeatCoolResults = heatcoolSearch.data("results", { "count": 500} );
  		myHeatCoolResults.on("data", function() {
  			var StartTimeHeatCool = Number(moment().subtract('days', 7).format("X"));
  			var jsonDataHC = {};
  			_.each(myHeatCoolResults.data().rows, function(column, rowCount) {
  				timestamp = String(column[0]);
  				device_name = String(column[1]);
  				scount = Number(column[2]);
  				if ( !( device_name in jsonDataHC ) ) { 
  					console.log("Creating Array for " + device_name);
  					jsonDataHC[device_name] = { "device_name" : device_name, data: {} }; 
  					console.log("Appending to Accordion" + device_name);
  					$('#heat_cool_accordion').append("<h3>"+ device_name + "</h3><div id='hc_cal_"+device_name+"' style='min-height: 300px'></div>"); 
  				}
  				jsonDataHC[device_name].data[timestamp] = scount;
  			});
  			console.log("before foreach: for calendar creation " ,jsonDataHC);
  			_.each( jsonDataHC, function( deviceHC, deviceCountHC) {
  				if ( deviceHC.device_name in jsonDataHC ) {
  				console.log("json data for "+deviceHC.device_name, deviceHC);
  				optionsHC = { itemSelector: "#hc_cal_"+deviceHC.device_name, 
  				   domain: "day",
  				   subDomain: "hour",
  				   domainGutter: 0,
				   verticalOrientation: true,
  				   rowLimit: 1,
  				   data: jsonDataHC[deviceHC.device_name].data,
  				   start: new Date(Number(StartTimeHeatCool)*1000),
  				   range: 8,
                  label: {
                        position: "left",
                        offset: {
                            x: 20,
                            y: 12
                        },
                        width: 75
                    },
  				   cellSize: 10,
  					itemName: ["minute", "minutes"],
  				   cellPadding: 5,
  				   legend: [5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60],
  				   legendColors: {
                    min: "#efefef",
                    max: "#0475f7",
                    empty: "#efefef"
                    }     };
  				new CalHeatMap().init(optionsHC);
  				}
  			});
  			setTimeout(function() { $('#heat_cool_accordion').accordion({collapsible: true, heightStyle: "content",active : 'none'}); }, 1500 );
  		});
  
  		submitTokens();


        //
        // DASHBOARD READY
        //
	
  		
        DashboardController.ready();
        pageLoading = false;
  		

    }
);
</script> 
</body>
</html>