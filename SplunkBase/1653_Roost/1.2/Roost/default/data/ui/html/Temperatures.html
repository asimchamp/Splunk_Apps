<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Temperatures | Splunk</title>
    <link rel="shortcut icon" href="{{SPLUNKWEB_URL_PREFIX}}/static/img/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/build/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/build/pages/dashboard-simple-bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/jquery-ui.css" />
  	<link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/application.css"/>
    <!--[if IE 7]><link rel="stylesheet" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/sprites-ie7.css" /><![endif]-->
</head>
<body class="simplexml preload">

<!-- 
BEGIN LAYOUT
This section contains the layout for the dashboard. Splunk uses proprietary
styles in <div> tags, similar to Bootstrap's grid system. 
-->
<a class="navSkip" href="#navSkip" tabindex="1">Screen reader users, click here to skip the navigation bar</a>
<div class="header">
    <div id="placeholder-splunk-bar">
        <a href="{{SPLUNKWEB_URL_PREFIX}}/app/launcher/home" class="brand" title="splunk &gt; listen to your data">splunk<strong>&gt;</strong></a>
    </div>
    <div id="placeholder-app-bar"></div>
</div>
<a id="navSkip"></a>
<div class="dashboard-body container-fluid main-section-body" data-role="main">
    <div class="dashboard-header clearfix">
        <h2>Temperatures</h2>
    </div>
    <div class="dashboard-row dashboard-row1">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="element1" style="width: 100%">                       
                      <div class="panel-body"><div id="tt_ct_diff_accordion" style="min-height:100px"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dashboard-row dashboard-row3">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">                
                <div class="panel-element-row">
                    <div class="dashboard-element chart" id="element3" style="width: 100%">
                        <div class="panel-head">
                            <h3>Away-ness</h3>
                        </div>
                        <div class="panel-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="footer"></div>

<!-- 
END LAYOUT
-->

<script src="{{SPLUNKWEB_URL_PREFIX}}/config?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/i18n.js"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/i18ncatalog?autoload=1"></script>
    <script type="text/javascript" src="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/d3.v3.min.js"></script>
  <script type="text/javascript" src="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/jquery-1.10.2.min.js"></script>
    <script src="{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/application.js"></script>  
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/build/simplexml.min/config.js"></script>
<script type="text/javascript">
require.config({
    baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
    waitSeconds: 0, // Disable require.js load timeout
    shim: { "{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/jquery-ui.js": { deps: ["jquery"] } }
});

//
// LIBRARY REQUIREMENTS
//
// In the require function, we include the necessary libraries and modules for
// the HTML dashboard. Then, we pass variable names for these libraries and
// modules as function parameters, in order.
// 
// When you add libraries or modules, remember to retain this mapping order
// between the library or module and its function parameter. You can do this by
// adding to the end of these lists, as shown in the commented examples below.

require([
    "splunkjs/mvc",
    "splunkjs/mvc/utils",
    "splunkjs/mvc/tokenutils",
    "underscore",
    "jquery",
    "splunkjs/mvc/simplexml",
    "splunkjs/mvc/headerview",
    "splunkjs/mvc/footerview",
    "splunkjs/mvc/simplexml/dashboardview",
    "splunkjs/mvc/simplexml/element/chart",
    "splunkjs/mvc/simplexml/element/event",
    "splunkjs/mvc/simplexml/element/html",
    "splunkjs/mvc/simplexml/element/list",
    "splunkjs/mvc/simplexml/element/map",
    "splunkjs/mvc/simplexml/element/single",
    "splunkjs/mvc/simplexml/element/table",
    "splunkjs/mvc/simpleform/formutils",
    "splunkjs/mvc/simpleform/input/dropdown",
    "splunkjs/mvc/simpleform/input/radiogroup",
    "splunkjs/mvc/simpleform/input/multiselect",
    "splunkjs/mvc/simpleform/input/checkboxgroup",
    "splunkjs/mvc/simpleform/input/text",
    "splunkjs/mvc/simpleform/input/timerange",
    "splunkjs/mvc/simpleform/input/submit",
    "splunkjs/mvc/searchmanager",
    "splunkjs/mvc/savedsearchmanager",
    "splunkjs/mvc/postprocessmanager",
    "splunkjs/mvc/simplexml/urltokenmodel",
    "{{SPLUNKWEB_URL_PREFIX}}/static/app/Roost/jquery-ui.js"
    // Add comma-separated libraries and modules manually here, for example:
    // ..."splunkjs/mvc/simplexml/urltokenmodel",
    // "splunkjs/mvc/checkboxview"
    ],
    function(
        mvc,
        utils,
        TokenUtils,
        _,
        $,
        DashboardController,
        HeaderView,
        FooterView,
        Dashboard,
        ChartElement,
        EventElement,
        HtmlElement,
        ListElement,
        MapElement,
        SingleElement,
        TableElement,
        FormUtils,
        DropdownInput,
        RadioGroupInput,
        MultiSelectInput,
        CheckboxGroupInput,
        TextInput,
        TimeRangeInput,
        SubmitButton,
        SearchManager,
        SavedSearchManager,
        PostProcessManager,
        UrlTokenModel,
  		jqueryui

        // Add comma-separated parameter names here, for example: 
        // ...UrlTokenModel, 
        // CheckboxView
        ) {



        var pageLoading = true;


        // 
        // TOKENS
        //
        
        // Create token namespaces
        var urlTokenModel = new UrlTokenModel();
        mvc.Components.registerInstance('url', urlTokenModel);
        var defaultTokenModel = mvc.Components.getInstance('default', {create: true});
        var submittedTokenModel = mvc.Components.getInstance('submitted', {create: true});

        urlTokenModel.on('url:navigate', function() {
            defaultTokenModel.set(urlTokenModel.toJSON());
            if (!_.isEmpty(urlTokenModel.toJSON()) && !_.all(urlTokenModel.toJSON(), _.isUndefined)) {
                submitTokens();
            } else {
                submittedTokenModel.clear();
            }
        });

        // Initialize tokens
        defaultTokenModel.set(urlTokenModel.toJSON());

        function submitTokens() {
            // Copy the contents of the defaultTokenModel to the submittedTokenModel and urlTokenModel
            FormUtils.submitForm({ replaceState: pageLoading });
        }

        function setToken(name, value) {
            defaultTokenModel.set(name, value);
            submittedTokenModel.set(name, value);
        }

        function unsetToken(name) {
            defaultTokenModel.unset(name);
            submittedTokenModel.unset(name);
        }

        //
        // SEARCH MANAGERS
        //

  		var device_list = new SearchManager({
  			"id": "device_list",
            "search": "|inputlookup nest_devices | table serial_number name",
            "status_buckets": 0,
            "cancelOnUnload": true,
            "earliest_time": "-1m@m",
            "latest_time": "now",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": true,
            "runWhenTimeIsUndefined": false
  		}, {tokens:true, tokenNamespace: "submitted"});
      

                var search3 = new SearchManager({
            "id": "search3",
            "search": "earliest=-7d@d `nest`  |eval leaf_status = if (leaf==\"True\",50,1) | timechart span=30m   avg(leaf_status) as \"Avg Leaf\" sum(auto_away) as \"Auto Away\" by name",
            "status_buckets": 0,
            "cancelOnUnload": true,
            "earliest_time": "0",
            "latest_time": "now",
            "app": utils.getCurrentApp(),
            "auto_cancel": 90,
            "preview": true,
            "runWhenTimeIsUndefined": false
        }, {tokens: true, tokenNamespace: "submitted"});



        //
        // SPLUNK HEADER AND FOOTER
        //

        new HeaderView({
            id: 'header',
            section: 'dashboards',
            el: $('.header'),
            acceleratedAppNav: true,
            useSessionStorageCache: true
        }, {tokens: true}).render();

        new FooterView({
            id: 'footer',
            el: $('.footer')
        }, {tokens: true}).render();


        //
        // DASHBOARD EDITOR
        //

        new Dashboard({
            id: 'dashboard',
            el: $('.dashboard-body')
        }, {tokens: true}).render();


        //
        // VIEWS: VISUALIZATION ELEMENTS
        //

        
        var element3 = new ChartElement({
            "id": "element3",
            "charting.chart.style": "shiny",
            "charting.chart.stackMode": "stacked100",
            "resizable": true,
            "charting.drilldown": "all",
            "charting.chart": "area",
            "charting.axisTitleX.visibility": "visible",
            "charting.legend.placement": "right",
            "charting.axisY.scale": "linear",
            "charting.chart.nullValueMode": "connect",
            "charting.axisX.scale": "linear",
            "charting.axisTitleX.text": "Date",
            "charting.chart.sliceCollapsingThreshold": "0.01",
            "charting.axisTitleY.visibility": "visible",
            "charting.legend.labelStyle.overflowMode": "ellipsisMiddle",
            "charting.layout.splitSeries": "0",
            "managerid": "search3",
            "el": $('#element3')
        }, {tokens: true}).render();

        

        // Initialize time tokens to default
        if (!defaultTokenModel.has('earliest') && !defaultTokenModel.has('latest')) {
            defaultTokenModel.set({ earliest: '0', latest: '' });
        }

  
  var deviceListSearch = splunkjs.mvc.Components.getInstance("device_list");
  var deviceListResults = deviceListSearch.data("results");
  
 
  deviceListResults.on("data", function() {
  	var Searches = {};
  	var Charts = {};	  
    $('#tt_ct_diff_accordion').click( function(e) { 
  			el = e.target.id.replace("h1_","").split("_");
  			sn = el[1];
  			console.log("clicked accordion header: ", el);
  			$('#tt_ct_diff_'+sn).children('.panel-footer').remove();
  			$('#enviro_'+sn).children('.panel-footer').remove();
  			Charts["tt_ct_diff_Chart_"+sn].render();
  			Charts["enviro_Chart_"+sn].render();
  	});
  	_.each(deviceListResults.data().rows, function (row, rowCount) 
              {
  				  record = deviceListResults.data().rows[rowCount];
  				  console.log("record: ",record);
  				  sn = record[0];
     		      
  				  console.log("appending and refreshing tt_ct_diff_accordion");
  					$('#tt_ct_diff_accordion').append("<h1 id='h1_TempCharts_"+sn+"' style='font-size: 1.3em; font-weight:bold;' class='accordion_toggle' >"+record[1]+" - "+record[0]+"</h1><div class='accordion_content' width='85%' ><h3>Difference (Positive - Target Temp is higher then Current Temp)</h3><div id='tt_ct_diff_"+sn+"'></div><h3>Temperature Differences</h3><div id='enviro_"+sn+"'></div></div>");
  					
  					console.log("create search: tt_ct_diff_Search_"+sn);
  					
  					Searches["tt_ct_diff_Search_"+sn] = new SearchManager({
  						"id": "tt_ct_diff_Search_"+ sn,
  						"cancelOnUnload": true,
  						"status_buckets": 0,                        
  						"search": '`temperature_diff("'+sn+'")`',                        
  						"latest_time": "now",                        
  						"earliest_time": "-7d@h",                        
  						"app": utils.getCurrentApp(),                        
  						"auto_cancel": 90,                        
  						"preview": true                    
  				  		}, {tokens: true, tokenNamespace: "submitted"});
  				   			        			
  					console.log("create search: enviro_Search_"+sn);
  					Searches["enviro_Search_"+sn] = new SearchManager({
            			"id": "enviro_Search_"+ sn,
                        "search": '`time_temp("'+sn+'")`',
                        "status_buckets": 0,
                        "cancelOnUnload": true,
                        "earliest_time": "-5d@d",
                        "latest_time": "now",
                        "app": utils.getCurrentApp(),
                        "auto_cancel": 90,
                        "preview": true,
                        "runWhenTimeIsUndefined": false
                    }, {tokens: true, tokenNamespace: "submitted"});
       
                        console.log("create chart: tt_ct_diff_Chart_"+sn);
                        
  							Charts["tt_ct_diff_Chart_"+sn] = new ChartElement({
                                "id": "tt_ct_diff_Chart_" + sn,
                                "charting.chart.style": "minimal",
                                "charting.axisTitleY.visibility": "visible",
                                "charting.axisTitleY2.visibility": "visible",
                                "resizable": true,
                                "charting.drilldown": "all",
                                "charting.chart": "bar",
                                "charting.axisTitleX.visibility": "visible",
                                "charting.axisY2.enabled": "false",
                                "charting.legend.placement": "right",
                                "charting.axisLabelsX.majorLabelStyle.rotation": "0",
                                "charting.axisY.scale": "linear",
                                "charting.chart.nullValueMode": "gaps",
                                "charting.axisLabelsX.majorLabelStyle.overflowMode": "ellipsisNone",
                                "charting.axisX.scale": "linear",
                                "charting.chart.stackMode": "stacked",
                                "charting.axisTitleX.text": "Time",
                                "charting.chart.sliceCollapsingThreshold": "0.01",
                                "charting.axisY2.scale": "inherit",
                                "charting.legend.labelStyle.overflowMode": "ellipsisMiddle",
                                "charting.layout.splitSeries": "1",
                                "el": $('#tt_ct_diff_'+sn),
                                "managerid": "tt_ct_diff_Search_"+sn
                            }, {tokens: true}).render();
  						console.log("create chart: enviro_Chart_"+sn);
  							Charts["enviro_Chart_"+sn] = new ChartElement({
                                "id": "enviro_Chart_"+sn,
                                "charting.chart.style": "shiny",
                                "charting.chart.stackMode": "default",
                                "resizable": true,
                                "charting.drilldown": "all",
                                "charting.chart": "line",
                                "charting.axisTitleX.visibility": "visible",
                                "charting.legend.placement": "right",
                                "charting.axisY.scale": "linear",
                                "charting.chart.nullValueMode": "connect",
                                "charting.axisX.scale": "linear",
                                "charting.axisTitleX.text": "Date",
                                "charting.chart.sliceCollapsingThreshold": "0.01",
                                "charting.axisTitleY.visibility": "visible",
                                "charting.legend.labelStyle.overflowMode": "ellipsisMiddle",
                                "charting.layout.splitSeries": "0",
                                "managerid": "enviro_Search_"+ sn,
                                "el": $('#enviro_'+sn)
                            }, {tokens: true}).render();  							
  	
  							eval("var tt_ct_diff_Chart_"+sn+" = Charts['tt_ct_diff_Chart_"+sn+"']");
  						    $('#tt_ct_diff_'+sn).children('.panel-footer').hide();
  							eval("var enviro_Chart_"+sn+" = Charts['enviro_Chart_"+sn+"']");
  						    $('#enviro_'+sn).children('.panel-footer').hide();
					
  				}); //end Each
  		console.log("creating tt_ct_diff_accordion");
  		setTimeout(function (){ $('#tt_ct_diff_accordion').accordion({collapsible: true, active : 'none', heightStyle: 'content' }); }, 1500 );
  });// end ON
  
        submitTokens();


        //
        // DASHBOARD READY
        //

        DashboardController.ready();
        pageLoading = false;

    }
);
</script>
</body>
</html>