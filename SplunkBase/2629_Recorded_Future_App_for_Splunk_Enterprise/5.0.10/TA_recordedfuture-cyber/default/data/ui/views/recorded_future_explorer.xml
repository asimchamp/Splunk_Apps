<form stylesheet="css/recorded_future_correlation.css" script="js/evidence.js">
  <label>Splunk Explorer Dashboard</label>
  <fieldset autoRun="true" submitButton="true">
    <input type="dropdown" token="rl_tok" searchWhenChanged="true">
      <label>Select a Risk List:</label>
      <search>
        <query>
          | rest splunk_server=local /services/data/lookup-table-files
          | search eai:acl.app="TA_recordedfuture-cyber" OR eai:acl.app="TA-recorded_future"
          | search title!="*cs.index.alive"
          | sort -title
          | fields title
        </query>
      </search>
      <fieldForLabel>title</fieldForLabel>
      <fieldForValue>title</fieldForValue>
    </input>
    <input type="dropdown" token="sourcetype_tok" searchWhenChanged="true">
      <label>Select a Source Type:</label>
      <prefix>sourcetype="</prefix>
      <suffix>"</suffix>
      <default></default>
      <search>
        <query>
          | metadata type=sourcetypes 
          | table sourcetype
        </query>
      </search>
      <fieldForLabel>sourcetype</fieldForLabel>
      <fieldForValue>sourcetype</fieldForValue>
      <change>
        <condition match="len('sourcetype_tok') > 0">
          <set token="sourcetype_flag">true</set>
        </condition>
        <condition>
          <unset token="sourcetype_flag"/>
        </condition>
      </change>
    </input>
    <input type="dropdown" token="field_tok" searchWhenChanged="true" depends="$sourcetype_flag$">
      <label>Select a Field:</label>
      <prefix>"</prefix>
      <suffix>"</suffix>
      <default></default>
      <search>
        <query>
          index=* $sourcetype_tok$ earliest=-24h latest=now 
          | fieldsummary 
          | stats count by field
        </query>
      </search>
      <fieldForLabel>field</fieldForLabel>
      <fieldForValue>field</fieldForValue>
      <change>
        <condition match="len('field_tok') > 0">
          <set token="field_flag">true</set>
        </condition>
        <condition>
          <unset token="field_flag"/>
        </condition>
      </change>
    </input>
  </fieldset>
  <row>
    <html>
        <div class="help-link" style="float: right; text-align: right;">
          <img src="/static/app/TA_recordedfuture-cyber/img/logo.svg" alt="Recorded Future, Inc logotype" style="height: 30px;"/><br/>
          <a href="/app/TA_recordedfuture-cyber/recorded_future_help_splunk_explorer">Help</a>
        </div>
      <div>
        Select a Risk List Type, Sourcetype, a field that contains a risk list value, and select Submit.
      </div>
    </html>
  </row>
  <row>
    <panel depends="$rl_tok$">
      <single>
        <title>Current Entity Risk List Size</title>
        <search>
          <query>
            | inputlookup $rl_tok$ 
            | stats count
          </query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
    <panel depends="$sourcetype_flag$,$field_flag$">
      <single>
        <title>Events with the Selected Values</title>
        <search depends="$field_tok$,$sourcetype_flag$">
          <query>
            index=* $sourcetype_tok$ ((earliest=-36h latest=now)) 
            | rename $field_tok$ as Name
            | search Name=*
            | stats count
          </query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
    <panel depends="$sourcetype_flag$,$field_flag$,$rl_tok$">
      <single>
        <title>Recorded Future Match Count of Selected Values</title>
        <search>
          <query>
	          index=* $sourcetype_tok$ ((earliest=-36h latest=now)) 
            | rename $field_tok$ as Name
            | lookup $rl_tok$ Name OUTPUT EvidenceDetails Risk RiskString
            | search Risk=*
            | stats count
          </query>
          <earliest>-8h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x65a637","0xf7bc38","0xf58f39","0xd93f3c"]</option>
        <option name="rangeValues">[0,100,400]</option>
        <option name="refresh.display">progressbar</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel depends="$sourcetype_flag$,$field_flag$">
      <table>
        <title>Most Active Selected Values</title>
        <search>
          <query>
            index=* $sourcetype_tok$ ((earliest=-8h latest=now)) 
            | rename $field_tok$ as Name
            | top Name showperc=false
          </query>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
  <row>
    <panel depends="$rl_tok$,$sourcetype_flag$,$field_flag$">
      <table id="etable">
        <title>Recorded Future Matches Details of Selected Values</title>
        <search>
          <query>
            index=* $sourcetype_tok$ ((earliest=-8h latest=now)) 
            | rename $field_tok$ as Name
            | lookup $rl_tok$ Name OUTPUT EvidenceDetails Risk RiskString
            | search Risk=*
            | eventstats count by Name
            | eval c_time=strftime(_time,"%m/%d/%y %H:%M:%S")
            | eventstats earliest(c_time) as first_seen latest(c_time) as last_seen
            | `format_evidence`
            | eval Risk = round(Risk,0)
            | sort -count -Score
            | table Name, source, count, Risk, first_seen, last_seen, RiskString, Evidence 
            | rename Name as $field_tok$, count as Count, source as Source, first_seen as "First Seen", last_seen as "Last Seen", RiskString as "Risk String"
          </query>
          <earliest>-8h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
</form>
