<dashboard stylesheet="css/recorded_future_correlation.css"
	   script="js/evidence.js">
  <label>Recorded Future Hash Log Correlation</label>
  <!-- Original search using real data
  <search id="core">
    <query>
	   <![CDATA[sourcetype="symantec:ep:risk:file" earliest=-24h 
		    | rex field=_raw "Application hash: (?<file_hash>[^,]+)"
		    | eval Name=file_hash  
		    | eval Time=strftime(_time,"%m/%d/%y %I:%M:%S:%p") 
		    | join Name [|inputlookup rf_hash_risklist.csv | table *]
		    | search Risk != ""]]>
	 </query>
  </search>
  -->
  <search id="core">
    <query>
      | rest splunk_server=local /services/TA_recordedfuture-cyber/sample_data type=hash
      | sort -Risk
    </query>
  </search>
  <row>
    <html>
      <div class="help-link" style="float: right; text-align: right;">
        <img src="/static/app/TA_recordedfuture-cyber/img/logo.svg" alt="Recorded Future, Inc logotype" style="height: 30px;"/><br/>
        <a href="/app/TA_recordedfuture-cyber/recorded_future_help_correlation_dashboards" target="_blank">Help</a>
      </div>
      <div>
        <h1>
          This dashboard displays correlated hashes with Recorded Future's Hash Risk List.
        </h1>
      </div>
    </html>
  </row>
  <row>
    <panel>
      <single>
        <title>Summary</title>
        <search base="core">
          <query>
            | stats dc(Name) as count
            | fields count
            | rangemap field=count low=0-0 evelated=1-1 default=severe
          </query>
        </search>
        <option name="underLabel">High Risk Hashes</option>
        <option name="refresh.time.visible">false</option>
        <option name="drilldown">none</option>
      </single>
    </panel>
    <panel>
      <table>
        <title>Top Hash Rules</title>
        <search base="core">
          <query>
            | eval Rule=spath(EvidenceDetails,"EvidenceDetails{}.Rule")
            | eval EvidenceString=spath(EvidenceDetails,"EvidenceDetails{}.EvidenceString")
            | top Rule limit=20 showperc=false
          </query>
        </search>
        <option name="drilldown">none</option>
        <option name="totalsRow">true</option>
      </table>
    </panel>
    <panel id="topcount">
      <table>
        <title>Top Hash Hits</title>
        <search base="core">
          <query>
            | eval Rule=spath(EvidenceDetails,"{}.rule")
            |  eval EvidenceString=spath(EvidenceDetails,"{}.evidenceString")
            | rename Name as Hash
            | top Hash limit=20 showperc=false
          </query>
        </search>
        <option name="drilldown">row</option>
        <option name="totalsRow">true</option>
        <drilldown>
          <condition field="Hash">
            <link target="_blank">/app/TA_recordedfuture-cyber/search?q=search%20index%3D*%20$row.Hash$</link>
          </condition>
          <condition>
            <link target="_blank">/app/TA_recordedfuture-cyber/recorded_future_hash_enrichment?form.name=$row.Hash$</link>
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table id="etable">
        <title>High Risk Hashes</title>
        <search base="core">
          <query>| eventstats Count BY Name
            | dedup Name
            | `format_evidence`
            | sort -Risk
            | eval Risk = round(Risk,0)
            | rename RiskString AS Rules
            | rename Name TO Hash
            | table Risk, Hash, Count, Rules, Evidence
          </query>
        </search>
        <option name="count">10</option>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
        <format type="color" field="Risk">
          <colorPalette type="list">["0x777777","0xffce00","0xcf0a2c"]</colorPalette>
          <scale type="threshold">30,71,100</scale>
        </format>
        <drilldown>
          <condition field="Hash">
            <link target="_blank">/app/TA_recordedfuture-cyber/search?q=search%20index%3D*%20$row.Hash$</link>
          </condition>
          <condition>
            <link target="_blank">/app/TA_recordedfuture-cyber/recorded_future_hash_enrichment?form.name=$row.Hash$</link>
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>
</dashboard>
