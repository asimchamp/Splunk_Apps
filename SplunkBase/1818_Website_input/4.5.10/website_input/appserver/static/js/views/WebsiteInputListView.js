require.config({paths:{datatables:"../app/website_input/js/lib/DataTables/js/jquery.dataTables",bootstrapDataTables:"../app/website_input/js/lib/DataTables/js/dataTables.bootstrap",text:"../app/website_input/js/lib/text",console:"../app/website_input/js/lib/console"},shim:{bootstrapDataTables:{deps:["datatables"]}}});define(["underscore","backbone","models/SplunkDBase","collections/SplunkDsBase","splunkjs/mvc","jquery","splunkjs/mvc/simplesplunkview","text!../app/website_input/js/templates/WebsiteInputListView.html","bootstrapDataTables","util/splunkd_utils","bootstrap.dropdown","css!../app/website_input/css/WebsiteInputListView.css","css!../app/website_input/css/SplunkDataTables.css"],function(m,l,g,a,d,h,k,i,b,c){var f=a.extend({url:"apps/local?count=-1",initialize:function(){a.prototype.initialize.apply(this,arguments)}});var j=a.extend({url:"data/inputs/web_input/?count=-1",initialize:function(){a.prototype.initialize.apply(this,arguments)}});var e=k.extend({className:"WebsiteInputListView",defaults:{change_dropdown_titles:true},initialize:function(){this.options=m.extend({},this.defaults,this.options);this.change_dropdown_titles=this.options.change_dropdown_titles;this.filter_app=null;this.filter_text=null;this.filter_scope=null;this.applied_filter=null;this.apps=null;this.data_table=null;this.retain_state=false;this.getInputs();this.apps=new f();this.apps.on("reset",this.gotApps.bind(this),this);this.apps.fetch({success:function(){console.info("Successfully retrieved the list of applications")},error:function(){console.error("Unable to fetch the apps")}})},events:{"click .app-filter > .dropdown-menu > li > a":"onClickAppFilter","change #free-text-filter":"applyFilter","keyup #free-text-filter":"goFilter","keypress #free-text-filter":"goFilter","click .scope-filter > .btn":"onClickScopeFilter","click .disable-input":"openDisableInputDialog","click #disable-this-input":"disableInput","click .delete-input":"openDeleteInputDialog","click #delete-this-input":"deleteInput","click .enable-input":"enableInput"},getInputs:function(){this.inputs=new j();this.inputs.on("reset",this.gotInputs.bind(this),this);this.inputs.fetch({success:function(){console.info("Successfully retrieved the inputs")},error:function(){console.error("Unable to fetch the inputs")},complete:function(n,o){}.bind(this)})},onClickScopeFilter:function(o){var n=h(o.target).text();this.setScopeFilter(n)},setScopeFilter:function(n){var o="All";if(n==="All"||n===null){this.filter_scope=null}else{if(n.indexOf("Enabled")>=0){this.filter_scope=true;o="Disable"}else{this.filter_scope=false;o="Enable"}}h(".scope-filter > .btn").each(function(){if(h(this).text()===o){h(this).addClass("active")}else{h(this).removeClass("active")}});this.applyFilter()},setFilterText:function(p,o,n){if(typeof n==="undefined"){n="All"}if(this.change_dropdown_titles){if(n){h("."+p+" > .dropdown-toggle").html(o+": "+n+'<span class="caret"></span>')}else{h("."+p+" > .dropdown-toggle").html(o+'<span class="caret"></span>')}}},doFilter:function(r,q,p,o){if(typeof o=="undefined"){o=true}var n=p;if(p===null){n="All"}this.setFilterText(r,q,n);h("."+r+" > .dropdown-menu > li > a").each(function(){if(h(this).text()===n){h("i",this).removeClass("hide")}else{h("i",this).addClass("hide")}});if(o){this.applyFilter()}},onClickAppFilter:function(o){var n=h(o.target).text();this.setAppFilter(n)},setAppFilter:function(n){if(n==="All"){this.filter_app=null}else{this.filter_app=n}this.doFilter("app-filter","App",n)},enableInput:function(q){var o=h(q.target).data("name");var p=h(q.target).data("namespace");var n=h(q.target).data("owner");h.ajax({url:c.fullpath(["/servicesNS",n,p,"/data/inputs/web_input",o,"enable"].join("/")),type:"POST",success:function(){console.info("Input enabled")}.bind(this),complete:function(r,s){if(r.status==403){console.info("Inadequate permissions to enable input")}else{this.retain_state=true;this.getInputs()}}.bind(this),error:function(r,t,s){if(r.status!=403){console.info("Input enablement failed")}}.bind(this)});return false},disableInput:function(q){var o=h(q.target).data("name");var p=h(q.target).data("namespace");var n=h(q.target).data("owner");h.ajax({url:c.fullpath(["/servicesNS",n,p,"/data/inputs/web_input",o,"disable"].join("/")),type:"POST",success:function(){console.info("Input disabled")}.bind(this),complete:function(r,s){if(r.status==403){console.info("Inadequate permissions to disable input")}else{h("#disable-input-modal",this.$el).modal("hide");this.retain_state=true;this.getInputs()}}.bind(this),error:function(r,t,s){if(r.status!=403){console.info("Input disablement failed")}}.bind(this)})},openDisableInputDialog:function(q){var o=h(q.target).data("name");var p=h(q.target).data("namespace");var n=h(q.target).data("owner");h("#disable-this-input",this.$el).data("name",o);h("#disable-this-input",this.$el).data("namespace",p);h("#disable-this-input",this.$el).data("owner",n);h(".disable-input-name",this.$el).text(o);h(".disable-input-namespace",this.$el).text(p);h(".disable-input-owner",this.$el).text(n);h("#disable-input-modal",this.$el).modal();return false},openDeleteInputDialog:function(q){var o=h(q.target).data("name");var p=h(q.target).data("namespace");var n=h(q.target).data("owner");h("#delete-this-input",this.$el).data("name",o);h("#delete-this-input",this.$el).data("namespace",p);h("#delete-this-input",this.$el).data("owner",n);h(".delete-input-name",this.$el).text(o);h(".delete-input-namespace",this.$el).text(p);h(".delete-input-owner",this.$el).text(n);h("#delete-input-modal",this.$el).modal();return false},deleteInput:function(q){var o=h(q.target).data("name");var p=h(q.target).data("namespace");var n=h(q.target).data("owner");h.ajax({url:c.fullpath(["/servicesNS",n,p,"/data/inputs/web_input",o].join("/")),type:"DELETE",success:function(){console.info("Input deleted")}.bind(this),complete:function(r,s){if(r.status==403){console.info("Inadequate permissions to delete input")}else{h("#delete-input-modal",this.$el).modal("hide");this.retain_state=true;this.getInputs()}}.bind(this),error:function(r,t,s){if(r.status!=403){console.info("Input deletion failed")}}.bind(this)})},goFilter:function(o){var n=o.keyCode||o.which;if(n==13){o.preventDefault()}this.applyFilter()},getAppDescriptionFromName:function(n){for(var o=0;o<this.apps.models.length;o++){if(this.apps.models[o].entry.attributes.name===n){return this.apps.models[o].entry.associated.content.attributes.label}}return n},applyFilter:function(){var n=":"+this.filter_app+":"+h("#free-text-filter").val()+":"+this.filter_scope;if(n===this.applied_filter){return}this.applied_filter=n;if(this.filter_app!==null){this.data_table.columns(2).search("^"+this.filter_app+"$",true)}else{this.data_table.columns(2).search("")}if(this.filter_scope===true){this.data_table.columns(3).search(".*Disable.*",true)}else{if(this.filter_scope===false){this.data_table.columns(3).search(".*Enable.*",true)}else{this.data_table.columns(3).search("")}}this.filter_text=h("#free-text-filter").val();this.data_table.columns([0.1]).search(h("#free-text-filter").val()).draw()},gotApps:function(){this.renderList()},gotInputs:function(){this.renderList()},endsWith:function(o,n){return o.indexOf(n,o.length-n.length)!==-1},getInputsCount:function(){var n=this.getInputsJSON();if(n){return n.length}else{return 0}},getInputsJSON:function(){var o=[];var n=null;for(var p=0;p<this.inputs.models.length;p++){n={name:this.inputs.models[p].entry.attributes.name,title:this.inputs.models[p].entry.content.attributes.title,namespace:this.inputs.models[p].entry.acl.attributes.app,owner:this.inputs.models[p].entry.acl.attributes.owner,disabled:this.inputs.models[p].entry.associated.content.attributes.disabled};o.push(n)}return o},getAppsJSON:function(r){if(typeof r==="undefined"){r=true}if(!this.apps){return[]}var q=[];var n=null;for(var p=0;p<this.apps.models.length;p++){n={name:this.apps.models[p].entry.attributes.name,label:this.apps.models[p].entry.associated.content.attributes.label};if(r){for(var o=0;o<this.inputs.models.length;o++){if(this.inputs.models[o].entry.acl.attributes.app===this.apps.models[p].entry.attributes.name){q.push(n);break}}}else{q.push(n)}}var q=m.uniq(q,function(u,t,s){return u.name});return q},renderList:function(o){if(typeof o=="undefined"){o=this.retain_state}var n=h("#list-template",this.$el).text();h("#content",this.$el).html(m.template(n,{inputs:this.getInputsJSON(),apps:this.getAppsJSON(),filter_app:this.filter_app,filter_text:this.filter_text,inputs_count:this.getInputsCount(),getAppDescriptionFromName:this.getAppDescriptionFromName.bind(this)}));this.data_table=h("#table",this.$el).DataTable({iDisplayLength:25,bLengthChange:false,searching:true,aLengthMenu:[[25,50,100,-1],[25,50,100,"All"]],bStateSave:true,fnStateLoadParams:function(p,q){return o},aaSorting:[[1,"asc"]],aoColumns:[null,null,{searchable:false},null]});this.setAppFilter(this.filter_app)},render:function(){this.$el.html(i)}});return e});