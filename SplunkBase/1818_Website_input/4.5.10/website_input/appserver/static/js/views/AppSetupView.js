require.config({paths:{text:"../app/website_input/js/lib/text",setup_view:"../app/website_input/js/views/SetupView"}});define(["underscore","jquery","models/SplunkDBase","setup_view","util/splunkd_utils","text!../app/website_input/js/templates/AppSetupView.html","css!../app/website_input/css/AppSetupView.css"],function(a,f,g,e,b,d){var c=g.extend({initialize:function(){g.prototype.initialize.apply(this,arguments)}});return e.extend({className:"AppSetupView",events:{"click #save-config":"saveConfig","click #user-agent-return-default":"setDefaultUserAgent"},defaults:{secure_storage_realm:"website_input_app_proxy",secure_storage_username:"IN_CONF_FILE"},formProperties:{proxyServer:".proxy-address input",proxyUser:".proxy-user input",proxyServerPort:".proxy-port input",proxyPassword:".proxy-password input",proxyPasswordConfirmation:".proxy-password-confirm input",proxyType:".proxy-type select",userAgent:".user-agent input"},initialize:function(){this.options=a.extend({},this.defaults,this.options);e.prototype.initialize.apply(this,[this.options]);this.setupValidators();this.website_input_configuration=null;this.secure_storage_stanza=this.makeStorageEndpointStanza(this.options.secure_storage_username,this.options.secure_storage_realm);this.input_stanza="web_input"},setDefaultUserAgent:function(){this.setUserAgent("Splunk Website Input (+https://splunkbase.splunk.com/app/1818/)")},updateModel:function(){this.website_input_configuration.entry.content.attributes.proxy_server=this.getProxyServer();this.website_input_configuration.entry.content.attributes.proxy_port=this.getProxyServerPort();this.website_input_configuration.entry.content.attributes.proxy_type=this.getProxyType();this.website_input_configuration.entry.content.attributes.proxy_user=this.getProxyUser();this.website_input_configuration.entry.content.attributes.proxy_password=""},savePassword:function(){var h=this.getProxyPassword();if(h.length===0){return this.deleteEncryptedCredential(this.secure_storage_stanza,true)}else{return this.saveEncryptedCredential(this.options.secure_storage_username,h,this.options.secure_storage_realm)}},saveConfig:function(){if(!this.userHasAdminAllObjects()){alert("You don't have permission to edit this app")}else{if(this.validate()){this.updateModel();this.showFormInProgress(true);f.when(this.website_input_configuration.save(),this.savePassword()).then(function(){this.showInfoMessage("Configuration successfully saved");this.showFormInProgress(false);this.redirectIfNecessary("web_input_monitoring")}.bind(this)).fail(function(h){this.showFormInProgress(false);this.showWarningMessage("Configuration could not be saved")}.bind(this));this.setConfigured()}}return false},setControlsEnabled:function(h){if(h===undefined){h=true}f("input,select",this.el).prop("disabled",!h)},showFormInProgress:function(h){f(".btn-primary").prop("disabled",h);this.setControlsEnabled(!h);if(h){f(".btn-primary").text("Saving Configuration...")}else{f(".btn-primary").text("Save Configuration")}},fetchAppConfiguration:function(){this.website_input_configuration=new c();this.setControlsEnabled(false);return this.website_input_configuration.fetch({url:"/splunkd/__raw/services/admin/app_website_input/default",id:"default",success:function(j,h,i){console.info("Successfully retrieved the default website_input configuration");this.setProxyServer(j.entry.content.attributes.proxy_server);this.setProxyServerPort(j.entry.content.attributes.proxy_port);this.setProxyType(j.entry.content.attributes.proxy_type);this.setProxyUser(j.entry.content.attributes.proxy_user);this.setProxyPassword(j.entry.content.attributes.proxy_password);this.setProxyPasswordConfirmation(j.entry.content.attributes.proxy_password);this.setUserAgent(j.entry.content.attributes.user_agent)}.bind(this),error:function(){console.warn("Unsuccessfully retrieved the default website_input configuration")}.bind(this)})},render:function(){f.when(this.isOnCloud()).then(function(h){if(this.userHasAdminAllObjects()){this.$el.html(a.template(d,{has_permission:this.userHasAdminAllObjects(),is_on_cloud:h}));if(this.website_input_configuration===null){this.setControlsEnabled(false);f.when(this.fetchAppConfiguration(),this.getEncryptedCredential(this.makeStorageEndpointStanza(this.options.secure_storage_username,this.options.secure_storage_realm),true),this.getInputStanza()).then(function(i,j,k){if(j){this.setProxyPassword(j.entry.content.attributes.clear_password);this.setProxyPasswordConfirmation(j.entry.content.attributes.clear_password)}if(k){this.setUserAgent(k.user_agent)}this.setControlsEnabled(true)}.bind(this))}}else{this.$el.html("Sorry, you don't have permission to perform setup")}}.bind(this))},isValidPort:function(i){var h=parseInt(i,10);if(i===""){return true}else{if(isNaN(h)){return false}else{if(h<1||h>65535){return false}else{return true}}}},isValidUserAgent:function(h){if(h.length===0){return false}else{return true}},matchesPassword:function(h){var i=this.getProxyPassword();if(i!==h){return false}else{return true}},isValidServer:function(i){var j=/^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+$/gm;var h=/\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/g;if(i===""){return true}else{if(j.exec(i)||h.exec(i)){return true}else{return false}}},setupValidators:function(){this.addValidator(".proxy-address",this.getProxyServer.bind(this),this.isValidServer,"Must be a valid domain name or IP address");this.addValidator(".proxy-port",this.getProxyServerPort.bind(this),this.isValidPort,"Must be a valid port number");this.addValidator(".proxy-password-confirm",this.getProxyPasswordConfirmation.bind(this),this.matchesPassword.bind(this),"Must match the password");this.addValidator(".user-agent",this.getUserAgent.bind(this),this.isValidUserAgent.bind(this),"Must not be blank")}})});