require.config({paths:{text:"../app/website_input/js/lib/text",preview_website_input_results:"../app/website_input/js/views/PreviewWebsiteInputResultsView",setup_view:"../app/website_input/js/views/SetupView"}});define(["underscore","backbone","collections/SplunkDsBase","splunkjs/mvc","util/splunkd_utils","jquery","models/services/server/ServerInfo","views/shared/controls/StepWizardControl","splunkjs/mvc/simpleform/input/dropdown","splunkjs/mvc/simpleform/input/text","preview_website_input_results","setup_view","text!../app/website_input/js/templates/WebsiteInputCreateView.html","bootstrap.dropdown","css!../app/website_input/css/WebsiteInputCreateView.css"],function(_,Backbone,SplunkDsBaseCollection,mvc,splunkd_utils,$,ServerInfo,StepWizardControl,DropdownInput,TextInput,PreviewWebsiteInputResultsView,SetupView,Template){var Indexes=SplunkDsBaseCollection.extend({url:"data/indexes",initialize:function(){SplunkDsBaseCollection.prototype.initialize.apply(this,arguments)}});var WebsiteInputCreateView=SetupView.extend({className:"WebsiteInputCreateView",defaults:{secure_storage_realm_prefix:"web_input://",secure_storage_username:"IN_CONF_FILE"},events:{"change #inputURL":"changeInputURL","click #do-preview":"clickUpdatePreview","click .preview-url":"clickUpdatePreview","click .clearSelector":"clearSelector","change #inputSelector":"changeInputSelector","keypress #inputSelector":"keypressInputSelector","click .show-selector-help-dialog":"showSelectorHelp","click .switch-styles":"switchStyles","click .show-results-preview-dialog":"showResultsPreview","click .show-results-in-search":"openPreviewInSearch","click #browserConnectionTest":"clickTestBrowser","change #inputBrowser":"clearTestBrowserLink","click .browserHelp":"showBrowserHelp","change #inputLoginURL":"determineFormFields","click #detect-field-names":"clickDetermineFormFields","click .authenticationHelp":"showAuthenticationHelp","change #inputPageLimit":"changeInputSelector","click #suggestURLFilter":"suggestURLFilter","click .openInNewTab":"clickOpenURL"},STATE_UNINITIALIZED:0,STATE_LOADED:1,STATE_READY:2,initialize:function(){this.options=_.extend({},this.defaults,this.options);this.capabilities=null;this.is_using_free_license=null;this.inputs=null;this.existing_input_names=[];this.selector_gadget_added_interval=null;this.sg_state=this.STATE_UNINITIALIZED;this.fetched_input_name=null;this.fetched_input_owner=null;this.fetched_input_namespace=null;this.form_key=Splunk.util.getFormKey();this.loaded_iframe_url=null;this.is_on_cloud=null;this.getExistingInputs();this.indexes=new Indexes();this.indexes.on("reset",this.gotIndexes.bind(this),this);this.indexes.fetch({success:function(){console.info("Successfully retrieved the list of indexes")},error:function(){console.error("Unable to fetch the indexes")}});var version=$C.VERSION_LABEL.split(".");if(version.length>1){var major=Number(version[0]);if(major<=6){require(["css!../app/website_input/css/StepControlWizard.css"])}}setInterval(this.tryToLoadSelectorGadget.bind(this),2000)},showSelectorHelp:function(){$("#selector-help-dialog",this.$el).modal();return false},showAuthenticationHelp:function(){$("#authentication-help-dialog",this.$el).modal();return false},addIfInputIsNonEmpty:function(d,name,inputid){if($(inputid,this.$el).val().length>0){d[name]=$(inputid,this.$el).val()}},addCheckboxInput:function(d,name,inputid){if($(inputid,this.$el).is(":checked")){d[name]="1"}else{d[name]="0"}},showBrowserHelp:function(){$("#browser-help-dialog",this.$el).modal();return false},clearTestBrowserLink:function(){$("#browserTestResults",this.$el).removeClass("browserChecking").removeClass("browserDoesntWork").removeClass("browserWorks").html("")},clickTestBrowser:function(){var args={browser:$("#inputBrowser",this.$el).val()};this.clearTestBrowserLink();$("#browserTestResults",this.$el).addClass("browserChecking").html("Testing...");$.ajax({url:Splunk.util.make_full_url("/splunkd/__raw/services/data/website_input_ops/test_browser"),data:args,type:"GET",success:function(result){if(result.success){$("#browserTestResults",this.$el).removeClass("browserChecking").addClass("browserWorks").html('<i class="icon-check"></i> Browser works!')}else{$("#browserTestResults",this.$el).removeClass("browserChecking").addClass("browserDoesntWork").html('<i class="icon-alert"></i> Browser didn\'t work :(')}console.info("Successfully tested the browser")}.bind(this),error:function(){}.bind(this)});return false},clearDetectFieldsLink:function(){$("#detectFieldResults",this.$el).removeClass("detectFieldsChecking").removeClass("detectFieldsFailed").removeClass("detectFieldsWorked").html("")},clickDetermineFormFields:function(e){this.determineFormFields(e,true);return false},determineFormFields:function(e,force){if(typeof force==="undefined"){force=false}if($("#inputLoginURL",this.$el).val().length===0){return}if(!force&&$("#inputUsernameField",this.$el).val().length>0&&$("#inputPasswordField",this.$el).val().length>0){return}this.clearDetectFieldsLink();$("#detectFieldResults",this.$el).addClass("detectFieldsChecking").html("Detecting...");var args={url:$("#inputLoginURL",this.$el).val(),user_agent:$("#inputUserAgent",this.$el).val()};$.ajax({url:Splunk.util.make_full_url("/splunkd/__raw/services/data/website_input_ops/get_login_fields"),data:args,type:"GET",success:function(result){if(result.username_field&&result.password_field){if(force||$("#inputUsernameField",this.$el).val()===""){$("#inputUsernameField",this.$el).val(result.username_field)}if(force||$("#inputPasswordField",this.$el).val()===""){$("#inputPasswordField",this.$el).val(result.password_field)}console.info("Successfully loaded the login form information");$("#detectFieldResults",this.$el).removeClass("detectFieldsChecking").addClass("detectFieldsWorked").html('<i class="icon-check"></i> Login fields detected')}else{$("#detectFieldResults",this.$el).removeClass("detectFieldsChecking").addClass("detectFieldsFailed").html('<i class="icon-alert"></i> Login fields could not be detected')}}.bind(this),error:function(){$("#detectFieldResults",this.$el).removeClass("detectFieldsChecking").addClass("detectFieldsFailed").html('<i class="icon-alert"></i> Login fields could not be detected')}.bind(this)});return false},showResultsPreview:function(){this.previewResultsView.updatePreview(this.makeConfig(true))},openPreviewInSearch:function(){var config=this.makeConfig();var arg_str="";var arguments_translation={interval:null,host:null,index:null,title:null,name:null,output_results:null,username:null,password:null,username_field:null,password_field:null,authentication_url:null};var default_arguments={timeout:"5",browser:"integrated_client",user_agent:"Splunk Website Input (+https://splunkbase.splunk.com/app/1818/)",page_limit:"1",depth_limit:"2",raw_content:"0",output_as_mv:"1",use_element_name:"0"};for(var k in config){var translation=arguments_translation[k];if(translation===null){continue}var value=config[k];var param_name=k;if(translation!==undefined){param_name=translation}if(default_arguments[param_name]!==undefined&&default_arguments[param_name]===value){}else{if(value.length>0&&/^[0-9]+$/gi.test(value)){arg_str=arg_str+param_name+"="+value+" "}else{if(value.length>0){arg_str=arg_str+param_name+'="'+value+'" '}}}}var url="search?q="+encodeURIComponent("| webscrape "+arg_str);var win=window.open(url,"_blank");win.focus()},renderPreviewURLs:function(urls){var html="";var option_template=_.template('<li><a href="#" data-url="<%- url %>" class="preview-url"><%- url %></a></li>');for(var c=0;c<urls.length;c++){html+=option_template({url:urls[c]})}$(".preview-url-dropdown-selector").html(html)},updatePreviewURLs:function(){$(".preview-urls-loading",this.$el).show();var args={};this.addIfInputIsNonEmpty(args,"page_limit","#inputPageLimit");this.addIfInputIsNonEmpty(args,"depth_limit","#inputDepthLimit");this.addIfInputIsNonEmpty(args,"url_filter","#inputURLFilter");this.addIfInputIsNonEmpty(args,"uri","#inputURL");this.addIfInputIsNonEmpty(args,"page_limit","#inputPageLimit");this.addIfInputIsNonEmpty(args,"browser","#inputBrowser");this.addIfInputIsNonEmpty(args,"timeout","#inputTimeout");this.addIfInputIsNonEmpty(args,"user_agent","#inputUserAgent");this.addIfInputIsNonEmpty(args,"username","#inputUsername");this.addIfInputIsNonEmpty(args,"password","#inputPassword");this.addIfInputIsNonEmpty(args,"authentication_url","#inputLoginURL");this.addIfInputIsNonEmpty(args,"username_field","#inputUsernameField");this.addIfInputIsNonEmpty(args,"password_field","#inputPasswordField");if(parseInt(args.page_limit,10)>10){args.page_limit="10"}$.ajax({url:Splunk.util.make_full_url("/splunkd/__raw/services/data/website_input_ops/scrape_page"),data:args,type:"POST",success:function(results){var urls=[];for(var c=0;c<results.length;c++){urls.push(results[c]["url"])}if(urls.length>0){this.renderPreviewURLs(urls)}else{this.renderPreviewURLs([$("#inputURL",this.$el).val()])}$(".preview-urls-loading",this.$el).hide();console.info("Successfully retrieved the preview URLs")}.bind(this),error:function(){$(".preview-urls-loading",this.$el).hide();console.error("Unable to fetch the results")}.bind(this)})},setIfValueIsNonEmpty:function(input,value){if(value!==null&&value!==undefined){$(input,this.$el).val(value)}},setCheckboxInput:function(input,value){if(value===true||value===false){$(input,this.$el).prop("checked",value);return}if(value!==null&&value!==undefined&&(value==="1"||value.toLowerCase()==="true")){$(input,this.$el).prop("checked",true)}else{$(input,this.$el).prop("checked",false)}},loadInput:function(input){if(input.content.name!==null){mvc.Components.getInstance("name").val(input.content.name)}mvc.Components.getInstance("index").val(input.content.index);mvc.Components.getInstance("host").val(input.content.host);if(input.content.sourcetype!==null){mvc.Components.getInstance("sourcetype").val(input.content.sourcetype)}this.setIfValueIsNonEmpty("#inputSelector",input.content.selector);this.setIfValueIsNonEmpty("#inputURL",input.content.url);this.setIfValueIsNonEmpty("#inputInterval",input.content.interval);if(input.content.title!==null){mvc.Components.getInstance("title").val(input.content.title)}this.setIfValueIsNonEmpty("#inputTimeout",input.content.timeout);this.setIfValueIsNonEmpty("#inputBrowser",input.content.browser);this.setIfValueIsNonEmpty("#inputUserAgent",input.content.user_agent);this.setIfValueIsNonEmpty("#inputPageLimit",input.content.page_limit);this.setIfValueIsNonEmpty("#inputURLFilter",input.content.url_filter);this.setIfValueIsNonEmpty("#inputDepthLimit",input.content.depth_limit);this.setIfValueIsNonEmpty("#inputUsername",input.content.username);this.setIfValueIsNonEmpty("#inputPassword",input.content.password);this.setIfValueIsNonEmpty("#inputLoginURL",input.content.authentication_url);this.setIfValueIsNonEmpty("#inputUsernameField",input.content.username_field);this.setIfValueIsNonEmpty("#inputPasswordField",input.content.password_field);this.setIfValueIsNonEmpty("#inputNameAttributes",input.content.name_attributes);this.setIfValueIsNonEmpty("#inputTextSeparator",input.content.text_separator);this.setCheckboxInput("#inputIncludeRaw",input.content.raw_content);this.setCheckboxInput("#inputIncludeEmpty",input.content.empty_matches);this.setCheckboxInput("#inputMV",input.content.output_as_mv);this.setCheckboxInput("#inputUseTagAsField",input.content.use_element_name);if(input.content.output_results!==null){mvc.Components.getInstance("output_results").val(input.content.output_results)}},fetchInput:function(input_name,namespace,owner){if(typeof namespace==="undefined"){var namespace=null}if(typeof owner==="undefined"){var owner=null}var promise=$.Deferred();var params={};params.output_mode="json";var uri=splunkd_utils.fullpath("/services/data/inputs/web_input/"+input_name);if(owner!==null&&namespace!==null){uri=splunkd_utils.fullpath("/servicesNS/"+encodeURIComponent(owner)+"/"+encodeURIComponent(namespace)+"/data/inputs/web_input/"+encodeURIComponent(input_name))}uri+="?"+Splunk.util.propToQueryString(params);jQuery.ajax({url:uri,type:"GET",success:function(result){if(result!==undefined&&result.isOk===false){console.error("Input could not be obtained: "+result.message);promise.reject()}else{if(result===undefined||result===null){console.error("Input could not be obtained: result object is null or undefined");promise.reject()}else{input=result.entry[0];promise.resolve(input)}}}.bind(this),error:function(jqXHR,textStatus,errorThrown){promise.reject()}.bind(this)});return promise},changeInputSelector:function(ev){this.refreshSelector($("#inputSelector").val())},keypressInputSelector:function(ev){var code=ev.keyCode||ev.which;if(code==13){this.refreshSelector($("#inputSelector").val())}},updateMatchCount:function(){var matches="";if($("#inputSelector",this.$el).val().trim().length>0){matches=$($("#inputSelector",this.$el).val(),frames[0].window.document).length}if(matches===""){$(".match-count",this.$el).text(matches)}else{if(matches===1){$(".match-count",this.$el).text("1 match in the current document")}else{if(matches>1||matches===0){$(".match-count",this.$el).text(matches+" matches in the current document")}}}},refreshSelector:function(selector){if(frames[0].window.selector_gadget){}frames[0].window.postMessage({selector:selector},"*");this.updateMatchCount()},clearSelector:function(){$("#_sg_div > input:nth-of-type(2)",frames[0].window.document).trigger("click")},gotIndexes:function(){if(mvc.Components.getInstance("index")){mvc.Components.getInstance("index").settings.set("choices",this.getChoices(this.indexes,function(entry){return !(entry.attributes.name[0]==="_")}))}},getChoices:function(collection,filter_fx){if(typeof filter_fx==="undefined"){filter_fx=null}if(!collection){return[]}var choices=[];for(var c=0;c<collection.models.length;c++){if(filter_fx&&!filter_fx(collection.models[c].entry)){continue}choices.push({label:collection.models[c].entry.attributes.name,value:collection.models[c].entry.attributes.name})}return choices},switchStyles:function(ev){var style=$(ev.target).text();$(".switch-styles > .btn").each(function(){if($(this).text()===style){$(this).addClass("active")}else{$(this).removeClass("active")}});if(this.loaded_iframe_url!==null){this.updatePreview(this.loaded_iframe_url)}else{this.updatePreview($("#inputURL",this.$el).val())}},clickOpenURL:function(ev){var url=$("#inputURL").val();window.open(url,"_blank")},changeInputURL:function(ev){var url=$("#inputURL").val();if(!url||url.length===""){$(".openInNewTab").addClass("hide")}else{$(".openInNewTab").removeClass("hide")}return this.clickUpdatePreview(ev)},clickUpdatePreview:function(ev){var url=$(ev.target).data("url");this.updatePreview(url);return true},selectorGadgetReceived:function(event){if(!event||!event.data||!event.data.message){console.warn("Selector gadget provided an invalid message");return}else{if(event.data.message==="selector_gadget_ready"){frames[0].window.postMessage({selector:$("#inputSelector",this.$el).val()},"*");this.sg_state=this.STATE_READY;console.info("Selector gadget is ready");return}else{if(event.data.message!=="selector_updated"||!event.data.selector){return}}}console.log("Got an event from selector gadget with an updated selector");if(this.sg_state<this.STATE_READY){this.refreshSelector($("#inputSelector",this.$el).val());return}if(event.data.selector===null){$("#inputSelector",this.$el).val("");this.updateMatchCount()}else{$("#inputSelector",this.$el).val(event.data.selector);this.updateMatchCount()}},tryToLoadSelectorGadget:function(){if(frames.length===0){return}if(this.sg_state>this.STATE_UNINITIALIZED){return}if(typeof frames[0].window.selector_gadget!=="undefined"){return}if((frames[0].window.document.readyState==="loaded"||frames[0].window.document.readyState==="interactive"||frames[0].window.document.readyState==="complete")&&frames[0].window.document.body!==null&&frames[0].window.document.body.innerHTML.length>0&&typeof frames[0].window.selector_gadget==="undefined"){console.log("Loading the selector gadget into the preview frame");this.startSelectorGadget();this.sg_state=this.STATE_LOADED;window.addEventListener("message",this.selectorGadgetReceived.bind(this),false)}},updatePreview:function(url){this.loaded_iframe_url=url;this.sg_state=this.STATE_UNINITIALIZED;$("#preview-panel",this.$el).attr("src","");if(!url||url===""){return}$(".page-preview-loading",this.$el).show();var params={};params.url=url;if($("#inputUsername",this.$el).val().length>0&&$("#inputPassword",this.$el).val().length>0){params.username=$("#inputUsername",this.$el).val();params.password=$("#inputPassword",this.$el).val()}if($("#inputBrowser",this.$el).val().length>0){params.browser=$("#inputBrowser",this.$el).val()}if($("#inputTimeout",this.$el).val().length>0){params.timeout=$("#inputTimeout",this.$el).val()}if($(".styles-off.active",this.$el).length>0){params.clean_styles="1"}this.addIfInputIsNonEmpty(params,"authentication_url","#inputLoginURL");this.addIfInputIsNonEmpty(params,"username_field","#inputUsernameField");this.addIfInputIsNonEmpty(params,"password_field","#inputPasswordField");this.addIfInputIsNonEmpty(params,"user_agent","#inputUserAgent");var uri=Splunk.util.make_url("/splunkd/__raw/services/data/website_input_ops/load_page");uri+="?"+Splunk.util.propToQueryString(params);$("#preview-form",this.$el).attr("action",uri);$("#form-key",this.$el).val(this.form_key);$("#preview-form",this.$el).submit();var selector_to_hide_when_done=$(".page-preview-loading",this.$el);$("iframe").load(function(){selector_to_hide_when_done.hide();$("iframe").contents().find("a").each(function(index){$(this).on("click",function(event){event.preventDefault();event.stopPropagation()})});$("iframe").contents().find("form").each(function(index){$(this).on("submit",function(event){event.preventDefault();event.stopPropagation()})})});return},createStep:function(step){if(this.steps===undefined){this.steps=new Backbone.Collection()}var newStep={label:_(step.label).t(),value:step.value,showNextButton:step.showNextButton!==undefined?step.showNextButton:true,showPreviousButton:step.showPreviousButton!==undefined?step.showPreviousButton:true,showDoneButton:step.showDoneButton!==undefined?step.showDoneButton:false,doneLabel:step.doneLabel||"Done",enabled:true,panelID:step.panelID,validate:function(selectedModel,isSteppingNext){var promise=$.Deferred();var validation_response=true;if(typeof this.validateStep!==undefined){validation_response=this.validateStep(selectedModel,isSteppingNext)}if(validation_response===true){promise.resolve()}else{if(validation_response===false){promise.reject()}else{return validation_response}}return promise}.bind(this)};return newStep},initializeSteps:function(){var c=0;this.steps=new Backbone.Collection();this.steps.add(this.createStep({label:"Enter URL",value:"url-edit",showNextButton:true,showPreviousButton:false,panelID:"#url-edit"}),{at:++c});this.steps.add(this.createStep({label:"Enter Credentials",value:"auth-edit",showNextButton:true,showPreviousButton:true,panelID:"#auth-edit"}),{at:++c});this.steps.add(this.createStep({label:"Define CSS Selector",value:"selector-edit",showNextButton:true,showPreviousButton:true,panelID:"#selector-edit"}),{at:++c});this.steps.add(this.createStep({label:"Customize Output",value:"output-edit",showNextButton:true,showPreviousButton:true,panelID:"#output-edit"}),{at:++c});this.steps.add(this.createStep({label:"Define Input Settings",value:"index-edit",showNextButton:true,showPreviousButton:true,panelID:"#index-edit"}),{at:++c});this.steps.add(this.createStep({label:"Save Input",value:"name-edit",showNextButton:true,showPreviousButton:true,panelID:"#name-edit"}),{at:++c});this.steps.add(this.createStep({label:"Finish",value:"final",showNextButton:false,showPreviousButton:false,showDoneButton:true,panelID:"#final"}),{at:++c})},clearValidationError:function(inputID){$(inputID).parent().parent().removeClass("error")},clearValidationErrors:function(){$.each($("input"),function(i,val){if($(val).parent().parent().hasClass("control-group")){$(val).parent().parent().removeClass("error");$(".help-inline",$(val).parent()).text("")}})},addValidationError:function(inputID,message){$(inputID).parent().parent().addClass("error");if($(".help-inline",$(inputID).parent()).length===0){$('<span class="help-inline"></span>').insertAfter(inputID)}$(".help-inline",$(inputID).parent()).text(message)},validateStep:function(selectedModel,isSteppingNext){var data=this.makeConfig();var issues=0;this.clearValidationErrors();if(selectedModel.get("value")==="url-edit"&&isSteppingNext){if(!this.isValidInterval($("#inputInterval").val())){this.addValidationError($("#inputInterval"),"Enter a valid interval");issues+=1}if($("#inputURL").val().length===0){this.addValidationError($("#inputURL"),"Enter a valid URL");issues+=1}else{if(this.is_on_cloud&&!$("#inputURL").val().startsWith("https://")){this.addValidationError($("#inputURL"),"Enter a URL that uses HTTPS (only HTTPS is allowed on cloud)");issues+=1}else{if(!this.is_on_cloud&&!$("#inputURL").val().startsWith("https://")&&!$("#inputURL").val().startsWith("http://")){this.addValidationError($("#inputURL"),"Enter a valid URL with either the HTTP or HTTPS protocol");issues+=1}}}if($("#inputDepthLimit").val().length!==0&&$("#inputDepthLimit").val().match(/^[0-9]+$/gi)===null){this.addValidationError($("#inputDepthLimit"),"Enter a valid integer");issues+=1}if($("#inputPageLimit").val().length!==0&&$("#inputPageLimit").val().match(/^[0-9]+$/gi)===null){this.addValidationError($("#inputPageLimit"),"Enter a valid integer");issues+=1}if($("#inputTimeout").val().length!==0&&$("#inputTimeout").val().match(/^[0-9]+$/gi)===null){this.addValidationError($("#inputTimeout"),"Enter a valid integer");issues+=1}if($("#inputBrowser").val()==="integrated_client"){$(".hide-when-using-browser",this.$el).show()}else{$(".hide-when-using-browser",this.$el).hide()}}if(selectedModel.get("value")==="auth-edit"&&isSteppingNext){if(this.is_on_cloud&&$("#inputLoginURL").val().length!==0&&!$("#inputLoginURL").val().startsWith("https://")){this.addValidationError($("#inputLoginURL"),"Enter a URL that uses HTTPS (only HTTPS is allowed on cloud)");issues+=1}else{if(!this.is_on_cloud&&$("#inputLoginURL").val().length!==0&&!$("#inputLoginURL").val().startsWith("https://")&&!$("#inputLoginURL").val().startsWith("http://")){this.addValidationError($("#inputLoginURL"),"Enter a valid URL with either the HTTP or HTTPS protocol");issues+=1}else{if(($("#inputLoginURL").val().length!==0||$("#inputPasswordField").val().length!==0)&&$("#inputLoginURL").val().length===0){this.addValidationError($("#inputLoginURL"),"Enter a URL of the login page");issues+=1}else{this.updatePreview($("#inputURL",this.$el).val());this.renderPreviewURLs([$("#inputURL",this.$el).val()]);this.updatePreviewURLs();this.clearDetectFieldsLink()}}}}if(selectedModel.get("value")==="name-edit"&&isSteppingNext){var promise=$.Deferred();$.when(this.saveInput(data)).then(function(){}).then(this.savePassword(data.name)).then(function(){promise.resolve()}).fail(function(msg){alert("The input could not be saved: "+msg);promise.reject()});return promise}if(issues>0){return false}else{return true}},setupStepWizard:function(initialStep){var wizard=new Backbone.Model({currentStep:initialStep});wizard.on("change:currentStep",function(model,currentStep){this.steps.map(function(step){step.stopListening()}.bind(this));var step=this.steps.find(function(step){return step.get("value")==currentStep});if(step.get("showNextButton")){$("button.btn-next",this.$el).show()}else{$("button.btn-next",this.$el).hide()}if(step.get("showPreviousButton")){$("button.btn-prev",this.$el).show()}else{$("button.btn-prev",this.$el).hide()}if(step.get("showDoneButton")){$("button.btn-finalize",this.$el).show();$("button.btn-finalize",this.$el).text(step.get("doneLabel"))}else{$("button.btn-finalize",this.$el).hide()}$(".wizard-content",this.$el).hide();$(step.get("panelID"),this.$el).show()}.bind(this));this.steps.unshift({label:"",value:"initial",showNextButton:false,showPreviousButton:false,enabled:false});this.stepWizard=new StepWizardControl({model:wizard,modelAttribute:"currentStep",collection:this.steps});$("#step-control-wizard",this.$el).append(this.stepWizard.render().el);$(".wizard-content",this.$el).hide();var initialStep=this.steps.find(function(step){return step.get("value")==initialStep});$(initialStep.get("panelID"),this.$el).show();this.stepWizard.step(1)},parseURL:function(url){var parser=document.createElement("a");parser.href=url;return parser},generateStanzaFromString:function(str,existing_stanzas){if(str===undefined||str===null||str===""){return""}if(typeof existing_stanzas=="undefined"||existing_stanzas===null){existing_stanzas=[]}if(existing_stanzas.length===0){return str.replace(/[^a-z0-9_]/gi,"_").toLowerCase()}var stanza_base=str.replace(/[^a-z0-9_]/gi,"_").toLowerCase();var possible_stanza=stanza_base;var stanza_suffix_offset=0;var collision_found=false;while(true){collision_found=false;for(var c=0;c<existing_stanzas.length;c++){if(existing_stanzas[c]===possible_stanza){collision_found=true;break}}if(!collision_found){return possible_stanza}else{stanza_suffix_offset=stanza_suffix_offset+1;possible_stanza=stanza_base+"_"+stanza_suffix_offset}}},generateTitleFromURL:function(url){var parsed=this.parseURL(url);return parsed.hostname},generateStanzaFromURL:function(url,existing_stanzas){var parsed=this.parseURL(url);return this.generateStanzaFromString(parsed.hostname)},generateFilterFromURL:function(url){var parsed=this.parseURL(url);var url_filter=parsed.protocol+"//"+parsed.hostname;if(parsed.port!==""){url_filter=url_filter+":"+parsed.port}return url_filter+"/*"},changeInputSelector:function(){if($("#inputURLFilter",this.$el).val().length!==0){}else{if(parseInt($("#inputPageLimit",this.$el).val(),10)<=1){}else{if($("#inputURL",this.$el).val().length<=0){}else{if($("#inputURL",this.$el).val().indexOf("http")===0&&this.isValidURL($("#inputURL",this.$el).val())){$("#inputURLFilter",this.$el).val(this.generateFilterFromURL($("#inputURL",this.$el).val()))}}}}},suggestURLFilter:function(){if($("#inputURL",this.$el).val().length<=0){}else{if($("#inputURL",this.$el).val().indexOf("http")===0&&this.isValidURL($("#inputURL",this.$el).val())){$("#inputURLFilter",this.$el).val(this.generateFilterFromURL($("#inputURL",this.$el).val()))}}return false},getExistingInputs:function(){var uri=splunkd_utils.fullpath("/services/data/inputs/web_input?output_mode=json");jQuery.ajax({url:uri,type:"GET",async:false,success:function(result){if(result!==undefined){this.inputs=result.entry}this.existing_input_names=[];for(var c=0;c<this.inputs.length;c++){this.existing_input_names.push(this.inputs[c]["name"])}}.bind(this)})},addIfNonEmpty:function(d,name,value){if(value){d[name]=value}},makeConfig:function(include_password){if(typeof include_password==="undefined"){include_password=false}var data={};if(this.isNew()&&mvc.Components.getInstance("name").val()){data.name=mvc.Components.getInstance("name").val()}if(mvc.Components.getInstance("index").val()){data.index=mvc.Components.getInstance("index").val()}if(mvc.Components.getInstance("host").val()){data.host=mvc.Components.getInstance("host").val()}if(mvc.Components.getInstance("sourcetype").val()){data.sourcetype=mvc.Components.getInstance("sourcetype").val()}this.addIfInputIsNonEmpty(data,"selector","#inputSelector");this.addIfInputIsNonEmpty(data,"url","#inputURL");this.addIfInputIsNonEmpty(data,"interval","#inputInterval");if(mvc.Components.getInstance("title").val()){data.title=mvc.Components.getInstance("title").val()}this.addIfInputIsNonEmpty(data,"timeout","#inputTimeout");this.addIfInputIsNonEmpty(data,"browser","#inputBrowser");this.addIfInputIsNonEmpty(data,"user_agent","#inputUserAgent");this.addIfInputIsNonEmpty(data,"page_limit","#inputPageLimit");this.addIfInputIsNonEmpty(data,"url_filter","#inputURLFilter");this.addIfInputIsNonEmpty(data,"depth_limit","#inputDepthLimit");this.addIfInputIsNonEmpty(data,"username","#inputUsername");if(include_password){this.addIfInputIsNonEmpty(data,"password","#inputPassword")}else{data.password=""}this.addIfInputIsNonEmpty(data,"authentication_url","#inputLoginURL");this.addIfInputIsNonEmpty(data,"username_field","#inputUsernameField");this.addIfInputIsNonEmpty(data,"password_field","#inputPasswordField");this.addIfInputIsNonEmpty(data,"name_attributes","#inputNameAttributes");this.addIfInputIsNonEmpty(data,"text_separator","#inputTextSeparator");this.addCheckboxInput(data,"raw_content","#inputIncludeRaw");this.addCheckboxInput(data,"empty_matches","#inputIncludeEmpty");this.addCheckboxInput(data,"output_as_mv","#inputMV");this.addCheckboxInput(data,"use_element_name","#inputUseTagAsField");if(mvc.Components.getInstance("output_results").val()){data.output_results=mvc.Components.getInstance("output_results").val()}if(!data.hasOwnProperty("name")&&this.isNew()){data.name=this.generateStanzaFromURL(data.url,this.existing_input_names)}if(!data.hasOwnProperty("title")){data.title=this.generateTitleFromURL(data.url)}return data},savePassword:function(name){var password=$("#inputPassword",this.$el).val();var stanza_name;if(name!==undefined){stanza_name=name}else{stanza_name=this.fetched_input_name}if(password.length===0){secure_storage_stanza=this.makeStorageEndpointStanza(this.options.secure_storage_username,this.options.secure_storage_realm_prefix+stanza_name);return this.deleteEncryptedCredential(secure_storage_stanza,true)}else{return this.saveEncryptedCredential(this.options.secure_storage_username,password,this.options.secure_storage_realm_prefix+stanza_name)}},saveInput:function(config){var promise=jQuery.Deferred();var params={};params.output_mode="json";var uri=splunkd_utils.fullpath("/servicesNS/admin/website_input/data/inputs/web_input");if(this.fetched_input_name!==null&&this.fetched_input_name!=="_new"){uri=splunkd_utils.fullpath("/servicesNS/"+encodeURIComponent(this.fetched_input_owner)+"/"+encodeURIComponent(this.fetched_input_namespace)+"/data/inputs/web_input/"+encodeURIComponent(this.fetched_input_name))}uri+="?"+Splunk.util.propToQueryString(params);$.ajax({url:uri,data:config,type:"POST",success:function(data){console.info("Input saved");var app=data.entry[0].acl.app;var owner=data.entry[0].acl.owner;var name=data.entry[0].name}.bind(this),complete:function(jqXHR,textStatus){if(jqXHR.status==403){console.info("Inadequate permissions");this.showWarningMessage("You do not have permission to make inputs")}else{if(jqXHR.status==409){console.info("Input already exists")}}promise.resolve()}.bind(this),error:function(jqXHR,textStatus,errorThrown){if(jqXHR.status===403){promise.reject("You do not have permission to make inputs")}else{if(jqXHR.status===409){promise.reject("An input with the given name already exists")}else{promise.reject("An error occurred")}}}.bind(this)});return promise},validate:function(){var issues=0;return issues===0},isValidURL:function(url){var regex=/^(https?:\/\/)?([\da-z\.-]+)([:][0-9]+)?([\/\w \.-]*)*\/?$/gi;return regex.test(url)},isValidInterval:function(interval){var re=/^\s*([0-9]+([.][0-9]+)?)\s*([dhms])?\s*$/gi;if(re.exec(interval)){return true}else{return false}},validateURL:function(event){if(!this.isValidURL(event.item)){if(this.isValidURL("http://"+event.item)){$("#urls").tagsinput("add","http://"+event.item)}event.cancel=true}},hide:function(selector){selector.css("display","none");selector.addClass("hide")},unhide:function(selector){selector.removeClass("hide");selector.removeAttr("style")},hideMessages:function(){this.hideWarningMessage();this.hideInfoMessage()},hideWarningMessage:function(){this.hide($("#warning-message",this.$el))},hideInfoMessage:function(){this.hide($("#info-message",this.$el))},showWarningMessage:function(message){$("#warning-message > .message",this.$el).text(message);this.unhide($("#warning-message",this.$el))},showInfoMessage:function(message){$("#info-message > .message",this.$el).text(message);this.unhide($("#info-message",this.$el))},hasCapability:function(capability){var uri=Splunk.util.make_url("/splunkd/__raw/services/authentication/current-context?output_mode=json");if(this.capabilities===null){jQuery.ajax({url:uri,type:"GET",async:false,success:function(result){if(result!==undefined){this.capabilities=result.entry[0].content.capabilities}}.bind(this)})}if(this.capabilities.length===0&&this.is_using_free_license===null){uri=Splunk.util.make_url("/splunkd/__raw/services/licenser/groups/Free?output_mode=json");jQuery.ajax({url:uri,type:"GET",async:false,success:function(result){if(result!==undefined){this.is_using_free_license=result.entry[0].content.is_active}else{this.is_using_free_license=false}}.bind(this)})}if(this.is_using_free_license){return true}else{return $.inArray(capability,this.capabilities)>=0}},importJS:function(src,look_for,onload){var s=document.createElement("script");s.setAttribute("type","text/javascript");s.setAttribute("src",src);if(onload){this.waitForScriptLoad(look_for,onload)}var head=frames[0].window.document.getElementsByTagName("head")[0];if(head){head.appendChild(s)}else{frames[0].window.document.body.appendChild(s)}},importCSS:function(href,look_for,onload){var s=frames[0].window.document.createElement("link");s.setAttribute("rel","stylesheet");s.setAttribute("type","text/css");s.setAttribute("media","screen");s.setAttribute("href",href);if(onload){this.waitForScriptLoad(look_for,onload)}var head=frames[0].window.document.getElementsByTagName("head")[0];if(head){head.appendChild(s)}else{frames[0].window.document.body.appendChild(s)}},waitForScriptLoad:function(look_for,callback){var interval=setInterval(function(){if(frames[0].window.eval("typeof "+look_for)!="undefined"){clearInterval(interval);callback()}},50)},startSelectorGadget:function(){this.sg_state=this.STATE_UNINITIALIZED;var base_url=document.location.origin+Splunk.util.make_url("/static/app/website_input/js/lib/selectorgadget/");frames[0].window.eval("function i18n_register(){};");var base_url=document.location.origin+Splunk.util.make_url("/static/app/website_input/js/lib/selectorgadget")+"/";this.importCSS(base_url+"selectorgadget_custom.css");this.importJS(base_url+"jquery.min.js","jQuery",function(){jQuery.noConflict();this.importJS(base_url+"diff_match_patch.js","diff_match_patch",function(){this.importJS(base_url+"dom.js","DomPredictionHelper",function(){this.importJS(base_url+"interface.js")}.bind(this))}.bind(this))}.bind(this))},isNew:function(){if(this.fetched_input_name===null||this.fetched_input_name==="_new"){return true}else{return false}},render:function(){var has_permission=this.hasCapability("edit_modinput_web_input");if(this.is_on_cloud===null){this.server_info=new ServerInfo()}new ServerInfo().fetch().done(function(model){if(model.entry[0].content.instance_type){this.is_on_cloud=model.entry[0].content.instance_type==="cloud"}else{this.is_on_cloud=false}this.$el.html(_.template(Template,{has_permission:has_permission,is_on_cloud:this.is_on_cloud}));this.previewResultsView=new PreviewWebsiteInputResultsView({el:$("#preview-results-modal-holder",this.$el)});var indexes_dropdown=new DropdownInput({id:"index",selectFirstChoice:false,showClearButton:true,el:$("#inputIndexes",this.$el),choices:this.getChoices(this.indexes)},{tokens:true}).render();var sourcetype_input=new TextInput({id:"sourcetype",searchWhenChanged:false,el:$("#inputSourcetype",this.$el)},{tokens:true}).render();var host_input=new TextInput({id:"host",searchWhenChanged:false,el:$("#inputHost",this.$el)},{tokens:true}).render();var title_input=new TextInput({id:"title",searchWhenChanged:false,el:$("#titleInput",this.$el)},{tokens:true}).render();title_input.on("change",function(newValue){if(!mvc.Components.getInstance("name").val()&&newValue!==""){mvc.Components.getInstance("name").val(this.generateStanzaFromString(newValue))}}.bind(this));var name_input=new TextInput({id:"name",searchWhenChanged:false,el:$("#nameInput",this.$el)},{tokens:true}).render();var output_results_dropdown=new DropdownInput({id:"output_results",selectFirstChoice:false,showClearButton:false,el:$("#inputOutputResults",this.$el),choices:[{label:"Always",value:"always"},{label:"Only when the matches change",value:"when_matches_change"},{label:"Only when the contents of the raw web-pages change",value:"when_contents_change"}]},{tokens:true}).render();this.initializeSteps();this.setupStepWizard("url-edit");if(Splunk.util.getParameter("name")){var secure_storage_stanza=this.makeStorageEndpointStanza(this.options.secure_storage_username,this.options.secure_storage_realm_prefix+Splunk.util.getParameter("name"));$.when(this.fetchInput(decodeURIComponent(Splunk.util.getParameter("name")),decodeURIComponent(Splunk.util.getParameter("namespace")),decodeURIComponent(Splunk.util.getParameter("owner"))),this.getEncryptedCredential(secure_storage_stanza,true)).done(function(input,credential){console.info("Successfully retrieved the input");this.loaded_input=input;this.loadInput(this.loaded_input);this.fetched_input_name=decodeURIComponent(Splunk.util.getParameter("name"));this.fetched_input_owner=decodeURIComponent(Splunk.util.getParameter("owner"));this.fetched_input_namespace=decodeURIComponent(Splunk.util.getParameter("namespace"));$(".hide-if-existing",this.$el).hide();if(credential){$("#inputPassword",this.$el).val(credential.entry.content.attributes.clear_password)}}.bind(this)).fail(function(msg){console.error("Failed to retrieve the input");$("#input-not-loaded",this.$el).show();$("#step-control-wizard",this.$el).hide();$(".wizard-content",this.$el).hide()}.bind(this))}else{this.fetched_input_name=null;this.fetched_input_namespace=null;this.fetched_input_owner=null;$.when(this.fetchInput("_new")).done(function(input){console.log("Got the _new input");this.loaded_input=input;this.loadInput(this.loaded_input)}.bind(this))}}.bind(this))}});return WebsiteInputCreateView});