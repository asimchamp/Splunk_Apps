<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Configure GigaVUE-FM | Splunk</title>
    <link rel="shortcut icon" href="{{SPLUNKWEB_URL_PREFIX}}/static/img/favicon.ico" />
        <link rel="stylesheet" type="text/css" href="/en-US/static/@264376/css/build/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="/en-US/static/@264376/css/build/pages/dashboard-simple-bootstrap.min.css" />
    <!--- CUSTOM STYLE SCRIPTS -->
  <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/GigamonForSplunk/css/tabs.css" />  
  <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/static/app/GigamonForSplunk/dashboard.css"/>
    <!--[if IE 7]><link rel="stylesheet" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/sprites-ie7.css" /><![endif]-->
</head>
<body class="simplexml preload locale-en">
<!-- 
BEGIN LAYOUT
This section contains the layout for the dashboard. Splunk uses proprietary
styles in <div> tags, similar to Bootstrap's grid system. 
-->
<a class="navSkip" href="#navSkip" tabindex="1">Screen reader users, click here to skip the navigation bar</a>
<div class="header splunk-header">
        <div id="placeholder-splunk-bar">
            <a href="{{SPLUNKWEB_URL_PREFIX}}/app/launcher/home" class="brand" title="splunk &gt; listen to your data">splunk<strong>&gt;</strong></a>
        </div>
            <div id="placeholder-app-bar"></div>
</div>
<a id="navSkip"></a>
<div class="dashboard-body container-fluid main-section-body" data-role="main">
    <div class="dashboard-header clearfix">
        <h2>Configure GigaVUE-FM Hosts</h2>
    </div>

  <div id="row1" class="dashboard-row dashboard-row1">
        <div id="panel1" class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">

                <div class="panel-element-row">
                    <div id="html_notes" class="dashboard-element html" style="width: 100%">
                        <div class="panel-body html">
                          <strong>Note:</strong> The Modify tab does not actually modify anything. It is currently only for DELETING hosts and credentials.
                          <br/><strong>Also:</strong>The times listed in the Intervals dropdown are in seconds.
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  <div id="tabs" class="dashboard-row dashboard-row1" data-original-id="tabs">
        <div id="panel1" class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">
                
                <div class="panel-element-row">
                    <div id="element1" class="dashboard-element html" style="width: 100%">
                        <div class="panel-body html">
                                <ul id="tabs" class="nav nav-tabs">
                    <li class="active">
                        <a href="#" class="toggle-tab" data-toggle="tab" data-elements="addCredentials">Add GigaVUE-FM</a>
                    </li>
					<li id="modifyCredentials_tab">
						<a href="#" class="toggle-tab" data-toggle="tab" data-elements="modifyCredentials">Delete GigaVUE-FM</a>
					</li>
				</ul></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  	<div id="addCredentials" class="dashboard-row dashboard-row2 ui-corner-all" data-original-id="addCredentials">
        <div id="panel1" class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">
              <div id="add_error_msg" class=" ui-corner-all" style="padding:5px"></div>
                <div class="panel-element-row">
                    <div id="form" class="dashboard-element html" style="width: 100%">
                        <div class="panel-body html">
                           	<div class="fieldset">
                            <div class="input"><label><strong>Gigamon FM FQDN:</strong></label><div class="input input-text" id="gigahost"></div></div>
                          	<div class="input"><label><strong>Username:</strong></label><div class="input input-text" id="gigauser"></div></div>
                          	<div class="input"><label><strong>Password:</strong></label><div class="input input-text" id="gigapass"></div></div>
                              <div class="input"><label><strong>Interval:</strong></label><div class="input input-dropdown" id="gigainterval"></div></div>
                              <div class="input"><label><strong>Gigamon Details:</strong></label><div class="input input-checkbox" id="giga_services"></div></div>
                              <div class="input"><label><strong>FM Version:</strong></label><div class="input input-checkbox" id="giga_api"></div></div>
                        	<div class="form-submit" id="addCredentialSubmit"><button class="btn btn-primary submit">Add Credential</button></div>
                            </div>
                        
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  
  <div id="modifyCredentials" class="dashboard-row dashboard-row2" data-original-id="modifyCredentials">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel clearfix">
				<div id="modify_error_msg" class=" ui-corner-all" style="padding:5px"></div>
                <div class="panel-element-row">
                    <div class="dashboard-element html" id="credentials_list_parent" style="width: 100%">
                        <div id="credentials_list" class="panel-body html">
                        
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<div class="footer"></div>
<div id="templates" style="display:none"></div>
<!-- 
END LAYOUT
-->

<script src="{{SPLUNKWEB_URL_PREFIX}}/config?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/i18n.js"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/i18ncatalog?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/build/simplexml.min/config.js"></script>
  <script src="{{SPLUNKWEB_URL_PREFIX}}/static/app/GigamonForSplunk/js/tabs.js" type="text/javascript"></script>
  <script src="{{SPLUNKWEB_URL_PREFIX}}/static/app/GigamonForSplunk/js/general.js" type="text/javascript"></script>
<script type="text/javascript">
require.config({
    baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
    waitSeconds: 0 // Disable require.js load timeout
});

//
// LIBRARY REQUIREMENTS
//
// In the require function, we include the necessary libraries and modules for
// the HTML dashboard. Then, we pass variable names for these libraries and
// modules as function parameters, in order.
// 
// When you add libraries or modules, remember to retain this mapping order
// between the library or module and its function parameter. You can do this by
// adding to the end of these lists, as shown in the commented examples below.

require([
    "splunkjs/mvc",
    "splunkjs/mvc/utils",
    "splunkjs/mvc/tokenutils",
    "underscore",
    "jquery",
    "splunkjs/mvc/simplexml",
    "splunkjs/mvc/headerview",
    "splunkjs/mvc/footerview",
    "splunkjs/mvc/simplexml/dashboardview",
    "splunkjs/mvc/simplexml/dashboard/panelref",
    "splunkjs/mvc/simplexml/element/chart",
    "splunkjs/mvc/simplexml/element/event",
    "splunkjs/mvc/simplexml/element/html",
    "splunkjs/mvc/simplexml/element/list",
    "splunkjs/mvc/simplexml/element/map",
    "splunkjs/mvc/simplexml/element/single",
  	"splunkjs/mvc/tableview",
    "splunkjs/mvc/simpleform/formutils",
    "splunkjs/mvc/simplexml/eventhandler",
    "splunkjs/mvc/dropdownview",
    "splunkjs/mvc/simpleform/input/radiogroup",
    "splunkjs/mvc/simpleform/input/multiselect",
    "splunkjs/mvc/checkboxgroupview",
    "splunkjs/mvc/textinputview",
    "splunkjs/mvc/simpleform/input/timerange",
    "splunkjs/mvc/simpleform/input/submit",
    "splunkjs/mvc/searchmanager",
    "splunkjs/mvc/savedsearchmanager",
    "splunkjs/mvc/postprocessmanager",
    "splunkjs/mvc/simplexml/urltokenmodel"
    // Add comma-separated libraries and modules manually here, for example:
    // ..."splunkjs/mvc/simplexml/urltokenmodel",
    // "splunkjs/mvc/checkboxview"
    ],
    function(
        mvc,
        utils,
        TokenUtils,
        _,
        $,
        DashboardController,
        HeaderView,
        FooterView,
        Dashboard,
        PanelRef,
        ChartElement,
        EventElement,
        HtmlElement,
        ListElement,
        MapElement,
        SingleElement,
        TableElement,
        FormUtils,
        EventHandler,
        DropdownInput,
        RadioGroupInput,
        MultiSelectInput,
        CheckboxGroupInput,
        TextInput,
        TimeRangeInput,
        SubmitButton,
        SearchManager,
        SavedSearchManager,
        PostProcessManager,
        UrlTokenModel

        // Add comma-separated parameter names here, for example: 
        // ...UrlTokenModel, 
        // CheckboxView
        ) {

  		var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
        }
    }
};
  
  		
		$("<div class='navFooter' id='nav_footer'>&nbsp;<span class='bars fa fa-bars fa-2x'></span></div>").insertBefore("#navSkip");
                $(".header").slideToggle({direction: "up" }, 500);
                $('#nav_footer').click(function() {
                        $(".header").slideToggle( { direction: 'down'}, 500);
                });

		_APP_NAME = "GigamonForSplunk";
  
  		$("#templates").load("{{SPLUNKWEB_URL_PREFIX}}/static/app/"+_APP_NAME+"/html/templates.html?ts="+_.now());
		GigamonTemplateSettings = {
  			interpolate: /\{\{(.+?)\}\}/g
        };
        var pageLoading = true;


  		var showHeaders = getUrlParameter('showHeader');
  		if (!showHeaders || typeof showHeaders === 'undefined') {
  			console.log("These are not the droids you are looking for.");
  		} else {
  			$(".header").hide();
  			$("#nav_footer").hide();
  		}
        // 
        // TOKENS
        //
        
        // Create token namespaces
        var urlTokenModel = new UrlTokenModel();
        mvc.Components.registerInstance('url', urlTokenModel);
        var defaultTokenModel = mvc.Components.getInstance('default', {create: true});
        var submittedTokenModel = mvc.Components.getInstance('submitted', {create: true});

        urlTokenModel.on('url:navigate', function() {
            defaultTokenModel.set(urlTokenModel.toJSON());
            if (!_.isEmpty(urlTokenModel.toJSON()) && !_.all(urlTokenModel.toJSON(), _.isUndefined)) {
                submitTokens();
            } else {
                submittedTokenModel.clear();
            }
        });

        // Initialize tokens
        defaultTokenModel.set(urlTokenModel.toJSON());

        function submitTokens() {
            // Copy the contents of the defaultTokenModel to the submittedTokenModel and urlTokenModel
            FormUtils.submitForm({ replaceState: pageLoading });
        }

        function setToken(name, value) {
            defaultTokenModel.set(name, value);
            submittedTokenModel.set(name, value);
        }

        function unsetToken(name) {
            defaultTokenModel.unset(name);
            submittedTokenModel.unset(name);
        }

        
        
        //
        // SEARCH MANAGERS
        //



        //
        // SPLUNK HEADER AND FOOTER
        //

        new HeaderView({
            id: 'header',
            section: 'dashboards',
            el: $('.header'),
            acceleratedAppNav: true,
            useSessionStorageCache: true,
            splunkbar: true,
            appbar: true,
            litebar: false,
        }, {tokens: true}).render();

        new FooterView({
            id: 'footer',
            el: $('.footer')
        }, {tokens: true}).render();


        //
        // DASHBOARD EDITOR
        //

        new Dashboard({
            id: 'dashboard',
            el: $('.dashboard-body'),
            showTitle: true,
            editable: true
        }, {tokens: true}).render();

  		//Add Credentials
  		var service = mvc.createService({ owner: "nobody" });

  		var buildCredentialItem = function(row){
  							row.idname = $.trim(row.name).replace(/:/g,"_").replace(/\./g,"_").replace(/\//g,"");
  							
  						 	$(_.template($("#configured_credential").html(),row,GigamonTemplateSettings)).appendTo("#credentials_list");
  							
  							row.hostnameInput = new TextInput({
            					"id": "modify_hostname_"+row.idname,
            					"value": "$form.modify_hostname_"+row.idname+"$",
            					"el": $('#'+row.idname+'_modify_hostname'),
  								"default": row.content.realm,
  								"disabled": true
        					}, {tokens: true}).render();
  							row.usernameInput = new TextInput({
            					"id": "modify_username_"+row.idname,
            					"value": "$form.modify_username_"+row.idname+"$",
            					"el": $('#'+row.idname+'_modify_username'),
  								"default": row.content.username
        					}, {tokens: true}).render();
  							row.passwordInput = new TextInput({
            					"id": "modify_password_"+row.idname,
            					"value": "$form.modify_password_"+row.idname+"$",
            					"el": $('#'+row.idname+'_modify_password'),
  								"default": row.content.clear_password,
  								"type":"password"
        					}, {tokens: true}).render();
  
  							///DELETE HANDLER
  							
  							$("#"+row.idname+"_delete").on("click",function(e){
  								console.log("Duh, something was clicked");
  								e.preventDefault();
                          		if (confirm("Really delete Credential " + row.name + "?")) {
  										service.del(row.links.remove)
                        				.done(function() { 
                        					$("#"+row.idname+"_container").empty();
  											service.del("/servicesNS/nobody/"+_APP_NAME+"/configs/conf-inputs/gigamon%3A%252F%252F"+row.content.realm);
  											updateModifyMsg("Successfully Deleted the Credentials and Data Input");
  											setTimeout(function(){updateModifyMsg("");$('#modify_error_msg').removeClass("ui-state-error").removeClass("ui-state-highlight");},7500)
  										});
                                	} else {
                                		return false;
                                	}                                       
                        	

  							});
  							
  
  					};
  		var add_gigahost = new TextInput({
            "id": "add_gigahost",
            "value": "$form.add_gigahost$",
            "el": $('#gigahost')
        }, {tokens: true}).render();
 
  
  		var add_gigauser = new TextInput({
            "id": "add_gigauser",
            "value": "$form.add_gigauser$",
            "el": $('#gigauser')
        }, {tokens: true}).render();
  
  		var add_gigapass = new TextInput({
            "id": "add_gigapass",
            "value": "$form.add_gigapass$",
            "el": $('#gigapass'),
  			"type": "password"
        }, {tokens: true}).render();
  
  		var add_gigainterval = new DropdownInput({
            "id": "add_gigainterval",
            "value": "$form.add_gigainterval$",
            "el": $('#gigainterval'),
  			"choices": [  {"label":"30","value": 30 },	//30 seconds
                          {"label":"60", "value": 60},	//1 minute
                          {"label":"300", "value":300},	//5 minutes
                          {"label":"600", "value":600 },//10 minutes
                          {"label":"900","value":900},	//15 minutes
                          {"label":"1800","value":1800},//30 minutes
                          {"label":"3600", "value":3600}//60 minutes
  						],
  			"default" : "300"
        }, {tokens: true}).render();

  		var giga_services = new CheckboxGroupInput({
            id: "giga_services",
  			choices: [ {"label":"Node", "value":"node"},
  						{"label":"Ports", "value":"port"},
  						{"label":"Port Statistics", "value":"stats"},
  						{"label":"Audit Logs","value":"audit"},
  						{"label":"Event Logs","value":"event"},
  						{"label":"System Users","value":"users"},
  					],
            el: $("#giga_services")
        }).render();
  
  		var giga_api = new RadioGroupInput({
            id: "giga_api",
            default: "v1.1",
  			choices: [ 
				   {"label":"3.1.X", "value":"v1.1"},
				   {"label":"3.2.X", "value":"v1.2"},
				   {"label":"3.3.X and Above", "value":"v1.3"}
  					],
            el: $("#giga_api")
        }).render();
  
  		var addCredentials_submit = new SubmitButton({
            id: "addCredentials_submit",
            el: $("#addCredentialSubmit"),
            text: "Add GigaVUE-FM"
        }, {tokens: true}).render();

  		addCredentials_submit.on("submit", function() {
            submitTokens();
  			

            // When the Submit button is clicked, get all the form fields by accessing token values
            
            var myRealm = $.trim(add_gigahost.val()), myUser = $.trim(add_gigauser.val()), myPass = add_gigapass.val();
  			var myQuery = "name="+myUser+"&password="+myPass+"&realm="+myRealm;
  			var baseData = "index=main";
  			var baseServices = "domain";
  			var addSvcs = giga_services.val().join(":");
  			var interval = add_gigainterval.val();
  			if (addSvcs.length > 1) { baseServices=baseServices+":"+addSvcs; }
  			var myApi = giga_api.val();
  			var myDataInput = "name=gigamon://"+myRealm+"&hostname="+myRealm+"&username="+myUser+"&api="+myApi+"&services="+baseServices+"&"+baseData+"&interval="+interval+"&disabled=0";
  			
  			var myDataUrl = "/servicesNS/nobody/"+_APP_NAME+"/configs/conf-inputs/";
  			var updateError = function(msg){ $('#add_error_msg').html('<span class="ui-icon ui-icon-alert" style="float:left; margin-right:.3em"></span><strong>'+msg+'</strong>').addClass("ui-state-error"); };
  			if ( !validate("defined",myRealm) ) { updateError("Please define a hostname"); return; }
			if ( !validate("defined",myUser) ) { updateError("Please define a username"); return; }
  			if ( !validate("defined",myPass) ) { updateError("Please define a password"); return; }
  			var updateMessage = function(msg){ $('#add_error_msg').html('<span class="ui-icon ui-icon-alert" style="float:left; margin-right:.3em"></span><strong>'+msg+'</strong>').removeClass("ui-state-error").addClass("ui-state-highlight"); };
  			updateError("");

  			//// Create a new Secured Password
  			service.request(
  				"/servicesNS/nobody/"+_APP_NAME+"/storage/passwords/",
                "POST",
                null,
                null,
                myQuery,
  				{"Content-Type": "text/plain"},
                null)
            .done(function(data) { 
                          	console.log("Returned from creation. Long Trip.");
  							updateError("Successfully stored credentials.");
  							var row = JSON.parse(data).entry[0];
  							buildCredentialItem(row);
  							///// Create a new Data Input for the Modular Input
  							service.request(
                                myDataUrl,
  								"POST",
  								null,
  								null,
  								myDataInput,
  								{"Content-Type":"text/plain"},
  								null)
  								.done(function(data){
                                    // Refresh the gigamon modular input to pick up the changes.
  									$.get("/en-US/debug/refresh?entity=admin/gigamon");
  									updateMessage("Successfully stored credentials and created data input");
  									
  								});
  							setTimeout(function(){updateMessage("");$('#add_error_msg').removeClass("ui-state-error").removeClass("ui-state-highlight");},7500)
            })
  			.error(function(data) {
  				var errorMessage = JSON.parse(data.responseText);
  				console.log(errorMessage);
  				updateError(errorMessage["messages"][0]["text"]);
  			});
  
  			
  		});
        //
        // VIEWS: VISUALIZATION ELEMENTS
        //


        // Initialize time tokens to default
        if (!defaultTokenModel.has('earliest') && !defaultTokenModel.has('latest')) {
            defaultTokenModel.set({ earliest: '0', latest: '' });
        }

        submitTokens();

  
  		//Load Credentials
  		
  			var updateModifyError = function(msg){ $('#modify_error_msg').html('<span class="ui-icon ui-icon-alert" style="float:left; margin-right:.3em"></span><strong>'+msg+'</strong>').addClass("ui-state-error"); };
  			var updateModifyMsg = function(msg){ $('#modify_error_msg').html('<span class="ui-icon ui-icon-alert" style="float:left; margin-right:.3em"></span><strong>'+msg+'</strong>').removeClass("ui-state-error").addClass("ui-state-highlight"); };
  																			
  			service.request(
  				"/servicesNS/nobody/"+_APP_NAME+"/storage/passwords/",
                "GET",
                null,
                null,
                null,
                {"Content-Type": "application/json"},
                null)
                    .done(function(data) { 
  						_.each(JSON.parse(data).entry, function(row){
  							buildCredentialItem(row);
  
  						});
  			
  		});

        //
        // DASHBOARD READY
        //

        DashboardController.ready();
        pageLoading = false;

    }
);
</script>
  
</body>
</html>
