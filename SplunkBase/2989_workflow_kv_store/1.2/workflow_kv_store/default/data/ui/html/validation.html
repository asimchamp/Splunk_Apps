<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Validation</title>
        <link rel="shortcut icon" href="{{SPLUNKWEB_URL_PREFIX}}/static/img/favicon.ico" />
        <link rel="stylesheet" type="text/css"  href="{{SPLUNKWEB_URL_PREFIX}}/static/app/workflow_kv_store/table_decorations.css" />
        <link rel="stylesheet" type="text/css" href="/en-US/static/@f3e41e4b37b2/css/build/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="/en-US/static/@f3e41e4b37b2/css/build/pages/dashboard-simple-bootstrap.min.css" />
    </head>
    <body class="simplexml preload locale-en">
        <!--
         BEGIN LAYOUT
         This section contains the layout for the dashboard. Splunk uses proprietary
         styles in <div> tags, similar to Bootstrap's grid system.
         -->
        <a class="navSkip" href="#navSkip" tabindex="1">Screen reader users, click here to skip the navigation bar</a>
        <div class="header splunk-header">
            <div id="placeholder-splunk-bar">
                <a href="{{SPLUNKWEB_URL_PREFIX}}/app/launcher/home" class="brand" title="splunk &gt; listen to your data">splunk<strong>&gt;</strong></a>
            </div>
            <div id="placeholder-app-bar"></div>
        </div>
        <a id="navSkip"></a>
        <div class="dashboard-body container-fluid main-section-body" data-role="main">
             <div class="dashboard-header clearfix">
            <h2>Validation</h2>
          </div>
            
               <span style="display: inline;">
                   
                    <div style="display: inline;" id="search_btn">
                        <button class="btn btn-primary">Send</button>
                    </div>
                  <div style="display: inline;" id="delete_btn">
                        <button class="btn btn-primary">Delete</button>
                    </div>
                  <div style="display: inline;" id="back_btn">
                        <button class="btn btn-primary">Back to Edition</button>
                    </div>
                  <div style="display: inline;" id="cancel_btn">
                        <button class="btn btn-primary">Cancel</button>
                    </div>
                  
                </span>
               
           <div id="row1" class="dashboard-row dashboard-row1">
                <div id="panel1" class="dashboard-cell" style="width: 100%;">
                     <div class="dashboard-panel clearfix">
                     <h2 class="panel-title">validate table</h2>
                    <div class="panel-element-row">
                        <div id="valid_table" class="dashboard-element table" style="width: 100%">
                            <div class="panel-body"></div>
                        </div>
                    </div>
                </div>
               </div>
             
          </div>
             <div id="row2" class="dashboard-row dashboard-row2">
        
                <div id="panel2" class="dashboard-cell" style="width: 100%;">
                     <div class="dashboard-panel clearfix">
                         <h2 class="panel-title">confirm table</h2>
                    <div class="panel-element-row">
                        <div id="confirm_table" class="dashboard-element table" style="width: 100%">
                            <div class="panel-body"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
  </div>

            
           
        <div class="footer"></div>
        
        <!--
         END LAYOUT
         -->
        
        <script src="{{SPLUNKWEB_URL_PREFIX}}/config?autoload=1"></script>
        <script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/i18n.js"></script>
        <script src="{{SPLUNKWEB_URL_PREFIX}}/i18ncatalog?autoload=1"></script>
        <script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/build/simplexml.min/config.js"></script>
        <script type="text/javascript">
            // <![CDATA[
            require.config({
                           baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
                           waitSeconds: 0 // Disable require.js load timeout
                           });
                           
                           //
                           // LIBRARY REQUIREMENTS
                           //
                           // In the require function, we include the necessary libraries and modules for
                           // the HTML dashboard. Then, we pass variable names for these libraries and
                           // modules as function parameters, in order.
                           //
                           // When you add libraries or modules, remember to retain this mapping order
                           // between the library or module and its function parameter. You can do this by
                           // adding to the end of these lists, as shown in the commented examples below.
                           
                           require([
                                    "splunkjs/mvc",
                                    "splunkjs/mvc/utils",
                                    "splunkjs/mvc/tokenutils",
                                    "underscore",
                                    "jquery",
                                    "splunkjs/mvc/simplexml",
                                    "splunkjs/mvc/headerview",
                                    "splunkjs/mvc/footerview",
                                    "splunkjs/mvc/simplexml/dashboardview",
                                    "splunkjs/mvc/simplexml/dashboard/panelref",
                                    "splunkjs/mvc/simplexml/element/chart",
                                    "splunkjs/mvc/simplexml/element/event",
                                    "splunkjs/mvc/simplexml/element/html",
                                    "splunkjs/mvc/simplexml/element/list",
                                    "splunkjs/mvc/simplexml/element/map",
                                    "splunkjs/mvc/simplexml/element/single",
                                    "splunkjs/mvc/simplexml/element/table",
                                    "splunkjs/mvc/simpleform/formutils",
                                    "splunkjs/mvc/simplexml/eventhandler",
                                   
                                    "splunkjs/mvc/simpleform/input/dropdown",
                                    "splunkjs/mvc/simpleform/input/radiogroup",
                                  
                                    "splunkjs/mvc/simpleform/input/multiselect",
                                    "splunkjs/mvc/simpleform/input/checkboxgroup",
                                    "splunkjs/mvc/simpleform/input/text",
                                    "splunkjs/mvc/simpleform/input/timerange",
                                    "splunkjs/mvc/simpleform/input/submit",
                                    "splunkjs/mvc/searchmanager",
                                    "splunkjs/mvc/savedsearchmanager",
                                    "splunkjs/mvc/postprocessmanager",
                                    "splunkjs/mvc/tableview",
                                    "splunkjs/mvc/simplexml/urltokenmodel"
                                    // Add comma-separated libraries and modules manually here, for example:
                                    // ..."splunkjs/mvc/simplexml/urltokenmodel",
                                    // "splunkjs/mvc/checkboxview"
                                    ],
                                   function(
                                            mvc,
                                            utils,
                                            TokenUtils,
                                            _,
                                            $,
                                            DashboardController,
                                            HeaderView,
                                            FooterView,
                                            Dashboard,
                                            PanelRef,
                                            ChartElement,
                                            EventElement,
                                            HtmlElement,
                                            ListElement,
                                            MapElement,
                                            SingleElement,
                                            TableElement,
                                            FormUtils,
                                            EventHandler,
                                          
                                            DropdownInput,
                                            RadioGroupInput,
                                            
                                            MultiSelectInput,
                                            CheckboxGroupInput,
                                            TextInput,
                                            TimeRangeInput,
                                            SubmitButton,
                                            SearchManager,
                                            SavedSearchManager,
                                            PostProcessManager,
                                            TableView,
                                            UrlTokenModel
                                            
                                            // Add comma-separated parameter names here, for example:
                                            // ...UrlTokenModel,
                                            // CheckboxView
                                            ) {
                                   
                                    var pageLoading = true;
                                   
                                   
                                   //
                                   // TOKENS
                                   //
                                   
                                   // Create token namespaces
                                   var urlTokenModel = new UrlTokenModel();
                                   mvc.Components.registerInstance('url', urlTokenModel);
                                   var defaultTokenModel = mvc.Components.getInstance('default', {create: true});
                                   var submittedTokenModel = mvc.Components.getInstance('submitted', {create: true});
                                   
                                   urlTokenModel.on('url:navigate', function() {
                                                    defaultTokenModel.set(urlTokenModel.toJSON());
                                                    if (!_.isEmpty(urlTokenModel.toJSON()) && !_.all(urlTokenModel.toJSON(), _.isUndefined)) {
                                                    submitTokens();
                                                    } else {
                                                    submittedTokenModel.clear();
                                                    }
                                                    });
                                   
                                   // Initialize tokens
                                   defaultTokenModel.set(urlTokenModel.toJSON());
                                   
                                   function submitTokens() {
                                   // Copy the contents of the defaultTokenModel to the submittedTokenModel and urlTokenModel
                                   FormUtils.submitForm({ replaceState: pageLoading });
                                   }
                                   
                                   function setToken(name, value) {
                                   defaultTokenModel.set(name, value);
                                   submittedTokenModel.set(name, value);
                                   }
                                   
                                   function unsetToken(name) {
                                   defaultTokenModel.unset(name);
                                   submittedTokenModel.unset(name);
                                   }
                                  
                                   
                                   
                                   //
                                   // SEARCH MANAGERS
                                   //
                                   
                                   var search1 = new SearchManager({
                                                                   "id": "search1",
                                                                   "search": "|inputlookup valid_kv_lookup |eval keyID=_key",
                                                                   "cancelOnUnload": true,
                                                                   "status_buckets": 0,
                                                                   "earliest_time": "0",
                                                                   "latest_time": "$latest$",
                                                                   "app": utils.getCurrentApp(),
                                                                   "auto_cancel": 90,
                                                                   "preview": true,
                                                                   "runWhenTimeIsUndefined": false
                                                                   }, {tokens: true,tokenNamespace: "submitted"});
                                   
                                    var search2 = new SearchManager({
                                                                   "id": "search2",
                                                                   "search": "|inputlookup confirm_kv_lookup |eval keyID=_key |stats values(firstname) as firstname values(lastname) as lastname values(email) as email values(keyID) as keyID values(date_validation) as date_validation values(description) as description by num |sort + num",
                                                                   "cancelOnUnload": true,
                                                                   "status_buckets": 0,
                                                                   "earliest_time": "0",
                                                                   "latest_time": "$latest$",
                                                                   "app": utils.getCurrentApp(),
                                                                   "auto_cancel": 90,
                                                                   "preview": true,
                                                                   "runWhenTimeIsUndefined": false
                                                                   }, {tokens: true,tokenNamespace: "submitted"});
                                   
                                 
                                  
                                   
                                   //
                                   // SPLUNK HEADER AND FOOTER
                                   //
                                   
                                   new HeaderView({
                                                  id: 'header',
                                                  section: 'dashboards',
                                                  el: $('.header'),
                                                  acceleratedAppNav: true,
                                                  useSessionStorageCache: true,
                                                  splunkbar: true,
                                                  appbar: true,
                                                  litebar: false,
                                                  }, {tokens: true}).render();
                                   
                                   new FooterView({
                                                  id: 'footer',
                                                  el: $('.footer')
                                                  }, {tokens: true}).render();
                                   
                                   
                                   //
                                   // DASHBOARD EDITOR
                                   //
                                   
                                   new Dashboard({
                                                 id: 'dashboard',
                                                 el: $('.dashboard-body'),
                                                 showTitle: true,
                                                 editable: true
                                                 }, {tokens: true}).render();
                                   
                                   
                                   //
                                   // VIEWS: VISUALIZATION ELEMENTS
                                   //
                                   
                                   var valid_table = new TableElement({
                                                                     "id": "valid_table",
                                                                     "drilldown": "cell",
                                                                     "fields":"num firstname lastname email description",
                                                                     "managerid": "search1",
                                                                     "el": $('#valid_table')
                                                                     }, {tokens: true,tokenNamespace: "submitted"}).render();
                                   
                                   

				 						var confirm_table = new TableElement({
                                                                     "id": "confirm_table",
                                                                     "drilldown": "none",
                                                                     "fields":"num date_validation firstname lastname email description",
                                                                     "managerid": "search2",
                                                                     "el": $('#confirm_table')
                                                                     }, {tokens: true,tokenNamespace: "submitted"}).render();
                                  
 									
                                   //
                                   // VIEWS: FORM INPUTS
                                   //
                                   
                                   var input1 = new TextInput({
                                                              "id": "input1",
                                                              "value": "$form.firstname$",
                                                              "el": $('#input1')
                                                              }, {tokens: true}).render();
                                   
                                   input1.on("change", function(newValue) {
                                             FormUtils.handleValueChange(input1);
                                             });
                                   
                                   var input2 = new TextInput({
                                                              "id": "input2",
                                                              "value": "$form.lastname$",
                                                              "el": $('#input2')
                                                              }, {tokens: true}).render();
                                   
                                   input2.on("change", function(newValue) {
                                             FormUtils.handleValueChange(input2);
                                             });
                                   
                                   var input3 = new TextInput({
                                                              "id": "input3",
                                                              "value": "$form.email$",
                                                              "el": $('#input3')
                                                              }, {tokens: true}).render();
                                   
                                   input3.on("change", function(newValue) {
                                             FormUtils.handleValueChange(input3);
                                             });
                                   
                                   
                                   
                                                                     // Initialize time tokens to default
                                   if (!defaultTokenModel.has('earliest') && !defaultTokenModel.has('latest')) {
                                   defaultTokenModel.set({ earliest: '0', latest: '' });
                                   }
                                   
                                   submitTokens();
                                   
                                   
                                   //
                                   // DASHBOARD CONTROL ELEMENTS
                                   //
                                   
                                   function pushArray(arr1,arr2){
                                   
                                   if(arr1 && arr2 && Array.isArray(arr1)){
                                   arr1.push.apply(arr1,Array.isArray(arr2) ? arr2 : [arr2] );
                                   }
                                   }
                                   
                                   
                                   var tab_c = [];
                                   var obj = {};
                                   var obj_key = [];
                                   var keyid_array =[];
                                   
                                   valid_table.on('click',function(e){
                                                 e.preventDefault();
                                                 if(e.field === 'num'){
                                                 
                                                 var num_value = e.data['row.num'];
                                                 var email_value = e.data['row.email'];
                                                 var firstname_value = e.data['row.firstname'];
                                                 var lastname_value = e.data['row.lastname'];
             									 var description = e.data['row.description'];
                                                 var keyid = e.data['row.keyID'];
                                                 
                                                 obj={
                                                 'number' : num_value,
                                                 'email' : email_value,
                                                 'first_name' : firstname_value,
                                                 'last_name' : lastname_value,
													'description' : description
                                                 }
                                                 
                                                 
                                                 
                                                 if(tab_c.length == 0){
                                                 tab_c.push(obj);
                                                 pushArray(obj_key,num_value);
                                                 pushArray(keyid_array,keyid);
                                                 myfunction(obj_key);
                                                 }
                                                 else{
                                                 
                                                 if(_.contains(obj_key,num_value)){
                                                 
                                                 for(i = tab_c.length-1;i>=0;i--){
                                                 
                                                 if(tab_c[i].number === num_value){
                                                 tab_c.splice(i,1);
                                                 obj_key.splice(obj_key.indexOf(num_value),1);
                                                 keyid_array.splice(keyid_array.indexOf(keyid),1);
                                                 myfunction(obj_key);
                                                 }
                                                 
                                                 }
                                                 
                                                 }else{
                                                 tab_c.push(obj);
                                                 pushArray(obj_key,num_value);
                                                 pushArray(keyid_array,keyid);
                                                 myfunction(obj_key);
                                                 }
                                                 
                                                 }
                                                 
                                                 
                                                 
                                                 }else{
                                                 e.preventDefault();
                                                 }
                                                 
                                                 });
                                   
                                   
                                   
                                   
                                   //
                                   // DASHBOARD COLORATION
                                   //
                                   
                                   function myfunction(a) {
                                   
                                   
                                   var CustomRangeRenderer = TableView.BaseCellRenderer.extend({
                                                                                               
                                                                                               canRender:function(cell){
                                                                                               return _(['num']).contains(cell.field);
                                                                                               
                                                                                               
                                                                                               },
                                                                                               
                                                                                               render:function($td,cell){
                                                                                               
                                                                                               var value = String(cell.value);
                                                                                               
                                                                                               
                                                                                               if(_.contains(a,value)){
                                                                                               
                                                                                               
                                                                                               $td.addClass('range-cell').addClass('range-elevated');
                                                                                               
                                                                                               }
                                                                                               $td.text(value).addClass('text');
                                                                                               
                                                                                               }
                                                                                               });
                                   													mvc.Components.get('valid_table').getVisualization(function(tableView) {
                                                                                     tableView.on('rendered', function() {
                                                                                                  // Apply class of the cells to the parent row in order to color the whole row
                                                                                                  tableView.$el.find('td.range-cell').each(function() {
                                                                                                                                           $(this).parents('tr').addClass(this.className);
                                                                                                                                           });
                                                                                                  });
                                                                                     // Add custom cell renderer, the table will re-render automatically.
                                                                                     tableView.addCellRenderer(new CustomRangeRenderer());
                                                                                     });
                                   
                                   };

    								//
                                   // CANCEL BUTTON
                                   //

									$('#cancel_btn').on('click',function(){
										 tab_c =[];
                                         obj_key = [];
										 keyid_array = [];
                                         myfunction(obj_key);
									});

	
                                   
                                   //
                                   // DELETE BUTTON
                                   //

									$('#delete_btn').on('click',function(){
										delete_keyid();
									});
                                   
                                   // Call this function when the Delete Record button is clicked
                                   function delete_keyid() {
                                   // Get the value of the key ID field
                                   var tokens = mvc.Components.get("default");
                                   //var form_keyid = tokens.get("KeyID");
                                   
                                   // Delete the record that corresponds to the key ID using
                                   // the del method to send a DELETE request
                                   // to the storage/collections/data/{collection}/ endpoint

										if(keyid_array.length > 0){
										for(i=0;i<keyid_array.length;i++){
                                   service.del("storage/collections/data/validatecollection/" + encodeURIComponent(keyid_array[i]))
										}
                                   //.done(function() {
                                   // Run the search again to update the table
                                       search1.startSearch();
										
                                   //  });
                                   return false;
                                   console.log("from delete function",keyid_array);
                                   };
                                   
                                   };
                                   
                                   
                                   //
                                   // SUBMIT FORM DATA
                                   //
                                   
                                   var service = mvc.createService({ owner: "nobody" });



									$('#back_btn').on('click',function(){
									

											 for(i=0;i<tab_c.length;i++){
                                                       
                                                       
                                                       var record = {
                                                       "firstname": tab_c[i].first_name,
                                                       "lastname": tab_c[i].last_name,
                                                       "email": tab_c[i].email,
                                                       "num":tab_c[i].number,
													
														"description":tab_c[i].description
                                                       };
                                                       
                                                       service.request(
                                                                       "storage/collections/data/backcollection/",
                                                                       "POST",
                                                                       null,
                                                                       null,
                                                                       JSON.stringify(record),
                                                                       {"Content-Type": "application/json"},
                                                                       null);
                                                       
                                                       }
                                                       
                                                       
                                                       tab_c =[];
                                                       obj_key = [];
														delete_keyid();
                                                       keyid_array = [];
                                                       myfunction(obj_key);
                                                          
                                                       
                                                       });
                                   
                                   
											
										
						
                                   
                                   $('#search_btn').on('click',function(){
                                                  var current_date = new Date();
													var dd = current_date.getDate();
													var mm = current_date.getMonth()+1; //January is 0!
													var yyyy = current_date.getFullYear();
													current_date = dd+'-'+mm+'-'+yyyy; 
                                                       
                                                       for(i=0;i<tab_c.length;i++){
                                                       
                                                       
                                                       var record = {
                                                       "firstname": tab_c[i].first_name,
                                                       "lastname": tab_c[i].last_name,
                                                       "email": tab_c[i].email,
                                                       "num":tab_c[i].number,
														"date_validation":current_date,
														"description":tab_c[i].description
                                                       };
                                                       
                                                       service.request(
                                                                       "storage/collections/data/confirmcollection/",
                                                                       "POST",
                                                                       null,
                                                                       null,
                                                                       JSON.stringify(record),
                                                                       {"Content-Type": "application/json"},
                                                                       null);
                                                       
                                                       }
                                                       
                                                       
                                                       tab_c =[];
                                                       obj_key = [];
														delete_keyid();
                                                       keyid_array = [];
                                                       myfunction(obj_key);
                                                       
                                                       search2.startSearch();
                                                       
                                                       
                                                       });
                                   
                                   
                                   
                                   //
                                   // DASHBOARD READY
                                   //
                                   
                                   DashboardController.ready();
                                   pageLoading = false;
                                   
                                   }
                                   );
                                   // ]]>
            </script>
        <script src="{{SPLUNKWEB_URL_PREFIX}}/static/app/workflow_kv_store/table_row_highlighting.js" type="text/javascript"></script>
    </body>
</html>