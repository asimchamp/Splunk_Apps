<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Starter</title>
        <link rel="shortcut icon" href="{{SPLUNKWEB_URL_PREFIX}}/static/img/favicon.ico" />
        <link rel="stylesheet" type="text/css"  href="{{SPLUNKWEB_URL_PREFIX}}/static/app/workflow_kv_store/table_decorations.css" />
           <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/build/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/build/pages/dashboard-simple-bootstrap.min.css" />
    </head>
    <body class="simplexml preload locale-en">
        <!--
         BEGIN LAYOUT
         This section contains the layout for the dashboard. Splunk uses proprietary
         styles in <div> tags, similar to Bootstrap's grid system.
         -->
        <a class="navSkip" href="#navSkip" tabindex="1">Screen reader users, click here to skip the navigation bar</a>
        <div class="header splunk-header">
            <div id="placeholder-splunk-bar">
                <a href="{{SPLUNKWEB_URL_PREFIX}}/app/launcher/home" class="brand" title="splunk &gt; listen to your data">splunk<strong>&gt;</strong></a>
            </div>
            <div id="placeholder-app-bar"></div>
        </div>
        <a id="navSkip"></a>
        <div class="dashboard-body container-fluid main-section-body" data-role="main">
            <div class="dashboard-header clearfix">
                <h2>Starter</h2>
            </div>
            
            <div style="display:inline;" id="search_btn">
                <button class="btn btn-primary">Send</button>
            </div>
          	<div style="display:inline;" id="cancel_btn">
                <button class="btn btn-primary">Cancel</button>
            </div>
            
            
            <div id="row1" class="dashboard-row dashboard-row1">
                <div id="panel1" class="dashboard-cell" style="width: 100%;">
                    <div class="dashboard-panel clearfix">
                         <h2 class="panel-title">contact overflow</h2>
                        <div class="panel-element-row">
                            <div id="content_table" class="dashboard-element table" style="width: 100%">
                               
                                <div class="panel-body"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer"></div>
        
        <!--
         END LAYOUT
         -->
        
        <script src="{{SPLUNKWEB_URL_PREFIX}}/config?autoload=1"></script>
        <script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/i18n.js"></script>
        <script src="{{SPLUNKWEB_URL_PREFIX}}/i18ncatalog?autoload=1"></script>
        <script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/build/simplexml.min/config.js"></script>
        <script type="text/javascript">
            // <![CDATA[
            require.config({
                           baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
                           waitSeconds: 0 // Disable require.js load timeout
                           });
                           
                           //
                           // LIBRARY REQUIREMENTS
                           //
                           // In the require function, we include the necessary libraries and modules for
                           // the HTML dashboard. Then, we pass variable names for these libraries and
                           // modules as function parameters, in order.
                           //
                           // When you add libraries or modules, remember to retain this mapping order
                           // between the library or module and its function parameter. You can do this by
                           // adding to the end of these lists, as shown in the commented examples below.
                           
                           require([
                                    "splunkjs/mvc",
                                    "splunkjs/mvc/utils",
                                    "splunkjs/mvc/tokenutils",
                                    "underscore",
                                    "jquery",
                                    "splunkjs/mvc/simplexml",
                                    "splunkjs/mvc/headerview",
                                    "splunkjs/mvc/footerview",
                                    "splunkjs/mvc/simplexml/dashboardview",
                                    "splunkjs/mvc/simplexml/dashboard/panelref",
                                    "splunkjs/mvc/simplexml/element/chart",
                                    "splunkjs/mvc/simplexml/element/event",
                                    "splunkjs/mvc/simplexml/element/html",
                                    "splunkjs/mvc/simplexml/element/list",
                                    "splunkjs/mvc/simplexml/element/map",
                                    "splunkjs/mvc/simplexml/element/single",
                                    "splunkjs/mvc/simplexml/element/table",
                                    "splunkjs/mvc/simpleform/formutils",
                                    "splunkjs/mvc/simplexml/eventhandler",
                                    
                                    "splunkjs/mvc/simpleform/input/dropdown",
                                    "splunkjs/mvc/simpleform/input/radiogroup",
                                  
                                    "splunkjs/mvc/simpleform/input/multiselect",
                                    "splunkjs/mvc/simpleform/input/checkboxgroup",
                                    "splunkjs/mvc/simpleform/input/text",
                                    "splunkjs/mvc/simpleform/input/timerange",
                                    "splunkjs/mvc/simpleform/input/submit",
                                    "splunkjs/mvc/searchmanager",
                                    "splunkjs/mvc/savedsearchmanager",
                                    "splunkjs/mvc/postprocessmanager",
                                    "splunkjs/mvc/tableview",
                                    "splunkjs/mvc/simplexml/urltokenmodel"
                                    // Add comma-separated libraries and modules manually here, for example:
                                    // ..."splunkjs/mvc/simplexml/urltokenmodel",
                                    // "splunkjs/mvc/checkboxview"
                                    ],
                                   function(
                                            mvc,
                                            utils,
                                            TokenUtils,
                                            _,
                                            $,
                                            DashboardController,
                                            HeaderView,
                                            FooterView,
                                            Dashboard,
                                            PanelRef,
                                            ChartElement,
                                            EventElement,
                                            HtmlElement,
                                            ListElement,
                                            MapElement,
                                            SingleElement,
                                            TableElement,
                                            FormUtils,
                                            EventHandler,
                                         
                                            DropdownInput,
                                            RadioGroupInput,
                                         
                                            MultiSelectInput,
                                            CheckboxGroupInput,
                                            TextInput,
                                            TimeRangeInput,
                                            SubmitButton,
                                            SearchManager,
                                            SavedSearchManager,
                                            PostProcessManager,
                                            TableView,
                                            UrlTokenModel
                                            
                                            // Add comma-separated parameter names here, for example:
                                            // ...UrlTokenModel,
                                            // CheckboxView
                                            ) {
                                   
                                   var pageLoading = true;
                                   
                                   
                                   //
                                   // TOKENS
                                   //
                                   
                                   // Create token namespaces
                                   var urlTokenModel = new UrlTokenModel();
                                   mvc.Components.registerInstance('url', urlTokenModel);
                                   var defaultTokenModel = mvc.Components.getInstance('default', {create: true});
                                   var submittedTokenModel = mvc.Components.getInstance('submitted', {create: true});
                                   
                                   urlTokenModel.on('url:navigate', function() {
                                                    defaultTokenModel.set(urlTokenModel.toJSON());
                                                    if (!_.isEmpty(urlTokenModel.toJSON()) && !_.all(urlTokenModel.toJSON(), _.isUndefined)) {
                                                    submitTokens();
                                                    } else {
                                                    submittedTokenModel.clear();
                                                    }
                                                    });
                                   
                                   // Initialize tokens
                                   defaultTokenModel.set(urlTokenModel.toJSON());
                                   
                                   function submitTokens() {
                                   // Copy the contents of the defaultTokenModel to the submittedTokenModel and urlTokenModel
                                   FormUtils.submitForm({ replaceState: pageLoading });
                                   }
                                   
                                   function setToken(name, value) {
                                   defaultTokenModel.set(name, value);
                                   submittedTokenModel.set(name, value);
                                   }
                                   
                                   function unsetToken(name) {
                                   defaultTokenModel.unset(name);
                                   submittedTokenModel.unset(name);
                                   }
                                   
                                   
                                   
                                   //
                                   // SEARCH MANAGERS
                                   //
                                   
                                   var search1 = new SearchManager({
                                                                   "id": "search1",
                                                                   "cancelOnUnload": true,
                                                                   "search": "|inputlookup DataCSV|lookup valid_kv_lookup num OUTPUT email as email_kv_valid |lookup edit_kv_lookup num OUTPUT email as email_kv_edit |lookup confirm_kv_lookup num OUTPUT email as email_kv_confirm |lookup back_kv_lookup num OUTPUT email as email_kv_back |eval email_ori=email |eval email=if(isnotnull(email_kv_confirm),email_ori.\";3\",if(isnotnull(email_kv_valid),email_ori.\";2\",if(isnotnull(email_kv_back),email.\";4\",if(isnotnull(email_kv_edit),email_ori.\";1\",email_ori.\";0\"))))|eval status=if(isnotnull(email_kv_confirm),\"Confirmed\",if(isnotnull(email_kv_back),\"Stand by\",if(isnotnull(email_kv_valid),\"In progress ...\",if(isnotnull(email_kv_edit),\"Loading ...\",\"not yet\"))))| table num _time firstname lastname email email_ori status| sort + num",
                                                                   "status_buckets": 0,
                                                                   "earliest_time": "$earliest$",
                                                                   "latest_time": "$latest$",
                                                                   "app": utils.getCurrentApp(),
                                                                   "auto_cancel": 90,
                                                                   "preview": true,
                                                                   "runWhenTimeIsUndefined": false
                                                                   }, {tokens: true, tokenNamespace: "submitted"});
                                   
                                   
                                   
                                   //
                                   // SPLUNK HEADER AND FOOTER
                                   //
                                   
                                   new HeaderView({
                                                  id: 'header',
                                                  section: 'dashboards',
                                                  el: $('.header'),
                                                  acceleratedAppNav: true,
                                                  useSessionStorageCache: true,
                                                  splunkbar: true,
                                                  appbar: true,
                                                  litebar: false,
                                                  }, {tokens: true}).render();
                                   
                                   new FooterView({
                                                  id: 'footer',
                                                  el: $('.footer')
                                                  }, {tokens: true}).render();
                                   
                                   
                                   //
                                   // DASHBOARD EDITOR
                                   //
                                   
                                   new Dashboard({
                                                 id: 'dashboard',
                                                 el: $('.dashboard-body'),
                                                 showTitle: true,
                                                 editable: true
                                                 }, {tokens: true}).render();
                                   
                                   
                                   //
                                   // VIEWS: VISUALIZATION ELEMENTS
                                   //
                                   
                                   var content_table = new TableElement({
                                                                        "id": "content_table",
                                                                        "drilldown":"cell",
                                                                        "fields":"num firstname lastname email status",
                                                                        "managerid": "search1",
                                                                        "el": $('#content_table')
                                                                        }, {tokens: true, tokenNamespace: "submitted"}).render();
                                   
                                   // Initialize time tokens to default
                                   if (!defaultTokenModel.has('earliest') && !defaultTokenModel.has('latest')) {
                                   defaultTokenModel.set({ earliest: '0', latest: '' });
                                   }
                                   
                                   submitTokens();
                                   
                                   
                                   //
                                   // DASHBOARD CONTROL ELEMENTS
                                   //
                                   
                                   function pushArray(arr1,arr2){
                                   
                                   if(arr1 && arr2 && Array.isArray(arr1)){
                                   arr1.push.apply(arr1,Array.isArray(arr2) ? arr2 : [arr2] );
                                   }
                                   }
                                   
                                   
                                   var tab_c = [];
                                   var obj = {};
                                   var obj_key = [];
                                   
                                   content_table.on('click',function(e){
                                                    e.preventDefault();
                                                    if(e.field === 'num'){
                                                    
                                                    var num_value = e.data['row.num'];
                                                    var email_value = e.data['row.email_ori'];
                                                    var firstname_value = e.data['row.firstname'];
                                                    var lastname_value = e.data['row.lastname'];
                                                    
                                                    obj={
                                                    'number' : num_value,
                                                    'email' : email_value,
                                                    'first_name' : firstname_value,
                                                    'last_name' : lastname_value
                                                    }
                                                    
                                                    
                                                    
                                                    if(tab_c.length == 0){
                                                    tab_c.push(obj);
                                                    pushArray(obj_key,num_value);
                                                    myfunction(obj_key);
                                                    }
                                                    else{
                                                    
                                                    if(_.contains(obj_key,num_value)){
                                                    
                                                    for(i = tab_c.length-1;i>=0;i--){
                                                    
                                                    if(tab_c[i].number === num_value){
                                                    tab_c.splice(i,1);
                                                    obj_key.splice(obj_key.indexOf(num_value),1);
                                                    myfunction(obj_key);
                                                    }
                                                    
                                                    }
                                                    
                                                    }else{
                                                    tab_c.push(obj);
                                                    pushArray(obj_key,num_value);
                                                    
                                                    myfunction(obj_key);
                                                    }
                                                    
                                                    }
                                                    
                                                    
                                                    
                                                    }else{
                                                    e.preventDefault();
                                                    }
                                                    
                                                    });
                                   
                                   
                                   //
                                   // DASHBOARD COLORATION
                                   //
                                   
                                   function myfunction(a) {
                                   
                                  
                                   
                                   var CustomRangeRenderer = TableView.BaseCellRenderer.extend({
                                                                                               
                                           canRender:function(cell){
                                           return _(['num']).contains(cell.field);
                                                                                               
                                           },
                                                                                               
                                            render:function($td,cell){
                                                                                               
                                            var value = String(cell.value);
                                                                                               
                                             if(_.contains(a,value)){
                                                                                               
                                              $td.addClass('range-cell').addClass('range-elevated');
                                                                                               
                                              }
                                              $td.text(value).addClass('text');
                                                                                               
                                              }
                                             });
                                   mvc.Components.get('content_table').getVisualization(function(tableView) {
                                                                                        tableView.on('rendered', function() {
                                                                                                     // Apply class of the cells to the parent row in order to color the whole row
                                                                                                     tableView.$el.find('td.range-cell').each(function() {
                                                                                                                                              $(this).parents('tr').addClass(this.className);
                                                                                                                                              });
                                                                                                     });
                                                                                        // Add custom cell renderer, the table will re-render automatically.
                                                                                        tableView.addCellRenderer(new CustomRangeRenderer());
                                                                                        });
                                   
                                   };
                                   
                                   var service = mvc.createService({ owner: "nobody" });

									$('#cancel_btn').on('click',function(){

											if(typeof tab_c != typeof undefined){
												
												if(tab_c.length>0){
												
													tab_c = [];
													obj_key = [];
                                                    myfunction(obj_key);


												}
												
											}
										});
                                   
                                   $('#search_btn').on('click',function(){
                                                       console.log(tab_c);
                                                       
                                                       for(i=0;i<tab_c.length;i++){
                                                       
                                                       
                                                       var record = {
                                                       "firstname": tab_c[i].first_name,
                                                       "lastname": tab_c[i].last_name,
                                                       "email": tab_c[i].email,
                                                       "num":tab_c[i].number
                                                       };
                                                       
                                                       service.request(
                                                                       "storage/collections/data/editcollection/",
                                                                       "POST",
                                                                       null,
                                                                       null,
                                                                       JSON.stringify(record),
                                                                       {"Content-Type": "application/json"},
                                                                       null);
                                                       
                                                       }
                                                       
                                                       tab_c =[];
                                                       obj_key = [];
                                                       myfunction(obj_key);
                                                       
                                                       search1.startSearch();
                                                       
                                                       
                                                       });
                                   
                                   
                                   
                                   
                                   
                                   //
                                   // DASHBOARD READY
                                   //
                                   
                                   DashboardController.ready();
                                   pageLoading = false;
                                   
                                   }
                                   );
                                   // ]]>
            </script>
        <script src="{{SPLUNKWEB_URL_PREFIX}}/static/app/workflow_kv_store/table_row_highlighting.js" type="text/javascript"></script>
    </body>
</html>