{% extends "splunkdj:base_with_account_bar.html" %}

{% load splunkmvc %}

{% block title %}{{app_name}} Home Page{% endblock title %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}{{app_name}}/css/main.css" />
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}{{app_name}}/bower_components/codemirror/lib/codemirror.css" />
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}{{app_name}}/bower_components/codemirror/theme/monokai.css" />
    
    <script type="text/javascript" src="{{STATIC_URL}}{{app_name}}/bower_components/mermaid/dist/mermaid.full.js"></script>
    <script type="text/javascript">
        var showPipeResult = function (pipeId) {
            console.log({
                type: 'show_pipe_result',
                pipeId: pipeId
            });    
        };
        var searchResult;
    </script>
    <style type="text/css">
        .label {
            text-transform: none;
        }
        .table-scroll {
            width: 750px;
            max-width: 750px;
            height: 800px;
            max-height: 800px;
            overflow-x:scroll;
            overflow-y:scroll;
        }
        .div-bordered {
            border: 2px solid #888;
            border-radius:3px;
        }
    </style>
{% endblock css %}

{% block content %}
    <div> 
        <div class="row">
            <div class="span2">
            </div>
            <div class="span5">
                <p>Enter your search below</p>
            </div>
        </div>
        <div class="row">
            <div class="span8">
                <textarea id="spl" width="100%">
                </textarea>    
                <div id="pipeline-diagram">
                </div>
            </div>
            <div class="span4">
                <div id="search-vis">
                </div>
                <div id="search-result">
                </div>
            </div>
        </div>
        <div class="row">
            <div id="timeline">
            </div>
        </div>
        <div class="row">
            <div id="eventviewer">
            </div>
        </div>
    </div>

{% endblock content%}

{% block js %}
    <script type="text/template" id="search-result-template">
        <p><%= search %></p>
        <p><%= time %></p>
        <p><%= error %></p>
        <div class="container table-scroll div-bordered">
            <table class="table table-striped table-bordered table-condensed">
                <% _.each(events, function (event) { %>
                    <tr>
                        <% _.each(_.pairs(event), function (kv) { %>
                            <td><%= kv[1] %></td>
                        <% }); %>
                    </tr>         
                <% }); %>
            </table>
        </div>
    </script>
    
    <script>
    require([
        "backbone",
        "underscore",
        "{{app_name}}/bower_components/d3/d3.min", 
        "{{app_name}}/bower_components/codemirror/lib/codemirror", 
        "{{app_name}}/bower_components/codemirror/addon/mode/simple", 
        "{{app_name}}/bower_components/codemirror/keymap/vim", 
        "{{app_name}}/js/codemirror/spl",
        "{{app_name}}/js/main"], function (Backbone, _, d3, 
            CodeMirror, cmSimple, cmVim, cmSpl) {
        
        var Search = Backbone.Model.extend({
            urlRoot: '../searches',
            initialize: function (){
            }
        });    
        
        showPipeResult = function (pipeId) {
            console.log({
                type: 'show_pipe_result_with_events',
                pipeId: pipeId
            });
            var template = _.template($("#search-result-template").html(), {
                    search: searchResult.get('search'),
                    time: searchResult.get('time'),
                    error: searchResult.get('error'),
                    events: searchResult.get('pipeline')[parseInt(pipeId) - 1].events,
                });
            $("#search-result").html(template);
        };
        
        var drawPipelineGraph = function (searchObject) {
            var graph = 'graph TD; classDef default fill:#fff,stroke:#65a637,stroke-width:2px;';
            var pipes = searchObject.get('q').trim().split('\n');
            pipes = _.map(pipes, function (p) {
                var firstPipe = p.indexOf('|');
                return p.substring(firstPipe + 1).trim().replace(/\|/, ':');
            });
            var prev = 0;
            var size = 0;
            var pipeline = searchObject.get('pipeline');
            searchResult = searchObject;
            for(var i = 0; i < pipes.length; i++) {
                size = pipeline ? pipeline[i].job.resultCount : 0;
                var edge = _.template(' <%= start %>-->|<%= pipe %>|<%= end %>[<%= size %>]; click <%= end %> showPipeResult; ')({
                    start: prev,
                    size: size,
                    pipe: pipes[i].trim(),
                    end: prev + 1
                });        
                graph += edge;
                prev++;    
            }
            return graph;
        };
        
        var search = new Search({ time: '', search: '', error: '', 
            result: {}, pipeline: [] });
        
        SearchResultView = Backbone.View.extend({
            initialize: function(){
                this.model.on('change', this.render, this);
            },
            render: function(){
                var template = _.template($("#search-result-template").html(), {
                        search: this.model.get('search'),
                        time: this.model.get('time'),
                        error: this.model.get('error'),
                        events: this.model.get('result').events,
                    });
                this.$el.html(template);
            },
            model: search
        });
        
        var searchResultView = new SearchResultView({ el: $("#search-result") });
            
        var editor = CodeMirror.fromTextArea(document.getElementById("spl"), {
            lineNumbers: true,
            theme: 'monokai',
            vimMode: true 
        });
        
        editor.on("change", function(cm, changeObj){
            var diagram = $('#pipeline-diagram');
            var graph = drawPipelineGraph({
                q: cm.getValue(),
                get: function (property) {
                    return this[property];
                }
            });
            console.log({
                event: 'render_graph',
                graph: graph    
            });
            diagram.html(graph);
            diagram.attr('class', 'mermaid');
            diagram.removeAttr('data-processed');
            try {
                mermaid.init();   
            } catch (e) {
                console.log(e);
            }
        });
        
        var fetchCommandDoc = function (command, callback) {
            var searchHelperUrl = '../../../../en-US/api/shelper?snippet=true&snippetEmbedJS=false&namespace={{app_name}}&useTypeahead=true&useAssistant=true&showCommandHelp=true&showCommandHistory=true&showFieldInfo=false&search=' + command;
            $.get(searchHelperUrl, function (data) {
                callback(data);
            });
        };
        
        var lineWidgets = {};
        
        editor.setOption("extraKeys", {
            'Ctrl-Enter': function (cm) {
                // eventViewer.settings.set("search", cm.getValue());
                search.set('error', '');
                search.save({ q: cm.getValue() }, {
                    success: function (s) {
                        console.log(s.toJSON());      
                        try {
                            if(s.get('q')) {
                                var diagram = $('#pipeline-diagram');
                                var graph = drawPipelineGraph(s);
                                console.log({
                                    event: 'render_graph',
                                    graph: graph    
                                });
                                diagram.html(graph);
                                diagram.attr('class', 'mermaid');
                                diagram.removeAttr('data-processed');
                                mermaid.init();    
                            }    
                        } catch (e) {
                            console.log(e);
                        }
                    }
                });          
            },
            'Shift-Cmd-D': function (cm) {
                var line = cm.getCursor().line;
                if(lineWidgets[line]) {
                    console.log('remove line widget');
                    cm.removeLineWidget(lineWidgets[line]);                    
                    lineWidgets[line] = undefined;
                } else {
                    console.log('add line widget');
                    var components = cm.getLine(line).split(' ');
                    var command = components[0] === '|' ? components[1] : components[0];
                    
                    fetchCommandDoc(command, function (doc) {
                        var docDiv = document.createElement("div");
                        docDiv.innerHTML = doc;
                        var widget = cm.addLineWidget(line, docDiv);
                        lineWidgets[line] = widget;         
                    }); 
                }
            }
        });
    });
    </script>
{% endblock js %}